<!DOCTYPE html><html lang="en-GB" class="js "><head><script type="text/javascript" async="" src="//app.meetami.ai/launchpad.php?c=168019131601"></script><script type="text/javascript" async="" src="//static.hotjar.com/c/hotjar-1317699.js?sv=5"></script><script type="text/javascript" src="https://m.addthis.com/live/red_lojson/300lo.json?si=5e0a28b02fada64c&amp;bkl=0&amp;bl=1&amp;sid=5e0a28b02fada64c&amp;pub=ra-57f3c869c15414c8&amp;rev=v8.28.1-wp&amp;ln=en&amp;pc=men&amp;cb=0&amp;ab=-&amp;dp=www.stockport.gov.uk&amp;fp=brownfield%2Fbrownfield-land-register&amp;fr=&amp;of=1&amp;pd=0&amp;irt=0&amp;vcl=0&amp;md=0&amp;ct=0&amp;tct=0&amp;abt=0&amp;cdn=0&amp;pi=1&amp;rb=0&amp;gen=100&amp;chr=UTF-8&amp;colc=1577724080699&amp;jsl=0&amp;uvs=5e0a28b0c4dd6c93000&amp;skipb=1&amp;callback=addthis.cbs.jsonp__043715880019590260"></script><script type="text/javascript" src="https://v1.addthisedge.com/live/boost/ra-57f3c869c15414c8/_ate.track.config_resp"></script><script type="text/javascript" src="https://z.moatads.com/addthismoatframe568911941483/moatframe.js"></script>
    <script id="typef_orm" src="https://s3-eu-west-1.amazonaws.com/share.typeform.com/share.js"></script><script async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-NXDQK7S"></script><script async="" src="//www.google-analytics.com/analytics.js"></script><script type="text/javascript" async="" src="//siteimproveanalytics.com/js/siteanalyze_448530.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>
    
<meta http-equiv="Content-Security-Policy" content="default-src https: wss: http:; child-src 'self' http://s7.addthis.com https://s7.addthis.com http://www.youtube.com https://www.youtube.com http://stockportcouncil.typeform.com https://stockportcouncil.typeform.com http://www.google.com/maps/ https://www.google.com/maps/ http://www.opinionstage.com/polls/ https://www.opinionstage.com/polls/ http://www.google.com/recaptcha/api2/anchor https://www.google.com/recaptcha/api2/anchor http://www.google.com/recaptcha/api2/bframe https://www.google.com/recaptcha/api2/bframe http://player.vimeo.com/ https://player.vimeo.com/ http://stage.midas-pps.tractivity.co.uk/ https://stage.midas-pps.tractivity.co.uk/ *.cloudfront.net/butotv/live/ http://www.facebook.com/ https://www.facebook.com/ *.stockport.gov.uk *.smbcdigital.net http://stockportmaps.github.io https://stockportmaps.github.io; font-src 'self' http://font.googleapis.com https://font.googleapis.com http://maxcdn.bootstrapcdn.com/font-awesome/ https://maxcdn.bootstrapcdn.com/font-awesome/ http://fonts.gstatic.com/ https://fonts.gstatic.com/ http://static.tacdn.com https://static.tacdn.com; img-src 'self' http://khms0.googleapis.com https://khms0.googleapis.com http://khms1.googleapis.com https://khms1.googleapis.com http://geo0.ggpht.com https://geo0.ggpht.com http://geo1.ggpht.com https://geo1.ggpht.com http://geo2.ggpht.com https://geo2.ggpht.com http://geo3.ggpht.com https://geo3.ggpht.com http://cbks0.googleapis.com https://cbks0.googleapis.com http://csi.gstatic.com https://csi.gstatic.com http://maps.gstatic.com https://maps.gstatic.com http://maps.googleapis.com https://maps.googleapis.com http://images.contentful.com/ https://images.contentful.com/ http://images.ctfassets.net https://images.ctfassets.net http://www.google-analytics.com/r/collect https://www.google-analytics.com/r/collect http://www.google-analytics.com/collect https://www.google-analytics.com/collect http://stats.g.doubleclick.net/r/collect https://stats.g.doubleclick.net/r/collect http://s3-eu-west-1.amazonaws.com/ https://s3-eu-west-1.amazonaws.com/ http://maps.stockport.gov.uk/ https://maps.stockport.gov.uk/ http://interactive.stockport.gov.uk/ https://interactive.stockport.gov.uk/ http://ads.astuntechnology.com/ https://ads.astuntechnology.com/ http://s3-eu-west-1.amazonaws.com/ https://s3-eu-west-1.amazonaws.com/ http://share.typeform.com/ https://share.typeform.com/ http://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ http://customer.cludo.com/img/ https://customer.cludo.com/img/ http://uk1.siteimprove.com/ https://uk1.siteimprove.com/ http://stockportb.logo-net.co.uk/ https://stockportb.logo-net.co.uk/ http://cloudfront.net/butotv/ https://cloudfront.net/butotv/ data: http://www.tripadvisor.co.uk/ https://www.tripadvisor.co.uk/ http://syndication.twitter.com/i/ https://syndication.twitter.com/i/ http://platform.twitter.com/css/ https://platform.twitter.com/css/ http://pbs.twimg.com/ https://pbs.twimg.com/ http://1.bp.blogspot.com/-v6yARqgGaBc/WKL2ZtO9lhI/AAAAAAAAEDU/0CJfMgpdnWg0i6-Wd87E1vTtdKk4TeikQCLcB/s1600/Fake-or-Counterfeit-Bathmate-Pumps.png https://1.bp.blogspot.com/-v6yARqgGaBc/WKL2ZtO9lhI/AAAAAAAAEDU/0CJfMgpdnWg0i6-Wd87E1vTtdKk4TeikQCLcB/s1600/Fake-or-Counterfeit-Bathmate-Pumps.png http://content.govdelivery.com/attachments/fancy_images/UKSMBC/2018/01/1741761/reviewoverlay_original.png https://content.govdelivery.com/attachments/fancy_images/UKSMBC/2018/01/1741761/reviewoverlay_original.png http://app.meetami.ai https://app.meetami.ai *.cloudfront.net/butotv/live/ http://www.facebook.com/ https://www.facebook.com/ *.siteimproveanalytics.io/; style-src 'self' 'unsafe-inline' http://cludo.com/css/ https://cludo.com/css/ http://s3-eu-west-1.amazonaws.com/ https://s3-eu-west-1.amazonaws.com/ http://share.typeform.com/ https://share.typeform.com/ http://maxcdn.bootstrapcdn.com/font-awesome/ https://maxcdn.bootstrapcdn.com/font-awesome/ http://fonts.googleapis.com/ https://fonts.googleapis.com/ http://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ http://maps.stockport.gov.uk/ https://maps.stockport.gov.uk/ http://cloudfront.net/butotv/ https://cloudfront.net/butotv/ http://tripadvisor.com https://tripadvisor.com http://tripadvisor.co.uk https://tripadvisor.co.uk http://static.tacdn.com https://static.tacdn.com data: http://platform.twitter.com/css/ https://platform.twitter.com/css/ http://stockportb.logo-net.co.uk/Delivery/ https://stockportb.logo-net.co.uk/Delivery/ *.cloudfront.net/butotv/live/ http://tagmanager.google.com/ https://tagmanager.google.com/ http://wpcc.io/lib/1.0.2/cookieconsent.min.css https://wpcc.io/lib/1.0.2/cookieconsent.min.css; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://ajax.googleapis.com/ajax/libs/jquery/ https://ajax.googleapis.com/ajax/libs/jquery/ http://maps.googleapis.com https://maps.googleapis.com http://m.addthisedge.com/live/boost/ https://m.addthisedge.com/live/boost/ http://v1.addthisedge.com/live/boost/ https://v1.addthisedge.com/live/boost/ http://www.google-analytics.com/analytics.js https://www.google-analytics.com/analytics.js http://tagmanager.google.com/ https://tagmanager.google.com/ http://api.cludo.com/scripts/ https://api.cludo.com/scripts/ http://customer.cludo.com/scripts/ https://customer.cludo.com/scripts/ http://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/ http://s3-eu-west-1.amazonaws.com/ https://s3-eu-west-1.amazonaws.com/ http://s7.addthis.com/ https://s7.addthis.com/ http://stockportcouncil.typeform.com/ https://stockportcouncil.typeform.com/ http://maps.stockport.gov.uk/ https://maps.stockport.gov.uk/ http://share.typeform.com/ https://share.typeform.com/ http://js.buto.tv/video/ https://js.buto.tv/video/ http://s7.addthis.com/js/300/addthis_widget.js https://s7.addthis.com/js/300/addthis_widget.js http://m.addthis.com/live/ https://m.addthis.com/live/ http://siteimproveanalytics.com/js/ https://siteimproveanalytics.com/js/ http://logo-net.co.uk/Delivery/ https://logo-net.co.uk/Delivery/ http://www.opinionstage.com/assets/loader.js https://www.opinionstage.com/assets/loader.js http://www.google.com/recaptcha/api.js https://www.google.com/recaptcha/api.js http://www.gstatic.com/recaptcha/ https://www.gstatic.com/recaptcha/ http://www.googletagmanager.com/ https://www.googletagmanager.com/ http://d26b395fwzu5fz.cloudfront.net/keen-tracking-1.1.3.min.js https://d26b395fwzu5fz.cloudfront.net/keen-tracking-1.1.3.min.js http://www.jscache.com/ https://www.jscache.com/ http://tripadvisor.com https://tripadvisor.com http://tripadvisor.co.uk https://tripadvisor.co.uk http://static.tacdn.com https://static.tacdn.com http://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js http://platform.twitter.com/ https://platform.twitter.com/ http://cdn.syndication.twimg.com/timeline/ https://cdn.syndication.twimg.com/timeline/ http://platform.twitter.com/css/ https://platform.twitter.com/css/ http://local.tractivity.co.uk/wp-includes/js/ https://local.tractivity.co.uk/wp-includes/js/ http://stage.midas-pps.tractivity.co.uk/ https://stage.midas-pps.tractivity.co.uk/ http://content.govdelivery.com/overlay/js/4939.js https://content.govdelivery.com/overlay/js/4939.js http://core-api-eu1.cludo.com/ https://core-api-eu1.cludo.com/ http://app.meetami.ai/ https://app.meetami.ai/ wss://chat.meetami.ai/ wss://chat.meetami.ai/socket.io/ http://cdn.trackjs.com/releases/current/tracker.js https://cdn.trackjs.com/releases/current/tracker.js http://feed2js.org/feed2js.php https://feed2js.org/feed2js.php http://connect.facebook.net/ https://connect.facebook.net/ http://widget.wheredoivote.co.uk/ https://widget.wheredoivote.co.uk/ http://static.hotjar.com/ https://static.hotjar.com/ http://wpcc.io/lib/1.0.2/cookieconsent.min.js https://wpcc.io/lib/1.0.2/cookieconsent.min.js; connect-src 'self' http://api.cludo.com/ https://api.cludo.com/ http://buto-ping-middleman.buto.tv/ https://buto-ping-middleman.buto.tv/ http://m.addthis.com/live/ https://m.addthis.com/live/ http://kinesis-ping-middleman.buto.tv https://kinesis-ping-middleman.buto.tv http://kinesis.eu-west-1.amazonaws.com/ https://kinesis.eu-west-1.amazonaws.com/ http://zldiarvaya.execute-api.eu-west-1.amazonaws.com/prod/ https://zldiarvaya.execute-api.eu-west-1.amazonaws.com/prod/ http://13bg9nmobj.execute-api.eu-west-1.amazonaws.com/production/player-analytics https://13bg9nmobj.execute-api.eu-west-1.amazonaws.com/production/player-analytics http://core-api-eu1.cludo.com/ https://core-api-eu1.cludo.com/ http://event-collector.buto.tv/ https://event-collector.buto.tv/ http://app.meetami.ai/ https://app.meetami.ai/ http://chat.meetami.ai/ https://chat.meetami.ai/ wss://chat.meetami.ai/ wss://chat.meetami.ai/socket.io/ http://localhost/sitereplier/chats/enabled/ https://localhost/sitereplier/chats/enabled/ *.stockport.gov.uk *.smbcdigital.net; media-src 'self' http://www.youtube.com/ https://www.youtube.com/ *.cloudfront.net/butotv/live/ http://wpc.196c.planetstream.net/00196C/audio/ https://wpc.196c.planetstream.net/00196C/audio/ http://app.meetami.ai/ https://app.meetami.ai/ *.meetami.ai/; object-src 'self' http://www.youtube.com https://www.youtube.com http://www.youtube.com https://www.youtube.com; manifest-src 'self' http://localhost:5000/assets/images/ui-images/sg/manifest.json https://localhost:5000/assets/images/ui-images/sg/manifest.json; frame-ancestors 'self' *.stockport.gov.uk *.smbcdigital.net *.meetami.ai/ *.chat.meetami.ai/; ">

    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="google-site-verification" content="UywEWyL4CKWpN2dJwn34rQs6aUSmPHcIxQ1Rk44RLsM">
<meta name="msvalidate.01" content="8DA150C0F201E529E61F4D627DE9C4C0"> 
        <link rel="shortcut icon" type="image/png" href="/assets/images/ui-images/sg/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/ui-images/sg/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/assets/images/ui-images/sg/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/assets/images/ui-images/sg/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/assets/images/ui-images/sg/manifest.json">
    <link rel="mask-icon" href="/assets/images/ui-images/sg/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <title>Brownfield First - Stockport Council</title>
        <meta name="Description" content="Information about the brownfield land register,">
                <meta property="og:title" content="Brownfield First - Brownfield Land Register">
    <link href="/assets/stylesheets/cludo-search-default.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/stylesheets/vendor/unsemantic-grid-responsive-tablet-min.css">
    <link rel="stylesheet" href="/assets/stylesheets/styleguide-sg.min.css?v=m48U5K6JjL-MxzozQA9HC5U5WW8c5dDnrokMKiCIXJg">
    <link rel="stylesheet" href="/assets/stylesheets/site-sg.min.css?v=7lIw5w_YTQzcJE2fAFgUbBsUVg6MzHGgCYLxQVJXHQY">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" integrity="sha256-AIodEDkC8V/bHBkfyxzolUMw57jeQ9CauwhVW6YJ9CA= sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1 sha512-4uGZHpbDliNxiAv/QzZNo/yb2FtAX+qiDb7ypBWiEdJQX8Pugp8M6il5SRkN8jQrDLWsh3rrPDSXRf3DwFYM6g==" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/stylesheets/vendor/slick.min.css">
    <link rel="stylesheet" href="/assets/stylesheets/vendor/jquery-ui-1.12.1.custom/jquery-ui.min.css">
    <link rel="stylesheet" href="/lib/trumbowyg/trumbowyg.min.css">
    <link rel="alternate" type="application/rss+xml" href="/news/rss" title="Stockport Council News Feed">
    <link rel="alternate" type="application/rss+xml" href="/events/rss" title="Stockport Council Events Feed">

    <link rel="stylesheet" type="text/css" href="//wpcc.io/lib/1.0.2/cookieconsent.min.css">
<script src="//wpcc.io/lib/1.0.2/cookieconsent.min.js"></script>
<script>
  window.addEventListener("load", function() {
    window.wpcc.init({
      border: "thin",
      corners: "small",
      colors: {
        popup: { background: "#285e61", text: "#ffffff", border: "#234e52" },
        button: { background: "#ffffff", text: "#234e52" }
      },
      content: {
        message: "This website uses cookies to make sure you get the best experience on our website.",
        href: "https://www.stockport.gov.uk/cookies",
        button:"Accept cookies"
      }
    });
  });
</script>

    
<script>
    dataLayer = [{
        'AnalyticsTrackingCode': 'UA-1880211-1'
    }];
</script>
    
<script type="text/javascript">
    /*<![CDATA[*/
    (function () {
        var sz = document.createElement('script'); sz.type = 'text/javascript'; sz.async = true;
        sz.src = '//siteimproveanalytics.com/js/siteanalyze_448530.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sz, s);
    })();
    /*]]>*/
</script>

<script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date(); a = s.createElement(o),
                m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-1880211-1', 'auto');
        ga('send', 'pageview');
</script>

<!-- Google Tag Manager -->
<script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-NXDQK7S');
</script>
<!-- End Google Tag Manager -->

    <script type="text/javascript" src="/assets/javascript/vendor/require.2.3.4.min.js"></script>
        <script type="text/javascript" src="/assets/javascript/requireConfig.js"></script>
<script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="cludo" src="//customer.cludo.com/scripts/bundles/search-script.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="cludoconfig" src="/assets/javascript/stockportgov/cludo.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="startup" src="/assets/javascript/stockportgov/startup.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="carousel" src="/assets/javascript/stockportgov/carousel.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="matchHeight" src="/lib/matchHeight/dist/jquery.matchHeight-min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="matchboxconfig" src="/assets/javascript/stockportgov/matchbox.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="slick" src="/assets/javascript/vendor/slick.js"></script><style type="text/css">.at-icon{fill:#fff;border:0}.at-icon-wrapper{display:inline-block;overflow:hidden}a .at-icon-wrapper{cursor:pointer}.at-rounded,.at-rounded-element .at-icon-wrapper{border-radius:12%}.at-circular,.at-circular-element .at-icon-wrapper{border-radius:50%}.addthis_32x32_style .at-icon{width:2pc;height:2pc}.addthis_24x24_style .at-icon{width:24px;height:24px}.addthis_20x20_style .at-icon{width:20px;height:20px}.addthis_16x16_style .at-icon{width:1pc;height:1pc}#at16lb{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:1001;background-color:#000;opacity:.001}#at_complete,#at_error,#at_share,#at_success{position:static!important}.at15dn{display:none}#at15s,#at16p,#at16p form input,#at16p label,#at16p textarea,#at_share .at_item{font-family:arial,helvetica,tahoma,verdana,sans-serif!important;font-size:9pt!important;outline-style:none;outline-width:0;line-height:1em}* html #at15s.mmborder{position:absolute!important}#at15s.mmborder{position:fixed!important;width:250px!important}#at15s{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABtJREFUeNpiZGBgaGAgAjAxEAlGFVJHIUCAAQDcngCUgqGMqwAAAABJRU5ErkJggg==);float:none;line-height:1em;margin:0;overflow:visible;padding:5px;text-align:left;position:absolute}#at15s a,#at15s span{outline:0;direction:ltr;text-transform:none}#at15s .at-label{margin-left:5px}#at15s .at-icon-wrapper{width:1pc;height:1pc;vertical-align:middle}#at15s .at-icon{width:1pc;height:1pc}.at4-icon{display:inline-block;background-repeat:no-repeat;background-position:top left;margin:0;overflow:hidden;cursor:pointer}.addthis_16x16_style .at4-icon,.addthis_default_style .at4-icon,.at4-icon,.at-16x16{width:1pc;height:1pc;line-height:1pc;background-size:1pc!important}.addthis_32x32_style .at4-icon,.at-32x32{width:2pc;height:2pc;line-height:2pc;background-size:2pc!important}.addthis_24x24_style .at4-icon,.at-24x24{width:24px;height:24px;line-height:24px;background-size:24px!important}.addthis_20x20_style .at4-icon,.at-20x20{width:20px;height:20px;line-height:20px;background-size:20px!important}.at4-icon.circular,.circular .at4-icon,.circular.aticon{border-radius:50%}.at4-icon.rounded,.rounded .at4-icon{border-radius:4px}.at4-icon-left{float:left}#at15s .at4-icon{text-indent:20px;padding:0;overflow:visible;white-space:nowrap;background-size:1pc;width:1pc;height:1pc;background-position:top left;display:inline-block;line-height:1pc}.addthis_vertical_style .at4-icon,.at4-follow-container .at4-icon{margin-right:5px}html>body #at15s{width:250px!important}#at15s.atm{background:none!important;padding:0!important;width:10pc!important}#at15s_inner{background:#fff;border:1px solid #fff;margin:0}#at15s_head{position:relative;background:#f2f2f2;padding:4px;cursor:default;border-bottom:1px solid #e5e5e5}.at15s_head_success{background:#cafd99!important;border-bottom:1px solid #a9d582!important}.at15s_head_success a,.at15s_head_success span{color:#000!important;text-decoration:none}#at15s_brand,#at15sptx,#at16_brand{position:absolute}#at15s_brand{top:4px;right:4px}.at15s_brandx{right:20px!important}a#at15sptx{top:4px;right:4px;text-decoration:none;color:#4c4c4c;font-weight:700}#at15sptx:hover{text-decoration:underline}#at16_brand{top:5px;right:30px;cursor:default}#at_hover{padding:4px}#at_hover .at_item,#at_share .at_item{background:#fff!important;float:left!important;color:#4c4c4c!important}#at_share .at_item .at-icon-wrapper{margin-right:5px}#at_hover .at_bold{font-weight:700;color:#000!important}#at_hover .at_item{width:7pc!important;padding:2px 3px!important;margin:1px;text-decoration:none!important}#at_hover .at_item.athov,#at_hover .at_item:focus,#at_hover .at_item:hover{margin:0!important}#at_hover .at_item.athov,#at_hover .at_item:focus,#at_hover .at_item:hover,#at_share .at_item.athov,#at_share .at_item:hover{background:#f2f2f2!important;border:1px solid #e5e5e5;color:#000!important;text-decoration:none}.ipad #at_hover .at_item:focus{background:#fff!important;border:1px solid #fff}.at15t{display:block!important;height:1pc!important;line-height:1pc!important;padding-left:20px!important;background-position:0 0;text-align:left}.addthis_button,.at15t{cursor:pointer}.addthis_toolbox a.at300b,.addthis_toolbox a.at300m{width:auto}.addthis_toolbox a{margin-bottom:5px;line-height:initial}.addthis_toolbox.addthis_vertical_style{width:200px}.addthis_button_facebook_like .fb_iframe_widget{line-height:100%}.addthis_button_facebook_like iframe.fb_iframe_widget_lift{max-width:none}.addthis_toolbox a.addthis_button_counter,.addthis_toolbox a.addthis_button_facebook_like,.addthis_toolbox a.addthis_button_facebook_send,.addthis_toolbox a.addthis_button_facebook_share,.addthis_toolbox a.addthis_button_foursquare,.addthis_toolbox a.addthis_button_linkedin_counter,.addthis_toolbox a.addthis_button_pinterest_pinit,.addthis_toolbox a.addthis_button_tweet{display:inline-block}.addthis_toolbox span.addthis_follow_label{display:none}.addthis_toolbox.addthis_vertical_style span.addthis_follow_label{display:block;white-space:nowrap}.addthis_toolbox.addthis_vertical_style a{display:block}.addthis_toolbox.addthis_vertical_style.addthis_32x32_style a{line-height:2pc;height:2pc}.addthis_toolbox.addthis_vertical_style .at300bs{margin-right:4px;float:left}.addthis_toolbox.addthis_20x20_style span{line-height:20px}.addthis_toolbox.addthis_32x32_style span{line-height:2pc}.addthis_toolbox.addthis_pill_combo_style .addthis_button_compact .at15t_compact,.addthis_toolbox.addthis_pill_combo_style a{float:left}.addthis_toolbox.addthis_pill_combo_style a.addthis_button_tweet{margin-top:-2px}.addthis_toolbox.addthis_pill_combo_style .addthis_button_compact .at15t_compact{margin-right:4px}.addthis_default_style .addthis_separator{margin:0 5px;display:inline}div.atclear{clear:both}.addthis_default_style .addthis_separator,.addthis_default_style .at4-icon,.addthis_default_style .at300b,.addthis_default_style .at300bo,.addthis_default_style .at300bs,.addthis_default_style .at300m{float:left}.at300b img,.at300bo img{border:0}a.at300b .at4-icon,a.at300m .at4-icon{display:block}.addthis_default_style .at300b,.addthis_default_style .at300bo,.addthis_default_style .at300m{padding:0 2px}.at300b,.at300bo,.at300bs,.at300m{cursor:pointer}.addthis_button_facebook_like.at300b:hover,.addthis_button_facebook_like.at300bs:hover,.addthis_button_facebook_send.at300b:hover,.addthis_button_facebook_send.at300bs:hover{opacity:1}.addthis_20x20_style .at15t,.addthis_20x20_style .at300bs{overflow:hidden;display:block;height:20px!important;width:20px!important;line-height:20px!important}.addthis_32x32_style .at15t,.addthis_32x32_style .at300bs{overflow:hidden;display:block;height:2pc!important;width:2pc!important;line-height:2pc!important}.at300bs{overflow:hidden;display:block;background-position:0 0;height:1pc;width:1pc;line-height:1pc!important}.addthis_default_style .at15t_compact,.addthis_default_style .at15t_expanded{margin-right:4px}#at_share .at_item{width:123px!important;padding:4px;margin-right:2px;border:1px solid #fff}#at16p{background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABtJREFUeNpiZGBgaGAgAjAxEAlGFVJHIUCAAQDcngCUgqGMqwAAAABJRU5ErkJggg==);z-index:10000001;position:absolute;top:50%;left:50%;width:300px;padding:10px;margin:0 auto;margin-top:-185px;margin-left:-155px;font-family:arial,helvetica,tahoma,verdana,sans-serif;font-size:9pt;color:#5e5e5e}#at_share{margin:0;padding:0}#at16pt{position:relative;background:#f2f2f2;height:13px;padding:5px 10px}#at16pt a,#at16pt h4{font-weight:700}#at16pt h4{display:inline;margin:0;padding:0;font-size:9pt;color:#4c4c4c;cursor:default}#at16pt a{position:absolute;top:5px;right:10px;color:#4c4c4c;text-decoration:none;padding:2px}#at15sptx:focus,#at16pt a:focus{outline:thin dotted}#at15s #at16pf a{top:1px}#_atssh{width:1px!important;height:1px!important;border:0!important}.atm{width:10pc!important;padding:0;margin:0;line-height:9pt;letter-spacing:normal;font-family:arial,helvetica,tahoma,verdana,sans-serif;font-size:9pt;color:#444;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABtJREFUeNpiZGBgaGAgAjAxEAlGFVJHIUCAAQDcngCUgqGMqwAAAABJRU5ErkJggg==);padding:4px}.atm-f{text-align:right;border-top:1px solid #ddd;padding:5px 8px}.atm-i{background:#fff;border:1px solid #d5d6d6;padding:0;margin:0;box-shadow:1px 1px 5px rgba(0,0,0,.15)}.atm-s{margin:0!important;padding:0!important}.atm-s a:focus{border:transparent;outline:0;transition:none}#at_hover.atm-s a,.atm-s a{display:block;text-decoration:none;padding:4px 10px;color:#235dab!important;font-weight:400;font-style:normal;transition:none}#at_hover.atm-s .at_bold{color:#235dab!important}#at_hover.atm-s a:hover,.atm-s a:hover{background:#2095f0;text-decoration:none;color:#fff!important}#at_hover.atm-s .at_bold{font-weight:700}#at_hover.atm-s a:hover .at_bold{color:#fff!important}.atm-s a .at-label{vertical-align:middle;margin-left:5px;direction:ltr}.at_PinItButton{display:block;width:40px;height:20px;padding:0;margin:0;background-image:url(//s7.addthis.com/static/t00/pinit00.png);background-repeat:no-repeat}.at_PinItButton:hover{background-position:0 -20px}.addthis_toolbox .addthis_button_pinterest_pinit{position:relative}.at-share-tbx-element .fb_iframe_widget span{vertical-align:baseline!important}#at16pf{height:auto;text-align:right;padding:4px 8px}.at-privacy-info{position:absolute;left:7px;bottom:7px;cursor:pointer;text-decoration:none;font-family:helvetica,arial,sans-serif;font-size:10px;line-height:9pt;letter-spacing:.2px;color:#666}.at-privacy-info:hover{color:#000}.body .wsb-social-share .wsb-social-share-button-vert{padding-top:0;padding-bottom:0}.body .wsb-social-share.addthis_counter_style .addthis_button_tweet.wsb-social-share-button{padding-top:40px}.body .wsb-social-share.addthis_counter_style .addthis_button_facebook_like.wsb-social-share-button{padding-top:21px}@media print{#at4-follow,#at4-share,#at4-thankyou,#at4-whatsnext,#at4m-mobile,#at15s,.at4,.at4-recommended{display:none!important}}@media screen and (max-width:400px){.at4win{width:100%}}@media screen and (max-height:700px) and (max-width:400px){.at4-thankyou-inner .at4-recommended-container{height:122px;overflow:hidden}.at4-thankyou-inner .at4-recommended .at4-recommended-item:first-child{border-bottom:1px solid #c5c5c5}}</style><style type="text/css">.at-branding-logo{font-family:helvetica,arial,sans-serif;text-decoration:none;font-size:10px;display:inline-block;margin:2px 0;letter-spacing:.2px}.at-branding-logo .at-branding-icon{background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAMAAAC67D+PAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRF////+GlNUkcc1QAAAB1JREFUeNpiYIQDBjQmAwMmkwEM0JnY1WIxFyDAABGeAFEudiZsAAAAAElFTkSuQmCC")}.at-branding-logo .at-branding-icon,.at-branding-logo .at-privacy-icon{display:inline-block;height:10px;width:10px;margin-left:4px;margin-right:3px;margin-bottom:-1px;background-repeat:no-repeat}.at-branding-logo .at-privacy-icon{background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAKCAMAAABR24SMAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABhQTFRF8fr9ot/xXcfn2/P5AKva////////AKTWodjhjAAAAAd0Uk5T////////ABpLA0YAAAA6SURBVHjaJMzBDQAwCAJAQaj7b9xifV0kUKJ9ciWxlzWEWI5gMF65KUTv0VKkjVeTerqE/x7+9BVgAEXbAWI8QDcfAAAAAElFTkSuQmCC")}.at-branding-logo span{text-decoration:none}.at-branding-logo .at-branding-addthis,.at-branding-logo .at-branding-powered-by{color:#666}.at-branding-logo .at-branding-addthis:hover{color:#333}.at-cv-with-image .at-branding-addthis,.at-cv-with-image .at-branding-addthis:hover{color:#fff}a.at-branding-logo:visited{color:initial}.at-branding-info{display:inline-block;padding:0 5px;color:#666;border:1px solid #666;border-radius:50%;font-size:10px;line-height:9pt;opacity:.7;transition:all .3s ease;text-decoration:none}.at-branding-info span{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.at-branding-info:before{content:'i';font-family:Times New Roman}.at-branding-info:hover{color:#0780df;border-color:#0780df}</style><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="clipboard" src="//cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jquery" src="/assets/javascript/vendor/jquery.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="multiselect" src="/assets/javascript/stockportgov/multiSelect.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="utils" src="/assets/javascript/stockportgov/utils.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="validate" src="/assets/javascript/vendor/jquery.validate.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jquery-ui" src="/assets/javascript/../stylesheets/vendor/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="jquery.cookie" src="/assets/javascript/vendor/jquery.cookie.js"></script><style type="text/css">                .cludo-search-modal-body a, .cludo-search-modal-header a{                    color: #055c58;                }                #cludo-search-form-content input[type="search"] {                    border-top: 1px solid #055c58;                    border-bottom: 1px solid #055c58;                }                #cludo-search-form .search_autocomplete li:hover, .cludo-search-form .search_autocomplete li:hover,#cludo-search-form-content .search_autocomplete li:hover, #cludo-search-form .search_autocomplete li.active, .cludo-search-form .search_autocomplete li.active, #cludo-search-form-content .search_autocomplete li.active, .cludo-search_autocomplete .search_autocomplete li.active, .cludo-search_autocomplete .search_autocomplete li:hover {                    background-color: #055c58;                }                #cludo-search-results .cludo-search-modal-header .search-filters .search-filters-mobile-button.open {                    background-color: #055c58;                }                #cludo-search-results .search-filters ul a.active {                    background-color: #055c58;                }                #cludo-search-results .cludo-search-modal-body .search-did-you-mean b {                    color: #055c58;                }                #cludo-search-results .cludo-search-modal-body #cludo-load-more {                    background-color: #055c58;                }                #cludo-search-results .cludo-search-modal-body #cludo-load-more:hover {                    background-color: #044946;                }            #cludo-search-results a:focus, #cludo-search-results button:focus, #cludo-search-form button:focus, #cludo-search-form input:focus, #cludo-search-form-content button:focus, #cludo-search-form-content input:focus {                border-color: #055c58 !important;            }                #cludo-search-results .cludo-search-modal-body .cludo-banner {                    background-color: #055c58;                }                #cludo-search-results .cludo-search-modal-body .cludo-banner * {                    color: #ffffff !important;                }                .cludo-search-modal-header {                    border-radius: 10px 10px 0 0;                }                .cludo-search-modal-body {                    border-radius: 0 0 10px 10px;                }                #cludo-search-results .search-filters ul {                    border-radius: 10px;                }                #cludo-search-results .search-filters ul li:first-child a{                    border-radius: 10px 10px 0 0;                }                #cludo-search-results .search-filters ul li:last-child a{                    border-radius: 0 0 10px 10px;                }                .search-results-item__inner__image img {                    border-radius: 7px                }</style><script async="" src="https://script.hotjar.com/modules.297b225e0b92ebb96f25.js" charset="utf-8"></script><style type="text/css">iframe#_hjRemoteVarsFrame {display: none !important; width: 1px !important; height: 1px !important; opacity: 0 !important; pointer-events: none !important;}</style><style data-emotion=""></style><script src="https://app.meetami.ai/chats/cc/168019131601" type="text/javascript"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js" src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="//app.meetami.ai/js/jq-ui.js" src="//app.meetami.ai/js/jq-ui.js"></script><style></style><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="//app.meetami.ai/js/jquery.touchpunch.min.js" src="//app.meetami.ai/js/jquery.touchpunch.min.js"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="//app.meetami.ai/chats/scripts" src="//app.meetami.ai/chats/scripts"></script><script type="text/javascript" charset="utf-8" async="" data-requirecontext="_" data-requiremodule="//app.meetami.ai/js/socket-io.js" src="//app.meetami.ai/js/socket-io.js"></script></head>
<body class="container-layout-free type-article" bgcolor="white"><div class="wpcc-container wpcc-float wpcc-corners-round wpcc-corners-small wpcc-border-thin wpcc-bottom wpcc-left wpcc-color-custom-1964970280 " style=""><span class="wpcc-message">This website uses cookies to make sure you get the best experience on our website. <a class="wpcc-privacy" href="https://www.stockport.gov.uk/cookies" rel="noopener" target="_blank" tabindex="1">Learn more</a></span><div class="wpcc-compliance"><a class="wpcc-btn" tabindex="2">Accept cookies</a></div></div>

    <!-- Google Tag Manager (noscript) -->
<noscript aria-hidden="true">
    &lt;iframe src="https://www.googletagmanager.com/ns.html?id=+GTM-NXDQK7S" height="0" width="0" style="display:none;visibility:hidden"&gt;&lt;/iframe&gt;
</noscript>
<!-- End Google Tag Manager (noscript) -->
    

<script>(function () { var qs, js, q, s, d = document, gi = d.getElementById, ce = d.createElement, gt = d.getElementsByTagName, id = 'typef_orm', b = 'https://s3-eu-west-1.amazonaws.com/share.typeform.com/'; if (!gi.call(d, id)) { js = ce.call(d, 'script'); js.id = id; js.src = b + 'share.js'; q = gt.call(d, 'script')[0]; q.parentNode.insertBefore(js, q) } })()</script>

<div class="l-header-container">
    <nav aria-label="Skip to main content">
    <div class="skip-to-main-content">
        <a href="#content" class="skip-main">Skip to main content</a>
    </div>
    </nav>
    <header role="banner" id="header" class="grid-container grid-100">
        <div class="grid-50 mobile-grid-50 tablet-grid-50 logo-main">
            <a href="https://www.stockport.gov.uk"><img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/logo-stockport-full%402x.png" data-mobile-image="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/logo-stockport-mobile%402x.png" data-desktop-image="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/logo-stockport-full%402x.png" alt="Stockport Council Logo Homepage Link" title="Welcome to Stockport Council" class="logo-main-image"></a>
        </div>
        <div class="grid-50 mobile-grid-50 tablet-grid-50 grid-parent">
            <div class="header-container grid-100 grid-parent">
                <div class="grid-50 grid-parent header-myaccount">
                    <div class="menu">
                            <div class="menu-logged-out pull-right">
                                <a href="https://myaccount.stockport.gov.uk/" aria-label="Go to My Account"><span class="fa fa-user hide-on-mobile" aria-hidden="true"></span>My Account</a>
                            </div>
                    </div>
                </div>
                <div class="grid-50 grid-parent pull-right header-search-bar">
                    <div class="search-bar-header-container hide-on-mobile hide-on-tablet">
    <div class="search-bar-header">
        

<form aria-label="search website" action="" method="get" role="search" id="cludo-search-form" class="cludo-search_autocomplete">
    <label class="visuallyhidden" for="search-bar">
        search input box  
    </label>
    <input class="grid-100 tablet-grid-100 mobile-grid-100 search-input" id="search-bar" type="text" name="query" placeholder="Search" autocomplete="off">
    <button value="Submit search button" class="search-button" type="submit"><span class="fa fa-search" aria-hidden="true"></span><span class="visuallyhidden"> Submit Search button</span></button>

</form>
    </div>
</div>
<a href="#" class="show-search-button hide-on-desktop"><span class="visuallyhidden"> submit search</span>
    <span class="fa fa-search" aria-hidden="true"></span>
</a>

                </div>
            </div>
        </div>
    </header>
</div>
<div id="mobileSearchInput" class="grid-100 mobile-search-input search-bar-mobile-header-container" style="display: none;">
    <div class="search-bar-mobile-header">
        

<form aria-label="mobile search" action="" method="get" role="search" id="cludo-search-mobile-form" class="cludo-search_autocomplete">
    <label class="visuallyhidden" for="mobile-search-bar">
        search input box  
    </label>
    <input class="grid-100 tablet-grid-100 mobile-grid-100 search-input" id="mobile-search-bar" type="text" name="query" placeholder="Hi there! What are you looking for?" autocomplete="off">
    <button value="Submit search button" class="search-button" type="submit"><span class="fa fa-search" aria-hidden="true"></span><span class="visuallyhidden"> Submit Search button</span></button>

</form>
    </div>
</div>
<div class="banner-header-container">
    <div class="grid-container grid-100">

    </div>
</div>
<noscript role="contentinfo" aria-label="Javascript disabled information">
    &lt;div class="banner-header-container banner-header-warning-unsupported"&gt;
        &lt;div class="grid-container grid-100"&gt;
            &lt;div class="banner-header grid-100 mobile-grid-100 tablet-grid-100"&gt;
                &lt;p&gt;&lt;span class="banner-title"&gt;JavaScript off&lt;/span&gt;&lt;span class="banner-body"&gt;To get the best experience on this website please use a browser with JavaScript enabled.&lt;/span&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
</noscript>

<div id="browser-check" role="contentinfo" aria-label="Outdated browser" class="banner-header-container banner-header-warning-unsupported hidden">
    <div class="grid-container grid-100">
        <div class="banner-header grid-100 mobile-grid-100 tablet-grid-100">
            <p><span class="banner-title">Outdated browser</span><span class="banner-body">You are currently using an old browser. To get the best experience on this website please <a href="http://browsehappy.com/" title="Learn about the latest browsers">update your browser</a></span></p>
        </div>
    </div>
</div>

<!--[if lte IE 8]>
    <div class="banner-header-container banner-header-warning-unsupported">
        <div class="grid-container grid-100">
            <div class="banner-header grid-100 mobile-grid-100 tablet-grid-100">
                <p><span class="banner-title">Outdated browser</span><span class="banner-body">You are currently using an old browser. To get the best experience on this website please <a href="http://browsehappy.com/" title="Learn about the latest browsers">update your browser</a></span></p>
            </div>
        </div>
    </div>
<![endif]-->

<script type="text/javascript">
    require(['cludo'], function () { });
    require(['cludoconfig'],
        function (cludoconfig) {
            cludoconfig.Init();
        })
</script>

    
    <nav aria-label="Breadcrumb">
    <div class="breadcrumb-container">
        <div class="grid-container grid-100">
            <ul class="breadcrumb">
                <li><a href="/">Home</a></li>

                        <li class="chevron">›</li>
                        <li><a href="/topic/planning-and-building">Planning and building regulations</a></li>

                <li class="chevron">›</li>
                <li class="current"><span>Brownfield First</span></li>
            </ul>
        </div>
    </div>
</nav>

    <main>
        

<div class="grid-container-full-width">
    <div class="grid-container grid-100 article-cols">
        <div tabindex="-1" id="content"></div>
        <article id="uitest-page-has-loaded" class="article-col l-body-section-filled grid-parent mobile-grid-100 tablet-grid-100 grid-70">
            <section aria-label="Brownfield First content" class="grid-100 mobile-grid-100 ">
                <div class="l-content-container">
                    <div class="grid-100">
                            <div class="grid-100">
                                <h1>Brownfield First</h1>
                            </div>
                                                        <div class="alert-container">
                                </div>

                        



                        <div class="grid-100">


                                

<header class="article-navigation-header">    
    <nav class="l-vertical-list-no-margin article-navigation split-article-into-columns">
        <h2 class="visuallyhidden">Article navigation</h2>
        <ul>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">1.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/brownfield-overview">Overview</a>
                </li>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">2.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/about-brownfield-sites">About brownfield sites</a>
                </li>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">3.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/brownfield-gmsf">Brownfield and Greater Manchester Spatial Framework</a>
                </li>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">4.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/brownfield-sites">Brownfield sites </a>
                </li>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">5.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/register-a-brownfield-site">Register a brownfield site</a>
                </li>
                <li class="nav-active grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">6.</div>
                        <span class="grid-90 tablet-grid-90 mobile-grid-90">Brownfield Land Register</span>
                </li>
                <li class=" grid-100 tablet-grid-100 mobile-grid-100">
                    <div class="grid-10 tablet-grid-10 mobile-grid-10">7.</div>
                        <a class="grid-90 tablet-grid-90 mobile-grid-90" href="/brownfield/stockport-ldp-alerts">Sign up to Stockport Local Plan  alerts</a>
                </li>
        </ul>
    </nav> 
</header>



                                
<article class="clearfix">
    <h2 id="brownfield-land-register">6. Brownfield Land Register</h2>
    <p>The government requires each local planning authority in England to prepare, maintain and publish a register of previously developed (brownfield) land suitable for housing. They consider that the purpose of the register is to provide up to date and consistent information on sites that local authorities consider appropriate for residential development.</p>
<p>In order for sites to be included in the register, they must meet the following criteria:</p>
<ul>
<li>the site must be classified as 'previously developed land', as defined by the glossary to the National Planning Policy Framework (NPPF)</li>
<li>the site should be at least 0.25 hectares in size or capable of supporting at least 5 dwellings</li>
<li>the land is suitable for residential development</li>
<li>the land is available for residential development</li>
<li>residential development of the land is achievable within 15 years</li>
</ul>
<p>We have published our <a href="https://data.gov.uk/dataset/stockport-brownfield-land-register">brownfield land register</a> and it identifies land with the potential to accommodate net additional dwellings across the borough. The government requires that the register is published as a CSV file. The brownfield land register was last updated on 18 December 2019.</p>
<p>Stockport’s Brownfield Land Register is licensed under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government Licence 3.0</a>.</p>
<p><iframe class="mapframe" src="/map?layers=brownfield&amp;source=SMBC/brownfields&amp;panels=FindAddress,Null"></iframe></p>

</article>
                                
<div class="article-pagination grid-100">
    <div class="pagination-previous grid-50 tablet-grid-50">
            <a href="/brownfield/register-a-brownfield-site">
                <div class="article-chevron l-left-align">
                    <i class="fa fa-angle-left fa-3x" aria-hidden="true"></i>
                </div>
                    <p>Previous Page</p>
                    <p>Register a brownfield site</p>
            </a>
    </div>
    <div class="pagination-next grid-50 tablet-grid-50">
            <a href="/brownfield/stockport-ldp-alerts">
                    <p>Next Page</p>
                    <p>Sign up to Stockport Local Plan  alerts</p>
                <div class="article-chevron l-right-align">
                    <i class="fa fa-angle-right fa-3x" aria-hidden="true"></i>
                </div>
            </a>
    </div>
</div>
                        </div>
                    </div>
                </div>
            </section>
        </article>
                <div class="l-right-side-bar grid-30 tablet-grid-100 mobile-grid-100 grid-parent article-col article-col-sidebar">
                        <div class="l-right-side-bar-section">
                            <h2>Planning and building regulations</h2>
                            <ul>
                                                                    <li class="">
                                        <a href="/topic/planning"><span>Planning</span></a>
                                    </li>
                                    <li class="">
                                        <a href="/topic/building-regulations"><span>Building regulations</span></a>
                                    </li>
                                    <li class="">
                                        <a href="/topic/planning-policy"><span>Planning policy</span></a>
                                    </li>
                                    <li class="">
                                        <a href="/topic/conservation-and-heritage"><span>Conservation and heritage</span></a>
                                    </li>
                                    <li class="active">
                                        <a href="/brownfield"><span>Brownfield First</span></a>
                                    </li>
                                    <li class="">
                                        <a href="/self-build-and-custom-build-housing-register"><span>Self-build and custom build housing register</span></a>
                                    </li>

                            </ul>
                        </div>
                </div>
    </div>
</div>

<script type="text/javascript">
    require(['startup', 'carousel', 'matchHeight', 'matchboxconfig', 'slick'],
        function (startup, carousel, matchHeight, matchboxconfig, slick) {
            startup.Init();
            matchboxconfig.Init();
            carousel.Init();
        })
</script>
        <div class="hidden" id="envname">prod</div>
    </main>
    
        <script>(function () { var qs, js, q, s, d = document, gi = d.getElementById, ce = d.createElement, gt = d.getElementsByTagName, id = 'typef_orm', b = 'https://s3-eu-west-1.amazonaws.com/share.typeform.com/'; if (!gi.call(d, id)) { js = ce.call(d, 'script'); js.id = id; js.src = b + 'share.js'; q = gt.call(d, 'script')[0]; q.parentNode.insertBefore(js, q) } })()</script>
<footer>
        <div class="atoz">
    <h2> Find services A-Z </h2>
    <div class="alphabet">
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/a" aria-label="Find services A to Z A service">A</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/b" aria-label="B service">B</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/c" aria-label="C service">C</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/d" aria-label="D service">D</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/e" aria-label="E service">E</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/f" aria-label="F service">F</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/g" aria-label="G service">G</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/h" aria-label="H service">H</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/i" aria-label="I service">I</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/j" aria-label="J service">J</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/k" aria-label="K service">K</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/l" aria-label="L service">L</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/m" aria-label="M service">M</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/n" aria-label="N service">N</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/o" aria-label="O service">O</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/p" aria-label="P service">P</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/q" aria-label="Q service">Q</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/r" aria-label="R service">R</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/s" aria-label="S service">S</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/t" aria-label="T service">T</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/u" aria-label="U service">U</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/v" aria-label="V service">V</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/w" aria-label="W service">W</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/x" aria-label="X service">X</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/y" aria-label="Y service">Y</a>
            </div>
            <div class="letter ">
                    <a class="letter-bordered" href="/atoz/z" aria-label="Z service">Z</a>
            </div>
    </div>
</div>
    <div class="l-container-footer grid-container">
        <div class="grid-container grid-parent">
            <div class="grid-100 grid-parent">
                <div class="grid-30 tablet-grid-35 tablet-push-65 push-65 footer-social-container">
                        
<div class="footer-social-links">

            <a href="https://twitter.com/StockportMBC">
            <span class="visuallyhidden">link to stockport council @StockportMBC </span>
            <div class="icon-bordered icon-bordered-fixed icon-container icon-twitter icon-twitter">
                <span class="fa fa-2x fa-twitter" aria-hidden="true"></span>
            </div>
        </a>
        <a href="https://www.facebook.com/StockportMBC">
            <span class="visuallyhidden">link to stockport council Facebook </span>
            <div class="icon-bordered icon-bordered-fixed icon-container icon-twitter icon-facebook">
                <span class="fa fa-2x fa-facebook" aria-hidden="true"></span>
            </div>
        </a>
        <a href="https://www.youtube.com/user/StockportCouncil">
            <span class="visuallyhidden">link to stockport council Youtube </span>
            <div class="icon-bordered icon-bordered-fixed icon-container icon-twitter icon-youtube">
                <span class="fa fa-2x fa-youtube" aria-hidden="true"></span>
            </div>
        </a>
        <a href="https://www.instagram.com/stockportcouncil/">
            <span class="visuallyhidden">link to stockport council Instagram </span>
            <div class="icon-bordered icon-bordered-fixed icon-container icon-twitter icon-instagram">
                <span class="fa fa-2x fa-instagram" aria-hidden="true"></span>
            </div>
        </a>
</div>
                </div>
                <div class="grid-25 tablet-grid-25 tablet-pull-35 pull-30 mobile-grid-100">
                    <div class="footer-stockport-logo">
                            <a href="https://www.stockport.gov.uk"><img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/logo-stockport-footer%402x.png" alt="Stockport Council Logo Homepage Link"></a>
                    </div>
                </div>
                <div class="footer-links tablet-grid-40 pull-30 tablet-pull-35 grid-45 grid-100-mobile">
                    <div class="grid-100 tablet-grid-100 mobile-grid-100">
                        <ul class="footer-nav">
                                
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/topic/about-our-website">About our website</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/accessibility-statement">Accessibility statement</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/contact">Contact us</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/how-to-find-us">How to find us</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/topic/data-protection">Data protection</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/terms-and-conditions">Terms and conditions</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/freedom-of-information">Freedom of Information</a>
</li>
<li class="grid-50 tablet-grid-50 mobile-grid-100">
    <a href="/website-feedback">Website feedback</a>
</li>

                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div class="grid-parent grid-container footer-logo-links">
    <a href="https://www.gov.uk/" target="_blank" class="grid-20">
        <img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/gov-uk-logo.png" alt="GOV UK">
    </a>
    <a href="https://www.greatermanchester-ca.gov.uk/" target="_blank" class="grid-20">
        <img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/GMCA-logo.png" alt="Greater Manchester Combined Authority">
    </a>
    <a href="https://www.digitalstockport.info/digital-transformation-award/" target="_blank" class="grid-20">
        <img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/mj-logo.png" alt="The MJ Achievement Awards 2019">
    </a>
    <a href="https://idea.org.uk/" target="_blank" class="grid-20">
        <img src="https://s3-eu-west-1.amazonaws.com/live-iag-static-assets/Pioneer-logo.png" alt="Pioneer">
    </a>

</div>
    <div class="footer-bottom">
        <div class="grid-container ">
            <div class="grid-50 tablet-grid-50 copyright">
                <p id="ami-trigger">
© 2019 Stockport Metropolitan Borough Council                </p>
            </div>
            <div class="grid-50 tablet-grid-50 digital-link">
                <p>
                    <a href="http://digitalstockport.info">Built by the Digital Team in Stockport</a>
                </p>
            </div>
        </div>
    </div>
</footer>
    

    <script src="/assets/javascript/vendor/modernizr.min.js"></script>
    <script>
        if (typeof (globalButoIds) !== "undefined") {
            require(globalButoIds,
                function () {
                }
            );
        }
    </script>

    <script type="text/javascript">
        require(['validate', 'clipboard', 'jquery-ui', 'jquery.cookie'],
            function (validate, clipboard, jqueryui, jquerycookie) {
            })
    </script>

    
<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57f3c869c15414c8"></script><div id="_atssh" style="visibility: hidden; height: 1px; width: 1px; position: absolute; top: -9999px; z-index: 100000;"><iframe id="_atssh85" title="AddThis utility frame" style="height: 1px; width: 1px; position: absolute; top: 0px; z-index: 100000; border: 0px; left: 0px;" src="https://s7.addthis.com/static/sh.f48a1a04fe8dbf021b4cda1d.html#rand=0.49040309013798833&amp;iit=1577724080696&amp;tmr=load%3D1577724080666%26core%3D1577724080688%26main%3D1577724080694%26ifr%3D1577724080698&amp;cb=0&amp;cdn=0&amp;md=0&amp;kw=&amp;ab=-&amp;dh=www.stockport.gov.uk&amp;dr=&amp;du=https%3A%2F%2Fwww.stockport.gov.uk%2Fbrownfield%2Fbrownfield-land-register&amp;href=https%3A%2F%2Fwww.stockport.gov.uk%2Fbrownfield%2Fbrownfield-land-register&amp;dt=Brownfield%20First%20-%20Brownfield%20Land%20Register&amp;dbg=0&amp;cap=tc%3D0%26ab%3D0&amp;inst=1&amp;jsl=0&amp;prod=undefined&amp;lng=en&amp;ogt=title&amp;pc=men&amp;pub=ra-57f3c869c15414c8&amp;ssl=1&amp;sid=5e0a28b02fada64c&amp;srf=0.01&amp;ver=300&amp;xck=0&amp;xtr=0&amp;og=title%3DBrownfield%2520First%2520-%2520Brownfield%2520Land%2520Register&amp;csi=undefined&amp;rev=v8.28.1-wp&amp;ct=0&amp;xld=1&amp;xd=1"></iframe></div><style id="service-icons-0"></style>
<script type="text/javascript">
    var addthis_config = addthis_config||{};
    addthis_config.data_track_clickback = false;
</script>

    

<script type="text/javascript" id="">-1===navigator.userAgent.indexOf("MSIE ")&&-1===navigator.userAgent.indexOf("Trident/")&&function(){var a=document.createElement("script"),b="168019131601";a.type="text/javascript";a.async=!0;a.src="//app.meetami.ai/launchpad.php?c\x3d"+b;b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}();</script><iframe name="_hjRemoteVarsFrame" title="_hjRemoteVarsFrame" id="_hjRemoteVarsFrame" src="https://vars.hotjar.com/box-b736908ce6b0e933fad3a2e45df61b38.html" style="display: none !important; width: 1px !important; height: 1px !important; opacity: 0 !important; pointer-events: none !important;"></iframe>


	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">	<title>Chat to the Stockport Council team</title>



	
			<script type="text/javascript">
			console.log = function() {}
		</script>
	
	<style type="text/css">

		/* Font import */
		@import 'https://fonts.googleapis.com/css?family=Lato';
		* { outline: none; }

		/* Generic styles for both chatters */

#srContent {
	display: none;
	font-size: 13px;
	line-height: 1.2em;
	font-family: 'Lato', sans-serif !important;
	color: #444 !important;
	letter-spacing: 0 !important;
	font-weight: 300;
	z-index: 1000001;
	width: 340px;
	background: #fff;
	position: fixed;
	-webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box;
	border: 1px solid #e9e6e6;
	bottom: 0;
	box-shadow: none !important;
}
#srContent p, #srContent #srMsgs p { display: block; text-align: left; color: #444 !important; line-height: 1.2em; font-size: 13px; font-family: 'Lato', sans-serif !important; }
#srContent a { outline: none; color: #444 !important; }
#srLaunchContainer { z-index: 1000000 !important; position: fixed; outline: none; right: 49px !important; bottom: 20px !important; display: block; text-align: center; vertical-align: center; height: 72px; min-width: 72px; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%; }
#srContent #srMsgs::-webkit-scrollbar {
  width: 5px;
}

/* Track */
#srContent #srMsgs::-webkit-scrollbar-track {
  box-shadow: inset 0 0 0px grey !important ;
  border-radius: 0px;
}

/* Handle */
#srContent #srMsgs::-webkit-scrollbar-thumb {
  background:rgba(138,138,138,0.1) !important ;
  border-radius: 1px;
}

/* Handle on hover */
#srContent #srMsgs::-webkit-scrollbar-thumb:hover {
  background:rgba(138,138,138,0.5) !important ;
}

#callbackLaunchContainer { z-index: 1000000 !important; position: fixed; outline: none; left: 49px !important; bottom: 20px !important; display: block; text-align: center; vertical-align: center; height: 72px; min-width: 72px; -moz-border-radius: 50%; -webkit-border-radius: 50%; border-radius: 50%; }

a#srLaunch, a#srLaunchPhone {
	background: #da4a97;
	-moz-box-shadow: 2px 2px 7px rgba(68,68,68,0.25); -webkit-box-shadow: 2px 2px 7px rgba(68,68,68,0.25); box-shadow: 2px 2px 7px rgba(68,68,68,0.25);
	display:block;
	width: 72px;
	height: 72px;
	z-index: 1;
	position: absolute;
	right: 0px;
	bottom: 0px;
	-webkit-border-radius: 50%;
	-moz-border-radius: 50%;
	border-radius: 50%;
	font-family: 'Lato', sans-serif !important;
}
a#srLaunch.client { padding: 0; background: none; bottom: 20px; -moz-box-shadow: none; -webkit-box-shadow: none; box-shadow: none; outline: none !important; }
a#srLaunch.client { padding: 0; background: none; bottom: 20px; -moz-box-shadow: none; -webkit-box-shadow: none; box-shadow: none; outline: none !important; }
#srLaunch img { display: inline; height: 42px; width: 42px; margin: 15px auto; padding: 0; }
#srLaunch.client img { width: 72px; height: 72px; max-width: 100%; max-height: 100%; }

#srLaunchPhone img { display: block; height: 40px; width: 40px; padding: 0; margin: 14px auto; }

#srLaunchContainer .srBadge {
	position: fixed;
	z-index: 2;
	right: 54px;
	bottom: 73px;
	width: 17px;
	height: 17px;
	background: #000000;
	-moz-border-radius: 50%;
	-webkit-border-radius: 50%;
	border-radius: 50%;
	-moz-box-shadow: 2px 2px 7px rgba(68,68,68,0.25);
	color: #fcf6f6;
	font-size: 9px;
	line-height: 18px;
	display: none;
	font-family: 'Lato', sans-serif !important;
}

#srLaunchContainer #srPreviewMessage {
	margin-top: 6px;
	margin-right: -19px;
	width: 280px;
	text-align: center;
	background: #f2f2f2;
	position:absolute;
	right: 70px;
	padding: 14px 0;
	cursor: pointer;
	-webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.0.25);
	-moz-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.25);
	box-shadow: 0 1px 2px 0px rgba(0,0,0,0.25);
}

.srPreviewMessageContent {
	float: left;
	width: 100%;
}

#srPreviewMessage p:after, #srPreviewMessage p:before {
	right: 100%;
	top: 50%;
	border: solid transparent;
	content: " ";
	height: 0;
	width: 0;
	position: absolute;
	pointer-events: none;
}

#srPreviewMessage p:after {
	border-color: rgba(136, 183, 213, 0);
	border-right-color: #f7f7f7;
	border-width: 5px;
	margin-top: -5px;
}
#srPreviewMessage p:before {
	border-color: rgba(194, 225, 245, 0);
	border-right-color: #ddd;
	border-width: 6px;
	margin-top: -6px;
}

#srPreviewMessage .avatar-preview {
	float:left;
	width: 25px;
	height: 25px;
	margin-left: 6px;
	margin-top: 3px;
	background: #da4a97;
	-webkit-box-shadow: 2px 2px 3px 0px rgba(68,68,68,0.3);
	-moz-box-shadow: 2px 2px 3px 0px rgba(68,68,68,0.3);
	box-shadow: 1px 1px 3px 0px rgba(68,68,68,0.2);
	-webkit-border-radius: 50%;
	-moz-border-radius: 50%;
	border-radius: 50%;
}

#srPreviewMessage .avatar-preview.avatar-default {
	margin-top: 2px;
	margin-left: 2px;
	-webkit-box-shadow: none;
	-moz-box-shadow: none;
	box-shadow: none;
	-webkit-border-radius: 50%;
	-moz-border-radius: 50%;
	border-radius: 50%;
}

#srPreviewMessage .avatar-preview img {
	width: 23px;
	height: 23px;
	-webkit-border-radius: 50%;
	-moz-border-radius: 50%;
	border-radius: 50%;
	margin-top: 1px;
	margin-left: 0;
}
#srPreviewMessage .avatar-preview.avatar-default img {
	margin-top: -2px;
	margin-left: -2px;
}

#srPreviewMessage .avatar-preview.avatar-default img {
	width: 37px;
	height: 35px;
	max-width: 37px;
}

#srLaunchContainer #srPreviewMessage p {
	position:relative;
	display: table-cell;
	vertical-align: middle;
	text-align: left;
	margin-left: 39px;
	left: 13px;
	font-size: 11px;
	text-align: left;
	height: 29px;
	width: 180px;
	background: #f7f7f7;
	border: 1px solid #ddd;
	margin: 0 auto;
	font-family: "Lato",sans-serif;
	padding: 2px 8px;
	line-height: 1.2em;
}


#srContent h4 { background: #fff; color: #444 !important; font-family: 'Lato', sans-serif !important; margin: 0 0 10px 0; line-height: 1em; letter-spacing: 0; text-transform: none; font-weight: 500; font-size: 17px; padding: 12px !important; border-bottom: 1px solid #e9e6e6; }
#srContent h4 span#srIcon { height: 23px; width: 26px; margin-right: 20px; display: block !important; float: left; background: #da4a97; }
#srContent h4 span#srIcon img { width: 100%; height: 100%; }
#srContent h4 span#srMenu { float: right; display: block; margin-right: 0!important; }
#srContent h4 span#srMenu a { display: inline-block; width: 25px; height: 25px; margin-top: -4px; margin-left: 6px; background-position: center !important; background-repeat: no-repeat !important; }
#srContent h4 span#srMenu a.srClose { background-image: url('//app.meetami.ai/img/widget/close.png'); }
#srContent h4 span#srMenu a#srMin { background: url('//app.meetami.ai/img/widget/minimise.png') no-repeat; }

#srContent #srMsgs span p.srIntro, #srContent #srMsgs span p.srIntroPos { padding: 0; box-shadow: none; width: auto; margin-left: 60px; font-size: 14px; font-style: italic; border: none; background: none; }
#srContent #srMsgs span p.srIntro { margin-top: 0; padding-top:5px; margin-bottom: 6px; font-weight: 400; font-style: normal; }
#srContent #srMsgs span p.srIntroPos { margin-top: 0; font-weight: 300; margin-bottom: 20px; }
#srContent #srMsgs span p.srIntro:before, #srContent #srMsgs span p.srIntroPos:before, #srContent #srMsgs span p.srIntro:after, #srContent #srMsgs span p.srIntroPos:after { content: none; }

#srContent #srChatter {  }

#srContent #srChatter #srMsgs { overflow: auto; min-height: 150px; max-height: 342px; padding: 0 12px 10px 12px; }
#srContent #srChatter #srMsgs img.loading { margin: 25px auto; display: block; width: 40%; }
#srContent #srChatter img.loading-mini { margin: auto; height: 60px; }

#srContent #srMsgs > span { display: block; overflow: visible; margin-bottom: 12px; }
#srContent #srMsgs > span > span { background: #da4a97; margin-top: 2px; float: left; -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.2); -webkit-box-shadow: 2px 2px 5px rgba(68,68,68,0.2); box-shadow: 2px 2px 5px rgba(68,68,68,0.2);-webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%; border: 2px solid #da4a97; width: 52px; height: 52px; display: block; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
#srContent #srMsgs > span > span img { margin: 0 !important; padding: 0 !important; border: 0 !important; -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%; width: 48px; height: 48px; }
	#srContent #srMsgs > span > span { background: none; -moz-box-shadow: none; -webkit-box-shadow: none; box-shadow: none;-webkit-border-radius: 0; -moz-border-radius: 0; border-radius: 0; border: 0; }
	#srContent #srMsgs > span > span img { -webkit-border-radius: 0; -moz-border-radius: 0; border-radius: 0; }

/* Speech bubbles */
#srContent #srMsgs > p { position: relative; word-wrap: break-word; -moz-border-radius: 10px 10px 2px 10px; -webkit-border-radius: 10px 10px 2px 10px; border-radius: 10px 10px 2px 10px; padding: 5px 8px; margin: 0 9px 5px auto; width: 271px; background: #ebebeb !important; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; text-align: left; font-weight: normal; color: #444444 !important; line-height: 1.3em; }
#srContent #srMsgs > p.agent { -moz-border-radius: 12px 12px 12px 2px; -webkit-border-radius: 10px 10px 10px 2px; padding: 5px 8px; margin: 0 auto 5px 9px; background: #f7e5ed !important; width: 271px; }
#srContent #srMsgs p.inc-avatar span.avatar-mini { display: none; width: 25px; height: 25px; position: absolute; top: 5px; left: -44px; background: #da4a97; -webkit-box-shadow: 2px 2px 3px 0px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 3px 0px rgba(68,68,68,0.3); box-shadow: 1px 1px 3px 0px rgba(68,68,68,0.2); -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%; }
#srContent #srMsgs p.inc-avatar span.avatar-mini img { position: relative; width: 92%; height: 92%; margin: 4%; -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%; }

#srContent #srMsgs > p span { margin-bottom: 2px; display: block; font-weight: bold; }
#srContent #srMsgs p#srFaded, #srContent #srMsgs p.feint { text-align: center; border-radius: 2px; -webkit-box-shadow: none; -moz-box-shadow: none; box-shadow: none; padding: 8px 12px; margin: 12px auto; width: 95%; background: none; font-style: italic; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
#srContent #srMsgs p#srFaded:before, #srContent #srMsgs p.feint:before, #srContent #srMsgs p#srFaded:after, #srContent #srMsgs p.feint:after, #srContent #srMsgs p.inc-avatar:before { content: none; }

#srContent #srMsgs > p a.lnk_btn { display: table; cursor: pointer; margin: 10px auto 5px auto; text-decoration: none; padding: 4px 15px; color: #fff; background: #da4a97; -webkit-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); }

#srContent #srMsgs span:empty, #srContent #srMsgs p:empty { display: none; }

#srContent #dcErr { width: 100%; padding: 8px 12px; background: rgba(0,0,0,0.25); box-sizing: border-box; }
#srContent #dcErr p {padding: 0; margin: 4px 0; color: #fff !important; text-align: center; }

/* Green bubbles */
/* -webkit-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); */
#srContent #srChatter #srMsgs .srEndChat { position: relative; padding: 10px 8px 10px 52px; margin: 12px 9px; background: #b9e7cc; /*border: 1px solid #91bfa4;*/ color: #fcf6f6; -moz-border-radius: 12px; -webkit-border-radius: 12px; border-radius: 12px; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
#srContent #srChatter #srMsgs .srEndChat.phone { position: relative; background-image: url('//app.meetami.ai/img/widget/phone.svg'); background-size: 26px auto; background-repeat: no-repeat; background-position: 12px center; }
#srContent #srChatter #srMsgs .srEndChat.mail { background-image: url('//app.meetami.ai/img/widget/mail.png'); background-repeat: no-repeat; background-position: 12px center; }
#srContent #srChatter #srMsgs .srEndChat.chat { background-image: url('//app.meetami.ai/img/widget/chat.png'); background-repeat: no-repeat; background-position: 12px center; }
#srContent #srChatter #srMsgs .srEndChat.positive, #srContent #srChatter #srMsgs .srDPQuestion.positive  { padding: 10px 8px 10px 52px; background-image: url('//app.meetami.ai/img/widget/tick-grn.svg'); background-size: 26px 26px; background-repeat: no-repeat; background-position: 12px center; }
#srContent #srChatter #srMsgs .srEndChat p { margin: 5px 0; padding: 0; position: relative; top: 0; color: #fcf6f6 !important; }
#srContent #srChatter #srMsgs .srEndChat p a { color: #fcf6f6 !important; text-decoration: underline; }
#srContent #srChatter #srMsgs .srEndChat p a:hover { text-decoration: none; }
#srContent #srChatter #srMsgs .srEndChat > a#srSpecifyTimeBtn, #srContent #srChatter #srMsgs .srEndChat p a#srEndChatBtn { display: inline-block; padding: 5px 12px; margin-top: 10px; background: #fff; color: #b9e7cc;-webkit-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.2); -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.2); box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.2); }
#srContent #srChatter #srMsgs .srEndChat #srSelectTime { font-size: 12px; width: 70px; color: #444; padding: 3px 5px; margin-left: 8px; display: inline-block; }

#srContent #srChatter #srMsgs .srDPQuestion { padding: 7px 8px 7px 52px; margin: 0 9px 8px 9px; background: #c6e0ed url('//app.meetami.ai/img/widget/question-circle.svg') left 12px center / 26px 26px no-repeat; color: #444444; -moz-border-radius: 12px; -webkit-border-radius: 12px; border-radius: 12px; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
#srContent #srChatter #srMsgs .srDPQuestion.end { background-color: #b9e7cc; }
/*#srContent #srChatter #srMsgs .srDPQuestion.info { background-image: url('//app.meetami.ai/img/widget/chat.png'); background-repeat: no-repeat; background-position: 12px center; }*/
#srContent #srChatter #srMsgs .srDPQuestion p { margin: 0; color: #444444 !important; }
#srContent #srChatter #srMsgs .srDPQuestion.end p { color: #fcf6f6 !important; }
#srContent #srChatter .success-color { background: #b9e7cc; }


#srContent a.srViewMoreLink { font-size: 11px; display: table-cell; clear: both; text-decoration: underline; padding-top: 5px; padding-right: 18px; background: url('//app.meetami.ai/img/core/lnk-thru.svg') right bottom / auto 14px no-repeat; max-width: 78px; color: #007bff !important; }
#srContent a.srViewMoreLink:hover { text-decoration: none; }


/* Form */

#srContent #srChatter #srChatForm .input.text input { height: auto; }
#srContent #srChatter #srChatForm { width: 100%; box-sizing: border-box; margin: 0; padding: 0 12px; display: block }
#srContent #srChatter #srChatForm .input.text:nth-child(2) { border-top: 1px solid #ddd; padding-top: 5px; }
#srContent #srInputs { padding: 5px 0; margin-top: 10px; position: relative; }
#srContent #srInputs.text-center { text-align: center; }
#srContent #srInputs label { font-weight: normal; color: #bbb; font-size: 13px; }
#feedback-callback-form label, #srContent #srInputs .text label, #srCover .srCoverContent .textarea label, #srCoverRecovery .srCoverContentRecovery .textarea label { display: block; color: #bbb; margin-bottom: 2px; }
#srCover .srCoverContent .textarea label, #srCoverRecovery .srCoverContentRecovery .textarea label { text-align: center; }
#feedback-callback-form input[type="text"],.callbackForm input[type="text"], .callbackForm select, #feedback-callback-form input[type="email"], #feedback-callback-form input[type="tel"], #srCover .srCoverContent textarea#rlMsg, #srCoverRecovery .srCoverContentRecovery textarea#srchMsg, #srCover .srCoverContent .textarea textarea, #srCover .srCoverContent .textarea textarea, #srCover .srCoverContent .text input, #srCover .srCoverContent .email input, #srCover .srCoverContent .tel input, #srCoverRecovery .srCoverContentRecovery .text input, #srCoverRecovery .srCoverContentRecovery .email input, #srCoverRecovery .srCoverContentRecovery .tel input, #srContent #srInputs .textarea textarea, #srContent #srFeedback .textarea textarea, #srContent #srInputs .text input, #srContent #srInputs .email input { text-transform: none !important;margin-bottom: 4px; font-family: 'Lato', sans-serif; font-size: 13px; line-height: 13px; height: 32px; border-radius: 2px; display: block; border: 0; width: 100%; padding: 8px 14px !important; color: #444 !important; background: #fff !important; -webkit-box-sizing: border-box;‌​ -moz-box-sizing: border-box; box-sizing: border-box; -moz-box-shadow: 0 0 0 1px rgba(68,68,68,0.2); -webkit-box-shadow: 0 0 0 1px rgba(68,68,68,0.2) !important; box-shadow: 0 0 0 1px rgba(68,68,68,0.2) !important; }
#srContent #srInputs .text input, #srContent #srInputs .email input { padding: 6px 10px !important; }
#srContent #srInputs .textarea textarea { width: 100%; margin: 0; min-height: 0; outline: none !important; }
#srContent #srInputs .textarea textarea#amessage { width: 100%; margin-left: 0%; }
#srCover .srCoverContent .text input, #srCover .srCoverContent .email input, #srCover .srCoverContent .tel input, #srCoverRecovery .srCoverContentRecovery .text input, #srCoverRecovery .srCoverContentRecovery .email input, #srCoverRecovery .srCoverContentRecovery .tel input { margin-bottom: 5px; text-transform: none !important; }
#srContent #srInputs .textarea textarea, #srContent #srFeedback .textarea textarea, #srCover .srCoverContent textarea#rlMsg, #srCoverRecovery .srCoverContentRecovery textarea#srchMsg { height: 65px; resize: none; }
#srContent #srInputs .dp-yes, #srContent #srInputs .dp-no, #srContent #srInputs input[type=submit], #srContent a.srFormBtn, #srContent a.srCancelAppt, #srContent #srFeedback input[type=submit] { text-decoration: none; margin: 5px auto; display: table; padding: 4px 15px; color: #fff !important; background: #da4a97; -webkit-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); }
#srContent #srInputs .dp-container, #srContent #srInputs .cc-container { text-align: center; }
#srContent #srInputs .dp-yes, #srContent #srInputs .dp-no { border: none; outline: none; display:inline-block; margin: 0 4px; }
#srContent #srInputs .dp-yes:hover, #srContent #srInputs .dp-no:hover, #srContent #srInputs input[type=submit]:hover, #srContent a.srFormBtn:hover, #srContent #srFeedback input[type=submit]:hover { -webkit-box-shadow: 2px 2px 8px 2px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 8px 2px rgba(68,68,68,0.3); box-shadow: 2px 2px 8px 2px rgba(68,68,68,0.3); }

.callbackForm .half {width:49%;display:inline-block;margin:auto}
.grey-text-link {display: block;text-align: center;color: grey;font-weight: bold;}

#srContent img#footerLogo { margin: 0px 48px 5px 18px; float: right; -webkit-filter: grayscale(0.9); filter: grayscale(0.9); -o-transition: filter 0.5s ease; -moz-transition: filter 0.5s ease; -webkit-transition: filter 0.5s ease; transition: filter 0.5s ease; }
#srContent img#footerLogo:hover { -webkit-filter: grayscale(0); filter: grayscale(0); }

#srContent .centre, #srContent .centre p { text-align: center !important; margin-left: auto !important; margin-right: auto !important; }

#srContent label.error, #scheduleFutureCallback .error, #scheduleCallback .error { color: #C10005 !important; font-size: 13px; }
label#srMsgSender-error { display: none !important; }
#srContent input.error { background: #FFE1E2; }
p.small, p.srDataSecure { font-size: 12px; color: #999; font-style: italic; margin-top: 5px; margin-bottom: 5px; line-height: 1.2em; }
p.errormsg { color: #B30004 !important; }
p.srDataSecure { padding-left: 18px; background: url('//app.meetami.ai/img/widget/padlock.png') no-repeat; margin-top: 10px; }
p.srDataSecure span { color: #4898d3; font-style: normal; }
#srContent #srFeedback { padding: 10px 15px; }
#srContent #srFeedback .success { width: 100px; height: 100px; padding: 35px 29px 35px 28px; margin: 20px auto 8px auto; border: 0; background: #da4a97; -webkit-border-radius: 50%; -moz-border-radius: 50%; border-radius: 50%; -webkit-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); -moz-box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); box-shadow: 2px 2px 5px 1px rgba(68,68,68,0.3); -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
#srContent #srFeedback .success img { width: 43px; height: 32px; }
#srContent #srFeedback p#srBtm { margin-bottom: 25px; text-align: center; }

.srStarRating { width: 100%; padding: 12px 0; margin: 0 0 10px 0; background: #e1e1e1; -moz-border-radius: 10px; -webkit-border-radius: 10px; border-radius: 10px; color: #7a7b6a; }
#srContent #srFeedback .textarea textarea { margin-bottom: 12px; }
#srStars { width: 266px !important; display: block; margin: 0 auto; height: 75px; cursor: pointer; background: url('//app.meetami.ai/img/core/stars-pub.png') top center no-repeat; }
#srStars.star-1 { background-position: center 0; }
#srStars.star-2 { background-position: center -80px; }
#srStars.star-3 { background-position: center -160px; }
#srStars.star-4 { background-position: center -240px; }
#srStars.star-5 { background-position: center -320px; }

#srContent a.footerLnk, #srContent p.footerLnk { float: right; position: relative; display: block; text-align: right; margin: 0 10px 8px 0; font-size: 10px; font-variant: small-caps; color: #c1bcbf !important;
	background: url('//app.meetami.ai/img/core/powered-by-empty.svg') right center / 28px 26px no-repeat; padding: 1px 6px 5px 0;
/*		-moz-filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'></feColorMatrix></filter></svg>#grayscale");
					 -o-filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'></feColorMatrix></filter></svg>#grayscale");
*/		         -webkit-filter: grayscale(100%);
					 filter: gray;
				 -webkit-transition: -webkit-filter 500ms; transition: filter 500ms;
}
#srContent a.footerLnk > span, #srContent p.footerLnk > span { color: #fff; font-variant: normal; display: inline-block; margin-left: 7px; font-family: arial, sans-serif; }
#srContent a.footerLnk:hover, #srContent p.footerLnk:hover { -webkit-filter: none; filter: none; }
/* #srContent a.footerRate, #srContent p.footerRate { position: absolute; top: 9px; right: 26px; margin-left: 14px; margin: 0 0 8px 12px; z-index: 1; } */
#srContent a.footerRate button, #srContent p.footerRate { background: #c9c9c9; color: white !important; height: auto; line-height: 16px; border: none; font-size: 12px; padding: 2px 6px !important; font-weight: normal !important; border-radius: 0 !important;  }
#srContent a.footerRate.active-chat button { background: #da4a97 }
#srContent .feedback-upper-container { transition: .2s all; position: absolute; right: 0px; top: 42px; background: transparent; width: 100%; height: 60px; z-index: 1; }
#srContent.srWelcomeMessage .feedback-upper-container { display: none; }
#srContent .feedback-upper-container p { transition: .2s all; white-space: nowrap; text-align: right; position: absolute; top: 12px; right: 20px; margin-left: 14px; margin: 0 0 8px 12px; z-index: 1; font-size: 12px; }
#srContent .feedback-upper-container p span { transition: .2s all; opacity: 0; display: none; }
#srContent .feedback-upper-container p a { width: 95px; }
#srContent .feedback-upper-container.scrollbar-visible { height: 45px; background: rgba(255,255,255,0.95); }
#srContent .feedback-upper-container.scrollbar-visible p span { opacity: 1; display: inline-block; }

#srContent .feedback-upper-container.scrolled-top { background: transparent; }
#srContent .feedback-upper-container p.success-color { width: auto; }
#srContent .feedback-upper-container.scrolled-top p.success-color { width: 95px; }
#srContent .feedback-upper-container.scrolled-top p span { opacity: 0; }
#srContent .feedback-upper-container.scrolled-top.scrollbar-visible p { right: 25px; }

#srContent .feedback-prechat-container { position: relative; width: 85%; padding: 0; box-sizing: border-box; margin: 5px auto -9px auto; }
#srContent .feedback-prechat-container p { margin: 0 0 10px 0; border-top: 1px solid #e9e6e6; text-align: center; padding-top: 5px; color: #aaa !important; }
#srContent .feedback-prechat-container a.footerRate button { background: #da4a97 !important; }
#srContent .feedback-prechat-container p.success-color { border-top: none; color: #fff !important; }
#srContent .feedback-prechat-container.cc-exists { display: none; }

#srContent .srFormBtnGrey { background: #b9b9b9 !important; margin-right: 5px !important; display: inline-block !important; }
#srContent .srFormBtn.during { display: inline-block !important; }

#srContent #srMsgs p a.linkified { text-transform: none; font-size: 1em; display: block; margin-top: 8px; margin-bottom: 8px; text-decoration: underline; color: blue !important; }
#srContent #srMsgs p a.linkified:hover { text-decoration: none; }

/* Welcome message stylings */
#srContent.srWelcomeMessage {
	height: auto; max-height: 650px; bottom: 115px; right: 24px;
	width: 360px;
}
/*
#srContent.srWelcomeMessage::after {
	content: " ";
	position: absolute;
	display: block;
	width: 25px;
	height: 15px;
	bottom: -15px;
	right: 48px;
	background: url('//app.meetami.ai/img/widget/chat-btm.png') top left no-repeat;
}*/

#srContent.srWelcomeMessage #srMenu #srMin {
	display: none;
}

#srContent.srWelcomeMessage .footerLnk {
	display: none;
}

#srContent.srWelcomeMessage #srChatter form { position: relative; bottom: 5px; }
#srContent.srWelcomeMessage .feedback-prechat-container { bottom: 5px; }


#srLaunchContainer.srWelcomeMessage #srLaunch {
	display: block !important;
}

#srContent.srWelcomeMessage #srMsgs span:first-child {
	display: none;
}



	#srContent { height: auto; max-height: 650px; right: 12px; }

			/* Specifics for the small chatter */
		#srContent { bottom: 112px; }
	
	
	
#callbackCover {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: url(//app.meetami.ai/img/widget/sr-layer-bg.png) repeat;z-index: 999990;font-size: 13px;line-height: 1.2em;font-family: 'Lato', sans-serif !important;color: #444 !important;letter-spacing: 0 !important;font-weight: 300;-moz-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px;-webkit-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px;box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px;}
#callbackCover .lock {width:13px;height:16px;background-size: 100% 100%;display:inline-block;margin-right:4px }
#callbackCover .formContainer {margin:auto;margin-top:150px;width:350px;clear:both}
#callbackCover .callbackCoverContent {clear:both}
#callbackCover .callbackCoverContent .header {background-color:#FFF;padding:10px;text-align:left}
#callbackCover .callbackCoverContent .content {background-color:#f8f8f8;border-bottom:1px solid #f8f8f8;padding:10px 15px}
#callbackCover .callbackCoverContent .content .button {background-color:grey;width:49.5%;display:inline-block;color:#FFF;font-size:12px;font-weight:bold;text-align:center;padding:5px 10px; box-sizing: border-box;}
#callbackCover .callbackCloseBtn {color:#FFF;float:right;margin-bottom:15px}
#callbackCover .callbackCoverContent .content p.data {font-style:italic;color:#818181}
#callbackCover .callbackCoverContent .content .main-button {display:block;margin:0 auto;background-color:#da4a97;width:49%;border: none;outline: none;}
#callbackCover .callbackCoverContent .content .main-button.pending { opacity: 0.35; background: #da4a97 url('//app.meetami.ai/img/core/bg/loading.gif') left 10px center / 16px auto no-repeat; cursor: default; }


#callbackCover .futureCallbackCoverContent {display:none}

#callbackLaunchContainer .bubble-component { display:none}

#callbackLaunchContainer div.bubble {
	width: 300px;
	text-align: left;
	position:relative;
	padding:6px 12px;
	font-size:14px;
	/*top:10px;*/
	padding-right:20px;
	border-radius:5px;
	background-color:#444444;
	color:#ffffff;
}

#callbackLaunchContainer div.bubble-container {
	position: absolute;
	left: 90px;
	width: 300px;
	text-align: left;
	height:100px;
	font-size:14px;
	top:-11px;
	display: flex;
    align-items: center;
}

#callbackLaunchContainer div.close-bubble{
	position: absolute;
    right: 2px;
    color:#ffffff;
    z-index: 3;
    top: -3px;
	cursor:pointer;
	font-size:13px;
	display: block;
    height: 15px;
    width: 15px;
}

#callbackLaunchContainer div.close-bubble:hover{
	text-decoration:underline

}

#callbackLaunchContainer div.triangle {
	width: 0;
	height: 0;
	border-style: solid;
	border-width: 10px 12px 10px 0;
	border-color: transparent #444444 transparent transparent;
	position:absolute;
	top:28px;
	left:80px;
}

.callbackCoverContent .centre{ text-align:center}

#callbackCover .avatar {height:30px;background-color:#da4a97;}
/* Responsive aspects */
@media only screen and (min-width: 1px) and (max-width: 720px)  {

	#srContent #srMsgs > p, #srContent #srMsgs > p.agent { width: 80%; }
	#srContent #srInputs .textarea textarea { -moz-box-shadow: none !important; -webkit-box-shadow: none !important; box-shadow: none !important; }

	#srContent h4 span#srMenu a { width: 25px; height: 25px; padding: 10px; margin-top: -4px; margin-left: 5px; }
	#srContent h4 span#srMenu a.srMin, #srContent h4 span#srMenu a.srClose { background-size: 10px 10px !important; background-repeat: no-repeat !important; background-position: center center !important; box-sizing: border-box; }
	#srContent h4 span#srMenu a.srMin { background-size: 10px 10px; }
	#srContent.old #srMenu a[rel="srMinToggle"] {
		float: right;
		background: url(//app.meetami.ai/img/widget/down-arrow.png) !important;
		background-size: 10px 7px !important;
		background-repeat: no-repeat !important;
		background-position: center center !important;
	}
}

@media only screen and (max-height: 640px)  {

	#callbackCover .formContainer { margin: 22px auto 0 auto !important; max-width: 98%; }

}

		/* Other elements - e.g. callback buttons */

		/* Recovery layers styling */
	  #srCover, #srCoverRecovery , #srCoverMT, #srCoverIc { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('//app.meetami.ai/img/widget/sr-layer-bg.png') repeat; z-index: 999990; font-size: 13px; line-height: 1.2em; font-family: 'Lato', sans-serif !important; color: #444 !important; letter-spacing: 0 !important; font-weight: 300; }
	  #srCover .srCoverContent, #srCoverRecovery .srCoverContentRecovery, #srCoverIc #srIc { display: block; width: 350px; max-height: 350px; overflow: auto; position: absolute; top: 50%; left: 50%; margin-left: -175px; margin-top: -175px; z-index: 999991; }
	  #srCoverIc #srIc { background: #f2f2f2; -moz-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; -webkit-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; }
	  	    #srCoverRecovery .srCoverContentRecovery { background: #f2f2f2; -moz-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; -webkit-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; }
	  	  	    #srCover .srCoverContent { background: #f2f2f2; -moz-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; -webkit-box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; box-shadow: rgba(0, 0, 0, 0.2) 3px 3px 5px 2px; }
	  
	  #srCoverRecovery .srCoverContentRecovery h4, #srCover .srCoverContent h4, #srCoverIc #srIc h4 { color: #444; font-size: 125%; font-weight: 400; background: #fff; -moz-box-shadow: 0 0 1px 0 rgba(68,68,68,0.3); -webkit-box-shadow: 0 0 1px 0 rgba(68,68,68,0.3); box-shadow: 0 0 1px 0 rgba(68,68,68,0.3); padding: 12px 20px; -webkit-box-sizing: border-box;‌​ -moz-box-sizing: border-box; box-sizing: border-box; margin-top: 0; margin-bottom: 0; }
		#srCoverRecovery .srCoverContentRecovery h4:before, #srCover .srCoverContent h4:before, #srCoverIc #srIc h4:before { content: ''; width: 26px; height: 23px; margin: -4px 10px 0 -2px; display: block; float: left; background: #da4a97 url('//app.meetami.ai/img/widget/header-icon.png') left center no-repeat; background-size: 26px 23px; }
		#srCoverRecovery .srCoverContentRecovery .text-form, #srCover .srCoverContent .text-form, #srCoverIc #srIc .srFormSection { padding: 12px 20px; padding: 12px 20px; -webkit-box-sizing: border-box;‌​ -moz-box-sizing: border-box; box-sizing: border-box; }
	  #srCoverRecovery .srCoverContentRecovery p, #srCover .srCoverContent p { margin-bottom: 15px; }
	  #srContent #srInputs .srSubmitForm, #srCover .srCoverContent .srSubmitForm, #srCoverIc #srIc #srSubmitIc, #srCoverRecovery .srCoverContentRecovery .srSubmitForm, #srCoverRecovery .srCoverContentRecovery a#srSubmitForm, #srCoverRecovery .srCoverContentRecovery a#srChatNowSrch, #srCover .srCoverContent a#srSubmitForm, #srCover .srCoverContent a#srChatNow, a.srSubBtn { margin: 10px auto; display: block !important; background: #da4a97; color: #fff; text-decoration: none;
	    	      -webkit-border-radius: 0; -moz-border-radius: 0; border-radius: 0;
	    	    font-size: 105%; width: 150px; text-align: center; padding: 8px 12px; border: 0; -webkit-appearance: none;
	  }
	  #srCoverRecovery .srCoverContentRecovery img#srRLSrch, #srCover .srCoverContent img#srRL { width: 350px;
	    	  }
	  #srCover a.srCloseBtn, #srCoverRecovery a.srCloseBtn, #srCoverIc a.srCloseBtn { display: none; position: fixed; top: 50%; left: 50%; width: 350px; margin-top: -200px; margin-left: -175px; color: #fff !important; text-align: right; }
	  #srCloseTrigger { width: 100%; height: 3px; position: fixed; top: 0; left: 0; z-index: 9999999; }
	  #srCoverRecovery .srCoverContentRecovery p.error, #srCover .srCoverContent p.error, #srCoverRecovery .srCoverContentRecovery p.success, #srCover .srCoverContent p.success { background: #0C9C21; padding: 6px 15px; margin-bottom: 10px; color: #fff;
	    	  }
	  #srCoverRecovery .srCoverContentRecovery p.error, #srCover .srCoverContent p.error { background: #C40000; }
	  #srCoverMT #srMtl form label.error { width: 250px; }
	  #srCoverRecovery .srCoverContentRecovery img.loader, #srCover .srCoverContent img.loader { display: none; margin: 15px 75px; width: 150px; }

	  #srCoverMT #srMtl { width: 650px; max-height: 340px; position: absolute; top: 45%; left: 50%; margin-left: -325px; margin-top: -175px;
	    	      background: #fff;
	    	  }
	  #srCoverMT #srMtl h4 { background: #da4a97; color: #fff; font-size: 20px; font-weight: bold; padding: 12px 18px 5px 18px; margin: 0; }
	  #srCoverMT #srMtl p.intro { background: #da4a97; color: #fff; padding: 0 18px 12px 18px; margin: 0; }
	  #srCoverMT #srMtl form { margin: 22px 18px 20px 18px; }
	  #srCoverMT #srMtl form .input, #srCoverIc #srIc form .input { margin: 2px auto; height: auto; }
		#srCoverMT #srMtl form .select select, #srCoverMT #srMtl form .input input { width:auto; padding: 3px 6px; font-size: 1em; background: #fff; }
		#srCoverMT #srMtl form label, #srCoverIc #srIc form label { width: 100px; display: inline-block; padding-left: 0; font-size: 14px; height: auto; }
	  #srCoverMT #srMtl form p.srDataSecure { text-shadow: 1px 1px #fff; }
	  #srCoverMT #srMtl form label { width: 140px; display: inline-block; font-size: 15px; }
	  #srCoverMT #srMtl form .srSubmitBar { overflow: auto;background: #da4a97; color: #fff; padding: 10px 12px; margin: 25px 0 18px 0; }
	  #srCoverMT #srMtl form .srSubmitBar a { color: #fff; font-size: 10px; opacity: 0.75; filter: alpha(opacity=75); }
	  #srCoverMT #srMtl form .srSubmitBar a#srSubmitMTL { filter: alpha(opacity=75); opacity: 1; font-size: 16px; float: right; font-weight: bold; padding-right: 25px; background: url('//app.meetami.ai/img/widget/arrow.png') right center no-repeat; }

	  #srCoverIc #srIc .centre { text-align: center; }
	  #srCoverIc #srIc .centre img { text-align: center; margin: 10px auto; }
	  #srIcBtn { display: none; position: fixed; cursor: pointer; z-index: 999989; }

	  #srContent #srCloseOverlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%; z-index: 5; background-color: #fff; text-align: center; }
	  #srCloseContent { transform: translate(0, -50%); position: absolute; top: 50%; right: 0; left: 0; }
	  #srContent #srCloseOverlay #srCloseContent > p { text-align: center; font-size: 19px; width: 70%; margin: auto; color: #444 !important; margin-top: 0; }
	  #srContent #srCloseOverlay #srCloseButtons { text-align: center; margin-top: 40px; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton { cursor: pointer; width: 125px; padding: 9px 0px; display: inline-block; border-radius: 4px; box-shadow: 1px 1px 4px rgba(0,0,0,0.1); }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton p { text-align: center; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton p:nth-child(1) { font-size: 19px; margin-bottom: 0; margin-top: 0; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton p:nth-child(2) { font-size: 12px; margin-bottom: 0; margin-top: 3px; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton.srYes { background-color: #da4a97; margin-right: 15px; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton.srYes p { color: white !important; }
	  #srContent #srCloseOverlay #srCloseButtons .srCloseButton.srNo { background-color: #dbdbdb; }

	  #sr-toggles{width:47px;margin: 15px auto 15px auto;text-align:center;}
	  .sr-ios-toggle,.sr-ios-toggle:active{position:absolute;top:-5000px;height:0;width:0;opacity:0;border:none;outline:none;}
	  .sr-checkbox-label{-webkit-transition: .25s ease-in-out;-moz-transition: .25s ease-in-out;-o-transition: .25s ease-in-out;transition: .25s ease-in-out;display:block;position:relative;padding:10px;margin-bottom:0px;font-size:12px;line-height:16px;width:100%;height:25px;-webkit-border-radius:18px;-moz-border-radius:18px;border-radius:18px;background:#f8f8f8;cursor:pointer;}
	  .sr-checkbox-label:before{-webkit-transition: .25s ease-in-out;-moz-transition: .25s ease-in-out;-o-transition: .25s ease-in-out;transition: .25s ease-in-out;content:'';display:block;position:absolute;z-index:1;line-height:34px;text-indent:40px;height:25px;width:25px;-webkit-border-radius:100%;-moz-border-radius:100%;border-radius:100%;top:0px;left:0px;right:auto;background:white;-webkit-box-shadow:0 3px 3px rgba(0,0,0,.2),0 0 0 2px #dddddd;-moz-box-shadow:0 3px 3px rgba(0,0,0,.2),0 0 0 2px #dddddd;box-shadow:0 3px 3px rgba(0,0,0,.2),0 0 0 2px #dddddd;}
	  .sr-checkbox-label:after{content:attr(data-off);display:block;position:absolute;z-index:0;top:0;left:-300px;padding:10px;height:100%;width:300px;text-align:right;color:#bfbfbf;white-space:nowrap;box-sizing:border-box;font-weight:normal;}
	  .sr-ios-toggle:checked + .sr-checkbox-label{-webkit-box-shadow:inset 0 0 0 20px #da4a97,0 0 0 2px #da4a97;-moz-box-shadow:inset 0 0 0 20px #da4a97,0 0 0 2px #da4a97;box-shadow:inset 0 0 0 20px #da4a97,0 0 0 2px #da4a97;}
	  .sr-ios-toggle:checked + .sr-checkbox-label:before{left:calc(100% - 25px);-webkit-box-shadow:0 0 0 2px transparent,0 3px 3px rgba(0,0,0,.3);-moz-box-shadow:0 0 0 2px transparent,0 3px 3px rgba(0,0,0,.3);box-shadow:0 0 0 2px transparent,0 3px 3px rgba(0,0,0,.3);}
	  .sr-ios-toggle:checked + .sr-checkbox-label:after{content:attr(data-on);left:47px;width:25px;}

	  /* GREEN CHECKBOX */
		#sr-checkbox1 + .sr-checkbox-label{-webkit-box-shadow:inset 0 0 0 0px #da4a97,0 0 0 2px #dddddd;-moz-box-shadow:inset 0 0 0 0px #da4a97,0 0 0 2px #dddddd;box-shadow:inset 0 0 0 0px #da4a97,0 0 0 2px #dddddd;}
	  #sr-toggles #sr-checkbox1 + .sr-checkbox-label{ padding: 0; }
	  #sr-checkbox1:checked + .sr-checkbox-label{-webkit-box-shadow:inset 0 0 0 18px #da4a97,0 0 0 2px #da4a97;-moz-box-shadow:inset 0 0 0 18px #da4a97,0 0 0 2px #da4a97;box-shadow:inset 0 0 0 18px #da4a97,0 0 0 2px #da4a97;}
	  #sr-checkbox1:checked + .sr-checkbox-label:after{color:#da4a97;}

	  .feedback-callback-intro, #sr-toggles { display: none; }

	  .srWelcomeImage { position: fixed; bottom: 100px; right: 28px; display: none; cursor: pointer; z-index: 1; }
		.srWelcomeImage img { max-width: 500px; }
		.srWelcomeImage a#srImgMin { z-index: 10; position: absolute; top: 0; right: 0; line-height: 16px; background: rgba(0,0,0,0.5); color: #fff; width: 18px; height: 18px; display: block; text-align: center; -moz-border-radius: 15px; -webkit-border-radius: 15px; border-radius: 15px; }
		.srWelcomeImage a#srImgMin img { transform: rotate(45deg); }

	  
	  .mobOnly { display: none !important; }
	  .srCallBtn { display: none; background: #da4a97 url("//app.meetami.ai/img/core/bg/overlay.png") center bottom repeat-x; padding: 0; overflow: auto; width: 120px; position: fixed; z-index: 999999; left: 15px; bottom: 15px;
	    	  }
	  .srCallBtn a { display: block; color: #fff; background: url("//app.meetami.ai/img/widget/phone.png") 15px center no-repeat; background-size: 20px; padding: 8px 15px 8px 55px; text-shadow: 1px 1px 1px #777; font-size: 16px; }

	  .srRecordVoice { overflow: hidden; cursor: pointer; background-repeat: no-repeat; width: 32px; height: 26px; background: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzIgNTciIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMyIDU3OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CgkubWljLXN0MHtmaWxsOiNDRUM2Qzc7fQo8L3N0eWxlPgo8Zz4KCTxyZWN0IHg9IjEyLjciIHk9IjQyLjEiIGNsYXNzPSJtaWMtc3QwIiB3aWR0aD0iNi43IiBoZWlnaHQ9IjExLjEiLz4KCTxnPgoJCTxwYXRoIGNsYXNzPSJtaWMtc3QwIiBkPSJNMTcuNCw0My43aC0yLjhjLTYuNiwwLTEyLTUuNC0xMi0xMlYxOWgzLjJ2MTIuN2MwLDQuOCwzLjksOC44LDguOCw4LjhoMi44YzQuOCwwLDguOC0zLjksOC44LTguOFYxOWgzLjJ2MTIuN0MyOS40LDM4LjMsMjQsNDMuNywxNy40LDQzLjd6Ii8+Cgk8L2c+Cgk8cGF0aCBjbGFzcz0ibWljLXN0MCIgZD0iTTI0LjUsNy45YzAtNC0zLjItNy4yLTcuMi03LjJoLTIuNmMtNCwwLTcuMiwzLjItNy4yLDcuMnYyMi4yYzAsNCwzLjIsNy4yLDcuMiw3LjJoMi42YzQsMCw3LjItMy4yLDcuMi03LjIKCQlWNy45eiIvPgoJPHJlY3QgeD0iNy41IiB5PSI1MC4yIiBjbGFzcz0ibWljLXN0MCIgd2lkdGg9IjE3IiBoZWlnaHQ9IjUuNCIvPgo8L2c+Cjwvc3ZnPgo='); background-repeat: no-repeat; background-position: top right; position: absolute; right: 20px; bottom: 16px; }
  	.srRecordVoice.srRecording { background: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzIgNTciIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDMyIDU3OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CgkubWljLXN0MHtmaWxsOiMxYzlhOGQ7fQo8L3N0eWxlPgo8Zz4KCTxyZWN0IHg9IjEyLjciIHk9IjQyLjEiIGNsYXNzPSJtaWMtc3QwIiB3aWR0aD0iNi43IiBoZWlnaHQ9IjExLjEiLz4KCTxnPgoJCTxwYXRoIGNsYXNzPSJtaWMtc3QwIiBkPSJNMTcuNCw0My43aC0yLjhjLTYuNiwwLTEyLTUuNC0xMi0xMlYxOWgzLjJ2MTIuN2MwLDQuOCwzLjksOC44LDguOCw4LjhoMi44YzQuOCwwLDguOC0zLjksOC44LTguOFYxOWgzLjJ2MTIuN0MyOS40LDM4LjMsMjQsNDMuNywxNy40LDQzLjd6Ii8+Cgk8L2c+Cgk8cGF0aCBjbGFzcz0ibWljLXN0MCIgZD0iTTI0LjUsNy45YzAtNC0zLjItNy4yLTcuMi03LjJoLTIuNmMtNCwwLTcuMiwzLjItNy4yLDcuMnYyMi4yYzAsNCwzLjIsNy4yLDcuMiw3LjJoMi42YzQsMCw3LjItMy4yLDcuMi03LjIKCQlWNy45eiIvPgoJPHJlY3QgeD0iNy41IiB5PSI1MC4yIiBjbGFzcz0ibWljLXN0MCIgd2lkdGg9IjE3IiBoZWlnaHQ9IjUuNCIvPgo8L2c+Cjwvc3ZnPgo='); background-repeat: no-repeat; background-position: top right; }

	  .srRecordVoice.srProcessing { background-position: -60px -47px; }
	  .srRecordVoice.srProcessing .srSpinner { display: block !important; }
		/* .srRecordVoice.srFinishedProcessing { background-position: 0 0; } */
		.srSpinner { margin: 8px auto 0 -2px; width: 100%; text-align: center; display: none; }
	  #srRecordMobileUx .srSpinner { margin: 13px auto 0 auto; }
		.srSpinner > div { width: 5px; height: 5px; background-color: #da4a97; margin: 0 1px; border-radius: 100%; display: inline-block; -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both; animation: sk-bouncedelay 1.4s infinite ease-in-out both; }
		.srSpinner .bounce1 { -webkit-animation-delay: -0.32s; animation-delay: -0.32s; }
		.srSpinner .bounce2 { -webkit-animation-delay: -0.16s; animation-delay: -0.16s; }
		@-webkit-keyframes sk-bouncedelay { 0%, 80%, 100% { -webkit-transform: scale(0) } 40% { -webkit-transform: scale(1.0) } }
		@keyframes sk-bouncedelay { 0%, 80%, 100% { -webkit-transform: scale(0); transform: scale(0); } 40% { -webkit-transform: scale(1.0); transform: scale(1.0); } }
		.srTtsControls { position: absolute; bottom: 8px; left: 15px;  }
		.srTtsControls > div { float: left; }
		.srTtsMute { cursor: pointer; width: 25px; height: 25px; background: url("//app.meetami.ai/img/widget/mute-btn.svg") left top 4px / 20px auto no-repeat; }
		.srTtsControls.muted .srTtsMute { background-position: left top -22px; }
		.srTtsVolume { margin-left: 4px; margin-top: 2px; width: 32px; height: 20px; overflow-y: hidden; }
		.srTtsVolume .bar { cursor: pointer; overflow: hidden; height: 100%; width: 4px; margin-left: 2px; float: left; }
		.srTtsVolume .bar:after { content: ""; display: inline-block; background: #bfb6b8; width: 25px; height: 30px; margin-left: -5px; transform: rotateZ(-36deg); }
		.srTtsVolume .bar.active:after { background: #da4a97; }
		.srTtsControls.muted .srTtsVolume .bar:after { background: #bfb6b8; }
		.srTtsVolume .bar:nth-of-type(1) { padding-top: 18px; }
		.srTtsVolume .bar:nth-of-type(2) { padding-top: 14px; }
		.srTtsVolume .bar:nth-of-type(3) { padding-top: 10px; }
		.srTtsVolume .bar:nth-of-type(4) { padding-top: 6px; }
		.srTtsVolume .bar:nth-of-type(5) { padding-top: 2px; }
		#srChatter.delayed-creation .srTtsControls { display: none; }
		#srChatter.delayed-creation .srRecordVoice { bottom: 14px; }

		#srContent a.srCancelAppt { cursor: pointer; }
		#srContent a.srCancelApptBinary { display: inline-block; }
		#srContent a.srCancelApptBinary:first-of-type { margin-right: 5px; }
		#srContent a.srCancelApptBinary:last-of-type { background: #b9b9b9 !important; color: white !important; }

		#srRecordMobileUx { display: none; }

		.srDiscrete { position: absolute; bottom: 0; left: 0; padding: 8px; width: 38px; font-size: 14px; text-align: center; border-radius: 0 100% 0 0; background: rgba(0,0,0,0.05); color: #fff; box-sizing: border-box; }

		#srInputs.srForceFrameUserInput { height: 69px; }
		/* #srInputs.srForceFrameUserInput #hiddenFrame { width: 102.4%; height: 67px; margin-left: -2.3%; position: relative !important; } */
		#srInputs.srForceFrameUserInput #hiddenFrame { width: 96%; height: 67px; position: absolute !important; top: 4px; left: 4px; right: 10px; }
		#srInputs.srForceFrameUserInput #hiddenFrame.srInvisibleFrame { opacity: 0; left: 9999px; top: -9999px; }
		#srInputs.srForceFrameUserInput #hiddenFrame iframe { width: 100% !important; height: 100% !important; position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; }
		#srInputs.srForceFrameUserInput #srMsgSender { display: none; }
		#srInputs #srMsgSender.srNormalMsgSender  { display:block !important; }

		/* Responsive aspects */
		@media only screen and (min-height: 1px) and (max-height: 800px)  {
							#srContent { max-height: 75vh; }
					}

		#srLaunchContainer a.srCloseMobile.srMobileUx { display: none; }

		@media only screen and (min-width: 1px) and (max-width: 720px)  {

			#srInputs.srForceFrameUserInput #hiddenFrame { width: 97.6%; top: 22px; left: 1px; }

			#srContent { height: 60%; max-height: 100vh; width: 100%; bottom: 0; right: 0; left: 0; z-index: 1000001; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
							#srContent { min-height: 350px; }
						#srContent #srChatter #srMsgs { max-height: 80vh; }
			#srContent #srChatter form { position: absolute; bottom: 30px; }
			#srContent a.footerLnk, #srContent p.footerLnk { position: absolute; bottom: 0; right: 0; margin-right: 14px; }
			/* #srContent a.footerRate, #srContent p.footerRate { position: absolute; bottom: 0; left: 0; margin-right: 14px; } */
			#srContent #srFeedback form#srFbForm { position: relative; margin-top: 45px; }
			a#srLaunch, a#srLaunchPhone { right: -40px; bottom: -8px; width: 48px; height: 48px; }
			a#srLaunch img { width: 28px; height: 28px; margin: 10px auto; }
			a#srLaunchPhone { right: auto; left: -40px; }
			a#srLaunchPhone img { width: 26px; height: 26px; margin: 9px auto; }
			#srLaunchContainer { right: 54px !important; left: auto; }
			#srLaunchContainer .srBadge { right: 10px; bottom: 50px; left: auto; }
			#callbackLaunchContainer div.bubble-container { display: none !important; }
			#callbackLaunchContainer div.triangle { display: none !important; }

			/* MOBILE UX CHANGES */
			#srContent:not(.old) {
			 	width: 100% !important;
				max-width: auto !important;
				height: auto;
				background: transparent;
			    box-shadow: none;
				bottom: 0 !important;
				z-index: 1000000;
			}
			#srContent:not(.old) #srContentBoxShadow {
				width: 100%;
				height: 49px;
				box-shadow: 0 -6px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.23);
				position: absolute;
				left: 0;
				right: 0;
				bottom: 0px;
			}
			#srContent:not(.old).srMobileUxChatForm #srContentBoxShadow {
     			height: 193px;
			}
			#srContent:not(.old).srMobileUxDpQuestion #srContentBoxShadow {
				display: none !important;
			}
			#srContent:not(.old) #srChatter #srChatForm {
				width: 100%;
				position: absolute !important;
			}
							#srContent:not(.old) #srChatter #srChatForm #srMsgSender { width: 100%; }
				#srLaunchContainer:not(.old) { z-index: 999999 !important; }
				/* #srContent #srInputs > div.textarea > #srMsgSender { margin-left: 0; } */
				#srContent:not(.old) #srInputs #srMobileSendButton.srHasMsg { display: none !important; }
						#srContent:not(.old).srMobileUxChatForm #srChatter #srChatForm { width: 100%; padding: 0 2% !important; }
			#srContent:not(.old).srMobileUxDpQuestion #srChatter #srChatForm {
				width: 100%;
			}
			#srContent:not(.old) #srMobileSendButton {
				display: none;
				width: 20px;
			    height: 20px;
			    position: absolute;
			    top: 11px;
			    right: 17px;
			    border-radius: 50%;
				opacity: 0.7;
				transition: .1s all;
				cursor: pointer;
				background-image: url('//app.meetami.ai/img/widget/up.png');
				background-position: center;
		     	background-size: 54%;
			    background-repeat: no-repeat;
				background-color: #da4a97 !important;
			}
			#srContent:not(.old) #srMobileSendButton.srHasMsg {
				display: block !important;
			}
			#srContent:not(.old) #srMobileSendButton:hover {
				opacity: 1;
			}
			#srContent:not(.old) .loading-mini {
				display: none;
			}
			#srContent:not(.old) .feedback-prechat-container {
				width: 100%;
			    bottom: 42px;
			    left: 0;
			    padding: 8px 17px;
			}
			#srContent:not(.old) .feedback-prechat-container p {
			    background: #f2f2f2;
			    padding: 5px 0;
				box-shadow: 0 2px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.23);
				color: black !important;
    			margin: 0;
			}
			#srContent:not(.old) #srMsgs.prechat {
				bottom: 84px !important;
			}
			#srContent:not(.old).srWelcomeMessage {
				width: 100% !important;
				max-width: 100% !important;
			}
			#srChatter:not(.old) #srFeedback, #srChatter.old #srFeedback {
			  margin: 8px 9px;
				background: #f2f2f2;
				min-height: 0;
				overflow-y: auto;
				height: 80%;
			}
			#srChatter:not(.old) #srFeedback p {
				margin-bottom: 10px;
			}
			#srChatter:not(.old) #srFeedback form#srFbForm {
				bottom: 0 !important;
				margin-top: 0px !important;
			}
			#srLaunchContainer:not(.old).srInFeedbackState {
				display: none !important;
			}
							#srContent:not(.old) #srMsgs > p:not(.agent) { display: none; }
						#srContent:not(.old) #srMsgs p.srEndChat, #srContent:not(.old) #srMsgs div.srEndChat {
				/* background: #b9e7cc !important; */
				background-color: #b9e7cc !important;
				border: 1px solid #91bfa4 !important;
				color: #fcf6f6 !important;
			}
			#srContent:not(.old) #srMsgs p.srDPQuestion , #srContent:not(.old) #srMsgs div.srDPQuestion  {
				background-color: #c6e0ed !important;
				border: 1px solid #9eb8c5 !important;
				color: #000 !important;
			}
			#srLaunchContainer:not(.old) {
				right: 0px;
				bottom: 0px;
				height: 49px;
		    width: 8%;
		    min-width: 0;
				display: block;
				border-radius: 0;
				z-index: 1000001;
			}
			#srLaunchContainer:not(.old)[rel="srMinToggle"] {
				background: #f2f2f2;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx {
				position: absolute;
				bottom: 7px;
				right: 0;
				display: block;
				width: 100%;
				height: 100%;
				cursor: pointer;
				z-index: 400;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing .srMobileUxLoading svg, #srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing svg#srLaunchTxtSvg {
				display: none !important;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing .srMobileUxLoading .srSpinner {
				display: block !important;
      			margin: 15px auto 0 auto;
			    position: absolute;
			    right: 5px;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing .srMobileUxLoading .srSpinner > div {
				background-color: #da4a97;
			}

			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing .srMobileUxLoading {
			    background-position: -60px -47px;
				overflow: hidden;
				cursor: pointer;
				width: 51px;
				height: 46px;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx > div {
				position: absolute;
				bottom: 1px;
				right: 0;
				width: 52px;
				height: 28px;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx svg {
				position: absolute;
				bottom: 1px;
				right: 0;
		    width: 52px;
			  height: 28px;
			}
			#srMobileUxStartRec, #srLaunchTxtSvg {
				height: 39px !important;
			}
			#srLaunchTxtSvg {
				right: 9px !important;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx > div.srRecordVoice {
     			right: 10px;
				background-position: top right !important;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx svg#srMobileUxStartRec { right: 8px; }
			#srLaunchContainer:not(.old) #srMobileUxResumeRec svg { right: 2px; }
			#srLaunchContainer:not(.old) #srMobileUxStopRec svg { right: 2px; }

			@keyframes pulse {
			  	0% {
			    	opacity: 0.5;
			  	}
			  	50% {
			    	opacity: 1;
			  	}
				100% {
					opacity: 0.5;
				}
			}

			/* Default */
			#srLaunchContainer:not(.old) #srRecordMobileUx #srMobileUxStopRec,
			#srLaunchContainer:not(.old) #srRecordMobileUx .srMobileUxLoading,
			#srLaunchContainer:not(.old) #srRecordMobileUx #srMobileUxResumeRec,
			#srLaunchContainer:not(.old) #srRecordMobileUx .srRecordVoice {
				display: none;
			}

			#srContent:not(.old) a.srCloseMobile.srMobileUx {
				position: fixed; display: none;
				background: url('https://app.meetami.ai/img/widget/mobile/close.svg') left top no-repeat;
				width: 28px; height: 28px; bottom: 10px; left: 12px;
			}

			/* Recording */
			#srLaunchContainer:not(.old) #srRecordMobileUx.srRecording #srMobileUxStopRec {
				display: block;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srRecording #srMobileUxStopRec g path {
				opacity: 0.5;
				animation: pulse 2s infinite;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srRecording #srMobileUxStartRec {
				display: none;
			}

			/* Processing */
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing .srMobileUxLoading {
				display: block;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing #srMobileUxStartRec {
				display: none;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srProcessing #srMobileUxResumeRec {
				display: none;
			}

			/* Stopped recording */
			#srLaunchContainer:not(.old) #srRecordMobileUx.srStoppedRec:not(.srProcessing):not(.srRecording) #srMobileUxResumeRec {
				display: block;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srStoppedRec:not(.srProcessing) .srRecordVoice {
				display: block;
			}
			#srLaunchContainer:not(.old) #srRecordMobileUx.srStoppedRec:not(.srProcessing) #srMobileUxStartRec {
				display: none;
			}


			#srContent:not(.old) #srChatter {
			    box-shadow: none;
		     	position: absolute;
			    bottom: 0;
     			width: 100%;
			}
			#srContent:not(.old).srMobileUxChatForm #srChatter {
			    padding-bottom: 194px;
			}
			#srContent:not(.old).srNoAgentForm #srChatter {
			    padding-bottom: 215px;
			}
			#srContent:not(.old).srMobileUxDpQuestion #srChatter {
			    padding-bottom: 46px;
			}
			#srContent:not(.old) #srChatter #srMsgs {
				width: 100%;
				padding: 7px 7px;
				bottom: 49px;
     		position: absolute;
     		max-height: 100vh !important;
				min-height: auto !important;
				box-sizing: border-box;
				overflow: hidden;
			}
			#srContent:not(.old) #srChatter #srMsgs .srDPQuestionTempHidden {
				display: none;
			}
			#srContent:not(.old) #srChatter .srMobileUxEditActive input {
				width: 100%;
				height: 100%;
				padding: 7px 13px;
			}
			#srContent:not(.old) #srChatter .srMobileUxEditActive .srResponseEditSave, #srContent:not(.old) #srChatter .srMobileUxEditActive .srMsgInnerContent > p > span:not(.srResponseEditInputContainer), #srContent:not(.old) #srChatter .srMobileUxEditActive .srMobileUxEditButton {
				display: none;
			}
			#srContent:not(.old) #srChatter .srMobileUxEditActive .srMsgInnerContent > p {
				padding-left: 0 !important;
				margin: 0 !important;
			}
			#srContent:not(.old) #srChatter .srMobileUxEditActive {
				overflow: visible;
				padding: 0;
		     	width: 97%;
			    float: right;
			}
			#srContent:not(.old) #srChatter #srMsgs .srMobileUxEditActive .srMsgInner.srMobileUxEdit .srInnerImg {
				top: -2px !important;
				left: -15px !important;
				background: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzMuMSAzMS40IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMy4xIDMxLjQ7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KCjxyZWN0IHg9Ii0wLjYiIHk9Ii0wLjYiIGZpbGw9Im5vbmUiIHdpZHRoPSIzNC4zIiBoZWlnaHQ9IjMzLjEiLz4KPGc+Cgk8Zz4KCQk8Y2lyY2xlIGNsYXNzPSJhdmF0YXJGaWxsIiBmaWxsPScjZGE0YTk3JyBjeD0iMTYiIGN5PSIxNC44IiByPSIxMi44Ii8+Cgk8L2c+CjwvZz4KPHBvbHlnb24gZmlsbD0iI2ZmZiIgcG9pbnRzPSIyMy41LDE5LjcgMTcuOCwxOS43IDE2LDIyIDEzLjgsMTkuNyA4LjUsMTkuNyA4LjUsOSAyMy41LDkgIi8+Cjwvc3ZnPgo=') top left / 32px auto no-repeat !important;
			}
			#srContent:not(.old) #srChatter .srMobileUxEditButton {
				text-decoration: underline;
				cursor: pointer;
			}
			#srContent:not(.old) #srChatter .srResponseEditInputContainer input {
				font-size: 13px !important;
			}
			#srContent:not(.old) #srChatter .srResponseEditInputContainer input.srInputDisabled {

			}
			#srContent:not(.old) #srMsgs p, #srContent:not(.old) #srMsgs > div {
				background: #ffffff;
				width: 96%;
				padding: 3px 7px 7px 7px;
				margin: 5px 2% 0 2%;
			  border-radius: 0px;
				box-shadow: 0 2px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.23);
				font-size: 12px;
     		overflow: hidden;
				box-sizing: border-box;
			}
			#srContent:not(.old) #srMsgs p.agent, #srContent:not(.old) #srMsgs p.agent p, #srContent:not(.old) #srMsgs p.agent div,
			#srContent:not(.old) #srMsgs div.agent, #srContent:not(.old) #srMsgs div.agent p, #srContent:not(.old) #srMsgs div.agent div {
				background: #f2f2f2;
			}
			#srContent:not(.old) #srMsgs > p > .srMsgInner, #srContent:not(.old) #srMsgs > div > .srMsgInner {
			    /* width: 100% !important; */
				position: relative;
				width: auto !important;
				display: flex;
			}
			#srContent #srMsgs .srMsgInner p > span:first-of-type {
				margin-bottom: 2px;
				display: block;
				font-weight: bold;
			}
			#srContent:not(.old) #srMsgs > p.srDismissed, #srContent:not(.old) #srMsgs > div.srDismissed {
				display: none !important;
			}
			#srContent:not(.old) #srMsgs .srMsgInner .srMsgInnerContent {
				width: 100%;
				float: left;
			}
			#srContent:not(.old) #srMsgs .srMsgInner .srMsgInnerContent p {
				width: 100%;
				padding: 0 6px 0 0;
				box-shadow: none;
				float: left;
     		padding-left: 40px;
				box-sizing: border-box;
			}
			#srContent:not(.old) #srMsgs .srMsgInner .srDismiss {
				width: 75px;
				height: 100%;
				right: -111px;
				position: absolute;
     		margin-top: 2px;
				border-left: double #b7b7b7;
				cursor: pointer;
			}
			#srContent:not(.old) #srMsgs .srMsgInner .srDismissInner {
				width: 100%;
				height: 14px;
				position: absolute;
				text-align: center;
				top: 50%;
				margin-top: -7px;
			}
			#srContent:not(.old) #srChatter #srMsgs .srEndChat, #srContent:not(.old) #srChatter #srMsgs .srDPQuestion {
				width: 100%;
				margin: 5px 0 0 0;
			    padding: 13px 7px 14px 45px;
				background-color: #f2f2f2;
				border-radius: 0px;
				box-shadow: 0 2px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.23);
				border: none;
			}
						#srContent:not(.old) #srChatter #srMsgs .srEndChat .srMsgInner .srInnerImg, #srContent:not(.old) #srChatter #srMsgs .srDPQuestion .srMsgInner .srInnerImg {
				display: none;
			}
			#srContent:not(.old) #srChatter #srMsgs .srEndChat .srMsgInner .srMsgInnerContent p {
				background: none;
			}
			#srContent:not(.old) #srChatter #srMsgs .srDPQuestion .srMsgInner .srMsgInnerContent p {
				padding: 0;
			}
			#srContent:not(.old) #srMsgs > p span:first-of-type, #srContent:not(.old) #srMsgs > div span:first-of-type {
				font-size: 14px;
			}
			#srContent:not(.old) #srMsgs .srEndChat.phone p {
				background: none !important;
				box-shadow: none !important;
			}

						#srContent:not(.old) #srMsgs .srMsgInner .srInnerImg { position: absolute; content: ''; display: block; width: 37px; height: 35px; float: left; top: 50%; margin-top: -14px; background: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgMzMuMSAzMS40IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMy4xIDMxLjQ7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPHN0eWxlIHR5cGU9InRleHQvY3NzIj4KCS5hdjB7ZmlsbDojRkZGRkZGO30KCS5hdjF7ZmlsbDojRjJGMkYyO30KCS5hdjJ7ZmlsbDojMUYxQkREO30KPC9zdHlsZT4KPHJlY3QgeD0iLTAuNiIgeT0iLTAuNiIgZmlsbD0iI2ZmZiIgd2lkdGg9IjM0LjMiIGhlaWdodD0iMzMuMSIvPgo8Zz4KCTxnPgoJCTxjaXJjbGUgZmlsbD0iI2YyZjJmMiIgY3g9IjE2IiBjeT0iMTQuOCIgcj0iMTIuOCIvPgoJPC9nPgo8L2c+Cjxwb2x5Z29uIGZpbGw9IiNkYTRhOTciIHBvaW50cz0iMjMuNSwxOS43IDE3LjgsMTkuNyAxNiwyMiAxMy44LDE5LjcgOC41LDE5LjcgOC41LDkgMjMuNSw5ICIvPgo8L3N2Zz4K') top left / 34px auto no-repeat; background-size: 37px 35px; }
			#srContent:not(.old) #srMsgs > p.agent > .srMsgInner .srInnerImg, #srContent:not(.old) #srMsgs > div.agent > .srMsgInner .srInnerImg { background: url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB3aWR0aD0iMzMuMXB4IiBoZWlnaHQ9IjMxLjRweCIgdmlld0JveD0iLTI4MCA0MDUuNDkgMzMuMSAzMS40IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IC0yODAgNDA1LjQ5IDMzLjEgMzEuNDsiCgkgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+CgkuYXZhdGFye2ZpbGw6I0YyRjJGMjt9CgkuYXZhdGFyMXtmaWxsOiNGRkZGRkY7fQoJCS5hZ2VudC1hdmF0YXItc3BlZWNoLWJ1YmJsZSB7CgkJYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogZWFzZS1pbi1vdXQ7CgkgIAlhbmltYXRpb246IGZhZGVvdXRpbiA4cyBpbmZpbml0ZTsgLyogSUUgMTArLCBGeCAyOSsgKi8KCQktd2Via2l0LWFuaW1hdGlvbjogZmFkZW91dGluIDhzIGluZmluaXRlOyAvKiBTYWZhcmkgNCsgKi8KCSAgCS1tb3otYW5pbWF0aW9uOiBmYWRlb3V0aW4gOHMgaW5maW5pdGUgOyAvKiBGeCA1KyAqLwoJICAJLW8tYW5pbWF0aW9uOiBmYWRlb3V0aW4gOHMgaW5maW5pdGU7IC8qIE9wZXJhIDEyKyAqLwoJCWFuaW1hdGlvbi1pdGVyYXRpb24tY291bnQ6IGluZmluaXRlOwoJCWFuaW1hdGlvbi1kZWxheTogNXM7CgkJcG9zaXRpb246IHJlbGF0aXZlOwoJCXotaW5kZXg6IDE7Cgl9CgkuYWdlbnQtYXZhdGFyLXBsYXktaWNvbiB7CgkJcG9zaXRpb246IHJlbGF0aXZlOwoJCXotaW5kZXg6IC0xOwoJfQo8L3N0eWxlPgo8cGF0aCBjbGFzcz0iYWdlbnQtYXZhdGFyLXBsYXktaWNvbiIgZmlsbD0nI2RhNGE5NycgZD0iTS0yNTguNDIsNDE5LjkzbC04LjI5LTQuMTVjLTAuMi0wLjEtMC40NC0wLjAyLTAuNTQsMC4xOGMtMC4wMywwLjA1LTAuMDQsMC4xMS0wLjA0LDAuMTh2OC4yOWMwLDAuMjIsMC4xOCwwLjQsMC40LDAuNAoJYzAuMDYsMCwwLjEyLTAuMDEsMC4xOC0wLjA0bDguMjktNC4xNWMwLjItMC4xLDAuMjgtMC4zNCwwLjE4LTAuNTNDLTI1OC4yOCw0MjAuMDMtMjU4LjM0LDQxOS45Ny0yNTguNDIsNDE5LjkzeiBNLTI2Ni40OSw0MjMuNzkKCXYtN2w3LDMuNUMtMjU5LjQ5LDQyMC4yOS0yNjYuNDksNDIzLjc5LTI2Ni40OSw0MjMuNzl6Ii8+CjxwYXRoIGNsYXNzPSJhZ2VudC1hdmF0YXItcGxheS1pY29uIiBmaWxsPScjZGE0YTk3JyBkPSJNLTI2NCw0MDcuNTRjLTcuMDQsMC0xMi43NSw1LjcxLTEyLjc1LDEyLjc1czUuNzEsMTIuNzUsMTIuNzUsMTIuNzVzMTIuNzUtNS43MSwxMi43NS0xMi43NVMtMjU2Ljk2LDQwNy41NC0yNjQsNDA3LjU0egoJIE0tMjY0LDQzMi4yNGMtNi41OSwwLTExLjk1LTUuMzYtMTEuOTUtMTEuOTVzNS4zNi0xMS45NSwxMS45NS0xMS45NXMxMS45NSw1LjM2LDExLjk1LDExLjk1Uy0yNTcuNDEsNDMyLjI0LTI2NCw0MzIuMjR6Ii8+CiA8cGF0aCBmaWxsPScjZmZmJyBjbGFzcz0iYXZhdGFyIGFnZW50LWF2YXRhci1zcGVlY2gtYnViYmxlIiBkPSJNLTI4MC42LDQwNC44OWgzNC4zdjMzLjFoLTM0LjNWNDA0Ljg5eiIvPgogPGNpcmNsZSBjbGFzcz0iYWdlbnQtYXZhdGFyLXNwZWVjaC1idWJibGUiIGZpbGw9JyNkYTRhOTcnIGN4PSItMjY0IiBjeT0iNDIwLjI5IiByPSIxMi44Ii8+CiA8cGF0aCBmaWxsPScjZGE0YTk3JyBjbGFzcz0iYXZhdGFyMSBhZ2VudC1hdmF0YXItc3BlZWNoLWJ1YmJsZSIgZD0iTS0yNTYuNSw0MjUuMTloLTUuN2wtMS44LDIuM2wtMi4yLTIuM2gtNS4zdi0xMC43aDE1VjQyNS4xOXoiLz4KPC9zdmc+Cg==') top left / 34px auto no-repeat; }
			#srContent:not(.old) #srMsgs .srMsgInner .srInnerImg.has-img { background: none !important; }
			#srContent:not(.old) #srMsgs > p .avatar-mini.tt,
			#srContent:not(.old) #srMsgs p:before,
			#srContent:not(.old) #srMsgs > p.agent:before,
			#srContent.srWelcomeMessage:not(.old)::after,
			#srContent:not(.old) .footerLnk,
			#srContent:not(.old) .feedback-upper-container,
			#srContent:not(.old) #srMsgs > p:after,
			#srContent:not(.old) #srHeader,
			#srContent:not(.old) #srChatter.srFeedback,
			#srContent:not(.old) .srTtsControls,
			#srLaunchContainer:not(.old) #srLaunch,
			#srContent:not(.old) #srMsgs > span,
			/* #srContent:not(.old) #srInputs, */
			#srContent:not(.old) #srMsgs .loading,
			#srContent:not(.old) #srMsgs .srCloseOverlay, #srContent:not(.old) #srMsgs #srCloseOverlay,
			#srContent:not(.old) #srCloseOverlay,
			#srContent:not(.old) .loading,
			/* #srContent:not(.old) #srMsgSender, */
			#srContent:not(.old) #srChatForm #srInputs .srDataSecure {
				display: none !important;
			}
			#srContent:not(.old) #srMsgSender {
				font-size: 15px !important;
				height: 30px !important;
     			/* border-radius: 30px !important; */
     			overflow: hidden !important;
				border: solid 0px rgba(68,68,68,0.2) !important;
				padding-right: 28px !important;
			}
			#srContent:not(.old) #srChatForm.srMobileUxDpQuestion {
				background: transparent;
				border: none;
				box-shadow: none;
			}
			#srContent:not(.old) #srChatForm.srMobileUxDpQuestion #srInputs {
				display: block !important;
				padding: 0;
			}
			#srContent:not(.old) #srChatForm #srInputs .srFormBtn {
			    margin: 6px auto 8px auto;
			}
			#srContent:not(.old) #srMsgs div p.feint {
				box-shadow: none;
			}
			#srContent:not(.old) #srMsgs .feintMsg .srInnerImg {
				display: none;
			}
			#srContent:not(.old) #srMsgs .feintMsg p.feint {
				padding-left: 0;
			}
			#srContent:not(.old).srMobileUxChatForm {
			    padding-bottom: 200px;
			}
			#srContent:not(.old).srMobileUxChatForm #srInputs {
				height: auto !important;
			}
			#srContent:not(.old).srMobileUxChatForm #srMsgs {
				bottom: 202px !important;
			}
			#srContent:not(.old).srMobileUxDpQuestion {
			    padding-bottom: 39px;
			}
			#srContent:not(.old) #srMsgs .srDPQuestion p {
				background: none !important;
			}
			#srLaunchContainer:not(.old).srMobileUxChatForm #srRecordMobileUx, #srLaunchContainer:not(.old).srMobileUxDpQuestion #srRecordMobileUx {
				opacity: 0.6;
				cursor: disabled;
				display: none;
			}
			#srLaunchContainer:not(.old).srMobileUxChatForm, #srLaunchContainer:not(.old).srMobileUxDpQuestion {
				display: none !important;
			}
			#srLaunchContainer:not(.old).srMobileUxChatForm #srRecordMobileUx #srMobileUxStartRec, #srLaunchContainer:not(.old).srMobileUxDpQuestion #srRecordMobileUx #srMobileUxStartRec {
				display: none !important;
			}
			#srLaunchContainer:not(.old).srMobileUxChatForm #srRecordMobileUx #srMobileUxResumeRec, #srLaunchContainer:not(.old).srMobileUxDpQuestion #srRecordMobileUx #srMobileUxResumeRec {
				display: block !important;
			}
			#srContent:not(.old) #srChatter #srChatForm .input.text:nth-child(2) {
				border: none;
			}
			#srContent:not(.old) #srChatter #srChatForm {
				background: #f2f2f2;
			    width: 100%;
			    padding: 0 0 0 36px;
				/* box-shadow: 0 2px 20px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.23); */
				bottom: 0px;
    			left: 0px;
				margin: 0 !important;
			}
			#srContent:not(.old) #srInputs {
     			margin-top: 4px !important;
     			padding: 6px 18px;
      		height: 45px;
					box-sizing: border-box;
			}
			/* #srContent:not(.old) #srInputs:after {
				content: "";
			    height: 59px;
			    background: #f2f2f2;
			    width: 300px;
			    position: absolute;
			    right: -300px;
			    top: -4px;
     			z-index: 300;
			} */
			#srContent:not(.old) .srRecordVoice {
				display: none;
			}
			#srContent:not(.old).srMobileUxChatForm #srChatForm #srInputs, #srContent:not(.old).srMobileUxDpQuestion #srChatForm #srInputs {
				display: block !important;
				padding: 3px 7px 7px 7px;
    			margin-top: 0;
			}
			#srContent:not(.old) #srChatForm #srInputs label {
				/* display: none; */
    			font-size: 12px;
			}
			#srContent:not(.old) #srChatForm #srInputs input {
		     	padding: 5px 6px !important;
			    font-size: 13px !important;
     			margin-bottom: 5px;
     			border-radius: 2px;
			}
			#srContent:not(.old) #srChatForm #srInputs input#phone {
				margin-bottom: 0;
			}
			
			/* New Mobile UX changes (v2) */
			#srContent.old {
				margin: 0 1%;
				width: 98%;
			}
			#srContent.old .srRecordVoice {
			  right: 25px;
			  bottom: 5px;
				width: 34px;
				height: 35px;
			}
			.srTtsControls {
				display: none !important;
			}
			#srContent #srMsgs {
				height: 100%;
			}
			/* MOBILE UX CHANGES */

			.srRecordVoice { right: 20px; bottom: 18px;  }

			#srLaunchContainer #srPreviewMessage {
				margin-top: 33px;
				right: 5px;
				left: auto;
				padding: 8px 0;
			}
			.srWelcomeImage { right: 10px; }
			#srContent.srWelcomeMessage { max-width: 98%; bottom: 0; }
			#srContent.srWelcomeMessage:after { right: 10px; }
			#srContent.srWelcomeMessage #srChatter form { bottom: 18px; }

			#srIcBtn { max-width: 96%; }
			#feedback-callback-form input[type="text"],#scheduleCallback input[type="text"], #feedback-callback-form input[type="email"], #feedback-callback-form input[type="tel"], #srCover .srCoverContent textarea#rlMsg, #srCoverRecovery .srCoverContentRecovery textarea#srchMsg, #srCover .srCoverContent .textarea textarea, #srCover .srCoverContent .textarea textarea, #srCover .srCoverContent .text input, #srCover .srCoverContent .email input, #srCover .srCoverContent .tel input, #srCoverRecovery .srCoverContentRecovery .text input, #srCoverRecovery .srCoverContentRecovery .email input, #srCoverRecovery .srCoverContentRecovery .tel input, #srContent #srInputs .textarea textarea, #srContent #srFeedback .textarea textarea, #srContent #srInputs .text input, #srContent #srInputs .email input { border: solid 1px rgba(68,68,68,0.2); -moz-box-shadow: none; -webkit-box-shadow: none; box-shadow: none; }
			#srContent #srInputs .textarea textarea, #srContent #srInputs .text input, #srContent #srInputs .text input, #srContent #srInputs .email input, #srContent select, #srContent #srChatter #srMsgs .srEndChat #srSelectTime { font-size: 16px; }

			#srContent .feedback-prechat-container { position: absolute; bottom: 78px; left: 7.5%; margin: 5px auto; }

			#srContent #srFeedback  { min-height: 370px; }

			#srContent a.footerLnk { background: none !important; bottom: -10px; }
			#srContent a.footerLnk > span { font-variant: small-caps; color: #C1BCBD !important; display: inline; margin-left: 0; }
			#srContent #srInputs .textarea textarea { margin-bottom: -14px; }
		}

		@media only screen and (min-width: 1px) and (max-width: 540px)  {

			#srLaunchContainer:not(.old) { width: 11%; }
			#srContent:not(.old) #srChatter #srChatForm {
				width: 100%;
			}

		}

		@media screen and (-webkit-min-device-pixel-ratio:0) and (min-width: 1px) and (max-width: 720px) {
			/* Hack to prevent iOS devices trying to zoom in */
		  #srContent textarea,
		  #srContent input {
		    font-size: 16px !important;
		  }
		}

		/* Hack to display arrows properly on iPhone + not as emojis */
		#srContent #srMsgs > p.agent:after, #srContent #srMsgs > p:after { font-family: 'Hiragino Mincho ProN'; }


		/* Handle forms when we are on a landscape mobile */
		@media only screen and (min-height: 1px) and (max-height: 460px)  {

			#srContent #srChatter #srMsgs { min-height: 80px !important; }
			/* #srContent #srChatter #srChatForm { bottom: 20px; } */
			#srContent #srChatter #srChatForm.details { max-height: 55vh; /*top: 120px;*/ overflow-y: scroll; }
			#srContent #srChatter #srChatForm.details + a.footerLnk { display: none; }

		}

	</style>

	<!--[if lte IE 8]>
		<style type='text/css'>
			#srContent, #srLaunchContainer { display: none !important; }
		</style>
	<![endif]-->

	<div id="callbackCover">
		<div class="formContainer">
			<a class="callbackCloseBtn" href="#close" style="display: inline-block;">(x) Close</a>
						<div class="callbackCoverContent futureCallbackCoverContent" style="display:block">
				<div class="header">
					<img class="avatar" src="https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/widget/default-avatar.png"> Schedule a Call
				</div>
				<div class="content">
					<p>Schedule your call when it's convenient for you</p>
					<form action="/chats/chat/168019131601" id="scheduleFutureCallback" class="callbackForm" method="post" accept-charset="utf-8"><div style="display:none;"><input type="hidden" name="_method" value="POST"><input type="hidden" name="data[_Token][key]" value="00b035d9ed85165a7946d96e2b23393f50b425689b6c97d16dbdf23ea7ece3986fe326639616f3ff6ff57ca74b1003539775488a12b75c2f95c7d17fbb9aac59" id="Token19817471" autocomplete="off"></div>												<div class="input text"><label for="srNameRL">Your name</label><input name="data[Chat][full_name]" id="srNameRL" required="required" type="text"></div>						<p style="margin-bottom:0.5rem">When would you like your call? </p>
						<div class="input half">
														<div class="input select"><select name="data[Chat][callback_day]" id="ChatCallbackDay">
</select></div>						</div>

						<div class="input half" style="margin-left:1%">
							<div class="input select"><select name="data[Chat][callback_time]" id="ChatCallbackTime">
</select></div>						</div>


						<div class="input text"><label for="srPhoneRL">Phone number</label><input name="data[Chat][phone_no]" id="srPhoneRL" required="required" type="text"></div>						<p class="data"><span class="lock" style="background: url(&quot;https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/widget/padlock.png&quot;) repeat 0 0;"></span><a href="#">Data Once</a>.  We don't share any of your information</p>
						<a href="#callback" class="button main-button" id="request-callback-scheduled-btn">Schedule Call</a>					<div style="display:none;"><input type="hidden" name="data[_Token][fields]" value="4af02738d8784398c5972e8e8d5c9176336435eb%3A" id="TokenFields1883825597" autocomplete="off"><input type="hidden" name="data[_Token][unlocked]" value="" id="TokenUnlocked2146120832" autocomplete="off"></div></form>					<hr>
					 				</div>
			</div>
		</div>
	</div>

			
		
		
		
		
		

					<!-- Chat widget -->
			<!-- launch button -->
			<div id="srLaunchContainer" rel="srChatToggle" class="old">
				<div id="srPreviewMessage" style="display:none;">
					<div class="srPreviewMessageContent">
						<span class="avatar-preview">
							<img src="//app.meetami.ai/img/widget/mini-avatar-lrg.png">
						</span>
						<p></p>
					</div>
				</div>
									<a href="#chat" id="srLaunch" class="ami-icon"><img src="//app.meetami.ai/img/widget/sr-icon.svg" alt="Ami Icon"></a>								<span id="srUnreadCount" class="srBadge">0</span>
								<div id="srRecordMobileUx">
											<svg version="1.1" id="srLaunchTxtSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 57.2 43.5" style="enable-background:new 0 0 57.2 43.5;" xml:space="preserve">
<style type="text/css">
	.lchattxt{fill:#da4a97;stroke:#da4a97;stroke-width:0.75;stroke-miterlimit:10;}
	.lchattxt1{fill:#FFFFFF;stroke:#da4a97;stroke-width:0.5;stroke-miterlimit:10;}
</style>
<title>Artboard 2</title>
<path class="lchattxt" d="M3.7,35.8h20l4.7,5.1l4.2-5.1h20.7c1.1,0,2-0.9,2-2V4.5c0-1.1-0.9-2-2-2H3.7c-1.1,0-2,0.9-2,2v29.4
	C1.8,35,2.6,35.8,3.7,35.8z"></path>
<path class="lchattxt1" d="M26,26.7h12.6l1.8,1.9l1.6-1.9h2.8c0.4,0,0.8-0.3,0.8-0.8V14.9c0-0.4-0.3-0.8-0.8-0.8H26
	c-0.4,0-0.8,0.3-0.8,0.8V26C25.3,26.4,25.6,26.7,26,26.7z"></path>
<path class="lchattxt1" d="M11.4,22.6h2.6l1.8,1.9l1.6-1.9h12.8c0.4,0,0.8-0.3,0.8-0.8V10.8c0-0.4-0.3-0.8-0.8-0.8H11.4
	c-0.4,0-0.8,0.3-0.8,0.8v11.1C10.6,22.3,10.9,22.6,11.4,22.6z"></path>
</svg>
										
					<div class="srMobileUxLoading">
						<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 57.2 43.5" style="enable-background:new 0 0 57.2 43.5;" xml:space="preserve">
<style type="text/css">
	.emptyFill{fill:#fff;stroke:#da4a97;stroke-width:0.75;stroke-miterlimit:10;}
</style>
<title>Artboard 2</title>
<path class="emptyFill" d="M3.7,35.8h20l4.7,5.1l4.2-5.1h20.7c1.1,0,2-0.9,2-2V4.5c0-1.1-0.9-2-2-2H3.7c-1.1,0-2,0.9-2,2v29.4
	C1.8,35,2.6,35.8,3.7,35.8z"></path>
</svg>
						<div class="srSpinner">
							<div class="bounce1"></div>
							<div class="bounce2"></div>
							<div class="bounce3"></div>
						</div>
					</div>

				</div>
			</div>
			<div class="srWelcomeImage">
				<a href="#min" id="srImgMin"><img src="//app.meetami.ai/img/widget/plus-icon.svg" alt=""></a>				<img src="">
			</div>

			<!-- Widget itself -->
			<div id="srContent" class="old" style="position: fixed;">
				<!-- srHeader -->
				<div id="srHeader">
					<h4>
						<span id="srMenu"></span>
						<span id="srIcon"><img src="//app.meetami.ai/img/widget/header-icon.png" alt="Ami Icon"></span>
						&nbsp;
					</h4>
				</div>
				<!-- srContent -->
				<div id="srChatter" class="old">
					<div id="srContentBoxShadow"></div>
<div id="srError"></div>
<div id="srMsgs" class="">
	<img src="//app.meetami.ai/img/core/bg/loading.gif" class="loading" alt="Loading..."></div>


<form action="/chats/chat/168019131601" id="srChatForm" method="post" accept-charset="utf-8"><div style="display:none;"><input type="hidden" name="_method" value="POST"><input type="hidden" name="data[_Token][key]" value="00b035d9ed85165a7946d96e2b23393f50b425689b6c97d16dbdf23ea7ece3986fe326639616f3ff6ff57ca74b1003539775488a12b75c2f95c7d17fbb9aac59" id="Token391794377" autocomplete="off"></div>	<a href="#close" rel="srChatToggleMobile" class="srCloseMobile srMobileUx"></a>
	<div id="srInputs">
		<div class="input textarea"><textarea name="data[Chat][message]" id="srMsgSender" required="required" placeholder="Press [Enter] to send" cols="30" rows="6"></textarea><div id="srMobileSendButton"></div></div>			</div>
	<input type="hidden" name="data[Chat][page_url]" id="pageUrl">	<input type="hidden" name="data[Chat][chat_ref]" id="chat_ref"><div style="display:none;"><input type="hidden" name="data[_Token][fields]" value="40946c25d36699ccb48255d801b260e1cfca82f9%3AChat.chat_ref%7CChat.page_url" id="TokenFields1476361286" autocomplete="off"><input type="hidden" name="data[_Token][unlocked]" value="" id="TokenUnlocked1958215180" autocomplete="off"></div></form>

	<a href="http://www.meetami.ai" target="_blank" class="footerLnk">Powered By <span>Ami</span></a>				</div>
				<div id="srCloseOverlay">
					<div id="srCloseContent">
						<p>Are you sure you want to end this chat?</p>
						<div id="srCloseButtons">
							<div class="srCloseButton srYes">
								<p>Yes,</p>
								<p>end the chat</p>
							</div>
							<div class="srCloseButton srNo">
								<p>No,</p>
								<p>continue chatting</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		
		<input type="hidden" name="data[agents]" id="agentsList">		<input type="hidden" name="data[ami_agents]" id="amiAgentsList" value="">		<input type="hidden" name="data[ami_status]" id="amiAgentsStatus" value="0">		<input type="hidden" name="data[ic_chats]" id="icChats" value="0">		<input type="hidden" name="data[have_no]" value="0" id="srNoExists">		<input type="hidden" name="data[chat_dept]" id="chatDept">
	
	
	<div id="srCloseTrigger"></div>

	<audio id="chink" src="//app.meetami.ai/js/sound/what-another-message.mp3" preload="auto"></audio>

	<audio id="ttsPlaylist"></audio>

	
	
	<script>
	window.siteUrl = 'app.meetami.ai';
	var tts_empty_msg= 'Sorry I didn’t catch that could you repeat it please?';
	var clientAutoSendTime = '5000';

	</script>

	<script type="text/javascript">

		if (typeof define === 'function' && define.amd) {
			requirejs(["//app.meetami.ai/js/socket-io.js"], function (io) {
				srRunWidget(io);
			});
		} else {
			srRunWidget(io);
		}

	 function srRunWidget(io) {
     var initPosn = $srJq('#srContent').css('position');
console.log('INIT POSN: ' + initPosn);
		// Set the browser viewport to minimise issues on iOS
		$srJq(function($) {
			$srJq('meta[name=viewport]').first().replaceWith('<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">');
		});

		var client_ref = '168019131601';
		var auto_delay = '5';
		var character_count_threshold = '350';

		var domain_parts = window.location.hostname.split('.');
		var sub_domain = domain_parts.shift();
		var domain = domain_parts.join('.');
		if(domain == '' || domain.indexOf('.') < 1 || domain == 'co.uk' || domain == 'uk.com' || domain == 'org.uk'){
			domain = window.location.hostname;
		}
		if (domain != 'localhost'){
			domain = '.' + domain;
		}

		if(/Trident.*rv[ :]*11\./.test(navigator.userAgent) || /Edge\/\d./i.test(navigator.userAgent)) domain = "";

		var sr_data = {};

		var chat_dom = "<div id='srContentBoxShadow'></div><div id='srError'></div><div id='srMsgs' class=''>	<img src="//app.meetami.ai/img/core/bg/loading.gif" class="loading" alt="Loading..." /></div><form action="/chats/chat/168019131601" id="srChatForm" method="post" accept-charset="utf-8"><div style="display:none;"><input type="hidden" name="_method" value="POST"/><input type="hidden" name="data[_Token][key]" value="00b035d9ed85165a7946d96e2b23393f50b425689b6c97d16dbdf23ea7ece3986fe326639616f3ff6ff57ca74b1003539775488a12b75c2f95c7d17fbb9aac59" id="Token391794377" autocomplete="off"/></div>	<a href="#close" rel="srChatToggleMobile" class="srCloseMobile srMobileUx"></a>	<div id='srInputs'>		<div class="input textarea"><textarea name="data[Chat][message]" id="srMsgSender" required="required" placeholder="Press [Enter] to send" cols="30" rows="6"></textarea><div id="srMobileSendButton"></div></div>			</div>	<input type="hidden" name="data[Chat][page_url]" id="pageUrl"/>	<input type="hidden" name="data[Chat][chat_ref]" id="chat_ref"/><div style="display:none;"><input type="hidden" name="data[_Token][fields]" value="40946c25d36699ccb48255d801b260e1cfca82f9%3AChat.chat_ref%7CChat.page_url" id="TokenFields1476361286" autocomplete="off"/><input type="hidden" name="data[_Token][unlocked]" value="" id="TokenUnlocked1958215180" autocomplete="off"/></div></form>	<a href="http://www.meetami.ai" target="_blank" class="footerLnk">Powered By <span>Ami</span></a>";

		var isMobileUx = window.outerWidth <= 736 ? true : false;
		var dismissTime = 10000; // ms
		var dismissTimeouts = [];
		var isInputMsg = true;
		var filterFormSelectors = null;
		var srSwAutoTimer = setTimeout(function() {}, 1);
		var department_hours = [];

						department_hours[270] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[272] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[273] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[271] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[336] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[337] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[338] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[339] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[340] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[343] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[342] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[344] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[348] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[352] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[385] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[386] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[387] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[389] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[390] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[391] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[392] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[393] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[394] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[395] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[388] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[397] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
								department_hours[408] = {
					times: {
						opening: '',
						closing: '',
					},
					open: false,
					hasFutureHours: false
				}
						// setInterval(function() {
		// 	// console.log("filterFormSelectors", filterFormSelectors);
		// }, 2000);

		
		function srDisplayFailure () {
					}

		function srDisplaySuccess () {
					}

		function prepareMobileUxChatForm() {
			if (isMobileUx) {
				$srJq("#srContent").addClass("srMobileUxChatForm");
				$srJq("#srLaunchContainer").addClass("srMobileUxChatForm");
				$srJq("#srChatForm").find("input").off();
				$srJq("#srChatForm").find("input").on("keydown", function(e) {
					console.log(e.keyCode);
					if(e.keyCode == 13) {
						var params = $srJq('a[rel="srSubmitMessage"]').attr('name');
						if(typeof params != 'undefined'){
							submitMessage(params);
						} else {
							submitMessage();
						}
						$srJq("#srContent").removeClass("srMobileUxChatForm");
						$srJq("#srLaunchContainer").removeClass("srMobileUxChatForm");
					}
				});
			}
		}

		function bindChatMessageDraggable() {
			if(isMobileUx) {
				if($srJq("#srContent #srChatter #srMsgs").length == 0) return false;
				// $srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").draggable("destroy");
				$srJq("#srContent #srChatter #srMsgs > p:not(.srDPQuestion) .srMsgInner, #srContent #srChatter #srMsgs > div:not(.srDPQuestion) .srMsgInner").draggable({
					axis: "x",
					containment: [
						$srJq("#srContent #srChatter #srMsgs").offset().left - 90,
						$srJq("#srContent #srChatter #srMsgs").offset().top,
						17,
						$srJq("#srContent #srChatter #srMsgs").offset().bottom
					],
					stop: function(event, ui) {
						if(parseInt(ui.helper.css("left").replace("px", "")) > -70) {
							var to = "0px";
						} else {
							var to = "-106px";
						}
						ui.helper.animate({
							left: to
						}, "fast");
					}
				});

				$srJq.fn.ignore = function(sel){
				  	return this.clone().find(sel||">*").remove().end();
				};

				$srJq("#srContent #srChatter #srMsgs .srDismiss").click(function() {
					var msgToDismiss = $srJq(this).parents(".srMsgInner").find(".srMsgInnerContent").ignore("span").text().trim();
					dismissUpToMsg(msgToDismiss);

					var elems = [];
					elems.push($srJq(this).parents(".srMsgInner").parent());
					$srJq(this).parents(".srMsgInner").parent().prevAll('div, p').each(function(index, value) {
						elems.push($srJq(value));
					});

					$srJq.each(elems, function(index, value) {
						$srJq(value).animate({
							opacity: 0
						}, 200, function() {
							$srJq(value).css("opacity", 1);
							$srJq(value).addClass("srDismissed");
						});
					});
				});
			}
		}

		function dismissSpecificMsg(msgToDismiss, noDismissPre) {
			var chat_ref = getChatId();
			var uncorruptedMsgToDismiss = msgToDismiss;
			if(msgToDismiss == "") return false;
			msgToDismiss = msgToDismiss.replace(/<(?:.|\n)*?>/gm, ''); // Remove html elements
			msgToDismiss = msgToDismiss.replace(/(\r\n\t|\n|\r\t)/gm,'').replace(/[^a-zA-Z0-9 !?]+/g, '');; // Remove new lines
			$srJq("#srMsgs").find(".srMsgInnerContent").each(function(index, value) {
				var msg = $srJq(value).find("p").ignore("span").text().trim();
				if(msg == "") {
					var msg = $srJq(value).find("p").text().trim();
				}
				msg = msg.replace(/<(?:.|\n)*?>/gm, ''); // Remove html elements
				msg = msg.replace(/(\r\n\t|\n|\r\t)/gm,'').replace(/[^a-zA-Z0-9 !?]+/g, '');; // Remove new lines
				if(msg == msgToDismiss) {
					$srJq(value).parents(".srMsgInner").parent().animate({
						opacity: 0
					}, 200, function() {
						$srJq(value).parents(".srMsgInner").parent().css("opacity", 1);
						$srJq(value).parents(".srMsgInner").parent().addClass("srDismissed");
					});
					$srJq(value).parents(".srMsgInner").parent().prevAll("p, div").animate({
						opacity: 0
					}, 200, function() {
						$srJq(value).parents(".srMsgInner").parent().prevAll("p, div").css("opacity", 1);
						$srJq(value).parents(".srMsgInner").parent().prevAll("p, div").addClass("srDismissed");
					});
				}
			});
			$srJq.ajax({
				url: "//app.meetami.ai/chats/dismiss_specific_msg/",
				type: "POST",
				data: {
					chat_ref: chat_ref,
					msg: uncorruptedMsgToDismiss
				},
				success: function(data) {
					// console.log(data);
				}, error: function(e,f,g) {
					console.log(e);
				}
			});
		}

		function dismissUpToMsg(msg) {

			msg = msg.replace(/\\\//g, "/").replace("\"", "").replace("\"", "");
			console.log("dismissUpToMsg MSG: " + msg);
			var chat_ref = getChatId();

			$srJq.ajax({
				url: "//app.meetami.ai/chats/dismiss_up_to_msg/",
				type: "POST",
				data: {
					chat_ref: chat_ref,
					msg: msg
				},
				success: function(data) {
					console.log(data);
				}, error: function(e,f,g) {
					console.log(e);
				}
			});

		}

		var dismissRoundupInterval = false;

		function resizeIphone() {
			if(srIsiPhoneNoConfirm()) {
				$srJq("#srContent").css("max-height", $srJq(window).innerHeight());
			}
		}
		resizeIphone();

		$srJq(window).resize(function() {
			resizeIphone();
			var wasMobileUx = isMobileUx;
			// console.log(window.outerWidth);
			isMobileUx = window.outerWidth <= 736 ? true : false;
			if(!wasMobileUx && isMobileUx) {
				console.log("was desktop, now mobile");
				/* Converting from Desktop to Mobile Ux */
				convertMsgsMobileUx();
				bindChatMessageDraggable();
			} else if(wasMobileUx && !isMobileUx) {
				console.log("was mobile, now desktop");
				/* Converting from Mobile Ux to Desktop */
				convertMsgsDesktop();
			}
		});

		function convertMsgsDesktop() {
			return;
			$srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").each(function(index, value) {
				var html = $srJq(value).find(".srMsgInnerContent").find("p").first().html();
				$srJq(value).html(html);
			});
			scrollChat();
		}

		function convertMsgsMobileUx(checkExisting) {
			return;
			if($srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").length > 0) {
				$srJq("#srRecordMobileUx").addClass("srStoppedRec");
			}
			$srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").first().addClass("srInitialInstruction");
			$srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").each(function(index, value) {
				$srJq(value).removeClass("srDPQuestionTempHidden");
				// if($srJq(value).hasClass("srEmptyGoogleArrayMsg")) return;
				if($srJq(value).find(".srMsgInner").length == 0) {
					var feintClass = '';
					if($srJq(value).find(".feint").length > 0) {
						feintClass = 'feintMsg';
					}
					var html = $srJq(value).html();
					var newHtml = "<div class='srMsgInner " + feintClass + "'>";
						newHtml += "<div class='srMsgInnerContent'>";
							newHtml += "<div class='srInnerImg'></div>";
							newHtml += "<p>" + html + "</p>";
						newHtml += "</div>";
						if(!$srJq(value).hasClass("srDPQuestion")) {
							newHtml += "<div class='srDismiss'>";
								newHtml += "<div class='srDismissInner'>Dismiss</div>";
							newHtml += "</div>";
						}
					newHtml += "</div>";
					$srJq(value).html(newHtml);
					$srJq(value).find(".srMsgInnerContent").find("p").each(function(pindex, pvalue) {
						if($srJq(pvalue).html() == "") {
							$srJq(pvalue).remove();
						}
					});
					if($srJq(value).find(".avatar-mini.tt").length > 0) {
						$srJq(value).find(".srInnerImg").html($srJq(value).find(".avatar-mini.tt").html()).addClass('has-img');
					}
				}
			});
			if($srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").last().hasClass("srDPQuestion")) {
				$srJq("#srContent #srChatter #srMsgs > p, #srContent #srChatter #srMsgs > div").last().removeClass("srDismissed");
			}
		}
		if(isMobileUx) {
			convertMsgsMobileUx();
		}

		bounceTimer = '';
		// On Load functions
		$srJq(function(){

			$srJq(".srTtsVolume .bar").click(function() {
				$srJq(".srTtsVolume .bar").removeClass("active");
				$srJq(this).addClass("active").prevAll(".bar").addClass("active");
				$srJq.cookie('sr-tts-volume', $srJq(this).data("tts-volume"));
				setTtsVolume();
			});

			var tts_volume = $srJq.cookie('sr-tts-volume');
			if(typeof(tts_volume) !== 'undefined') {
				$srJq(".srTtsVolume .bar[data-tts-volume='" + tts_volume + "']").trigger("click");
			}

			$srJq(".srTtsMute").click(function() {
				if($srJq(this).parent().hasClass("muted")) {
					$srJq(this).parent().removeClass("muted");
					setTtsVolume();
					$srJq.cookie('sr-tts-muted', 0);
				} else {
					$srJq(this).parent().addClass("muted");
					setTtsVolume(0);
					$srJq.cookie('sr-tts-muted', 1);
				}
			});

			var muted = $srJq.cookie('sr-tts-muted');
			if(typeof(muted) == "undefined" || muted == 1) {
				$srJq(".srTtsMute").addClass("muted");
				$srJq.cookie('sr-tts-muted', 1);
				$srJq(".srTtsMute").parent().addClass("muted");
			}

      $srJq("#srMsgs").on('scroll', function() {
        if($srJq(this).scrollTop() == 0) {
          $srJq(".feedback-upper-container").addClass("scrolled-top");
        } else {
          $srJq(".feedback-upper-container").removeClass("scrolled-top");
        }
      });

			//$srJq('a#srLaunch').effect('bounce', {times: 3}, 'slow');
			// Set up a general bounce on the launch icon
			if (typeof bounceTimer == 'undefined' || bounceTimer == ''){
				bounceTimer = setInterval(function(){
					$srJq('a#srLaunch').effect('bounce', {times: 3}, 'slow');
				}, 25000);
console.log('BOUNCE TIMER SET 925');
			}

			scope = {
				chat: {
					functions: {
						unsentMessageInterval: null
					},
					hasUnknownQueries: false
				}
			};

			
			// Listen for a minimise icon and minimise if required
			$srJq('#srImgMin').on('click', function(e) {
				e.preventDefault();
				sr_minimiseWelcomeImg();
			});

			// Enable chat form in case of dodgy refresh
			enableChatForm('noFocus');

			// Set up the core user data cookie
			// First check for existing and update it
			var current_cookie = $srJq.cookie('sr-data');
			var current_session = $srJq.cookie('sr-cur');
			if(typeof current_cookie != 'undefined'){
				current_cookie = JSON.parse(current_cookie);
			}
			if(current_cookie !== undefined && typeof current_cookie['uid'] != 'undefined'){
				// Set up the data to store

				current_cookie['last_visit'] = new Date();
				current_cookie['page_no']++;
				if(current_session == undefined){
					if(typeof current_cookie['visit_no'] != 'undefined'){
						current_cookie['visit_no']++;
					} else {
						current_cookie['visit_no'] = 1;
					}
				}
				var visit_no = current_cookie['visit_no'];
				// Set the cookie
				current_cookie = JSON.stringify(current_cookie);
				$srJq.cookie('sr-data', current_cookie, { expires: 30, path: '/', domain: domain });

			} else {
				// Cookie has not been defined (i.e. new user or equivalent)
				var cookie_data = {
					first_visit: new Date(),
					last_visit: new Date(),
					uid: '',
					visit_no: 1,
					chat_no: 0,
					page_no: 1,
					device: '',
					browser: '',
					ip: '',
					os: '',
					platform: ''
				};
				var visit_no = 1;

				// Set the cookie
				cookie_data = JSON.stringify(cookie_data);
				$srJq.cookie('sr-data', cookie_data, { expires: 30, path: '/', domain: domain });
			}

			// Set up the specific session visit data
			if(current_session === undefined){
				$srJq.cookie('sr-cur', new Date(), { path: '/', domain: domain });
				var logon_time = new Date();
			} else {
				var logon_time = current_session;
			}

			// Check whether the user has an existing conversation + if so launch it
			checkExistingChats();

			var chat_auto_popup_image = "";
			var chat_auto_popup_image_dir = "https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/skin/chat_auto_popup_image/14";
			var chat_auto_popup_url = chat_auto_popup_image_dir + "/" + chat_auto_popup_image;

			// Check the screen width to only do this on larger screens
			var scrnWidth = getScreenWidth();


			// Automatically trigger the chat
			
							// If the default state of the chat is for it to be hidden then set the listenner to trigger it
				$srJq('#ami-trigger').click(function(e){
					//$srJq('#srContent').slideDown(50);
					e.preventDefault();
          if($srJq(this)[0].hasAttribute("rel", "srMinToggle")) {
            minToggle();
          } else {
            chatToggle();
            $srJq(this).attr("rel", "srMinToggle");
          }
				});
			
			// Trigger the chat toggle
			$srJq('div[rel="srChatToggle"], a[rel="srChatToggle"]').on('click', function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						chatToggle(params[0]);
					} else if(params.length == 2){
						chatToggle(params[0], params[1]);
					} else if(params.length == 3){
						chatToggle(params[0], params[1], params[2]);
					} else if(params.length == 4){
						chatToggle(params[0], params[1], params[2], params[3]);
					}
				} else {
					chatToggle();
				}
			});

			$srJq('button[rel="srTriggerCallWrapper"]').off('click');
			$srJq('button[rel="srTriggerCallWrapper"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						triggerCallWrapper(params[0]);
					} else if(params.length == 2){
						triggerCallWrapper(params[0], params[1]);
					} else if(params.length == 3){
						triggerCallWrapper(params[0], params[1], params[2]);
					} else if(params.length == 4){
						triggerCallWrapper(params[0], params[1], params[2], params[3]);
					}
				} else {
					triggerCallWrapper();
				}
			});

			// Trigger the form submission
			$srJq('a[rel="srSubmitForm"]').off('click');
			$srJq('a[rel="srSubmitForm"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					submitForm(params);
				} else {
					submitForm();
				}
			});

			// Trigger the form submission
			$srJq('a[rel="srEndReplierChat"]').off('click');
			$srJq('a[rel="srEndReplierChat"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						endReplierChat(params[0]);
					} else if(params.length == 2){
						endReplierChat(params[0], params[1]);
					}
				} else {
					endReplierChat();
				}
			});

			//load response timer to check for response timeouts from ami
			sr_loadResponseTimer();

			//Trigger interval for sending unsent messages
			scope.chat.functions.unsentMessageInterval = setInterval(saveUnsentMessage, 1000);

		});

		// Trigger listeners for AJAX complete
		$srJq( document ).ajaxComplete(function() {
			triggerListeners();
		});

		function triggerListeners(){

			$srJq("body").off("click", ".srCancelAppt");
			$srJq("body").on("click", ".srCancelAppt", function() {
				$srJq("#srContent .feedback-prechat-container").removeClass("cc-exists");
				handleCancelAppt($srJq(this).data("value"));
			});


			$srJq("#srMsgs").on('scroll', function() {
        if($srJq(this).scrollTop() == 0) {
        	$srJq(".feedback-upper-container").addClass("scrolled-top");
        } else {
          $srJq(".feedback-upper-container").removeClass("scrolled-top");
        }
      });

			// Close previously triggered listener events before binding new ones
			$srJq('div[rel="srChatToggle"], a[rel="srChatToggle"]').off('click');
			$srJq('div[rel="srChatToggle"], a[rel="srChatToggle"]').click(function(e){
        if(typeof(e.originalEvent.detail) !== "undefined" && e.originalEvent.detail != 1 && !navigator.userAgent.match(/Trident.*rv\:11\./)) {
        	return false;
        }
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						chatToggle(params[0]);
					} else if(params.length == 2){
						chatToggle(params[0], params[1]);
					} else if(params.length == 3){
						chatToggle(params[0], params[1], params[2]);
					} else if(params.length == 4){
						chatToggle(params[0], params[1], params[2], params[3]);
					}
				} else {
					chatToggle();
				}
			});

			$srJq('*[rel="srChatToggleMobile"]').off('click');
			$srJq('*[rel="srChatToggleMobile"]').click(function(e){
				if (isMobileUx) {
					if (confirm('Are you sure you wish to end this chat?')) {
						// Handle all the chat closing functionality
						closeReplier();
						// Switch the mobile icon back to the launch chat icon
						$srJq("#srRecordMobileUx").attr('class', '');
					}
				}
			});

			// Close previously triggered listener events before binding new ones
			$srJq('button[rel="srTriggerCallWrapper"]').off('click');
			$srJq('button[rel="srTriggerCallWrapper"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						triggerCallWrapper(params[0]);
					} else if(params.length == 2){
						triggerCallWrapper(params[0], params[1]);
					} else if(params.length == 3){
						triggerCallWrapper(params[0], params[1], params[2]);
					} else if(params.length == 4){
						triggerCallWrapper(params[0], params[1], params[2], params[3]);
					}
				} else {
					triggerCallWrapper();
				}
			});

			// Trigger thefeedback submission
			$srJq('a[rel="srSubmitFeedback"]').off('click');
			$srJq('a[rel="srSubmitFeedback"]').click(function(e){
				e.preventDefault();
				if($srJq(this).hasClass("during")) {
					var during = true;
				} else {
					var during = false;
				}
				submitFeedback(during);
			});

			$srJq('a[rel="srBackToChat"]').off('click');
			$srJq('a[rel="srBackToChat"]').click(function() {
				$srJq('#srChatter').html(chat_dom);
				$srJq('#srLaunchContainer').removeClass('srInFeedbackState');
				$srJq(".footerRate button").prop("disabled", false);
				checkExistingChats();
			});

			$srJq(".footerRate button").off('click');
			$srJq(".footerRate button").click(function(e) {
				e.preventDefault();
				if($srJq(this).prop("disabled") == "disabled") return;
				$srJq(this).prop("disabled", "disabled");
				var chat_ref = getChatId();
				chat_dom = $srJq("#srChatter").html();
	            // Display the feedback fom
				$srJq.ajax({
					type: "GET",
					url: "//app.meetami.ai/feedback/create/" + chat_ref + "/0/" + 1,
					success: function(feedback_form) {
						$srJq('#srChatter').html(feedback_form);
						$srJq('#srLaunchContainer').addClass('srInFeedbackState');
						populate_feedback_callback_form();
					},
					error: function(errorThrown) {
						console.log(errorThrown);
					}
				});
			});

			// Trigger the size toggle
			/*$srJq('a[rel="srSizeToggle"]').off('click');
			$srJq('a[rel="srSizeToggle"]').click(function(e){
				e.preventDefault();
				sizeToggle();
			});*/
			// Trigger the minimise toggle
			$srJq('*[rel="srMinToggle"]').off('click');
			$srJq('*[rel="srMinToggle"]').click(function(e){
				e.preventDefault();
				minToggle();
			});

			// Trigger the close layer
			$srJq('a[rel="srCloseLayer"]').off('click');
			$srJq('a[rel="srCloseLayer"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					closeLayer(params);
				} else {
					closeLayer();
				}
			});

			// Trigger the form submission
			$srJq('a[rel="srSubmitForm"]').off('click');
			$srJq('a[rel="srSubmitForm"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					submitForm(params);
				} else {
					submitForm();
				}
			});

			// Trigger the form submission
			$srJq('a[rel="srSubmitMessage"]').off('click');
			$srJq('a[rel="srSubmitMessage"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					submitMessage(params);
				} else {
					submitMessage();
				}
			});

			// Trigger the form submission
			$srJq('a[rel="srEndReplierChat"]').off('click');
			$srJq('a[rel="srEndReplierChat"]').click(function(e){
				e.preventDefault();
				var params = $srJq(this).attr('name');
				if(typeof params != 'undefined'){
					params = params.split(' ');
					if(params.length == 1){
						endReplierChat(params[0]);
					} else if(params.length == 2){
						endReplierChat(params[0], params[1]);
					}
				} else {
					endReplierChat();
				}
			});
		}



		function trackCallTrigger(client_ref, phone_no){

			var userRef = getUsrId();

			$srJq.ajax({
				type: "GET",
				url: "//app.meetami.ai/chats/track_an_action/" + client_ref + '/' + userRef + "/call_trigger/call",
				success: function(data) {
					window.location = "tel:" + phone_no;
				}, error: function(){
					window.location = "tel:" + phone_no;
				}
			});

		}

		$srJq.fn.hasScrollBar = function() {
      if(typeof(this.get(0)) !== "undefined") {
      	return this.get(0).scrollHeight > this.innerHeight();
      }
      return false;
	   }

		// On resize check the heights that we are using
		$srJq(window).resize(function() {
			msgHeight(10, function(){});
		});

		function mobileBtn(){

			// Change the main button's action if we have gone responsive
			var winWidth = getScreenWidth();
			if(winWidth < 720){

				var uid = '';
				uid = getUsrId();

				$srJq('#srChatNowSrch').attr('href','https://app.meetami.ai/chats/chat/168019131601/mob/' + uid).attr('rel', '').attr('target', '_blank');
				$srJq('#srRLSrch').closest('a').attr('href','https://app.meetami.ai/chats/chat/168019131601/mob/' + uid).attr('rel', '').attr('target', '_blank');
				$srJq('#srRL').closest('a').attr('href','https://app.meetami.ai/chats/chat/168019131601/mob/' + uid).attr('rel', '').attr('target', '_blank');
				oldSiteHack();
			} else {
				$srJq('#srChatNowSrch').attr('href','#chat').attr('rel', 'srChatToggle').attr('name', "coverhide SL-btn").attr('target', '');
				$srJq('#srRLSrch').closest('a').attr('href','#chat').attr('rel', 'srChatToggle').attr('name' , "coverhide SL-btn").attr('target', '');
				$srJq('#srRL').closest('a').attr('href','#chat').attr('rel', 'srChatToggle').attr('name', "coverhide RL-btn").attr('target', '');
				oldSiteHack();
			}
		}

		

		function imgToTxtHeader(block_mob, block_store){
			$srJq('#minIHBtn').hide();
			$srJq('#srContent #srIcon').attr('class', '');
			$srJq('#mobChatBtn').remove();
			if(typeof block_mob == 'undefined' || block_mob != 1){
				$srJq('#srContent #srHeader h4 > a#imageHeader').html('Chat<span class="mobHide il"> with us</span>').attr('class', '').attr('id', '');
			} else if (typeof block_mob != 'undefined' || block_mob == 1) {
				$srJq('#srContent #srHeader h4 > a#imageHeader').html('Chat').attr('class', '').attr('id', '');
			}
			$srJq('#srContent #srHeader').css("background", "#da4a97 url('//app.meetami.ai/img/core/bg/overlay.png') center bottom repeat-x" );
						// Drop a cookie to record that it is minimised
			if(typeof block_store == 'undefined' || block_store != 1){
				$srJq.cookie('srIMin', 1, { path: '/', domain: domain });
			}
		}

		function sr_getCurrentUnreadMessages() {
			return parseInt($srJq('#srUnreadCount').html());
		}

		function sr_updateUnreadMessages(count) {
			if(count < 1) {
				$srJq('#srUnreadCount').hide();
			} else {
				$srJq('#srUnreadCount').show();
			}
			$srJq('#srUnreadCount').html(count);
		}

		function sr_incrementUnreadMessages() {
			var currentCount = sr_getCurrentUnreadMessages();
			sr_updateUnreadMessages(currentCount+1);
		}

		function sr_markMessagesRead(override) {

			if (typeof override == 'undefined') { var override = 0; }

			var currentCount = sr_getCurrentUnreadMessages();
			if(currentCount > 0 || override == 1) {

				// Firstly read for a cookie
				if(typeof chat_ref == 'undefined'){
					var chat_ref = getChatId();
				}

				$srJq.ajax({
					type: "GET",
					url: "//app.meetami.ai/chats/mark_read/" + client_ref + "/" + chat_ref,
					success: function(data) {
						//console.log('marked chats as read', data);
					}
				});

				sr_updateUnreadMessages(0);
			}
		}

		function sr_isChatOpen() {
			return $srJq('#srContent').css('display') != 'none';
		}

		function sr_showPreviewMessage(msg, imgUrl) {
			var truncatedMsg = sr_truncate.apply(msg, [35,true]);
			$srJq('#srPreviewMessage p').html(truncatedMsg);

			if(imgUrl) {
				$srJq('#srPreviewMessage .avatar-preview').removeClass('avatar-default');
				$srJq('#srPreviewMessage .avatar-preview img').attr('src',imgUrl);
			} else {
				$srJq('#srPreviewMessage .avatar-preview').addClass('avatar-default');
				$srJq('#srPreviewMessage .avatar-preview img').attr('src','//app.meetami.ai/img/widget/mini-avatar-lrg.png');
			}

			$srJq('#srPreviewMessage').show();

			var showForMillis = 20 * 1000;
			setTimeout(sr_removePreviewMessage, showForMillis);
		}

		function sr_removePreviewMessage() {
			$srJq('#srPreviewMessage').hide();
			$srJq('#srPreviewMessage p').html('');
		}

		function sr_truncate(n, useWordBoundary) {
			var isTooLong = this.length > n,
				s_ = isTooLong ? this.substr(0,n-1) : this;
				s_ = (useWordBoundary && isTooLong) ? s_.substr(0,s_.lastIndexOf(' ')) : s_;
			return  isTooLong ? s_ + '&hellip;' : s_;
		}

		function sr_showWelcomeImage(img) {
			$srJq(".srWelcomeImage > img").attr("src", img);
			$srJq(".srWelcomeImage").slideDown(350);
		}

		function sr_minimiseWelcomeImg () {
			$srJq('.srWelcomeImage').slideUp(200);
			// Drop a cookie to prevent it reopening
			$srJq.cookie('sr-cl', 1, { path: '/', domain: domain });
		}

		$srJq(".srWelcomeImage img").click(function() {
			$srJq(".srWelcomeImage").hide();
			$srJq('#srContent, #srLaunchContainer').addClass('srWelcomeMessage');
			chatToggle();
			$srJq('#srLaunch').show();
			$srJq('#srContent .loading').hide();
		});

		var check_existing_interval = null;

		function sr_showWelcomeMessage() {
			$srJq('#srContent, #srLaunchContainer').addClass('srWelcomeMessage');
			checkExistingChats('undefined', function() {
				chatToggle(undefined, undefined, undefined, undefined, true);
				check_existing_interval = setInterval(function() {
					checkExistingChats('undefined');
				}, 3000);
			});
						$srJq('#srLaunch').show();
			$srJq('#srContent .loading').hide();
		}

		function sr_removeWelcomeMessage() {
			$srJq('#srContent, #srLaunchContainer').removeClass('srWelcomeMessage');
		}

		function sr_isWelcomeMessageOpen() {
			return $srJq('.srWelcomeMessage').length ? true : false;
		}

		// When the usr hts enter then submit the form
		$srJq( document ).ajaxComplete(function() {
			$srJq('#srMsgSender').off('keydown');
			$srJq('#srMsgSender').off('focusout');
			trackTyping();
			$srJq('#srMsgSender').keydown(function(event) {
				if (event.keyCode == 13 && !event.ctrlKey && !event.metaKey) {
					//First check if its a welcome message submission
					if(sr_isWelcomeMessageOpen()) {
													sr_removeWelcomeMessage();
											}

					//Regular submit message handling
					//Regular submit message handling
					if(isMobileUx && $srJq("#srMsgs").find(".srResponseEditInput").length > 0 && $srJq("#srMsgs").find(".srResponseEditInput").prop("disabled") == false) {
						console.log("Not autosending msg..");
						if (isMobileUx && $srJq('#srChatter').hasClass('delayed-creation')) {
							$srJq('#srMsgSender').blur();
						}
					} else {
						if (!isMobileUx || !$srJq('#srChatter').hasClass('delayed-creation')) {
							submitMessage();
						} else if (isMobileUx && $srJq('#srChatter').hasClass('delayed-creation')) {
							$srJq('#srMsgSender').blur();
						}
					}
				} else if (event.keyCode == 13 && (event.ctrlKey || event.metaKey)) {
					var curVal = $srJq('#srMsgSender').val();
					$srJq('#srMsgSender').val(curVal + "\r\n");
				}
			});
			// Handle done button
			var winWidth = getScreenWidth();
			if(winWidth < 720){
				$srJq('#srMsgSender').focusout(function(event) {
					submitMessage();
				});
			}
		});

		function disableScrollify() {
			if(jQuery && jQuery.scrollify && $srJq(window).width() <= 720) {
				jQuery.scrollify.disable();
				console.log("Disabling scrollify..");
			}
		}

		function enableScrollify() {
			if(jQuery && jQuery.scrollify && $srJq(window).width() <= 720) {
				jQuery.scrollify.enable();
				console.log("Enabling scrollify..");
			}
		}

		var minBtn = '<a href="#chat" rel="srMinToggle" id="srMin" class="srMin"> </a>';
		var smlBtn = '';//'<a href="#chat" rel="srSizeToggle" id="srSize" class="srSml"> </a>';
		var lrgBtn = '';//'<a href="#chat" rel="srSizeToggle" id="srSize" class="srMax"> </a>';
		var cloBtn = '<a href="#close" rel="srChatToggle" class="srClose"> </a>';

		function chatToggle(hideCover, transfer_type, block_msg, triggerCallback, delay_creation){

			// Get the current status of the chat
			var status = $srJq('#srContent').css('display');
			var fb_status = $srJq('#srChatter').attr('class');

			// Tweak transfertypes
			var btn = 0;
			if(transfer_type == 'SL-btn' || transfer_type == 'RL-btn'){
				transfer_type = transfer_type.replace('-btn', '');
				var btn = 1;
			}

			// If chat is currently closed then open it + create a new chat
			if(status == 'none'){
									/*var content_style = $srJq('#srContent').css('display');
					if(content_style == 'none'){
						$srJq('#srContent').slideDown(100);
					}*/
													//imgToTxtHeader(0,1);
								// Run the AJAX command to create the chat, culminating in a slide down (open) of the chat window
				if(typeof transfer_type == 'undefined'){
					createChat(undefined, undefined, undefined, delay_creation);
				} else {
					if(typeof block_msg != 'undefined'){
						if(typeof triggerCallback != 'undefined'){
							createChat(transfer_type, block_msg, triggerCallback);
						} else {
							createChat(transfer_type, block_msg);
						}
					} else {
						createChat(transfer_type);
					}
				}
			} else if(status == 'block' && fb_status == 'srFeedback') {
				// If currently open and feedback completed then close it
				closeReplier();
			} else {
				// If closing chat is confirmed then show the feedback form
				endReplierChat();
			}

			// If this is from a recovery layer then close the cover
			if(typeof hideCover != 'undefined' && hideCover == 'coverhide'){
				// Check for type (recovery layer or search layer)
				if (transfer_type == 'RL' && btn == 1){
					trackAction('RecoveryLayer', 'chat');
				} else if (transfer_type == 'SL' && btn == 1) {
					trackAction('SearchLayer', 'chat');
				}
				$srJq('#srCover .srCoverContent').slideUp(200);
				$srJq('#srCover').fadeOut(650);
				$srJq('#srCoverRecovery .srCoverContentRecovery').slideUp(200);
				$srJq('#srCoverRecovery').fadeOut(650);
			}
		}

		// Function to toggle the size between big and small
		function sizeToggle(){
			// Check the current open status
/*			var openstatus = $srJq('#srContent').css('display');
			// If closed then open it up + resize (N.B. for new chats the minToggle action won't be available)
			if(openstatus == 'none'){
				$srJq('#srChatter').slideDown(350);
			}

			// If / now open then simply resize
			var size = $srJq('#srContent').css('max-width');
			if(size == '550px'){
				$srJq('#srContent').animate({'max-width': '300px'}, 250);
				$srJq('#srSize').attr('class', 'srMax');
				$srJq('#srContent').attr('class', '');
			} else {
				$srJq('#srContent').animate({'max-width': '550px'}, 250);
				$srJq('#srSize').attr('class', 'srSml');
				$srJq('#srContent').attr('class', 'srBig');
			}
			$srJq('#srMin').attr('class', 'srMin');
*/
		}

		$srJq(window).on('resize', function(){
		 srSnapToDesktop();
		});

		function srSnapToDesktop () {
			if (!isMobileUx) {
				$srJq('#srContent').css({ 'height':'', 'bottom':'', 'width':'', 'margin':''});
				$srJq('#srLaunchContainer').show();
			} else {
				var contentDisplayed = $srJq('#srContent').css('display');
				if (contentDisplayed == 'block') {
					$srJq('#srLaunchContainer').hide();
				}
			}
			toggleBarForScreenSize();
		}

		function toggleBarForScreenSize ( ) {
			// Do we have a mobile Min class?
			if (!isMobileUx) {
				var isMinimised = $srJq('#srContent').hasClass('mobileMin');
				if (isMinimised) {
					$srJq('#srContent').hide();
					$srJq('#srContent #srHeader').css('cursor', 'default').off('click');
					triggerListeners();
					$srJq('#srContent').removeClass('mobileMin');
					$srJq('#srLaunchContainer a#srLaunch').show();
				}
			} else {
				var isMinimised = ( $srJq('#srContent').css('display') == 'none' && $srJq('#srLaunchContainer').attr('rel') == 'srMinToggle' );
				if (isMinimised) {
					$srJq("#srContent").show();
					setTimeout(function(){
						$srJq('#srContent #srHeader h4 #srMenu').html(minBtn + cloBtn);
						$srJq("#srMin").css({ transform: "rotateX(180deg)" });
						toggleBarClickability(true);
						$srJq('#srContent').addClass('mobileMin');
						triggerListeners();
						setTimeout(function(){
							var srContentHeight = $srJq("#srContent").outerHeight();
							var srHeaderHeight = $srJq("#srContent #srHeader").outerHeight();
							$srJq("#srContent").css({
								bottom: "-" + (srContentHeight - srHeaderHeight) + "px",
								width: "90%",
								margin: "0% 5%"
							});

						}, 10);
					}, 5);
				}
			}
		}

		function toggleBarClickability ( makeClickable ) {
			if (isMobileUx) {
				if (makeClickable === true) {
					$srJq('.srClose').fadeOut(125);
					$srJq('#srContent #srHeader').css('cursor', 'pointer');
					$srJq('#srContent #srHeader').on('click', function(e){
						e.preventDefault();
						minToggle();
					});
				} else {
					$srJq('.srClose').fadeIn(125);
					$srJq('#srContent #srHeader').css('cursor', 'default');
					$srJq('#srContent #srHeader').off('click');
				}
			}
		}

		// Minimise function
		function minToggle( ){

			var openstatus = $srJq('#srContent').css('display');
			if(!isMobileUx) {
									$srJq('#srContent').slideToggle(300);
							} else {
				var mobileOpenStatus = $srJq('#srContent').css("width");
			}
			if(openstatus == 'none' || (isMobileUx && $srJq('#srContent').hasClass('mobileMin'))){
				console.log('Opening');

				sr_markMessagesRead();
				sr_removePreviewMessage();
				toggleBarClickability(false);

				$srJq.cookie('srMin', 0);
				if(isMobileUx) {
					$srJq("#srContent").animate({
						bottom: "0px"
					}, function() {
						$srJq("#srContent").animate({
							width: "98%",
							margin: "0% 1%"
						});
						$srJq('#srContent').removeClass('mobileMin');
						$srJq("#srMin").css({
							transform: "rotateX(0deg)"
						});
					});
					return;
				}

				//opening
				$srJq('#srContent #srHeader h4 #srMenu').html(minBtn + cloBtn);
				$srJq('#srContent #srHeader h4 > a').attr('rel', 'srChatToggle');
								// Tweak the listenners to account for the lack of AJAX call here
				triggerListeners();
				scrollChat();
				disableScrollify();
			} else {
				console.log('Minimising');
				if(sr_isWelcomeMessageOpen()) {
					closeReplier();
				} else {
					//closing
					toggleBarClickability(true);
					$srJq('#srLaunchContainer').attr('rel', 'srMinToggle');
                  		// If the default state of the chat is for it to be hidden then set the listenner to trigger it
        		$srJq('#ami-trigger').attr("rel", "srMinToggle");
        	
					$srJq.cookie('srMin', 1);
					if(isMobileUx) {
						var srContentHeight = $srJq("#srContent").outerHeight();
						$srJq("#srContent").animate({
							bottom: "-" + (srContentHeight - 41) + "px"
						}, function() {
							$srJq("#srContent").animate({
								width: "90%",
								margin: "0% 5%"
							});
							$srJq("#srMin").css({
								transform: "rotateX(180deg)"
							});
							$srJq('#srContent').addClass('mobileMin');
						});
						return;
					}

					$srJq('#srContent #srHeader h4 #srMenu').html('');
											// $srJq('#srLaunchContainer').fadeOut(250);
										// Tweak the listeners (as not AJAX call has been made)
					triggerListeners();
					//sr_showLaunchContainer();
				}
				enableScrollify();
			}
		//	$srJq('#srContent').animate({'max-width': '300px'}, 250);
		}

		//Functions to open an close the chat window
		function openReplier (override) {

			var is_open = $srJq.cookie('srMin');
			if(typeof override == 'undefined'){
				override = 0;
			}
			var contentDisplay = $srJq('#srContent').css('display');
			//if ( contentDisplay == 'none' ) {
			//	$srJq('#srContent').show();
			//}
			if(typeof is_open == 'undefined' || is_open == 0 || override == 1){
				disableScrollify();
				if($srJq('#minIHBtn').length == 1){
					$srJq('#minIHBtn').hide();
				}
									$srJq('#srContent').slideDown(350);
								$srJq('#srContent #srHeader h4 #srMenu').html(minBtn + cloBtn);
				$srJq('#srContent #srHeader h4 > a').attr('rel', '');
			} else {
				// Set up the tab to unminimise the existing chat
				//$srJq('#srContent #srHeader h4 > a').attr('rel', 'srMinToggle');
				// toggleBarClickability(true);
			}
			$srJq('#srLaunchContainer').attr('rel', 'srMinToggle');
              // If the default state of the chat is for it to be hidden then set the listenner to trigger it
        $srJq('#ami-trigger').attr("rel", "srMinToggle");
      			clearInterval(bounceTimer);

			if (isMobileUx) {
				var min = $srJq.cookie('srMin');
				if(min == 1) {
					// $srJq('#srContent .srCloseMobile.srMobileUx').delay(350).fadeIn(150);
					var srContentHeight = $srJq('#srContent').outerHeight();
					$srJq('#srContent').css({
						display: "block",
						bottom: "-" + (srContentHeight - 41) + "px",
						width: "90%",
						margin: "0% 5%"
					});
					$srJq('#srContent').addClass('mobileMin');
					$srJq('#srContent #srHeader h4 #srMenu').html(minBtn + cloBtn);
					$srJq("#srMin").css({
						transform: "rotateX(180deg)"
					});
					toggleBarClickability(true);
				}
				$srJq('#srLaunchContainer').fadeOut(250);
			}

			// If for some unknown reason we are still displaying a count then hide it
			if ($srJq('#srUnreadCount').length) {
				var openState = sr_isChatOpen();
				if(openState === true){
					$srJq('#srUnreadCount').hide().html(0);
				}
			}
		}

		function closeReplier(leave_chat_cookie){

			if(sr_isWelcomeMessageOpen()) {
				setTimeout(function(){
					sr_removeWelcomeMessage();
				}, 1200);
			}

							$srJq('#srContent').slideUp(300);
						if(isMobileUx) $srJq('#srLaunchContainer').fadeIn(250);
			$srJq('#srContent #srHeader h4 a').attr('class', '');
			$srJq('#srChatter').attr('class', '');
			$srJq('#srContent #srHeader h4 > a').attr('rel', 'srChatToggle').attr('class', 'theHeader');
			$srJq('#srContent #srHeader h4 a#mobChatBtn').attr('class', 'mobOnly');
			closeEnd(leave_chat_cookie);
      $srJq('#srLaunchContainer').attr('rel', 'srChatToggle');
			if (isMobileUx || $srJq('#srContent .srCloseMobile.srMobileUx').css('display') == 'block') {
				$srJq('#srContent .srCloseMobile.srMobileUx').fadeOut(150);
			}
			// Finally repopulate the chat form with the correct content for a new chat
			$srJq.ajax({
				type: "GET",
				url: "//app.meetami.ai/chats/chat/" + client_ref + "/empty",
				success: function(data) {
					$srJq('#srChatter').html(data);
                      // If the default state of the chat is for it to be hidden then set the listenner to trigger it
            $srJq('#ami-trigger').attr("rel", "srChatToggle");
          					// Set up a general bounce on the launch icon
					if ( typeof bounceTimer == 'undefined' ){
						bounceTimer = setInterval(function(){
							$srJq('a#srLaunch').effect('bounce', {times: 3}, 'slow');
						}, 25000);
					}
				}
			});
			// Clear the department ID
			$srJq('#chatDept').val('');
			enableScrollify();
			toSimpleForm(1);
		}

		function closeEnd(leave_chat_cookie){
			// Handle the cookie deletion
			var chat_ref = $srJq.cookie('sr-ec');
			if(chat_ref != undefined){
				if(typeof(leave_chat_cookie) == "undefined") $srJq.removeCookie('sr-ec', { path: '/', domain: domain });
				$srJq.removeCookie('srMin');
				// And end the specific chat room
				endLiveChat(chat_ref);
			}
			srClearFrame();
		}

		function saveUnsentMessage() {

			clearInterval(check_existing_interval);

			//Dont save if its a welcome message as there is not chat to save it against
			if(sr_isWelcomeMessageOpen()) {
				return;
			}

			currentMsg = $srJq('#srMsgSender').val();
			if(currentMsg == null || currentMsg == scope.chat.savedMessage) {
				//No changes do nothing
				return;
			}
			scope.chat.savedMessage = currentMsg;

			var chat_ref = $srJq('#chat_ref').val();
			var current_cookie = $srJq.cookie('sr-data');

			if(typeof current_cookie != 'undefined'){
				current_cookie = JSON.parse(current_cookie);
			} else {
				//No cookie, cant saveUnsentMessage
				return;
			}

			var userId = current_cookie['uid'];
			var data = {
				msg: currentMsg,
				chatId: chat_ref,
				userId: userId
			}

			var url = "//app.meetami.ai/unsent_messages/save_user_message/" + data.chatId;

			$srJq.ajax({
				url: url,
				type: "POST",
				data: data,
				success: function(data) {
					//Do nothing
				}, error: function(e,f,g) {
					console.log(e);
				}
			});
		}

		var ttsPlaylist = [];
		var ttsAudio = document.getElementById("ttsPlaylist");
		var ttsAudioPlaying = false;
		var ttsInitiated = false;
		var msgsToRemove = [];
		ttsAudio.onended = function() {
			console.log("AUDIO ENDED");
			console.log("ttsPlaylist");
			console.log(ttsPlaylist);
			// console.log("MSG ELEM TO BE REMOVED!: ", msgRemove);
			// if(msgsToRemove.length > 0) {
			// 	var msgRemove = msgsToRemove.shift();
			// 	/* Check whether the last item in srMsgs is a DPQuestion. If yes, don't issue timeout */
			// 	// $srJq("#srMsgs").children("p, div").last().css("border", "solid thin red");
			// 	if(!$srJq("#srMsgs").children("p, div").last().hasClass("srDPQuestion")) {
			// 		setTimeout(function() {
			// 			dismissSpecificMsg(msgRemove);
			// 		}, dismissTime);
			// 	}
			// }
			// dismissTimeouts.push(t);
			if(ttsPlaylist.length > 0) {
				playTtsAudio(ttsPlaylist[0].src, ttsPlaylist[0].delay, true);
				msgRemoveElem = ttsPlaylist[0].msgElem;
				ttsPlaylist.shift();
			} else {
				ttsAudioPlaying = false;
			}
		}

		$srJq("body").on("click", "#srRecordMobileUx", function() {
			if(ttsInitiated == false) {
				ttsAudio.src = '//app.meetami.ai/audio/silence.mp3';
				ttsAudio.volume = 0;
				ttsAudio.load();
				ttsAudio.play();
				setTtsVolume();
				ttsInitiated = true;
			}
		});

		function checkRecentMsgHeight() {
			if($srJq("#srChatForm.details").length > 0) {
				$srJq("#srContent").css("height", "100%");
				$srJq("#srMsgs").css({
					maxHeight: ($srJq("#srContent").outerHeight() - 195) + "px"
				});
				return;
			}
			// var mostRecentHeight = $srJq("#srMsgs").find("p.agent").last().outerHeight();
			// var diff = (mostRecentHeight - $srJq("#srMsgs").outerHeight());
			// var srContentHeight = $srJq("#srContent").outerHeight();
			// var targetContentHeight = (parseFloat(srContentHeight + diff));
			// var windowInnerHeight = $srJq(window).innerHeight();
			// var sixtyPercent = (windowInnerHeight / 100) * 60;
			// if(mostRecentHeight > $srJq("#srMsgs").outerHeight() && targetContentHeight > sixtyPercent) {
			// 	$srJq("#srContent").css({
			// 		height: targetContentHeight + "px"
			// 	});
			// 	var targetMsgsHeight = ($srJq("#srContent").outerHeight() - 145);
			// 	$srJq("#srMsgs").css({
			// 		minHeight: targetMsgsHeight + "px",
			// 		maxHeight: targetMsgsHeight + "px"
			// 	});
			// } else if(targetContentHeight < sixtyPercent) {
			// 	$srJq("#srContent").css({
			// 		height: sixtyPercent + "px"
			// 	});
			// 	$srJq("#srMsgs").css({
			// 		minHeight: ($srJq("#srContent").outerHeight() - 145) + "px",
			// 		maxHeight: ($srJq("#srContent").outerHeight() - 145) + "px"
			// 	});
			// }
		}


		function handleTts(message, doNotBlock) {
			if(isMobileUx) {
				checkRecentMsgHeight();
        msgHeight(50, function(){});
				convertMsgsMobileUx();
				bindChatMessageDraggable();
			}
							return;
					}

		
		function setTtsVolume(override) {
			if(typeof(ttsAudio) === "undefined") return;
			if(typeof(override) !== "undefined") {
				var volumePercentage = override;
			} else {
				var volumePercentage = $srJq.cookie('sr-tts-volume');
			}
			if(typeof(volumePercentage) === "undefined") {
				volumePercentage = 60;
			}
			ttsAudio.volume = volumePercentage / 100;
		}

		// Adjust the volume and update the volume control
		function adjustTtsVolume (unMute, volume, override) {

			// Only do this for the desktop UX
			if(!isMobileUx) {
				var volumePercentage = $srJq.cookie('sr-tts-volume');
				var volumeMute = $srJq.cookie('sr-tts-muted');

				// If the user has not yet done anything to the volume
				if (typeof volumePercentage == 'undefined' || (typeof override != 'undefined' && override === true) ) {

					if (typeof volumeMute != 'undefined' && volumeMute == 1 && unMute === true) {
						$srJq.cookie('sr-tts-volume', volume);
						$srJq.cookie('sr-tts-muted', 0);
						$srJq('.srTtsMute').parent().removeClass("muted");
						colourActiveVolumeBars(volume);
					} else if (typeof volumeMute != 'undefined' && volumeMute == 0 && unMute === false) {
						$srJq('.srTtsMute').parent().addClass("muted");
						setTtsVolume(0);
						$srJq.cookie('sr-tts-muted', 1);
					}

				}

			}
		}

		function colourActiveVolumeBars (volume) {
			var options = [20, 40, 60, 80, 100];
			for (var i in options) {
				if (options[i] <= volume) {
					$srJq('.srTtsControls .srTtsVolume div.bar[data-tts-volume=' + options[i] + ']').addClass('active');
				} else {
					$srJq('.srTtsControls .srTtsVolume div.bar[data-tts-volume=' + options[i] + ']').removeClass('active');
				}
			}
		}

		var played = [];

		function playTtsAudio(src, delay, nextTriggered, overrideBlockPlayed) {
			if(typeof(overrideBlockPlayed) === "undefined" || overrideBlockPlayed === false) {
				if($srJq.inArray(src, played) != -1) {
					console.log("SRC IS IN PLAYED, RETURNING FALSE");
					return false;
				}
			}
			ttsAudio.src = src;
			ttsAudio.load();
			if(isMobileUx) {
				setTtsVolume(60);
			} else {
				setTtsVolume();
			}
			if(nextTriggered) {
				console.log("NEXT TRIGGERED");
				ttsAudio.play();
				played.push(src);
				ttsAudioPlaying = true;
			} else {
				console.log("SETTING DELAY FOR NEXT ITEM IN PLAYLIST");
				// setTimeout(function() {
					ttsAudio.play();
					played.push(src);
					ttsAudioPlaying = true;
				// }, delay);
			}
		}

		// AJAX function to create a new chat and return the ID (populating the relevant input)
		function createChat(transfer_type, block_msg, callback, delay_creation, delay_callback, delay_argument){

			$srJq('#amiAgentsStatus').val(0);

    		checkExistingChats('undefined', function() {

					// Reset the played list
					played = [];

    			var current_cookie = $srJq.cookie('sr-act');
    			if(typeof current_cookie != 'undefined') {
    				$srJq.removeCookie('sr-act', { path: '/', domain: domain });
    			}

    			var client_ref = '168019131601';
    			var agents = $srJq('#agentsList').val();
    			if(agents == ''){
    				agents = 'none'
    			}
    			var icChats = $srJq('#icChats').val();

    			openReplier(1);

					if(isMobileUx) {
						$srJq(".srRecordMobileUx").addClass("srStoppedRec");
					}

					
    			// Check for exisiting user data
    			var usr_cookie = $srJq.cookie('sr-data');
    			uid = '';
    			if(usr_cookie !== undefined){
    				usr_details = JSON.parse(usr_cookie);
    				if(usr_details['uid'] != '' && usr_details['uid'] != undefined){
    					uid = usr_details['uid'];
    				}
    			} else {
    				// Force page refresh, triggering the chat
    				$srJq.cookie('sr-lc', 1, { path: '/', domain: domain });
    				window.location.reload();
    			}

    			// Handle block_msg
    			if(typeof block_msg == 'undefined'){
    				block_msg = '';
    			}
    			if(typeof callback == 'undefined'){
    				callback = 0;
    			}

    			// If Google analytics events are enabled then track them
    			
				if(delay_creation) {
					$srJq("#srChatter").addClass("delayed-creation");
					if(isMobileUx) {
						$srJq("#srRecordMobileUx").addClass("srProcessing");
					}
					$srJq.ajax({
	    			type: "GET",
	    			url: "//app.meetami.ai/chats/autochat_popup_data/" + client_ref,
	    			success: function(data) {

							dataObj = JSON.parse(data);
							var image = srSetHeaderImage(dataObj, block_msg, false);
							// If no welcome message is set then add it in
							dataObj = checkForWelcome(dataObj);
							timeDelay = dataObj.welcome.length * auto_delay;
							if(block_msg == ''){
    							setTimeout(function () {
										dataObj = checkForWelcome(dataObj);
    								if(image != ''){
    									$srJq('#srMsgs').append('<p class="agent inc-avatar"><span class="avatar-mini tt"><img src="' + image +'" alt="' + dataObj.agent_name + '" /></span><span>' + dataObj.agent_name + ':</span> ' + dataObj.welcome + '</p>');
											handleTts(dataObj.welcome);
										} else {
	    									$srJq('#srMsgs').append('<p class="agent"><span>' + dataObj.agent_name + ':</span> ' + dataObj.welcome + '</p>');
											handleTts(dataObj.welcome);
    								}
									if(isMobileUx) {
										convertMsgsMobileUx();
										bindChatMessageDraggable();
										$srJq("#srRecordMobileUx").removeClass("srProcessing").addClass("srStoppedRec");
									}
    								$srJq('#srMsgs').linkify({ target: '_self' });
    								$srJq('#srFaded').remove();
										$srJq('a[rel="srSubmitMessage"]').click(function(e){
		    							e.preventDefault();
		    							var params = $srJq(this).attr('name');
		    							if(typeof params != 'undefined'){
		    								submitMessage(params);
		    							} else {
		    								submitMessage();
		    							}
		    						});
    							}, timeDelay);
    						}
						},
						error: function(errorThrown) {
							console.log(errorThrown);
						}
					});
					return;
				}

    			$srJq.ajax({
    				type: "GET",
    				url: "//app.meetami.ai/chats/create_chat/" + client_ref + '/' + agents + '/' + icChats + '/' + uid + '/' + block_msg + '/' + callback,
    				success: function(data) {

    					if(data != 'no-agent' && data != 'error') {
    						dataObj = JSON.parse(data);
    						timeDelay = dataObj.welcome.length * auto_delay;
    						$srJq('#chat_ref').val(dataObj.chat_ref);

								// If no welcome message is set then add it in
								dataObj = checkForWelcome(dataObj);

    						// Set Header image in separate function + return the image URL
    						var image = srSetHeaderImage(dataObj, block_msg, delay_callback);
// console.log(dataObj);
    						// If chat widget header image is set to square, modify the elements
    						if(dataObj.widget_header_image_style == 'sq') {
    							$srJq("#srContent #srMsgs > span > span, #srContent #srMsgs > span > span img").css({
    								"border-radius": "0%",
    								"-webkit-border-radius": "0%"
    							});
    							$srJq("#srContent #srMsgs > span > span").css({
    								"width": "48px",
    								"height": "48px"
    							});
    							$srJq("#srContent #srMsgs > span > span img").css({
    								"width": "44px",
    								"height": "44px"
    							});
    						}

    						// Set the page URL for submission
    						$srJq('#pageUrl').val(document.URL);
    						// Set the ID for the user cookie
    						usr_details['uid'] = dataObj.uid;
    						var uid = dataObj.uid;
    						usr_details['chat_no'] = dataObj.chat_no;
    						usr_details['os'] = dataObj.os;
    						usr_details['browser'] = dataObj.browser;
    						usr_details['ip'] = dataObj.ip;
    						usr_details['device'] = dataObj.device;
    						// Stringify the data and save it to the session
    						usr_details = JSON.stringify(usr_details);
    						$srJq.cookie('sr-data', usr_details, { expires: 30, path: '/', domain: domain });
    						// Write the initial welcome message
// console.log(dataObj);

    						if(block_msg == '' && !delay_callback){
									if (typeof dataObj.welcome == 'undefined') timeDelay = 750;

    							setTimeout(function () {
										dataObj = checkForWelcome(dataObj);
    								if(image != ''){
    									$srJq('#srMsgs').append('<p class="agent inc-avatar"><span class="avatar-mini tt"><img src="' + image +'" alt="' + dataObj.agent_name + '" /></span><span>' + dataObj.agent_name + ':</span> ' + dataObj.welcome + '</p>');
											handleTts(dataObj.welcome);
										} else {
	    								$srJq('#srMsgs').append('<p class="agent"><span>' + dataObj.agent_name + ':</span> ' + dataObj.welcome + '</p>');
											handleTts(dataObj.welcome);
    								}
    								$srJq('#srMsgs').linkify({ target: '_self' });
    								$srJq('#srFaded').remove();
										if(isMobileUx) {
											$srJq("#srRecordMobileUx.srProcessing").removeClass("srProcessing").addClass("srStoppedRec");
										}
    							}, timeDelay);
    						}

    						// Drop a session cookie to record the chat ref between pages
    						$srJq.cookie('sr-ec', dataObj.chat_ref, { expires: 1, path: '/', domain: domain });
    						// If it is an autochat create the relevant room
    						if(dataObj.is_auto == 0){
    							if(typeof transfer_type == 'undefined'){
    								createLiveChat(dataObj.chat_ref, dataObj.agent_id, dataObj.agent_name);
    							} else {
    								createLiveChat(dataObj.chat_ref, dataObj.agent_id, dataObj.agent_name, dataObj.chat_no, 1, transfer_type);
    							}
    						} else {
    							createLiveChat(dataObj.chat_ref, dataObj.agent_id, dataObj.agent_name, dataObj.chat_no, 1, 'ami');
    						}

    						// Check for recovery layer cookie + track the result outcome as chat begun if required
    						var rlCookie = $srJq.cookie('sr-rl');
    						if(typeof rlCookie != 'undefined'){
    							rlCookie = JSON.parse(rlCookie);
    							var rslt = rlCookie['rslt'];
    							rlCookie['rslt'] = 0;
    							rlCookie = JSON.stringify(rlCookie);
    							$srJq.cookie('sr-rl', rlCookie, { path: '/', domain: domain });

    							var usr_ref = getUsrId();
    							$srJq.ajax({
    								url: "//app.meetami.ai/user_searches/record_goal/" + uid + '/' + rslt + '/ch-' + dataObj.chat_ref,
    								type: "GET",
    								success: function(data) {}
    							});
    						}

    						if(block_msg != ''){
    							submitMessage(block_msg);
    						} else if(delay_callback) {
									submitMessage(delay_argument);
								}

    						
    					} else if ( data == 'error' ) {

    						// Show an error and close the chat
    						alert('Sorry but there was an error creating the chat. Please try again');
    						closeReplier();

    					} else {
    						$srJq('#chat_ref').val('no-agent');
    						$srJq('#srMsgs').html('<span><span><img src="//app.meetami.ai/img//widget/default-avatar-lrg.svg" alt="Ami icon" class="profile bbl" /></span><p class="srIntro">Sorry, but there are no agents available to chat at the moment. Please complete the form below and someone will be in touch shortly.</p></span>');
    						$srJq('#srMsgs').css('min-height', 0);
    						// Change the close button to end the replier chat with no feedback
    						$srJq('.srClose').attr("rel", "srEndReplierChat").attr('name', 'skip nof');
    						var form = '<input type="hidden" name="data[Chat][transfer]" value="transfer" /><div class="input text required"><label for="name">Full name</label><input id="name" name="data[Chat][name]" required="required" type="text" /></div><div class="input text required"><label for="email">Email address</label><input type="email" id="email" name="data[Chat][email]" required="required" /></div><div class="input text required"><label for="phone">Phone number</label><input id="phone" name="data[Chat][phone]" /></div><div class="input textarea required"><label class="left-align" for="message">Message</label><textarea id="amessage" name="data[Chat][amessage]" required="required"></textarea></div>';
    						$srJq('#srInputs').html(form + '<a href="#submit" rel="srSubmitMessage" name="form" class="srFormBtn">Submit</a>');
							$srJq('#srContent').addClass("srMobileUxChatForm srNoAgentForm");
							$srJq("#srLaunchContainer").addClass("srMobileUxChatForm");
							$srJq('#srChatForm').addClass('details');
							if(isMobileUx) {
								checkRecentMsgHeight();
                msgHeight(50, function(){});
							}
							// Add listener for form submission
    						$srJq('a[rel="srSubmitMessage"]').off('click');
    						$srJq('a[rel="srSubmitMessage"]').click(function(e){
    							e.preventDefault();
    							var params = $srJq(this).attr('name');
    							if(typeof params != 'undefined'){
    								submitMessage(params);
    							} else {
    								submitMessage();
    							}
    						});

    						// Check for recovery layer cookie + track the result outcome as chat attempted
    						var rlCookie = $srJq.cookie('sr-rl');
    						if(typeof rlCookie != 'undefined'){
    							rlCookie = JSON.parse(rlCookie);
    							var rslt = rlCookie['rslt'];
    							rlCookie['rslt'] = 0;
    							rlCookie = JSON.stringify(rlCookie);
    							$srJq.cookie('sr-rl', rlCookie, { path: '/', domain: domain });

    							var usr_ref = getUsrId();
    							$srJq.ajax({
    								url: "//app.meetami.ai/user_searches/record_goal/" + uid + '/' + rslt + '/form',
    								type: "GET",
    								success: function(data) {}
    							});
    						}
    					}

    				}
    			});
        });
		}

		function checkForWelcome (dataObj) {
			console.log('FIRST');
console.log(dataObj);
			// Check for a welcome message (not undefined)
			if (typeof dataObj.welcome == 'undefined' || dataObj.welcome == 'Undefined' || dataObj.welcome == 'undefined') {
				dataObj.welcome = "Hi, I am Ami, an artificial intelligence service. I can read and direct you to information and forms on this website.";
			}

			// Check for an agent name (not undefined)
			if (typeof dataObj.agent_name == 'undefined' || dataObj.agent_name == 'Undefined' || dataObj.agent_name == 'undefined') {
				dataObj.agent_name = "Ami";
			}

			// If not dataObj at all
			if (dataObj == 0) {
				dataObj = {
					'agent_name': 'Ami',
					'agent_team': 'Online Receptionist',
					'welcome': "Hi, I am Ami, an artificial intelligence service. I can read and direct you to information and forms on this website."
				}
			}
			console.log('Returned');
			console.log(dataObj);
			return dataObj;
		}

		var agentImage = '';
		function srSetHeaderImage (dataObj, block_msg, delayed) {
			console.log("SR SET HEADER IMAGE!!!!!!!!!!!!!!");
			var img_class = '';
			var image = '';
			if(dataObj.hasOwnProperty('agent_image')){
				image = dataObj.agent_image;
				var header_image = image;
				var img_class = 'bbl';
			} else if (typeof dataObj.ChatData != 'undefined' && typeof dataObj.ChatData.agent_image != 'undefined') {
        image = dataObj.ChatData.agent_image;
				var header_image = image;
				var img_class = 'bbl';
      }
			if(typeof(dataObj.aws_widget_header_image) !== "undefined" && dataObj.aws_widget_header_image != "") {
				var header_image = dataObj.aws_widget_header_image;
			} else {
				var header_image = "//app.meetami.ai/img/widget/default-avatar-lrg.svg";
			}
			if(typeof(header_image) === "undefined") return false;
			if(!delayed) {
				// For blocked message do not display the first agent message
				if(block_msg != ''){
					$srJq('#srMsgs').html('<span><span><img src="'+ header_image +'" alt="' + dataObj.agent_name + '" class="profile ' + img_class + '" /></span><p class="srIntro">You are chatting with ' + dataObj.agent_name + '</p><p class="srIntroPos">' + dataObj.agent_team + '</p></span><span><p id="srFaded">You\'re message is being sent...</p></span>');
				} else {
					$srJq('#srMsgs').html('<span><span><img src="'+ header_image +'" alt="' + dataObj.agent_name + '" class="profile ' + img_class + '" /></span><p class="srIntro">You are chatting with ' + dataObj.agent_name + '</p><p class="srIntroPos">' + dataObj.agent_team + '</p></span>');
					agentTyping(dataObj.agent_name);
				}
			}
			agentImage = '';

			return image;

		}

		// Function to call on load to check for existing conversations
		// This handles people that switch beteen pages whilst in a conversation
		function checkExistingChats(chat_ref, callback){

			// Firstly read for a cookie
			if(typeof chat_ref == 'undefined' || chat_ref == 'undefined'){
				var chat_ref = $srJq.cookie('sr-ec');
			}

			// If the cookie is set then check out the chat
			if(chat_ref !== undefined){

				// Before getting the chat details and handling the messages check if this is a search funnel redirect
				var searchCookie = $srJq.cookie('sr-sea-rdr');
				srSearchReinput(chat_ref, searchCookie, function (rslt) {

					if (rslt === true) {
	//				$srJq('#srContent').show();
						$srJq.ajax({
							type: "GET",
							url: "//app.meetami.ai/chats/check_chat/" + client_ref + "/" + chat_ref,
							success: function(data) {
								if(data == 'bad-request'){
									// Cookie was bad so delete it
									$srJq.removeCookie('sr-ec');
								} else if (data != 'client-error') {
									$srJq("#srRecordMobileUx").addClass("srStoppedRec");
									$srJq("#srContent").removeClass("srWelcomeMessage");
									// The existing chat is valid so process the data and display it
									dataObj = JSON.parse(data);
									$srJq('#chat_ref').val(dataObj.ChatData.chat_ref);
									if(dataObj.ChatData.hasOwnProperty('filter_form_selectors')) {
										filterFormSelectors = dataObj.ChatData.filter_form_selectors;
									}
									// Set up the existing chat data to display;
									var img_class = '';
									if(dataObj.ChatData.hasOwnProperty('agent_image')){
										var header_image = dataObj.ChatData.agent_image;
										var img_class = 'bbl';
									}
									if(dataObj.ChatData.aws_widget_header_image != "") {
										var header_image = dataObj.ChatData.aws_widget_header_image;
									} else {
										var header_image = "//app.meetami.ai/img/widget/default-avatar-lrg.svg";
									}
									// For blocked message do not display the first agent message
									cur_chat = '<span><span><img src="'+ header_image +'" alt="' + dataObj.ChatData.agent_name + '" class="profile ' + img_class + '" /></span><p class="srIntro">You are chatting with ' + dataObj.ChatData.agent_name + '</p><p class="srIntroPos">' + dataObj.ChatData.agent_team + '</p></span>';

									// Set up the department ID
									trackDept(dataObj.ChatData);

									// Run a check for search funnels
									console.log(dataObj);
									if (dataObj.ChatData.in_funnel === true && typeof dataObj.ChatData.funnel_type != 'undefined' && dataObj.ChatData.funnel_type == 'search') {
										srCreateSkipper(dataObj);
									}

									// Loop through the messags and add them in
									var msgHandle = handleExistingMessageArray(dataObj.Messages, undefined, dataObj.ChatData);
									cur_chat += msgHandle.cur_chat;

									if(msgHandle.rr_postponing == true) {
										handleRRPostponed(msgHandle.rr_postponed);
									}

									$srJq("#srContent .feedback-prechat-container").removeClass("cc-exists");
									if(switchform != '' && dataObj.ChatData.is_auto == 1){
										if(switchform != null && switchform.indexOf("CC*") != -1) {
											switchform = switchform.replace('CC*', '');
																						$srJq('#srInputs').html(switchform);
											$srJq('#srChatForm').addClass('details');
										} else if(switchform != null && switchform.indexOf("DP*") != -1) {
											triggerDP(false);
											switchform = switchform.replace('DP*', '');
											$srJq('#srInputs').html(switchform);
											$srJq('#srChatForm').addClass('details');
										} else if(switchform != null && switchform.indexOf("CC*") == -1 && switchform.indexOf("CB*") == -1 && switchform.indexOf("DP*") == -1){
											$srJq('#srInputs').html(switchform + '<a href="#submit" rel="srSubmitMessage" name="form" class="srFormBtn">Submit</a>');
											$srJq('#srChatForm').addClass('details');
											if(isMobileUx) {
												prepareMobileUxChatForm();
												$srJq("#srRecordMobileUx").addClass("srStoppedRec");
											}
										} else if(switchform != null) {
											// Handle callback forms slightly differently to make sure the buttons are correct
											switchform = switchform.replace('CB*', '');
											switchform = switchform.replace('XYXY', chat_ref);
											switchform = switchform.replace(/%/g, "'");
											if(switchform.indexOf("submit") == -1 && switchform.indexOf("button") == -1){
												switchform += '<p class=\"srDataSecure\"><b> Data Once </b> We only use this information to contact you regarding your enquiry.</p>';
												switchform += '<a href="#submit" rel="srSubmitMessage" name="form" class="srFormBtn">Submit</a>';
											}
											$srJq('#srInputs').html(switchform);
											$srJq('#srChatForm').addClass('details');
											if(isMobileUx) {
												prepareMobileUxChatForm();
												$srJq("#srRecordMobileUx").addClass("srStoppedRec");
											}
										}
									} else if(switchform != '' && dataObj.ChatData.is_auto == 0){
										triggerDP(false);
										switchform = switchform.replace('DP*', '');
										$srJq('#srInputs').html(switchform);
										$srJq('#srChatForm').addClass('details');
									}
									if(isMobileUx) {
										checkRecentMsgHeight();
                    // msgHeight(50, function(){});
									}
									sr_updateUnreadMessages(unread_msg_count);

									// Check whether it is a live chat (and if so whether we need to set a timeout to trigger a switch to auto)
																			if(agent_msg_count < 3 /*&& usr_msg_count < 2 */&& dataObj.ChatData.is_auto != 1){
											// How long until the timer should be triggered
											time_since = (new Date() / 1000) - last_msg_date; // TODO - Fix this to handle proper timezones
											time_since = (120 - time_since) * 1000;
											// Set a timeout for the no messages received
											if(time_since > 0){
												srSwAutoTimer = setTimeout(function () {
													srSwitchAuto();
												}, time_since);
											} else {
												srSwitchAuto();
											}
										}
									
									$srJq('#srMsgs').html(cur_chat);
									resizeIphone();
									if(isMobileUx) {
										setTimeout(function() {
											checkRecentMsgHeight();
                      // msgHeight(50, function(){});
										}, 500);
										convertMsgsMobileUx(true);
										bindChatMessageDraggable();
									}
									if(usr_msg_count > 0) {
										$srJq(".feedback-upper-container a.footerRate").addClass("active-chat");
									}
									$srJq('#pageUrl').val(document.URL);
									if(typeof(dataObj.ChatData.feedback_id) !== "undefined") {
										$srJq('#srChatter').data("sr-feedback-given", 1);
										$srJq('#srChatter a.footerRate').parent().replaceWith('<p class="footerRate success-color">Thanks for your feedback</p>');
										setTimeout(function() {
											$srJq('#srChatter .feedback-upper-container').hide();
										}, 25000);
									}

									if ( typeof listenToTimeForm != 'undefined' && listenToTimeForm == true ) {
																					srSetupTriggerTimeFormListenner();
																			}

									// If chat widget header image is set to square, modify the elements
									if(dataObj.ChatData.widget_header_image_style == 'sq') {
										$srJq("#srContent #srMsgs > span > span, #srContent #srMsgs > span > span img").css({
											"border-radius": "0%",
											"-webkit-border-radius": "0%"
										});
										$srJq("#srContent #srMsgs > span > span").css({
											"width": "48px",
											"height": "48px"
										});
										$srJq("#srContent #srMsgs > span > span img").css({
											"width": "44px",
											"height": "44px"
										});
									}

									// Linkify the content
									$srJq('#srMsgs').linkify({ target: '_self' });

									appendViewMoreLinkToResponse();
									// If we are showing a bubble header image then hide it
																			imgToTxtHeader(0,1);
									
									// Open the replier
									openReplier(0);
									// Finally scroll the chat window down to the bottom
									scrollChat();

		                            		                				// If the default state of the chat is for it to be hidden then set the listenner to trigger it
		                				$srJq('#ami-trigger').attr("rel", "srMinToggle");
		                			
									// If it is a live chat then add the user back in to the approipriate room
									if(dataObj.ChatData.is_auto == 0){
										joinChat(chat_ref, client_ref);
									} else {
										joinChat(chat_ref, client_ref, 'ami');
									}

									srTriggerListenners ()

									// If it is the end of a deep linking funnel then check whether the results page is empty
									if (typeof dataObj.ChatData.dl_redirect != 'undefined' && dataObj.ChatData.dl_redirect == true && typeof dataObj.ChatData.funnel_details != 'undefined') {
										hideOldBtns();
										checkDlFunnelRslt(dataObj.ChatData.funnel_details, dataObj);
									}

									// Add unsent message
									if ( typeof dataObj.UnsentMessage != 'undefined' ) {
										var unsentMessage = dataObj.UnsentMessage.message;
										$srJq('#srMsgSender').val(unsentMessage);
									}
		              return true;
								}
		            if(typeof(callback) !== "undefined") {
		            	callback();
		            }
							}
						});
					} else {
						console.log('Issue in the callback from search re-input');
					}
				}); // TODO - run off a callback
			} else {
        if(typeof(callback) !== "undefined") {
          callback();
        }
      }

		}

		function handleRRPostponed(msgs) {
			$srJq("#srMsgSender").attr("disabled", true);
			var attempts = 0;
			var isLast = false;
			if(typeof(msgs[0]) !== "undefined") {
				if(msgs[0].rr_data.target_url !== null) {
					var urlLength = msgs[0].rr_data.target_url.length;
					var curUrl = window.location.href;
					if(curUrl.substr(0, urlLength) !== msgs[0].rr_data.target_url) {
						return false;
					}
				}
			}
			var rr_interval = setInterval(function() {
				attempts++;
				if(attempts == 5) {
					isLast = true;
				}
				var attempt_data = handleExistingMessageArray(msgs, isLast);
				if(attempt_data.rr_postponing == false || isLast) {
					cur_chat = attempt_data.cur_chat;
					$srJq('#srMsgs').append(cur_chat);
					$srJq("#srMsgSender").attr("disabled", false);
					scrollChat();
					clearInterval(rr_interval);
					return true;
				}
			}, 3000);
		}

		function handleExistingMessageArray(msgs, isLast, chatData) {
			console.log(chatData);
			switchform = '';
			usr_msg_count = 0;
			agent_msg_count = 0;
			last_msg_date = '';
			unread_msg_count = 0;
			var listenToTimeForm = false;
			var removingAfterCTEnd = false;
			var rrPostponed = [];
			var rrPostponing = false
			var cur_chat = "";
				console.log(msgs);
				console.log(character_count_threshold);
			$srJq.each(msgs, function(k, v) {
				console.log(v);
				if(typeof(v) === "undefined") return;
				if(rrPostponing) {
					rrPostponed.push(v);
					return;
				}
				var dismissClass = '';
				if(typeof(v.transcoded_url) !== "undefined") {
					var transcodedUrl = v.transcoded_url;
				}
				if(v.is_mobile_dismissed == true) {
					dismissClass = 'srDismissed';
				}
				if(v.virtual_msg_type == 'results-response' && v.hasOwnProperty('rr_data')) {
					var rrHandle = handleResultsResponse({response: v.rr_data}, isLast);
					console.log("isLast", isLast);
					if(rrHandle.failed == true && !isLast) {
						rrPostponing = true;
						rrPostponed.push(v);
						return;
					}
					v.message = rrHandle.response.message;

				}
				if (v.sender_name == 'endChat' || v.sender_name == 'dpQuestion') {
					cur_chat += '<div class="' + v.virtual_msg_type + " " + dismissClass + '" data-m-id="' + v.id + '"><p>' + v.message + '</p></div>';
				} else if(v.sender_name == 'feint'){
					cur_chat += '<div class="' + dismissClass + '" data-m-id="' + v.id + '"><p class="feint">' + v.message + '</p></div>';
				} else if(v.is_agent_msg == 1){

					if(v.virtual_msg_type === 'campaign'){

						var message = v.message;
						message = formatAutoMessageStrForRegularExpression(message);
						console.log('##formatted message',message);

						//Logic of incrementing index by character_count_threshold plus distance to next <br/>,?,!, or . element
						for(var index = 0; index< message.length;index = getCutOffIndex(message,index,character_count_threshold)+1){
							var splitMessage = getSplitMessageString(message,index,character_count_threshold);
							if(splitMessage.length === 0) {
								//check that we don't print empty messages
								continue;
							}

							if ( typeof v.Agent.image != 'undefined' && v.Agent.image != '' && v.virtual_msg_type == null && v.Agent.image != null && typeof v.Agent.image_dir != 'undefined' && v.Agent.image_dir != '' && v.Agent.image_dir != null ) {
								cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar ' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + v.Agent.aws_image + '/small_'+ v.Agent.image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + splitMessage + '</p>';
							} else if ( typeof v.VirtualAgent.agent_image != 'undefined' && v.VirtualAgent.agent_image != '' && v.VirtualAgent.agent_image != null && typeof v.VirtualAgent.agent_image_dir != 'undefined' && v.VirtualAgent.agent_image_dir != '' && v.VirtualAgent.agent_image_dir != null ) {
								cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + v.VirtualAgent.aws_agent_image + '/small_' + v.VirtualAgent.agent_image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + splitMessage + '</p>';
							// } else if ( typeof chatData != 'undefined' && typeof chatData.agent_image != 'undefined' && chatData.agent_image != '' && chatData.agent_image != null ) {
							// 	cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + chatData.agent_image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + v.message + '</p>';
							} else {
								cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent ' + dismissClass + '" data-m-id="' + v.id + '"><span>' + v.sender_name + ':</span> ' + splitMessage + '</p>';
							}
						}
					} else {
						if ( typeof v.Agent.image != 'undefined' && v.Agent.image != '' && v.virtual_msg_type == null && v.Agent.image != null && typeof v.Agent.image_dir != 'undefined' && v.Agent.image_dir != '' && v.Agent.image_dir != null ) {
							cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar ' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + v.Agent.aws_image + '/small_'+ v.Agent.image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + v.message + '</p>';
						} else if ( typeof v.VirtualAgent.agent_image != 'undefined' && v.VirtualAgent.agent_image != '' && v.VirtualAgent.agent_image != null && typeof v.VirtualAgent.agent_image_dir != 'undefined' && v.VirtualAgent.agent_image_dir != '' && v.VirtualAgent.agent_image_dir != null ) {
							cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + v.VirtualAgent.aws_agent_image + '/small_' + v.VirtualAgent.agent_image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + v.message + '</p>';
						// } else if ( typeof chatData != 'undefined' && typeof chatData.agent_image != 'undefined' && chatData.agent_image != '' && chatData.agent_image != null ) {
						// 	cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent inc-avatar' + dismissClass + '" data-m-id="' + v.id + '"><span class="avatar-mini"><img src="' + chatData.agent_image +'" alt="' + v.sender_name + '" /></span><span>' + v.sender_name + ':</span> ' + v.message + '</p>';
						} else {
							cur_chat += '<p ' + ((typeof(v.transcoded_url) !== 'undefined')?'data-transcoded-url="' + v.transcoded_url + '"':'') + ' class="agent ' + dismissClass + '" data-m-id="' + v.id + '"><span>' + v.sender_name + ':</span> ' + v.message + '</p>';
						}
					}


					agent_msg_count++;
					last_msg_date = v.created_unix;

					if(!v.is_read) unread_msg_count++;

				} else {
					cur_chat += '<p class="' + dismissClass + '" data-m-id="' + v.id + '"><span>You:</span> ' + v.message + '</p>';
					usr_msg_count++;
				}
				if(v.form != '' && v.form != 'DP*'){
					switchform = v.form;
					// Handle callback forms slightly differently to make sure the buttons are correct
					if(v.form != null && v.form.indexOf("CB*") == -1 && switchform.indexOf("DP*") == -1 && switchform.indexOf("CC*") == -1){
						switchform += '<p class=\"srDataSecure\"><b> Data Once </b> We only use this information to contact you regarding your enquiry.</p>';
					}
				} else {
					switchform = '';
				}
				// Check whether there is a callback time setup listenner form
				if (v.message.indexOf("srSpecifyTimeBtn") > -1) {
					listenToTimeForm = true;
				} else {
					listenToTimeForm = false;
				}
				// Check whether the message is a managing expectations message
				if (scope.chat.hasUnknownQueries === false && v.virtual_msg_type == 'manExp') {
					scope.chat.hasUnknownQueries = true;
				}
			});
			return {
				cur_chat: cur_chat,
				rr_postponed: rrPostponed,
				rr_postponing: rrPostponing
			}
		}

		function srTriggerListenners () {
			// Listen out for the Deep Link button
			$srJq('a#srEndChatBtn').on('click', function(e){
				e.preventDefault();
				// Handle the transfer
				srTransferToAgent('DL');
			});
		}

		function hideOldBtns () {
			var totalNo = $srJq('a#srEndChatBtn').length;
			var counter = 1;
			$srJq('a#srEndChatBtn').each(function(){
				if (counter < totalNo) {
					$srJq(this).remove();
					counter++;
				}
			});
		}

		function checkDlFunnelRslt (funnel, chat) {
			// First up check that we are on the correct page
			var curUrl = window.location.href;
			if (curUrl.indexOf(funnel.dl_complete_url) > -1 && typeof funnel.dl_empty_element != 'undefined') {
				// If on the correct page get the content of the required element
				var contentToCheck = $srJq(funnel.dl_empty_element).html();
				if (contentToCheck.indexOf(funnel.dl_empty_check) > -1) {

					// Count the occurrences of the empty string
					var chatContent = $srJq('#srMsgs').html();
					var count_occurrences = srOccurrences(chatContent, funnel.dl_empty_msg, false);

					// Is the index of the required string there? if so track it as an empty results page
					if (count_occurrences > 0) {
						var newContent = funnel.dl_empty_btn_endit;
						// Show the form
						srTransferToAgent('DL');
					} else {
						var newContent = funnel.dl_empty_msg + '<a href="#action" id="srEndChatBtn">' + funnel.dl_empty_btn + '</a>';
					}
					//$srJq('#srEndChatBtn').remove();
					$srJq('#srEndChatBtn').closest('p').html(newContent);
					// Run an AJAX query to update the latest message
					var uid = getUsrId();
					var msgId = chat.Messages[chat.Messages.length -1];
					msgId = msgId.id;
					$srJq.ajax({
						type: "POST",
						data: { msg: newContent, type: 'srEndChat positive updated' },
						url: "//app.meetami.ai/chats/update_message/" + msgId + "/" + chat.ChatData.chat_ref + "/" + uid,
						success: function(data) {}
					});
					srTriggerListenners();
				}
			}
		}

		function srOccurrences(haystack, needle, allowOverlap) {

	    haystack += "";
	    needle += "";
	    if (needle.length <= 0) return (haystack.length + 1);

	    var n = 0,
	        pos = 0,
	        step = allowOverlap ? 1 : needle.length;

	    while (true) {
	        pos = haystack.indexOf(needle, pos);
	        if (pos >= 0) {
	            ++n;
	            pos += step;
	        } else break;
	    }
	    return n;
		}

		// Handle a generic transfer to agents
		// Picks the most appropriate method of getting in touch
		function srTransferToAgent (transferType) {
			// Figure out if agents are online + other bits of data
			var userId = getUsrId();
			var chatId = $srJq('#chat_ref').val();
			var agentsOnline = $srJq('#agentsList').val();

			// Run an AJAX query to the app to make a call on what to do about it
			$srJq.ajax({
				type: "GET",
				url: "//app.meetami.ai/chats/transfer/" + chatId + "/" + userId + "/" + agentsOnline + "/DL",
				success: function(data) {
					if (data != 0) {
						var dataObj = JSON.parse(data);
						handleAutoMsgs(dataObj, chatId);
						$srJq('a#srEndChatBtn').slideUp(200);
					} else {
						alert('Sorry but there was an error processing your request, please try again. If the problem persists please contact us.');
					}
				}
			});
		}

		function srHandleLineBreaks (msg) {
			return (msg + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1<br />$2');
		}

		function srHandleFormBreaks (formObj) {
			// Extrac t the object
			form_data = JSON.parse(formObj);
			// Loop through each item looking for messages
			for (var i in form_data) {
				if (typeof form_data[i]['name'] != 'undefined' && form_data[i]['name'] == 'data[Chat][message]') {
					form_data[i]['value'] = srHandleLineBreaks(form_data[i]['value']);
				}
			}
			// Re-encode as JSON + return
			formObj = JSON.stringify(form_data);
			return formObj;
		}

		var slowLoadFirstTimeout = setTimeout(function(){}),
			slowLoadSecondTimeout = setTimeout(function(){}),
			slowLoadThirdTimeout = setTimeout(function(){}),
			slowLoadChatTimeout = setTimeout(function(){}),
			slowLoad1Msg = "Ami is thinking...",
			slowLoad2Msg = "Ami is typing...",
			slowLoad3Msg = "Ami is researching...",
			slowLoadChatMsg = "Please wait while I find out for you.";

		function initSlowLoadTimers() {
			clearSlowLoadTimers();
			var agentName = getAgentName();
			if(agentName != "Ami") {
				slowLoad1Msg = slowLoad1Msg.replace("Ami", agentName);
				slowLoad2Msg = slowLoad2Msg.replace("Ami", agentName);
				slowLoad3Msg = slowLoad3Msg.replace("Ami", agentName);
				slowLoadChatMsg = slowLoadChatMsg.replace("Ami", agentName);
			}
							slowLoadFirstTimeout = setTimeout(function() {
					fadedExpectationMessage(slowLoad1Msg);
				}, 3 * 1000);
										slowLoadSecondTimeout = setTimeout(function() {
					fadedExpectationMessage(slowLoad2Msg);
				}, 10 * 1000);
										slowLoadThirdTimeout = setTimeout(function() {
					fadedExpectationMessage(slowLoad3Msg);
				}, 20 * 1000);
										slowLoadChatTimeout = setTimeout(function() {
					var data = {
						response: {
							agent_name: agentName,
							agent_image: agentImage
						}
					}
					$srJq(".sr-expectation-msg").remove();
					var html = getAgentMsgHtml(data, slowLoadChatMsg);
					$srJq("#srMsgs").append(html);
					scrollChat();
					storeMessage(slowLoadChatMsg, agentName, undefined, 1);
				}, 20 * 1000);
					}

		function clearSlowLoadTimers() {
			clearTimeout(slowLoadFirstTimeout);
			clearTimeout(slowLoadSecondTimeout);
			clearTimeout(slowLoadThirdTimeout);
			clearTimeout(slowLoadChatTimeout);
			$srJq(".sr-expectation-msg").remove();
		}

		function fadedExpectationMessage(message) {
			$srJq(".sr-expectation-msg").remove();
			$srJq('#srMsgs').append('<span class="sr-expectation-msg"><p id="srFaded">' + message + '</p></span>');
			scrollChat();
		}

		// Function to submit a message for saving
		// This handles both auto chat and ordinary chat submission
		function submitMessage(form){
			console.log("SUBMIT MESSAGE CALLED");

			clearInterval(check_existing_interval);

			if($srJq("#srChatter").hasClass("delayed-creation")) {
				createChat(undefined, undefined, undefined, false, true, form);
				$srJq("#srChatter").removeClass("delayed-creation");
				disableChatForm();
				return;
			}

			// Validate the form
			var isForm = false;
			if(typeof form == 'undefined' || form == 'form') {
				var isValid = $srJq('#srChatForm').valid();
				if (typeof form != 'undefined' && form == 'form') {
					isForm = true;
				}
			} else {
				var isValid = $srJq('#' + form + 'Form').valid();
			}

			// Check whether there is a phone number in the submitted form
			if($srJq('#srInputs input[type=tel]').length){
				phone_rslt = validatePhone($srJq('#srInputs input[type=tel]').val());
				if(phone_rslt != true){
					isValid = false;
					$srJq('#srInputs input[type=tel]').closest('div').children('p.errormsg').remove();
					$srJq('#srInputs input[type=tel]').closest('div').append('<p class="small errormsg">' + phone_rslt + '</p>');
				}
			}

			// If the timeout is set + someone starts talking then clear it
			if(typeof autoClose != 'undefined'){
				clearTimeout(autoClose);
				delete autoClose;
				msg_val = $srJq('#srMsgSender').val();
				if(typeof form != 'undefined' && form != 'form') {
					msg_val = $srJq('#' + form).val();
				} else {
					msg_val = $srJq('#' + form).val();
				}
				if(msg_val != undefined && (msg_val.indexOf('no') > -1 || msg_val.indexOf('No') > -1 || msg_val.indexOf('NO') > -1 || msg_val.indexOf('thanx') > -1 || msg_val.indexOf('thanks') > -1)){
					endReplierChat('skip', 'nof');
					return;
				}
			}

			// Get the number of currently live chats
			var icChats = $srJq('#icChats').val();

			if(isValid == true){

				// Get the chat reference
				var chat_ref = $srJq('#chat_ref').val();
				enableChatForm();
				// Retrieve the message that has been typed
				if(typeof form != 'undefined' && form != 'form') {
					form_data = $srJq('#' + form + 'Form').serializeArray();
				} else {
					form_data = $srJq('#srChatForm').serializeArray();
				}

				form_data = JSON.stringify(form_data);
				// Get the message for sockets
				if($srJq('#srMsgSender').length){
					var msg = $srJq('#srMsgSender').val();
					// Because it is a message input strip out inappropriate spaces from the string
					msg = stripIncorrectSpaces(msg);
					// Convert line breaks to HTML
					msg = srHandleLineBreaks(msg);
					var winWidth = getScreenWidth();
					if(winWidth < 720){
						$srJq('#srMsgSender').off('focusout');
						$srJq('#srMsgSender').blur();
						$srJq('#srMsgSender').focusout(function(event) {
							submitMessage();
						});
					}
				}

				// Is it a transfer? If so show the loading icon
				var is_form = $srJq('#srMsgSender').val();
				if(is_form == undefined){
					$srJq('#srInputs').html('<img src="//app.meetami.ai/img/core/bg/loading.gif" class="loading" style="width: 70px; display: block; margin: 5px auto;" alt="Loading..." />');
					if(isMobileUx) {
						checkRecentMsgHeight();
            msgHeight(20, function(){});
					}
					$srJq('#srChatForm').removeClass('details');
				} else {

					// Because it is a chat input check whether we need to send a GA event
					var msgCount = $srJq('#srMsgs > p').length;
					if (msgCount == 1) {
											}

				}

				var agentsAvailable = $srJq('#agentsList').val();
				var curAgents = '';

				// Disable the input until an auto response is received
				disableChatForm();

				// If it is a form submission then set the "Agents" list to the user ref so we can submit it
				// (this is because we no longer have a chat ref attached to this submission)
				form_agents = '';
				if(typeof form != 'undefined' && form == 'form'){
					var current_cookie = $srJq.cookie('sr-data');
					if(typeof current_cookie != 'undefined'){
						current_cookie = JSON.parse(current_cookie);
						curAgents = agentsAvailable;
						agentsAvailable = current_cookie['uid'];
					}

					// If Google analytics events are enabled then track them
					
				} else if(typeof form != 'undefined') {
					// If the person has submitted a message via the none-standard form
					// Then retrieve the message from there
					msg = $srJq('#' + form).val();
				}

				
				form_data = srHandleFormBreaks(form_data);

        if(typeof(msg) == "undefined") msg = '';

				// Check submission for search funnel entries
				if (srInSearchFunnel()) {
					console.log('CHECKING FOR CF');
					var appendage = {name: "cf_value", value: srCheckSearchFunnelValue(msg)};
					form_data = appendToFormData(form_data, appendage);
					console.log('CF is: ');
					console.log(appendage);
				}

				if(srInFilterForm()) {
					var appendage = {name: "ff_value", value: srCheckFilterFormValue(msg)};
					form_data = appendToFormData(form_data, appendage);
				}

        // Format the message and add it into the widget before the AJAX call...
        if (typeof msg != 'undefined' && msg != "") {

					// Add it into the widget
		      $srJq('#srMsgs').append('<p><span>You:</span> ' + msg + '</p>');
          $srJq('#srMsgSender').val("");
          scrollChat();
        }

				initSlowLoadTimers();

				// Run the AJAX submission + save
				$srJq.ajax({
					url: "//app.meetami.ai/chats/add_msg/" + client_ref + "/" + chat_ref + "/" + agentsAvailable + '/' + icChats + '/' + curAgents,
					type: "POST",
					data: {data: form_data},
					success: function(data) {
						console.log('Completed add_msg');
						clearSlowLoadTimers();
						// console.log(data);
						// Assign the JSON array to an object
						dataObj = JSON.parse(data);
						if(isMobileUx) {
							$srJq("#srMobileSendButton").removeClass("srHasMsg");
							// $srJq(".srMobileUxEdit").parent().remove();
						}
						var message = "";
						// if(dataObj.redirect !== "undefined" && dataObj.redirect == "email") {
						// 	// {"redirect":"email","msg":"Thanks you geeza! I have sent your details to one of my colleagues who will be in touch shortly.","callback_id":"25071","callback_funnel":1,"callback_trigger":"sf","response":{"grn_msg":{"override":0,"msg":"This is a message at end of funnel - BOOM"}}}
						// 	if(typeof(dataObj.msg) !== "undefined") {
						// 		handleTts(dataObj.msg);
						// 	}
						// 	if(typeof(dataObj.response) !== "undefined" && typeof(dataObj.response.grn_msg) !== "undefined") {
						// 		handleTts(dataObj.response.grn_msg.msg);
						// 	}
						// } else {
						// 	if(typeof(dataObj.response) !== "undefined") {
						// 		if(typeof(dataObj.response.pretext) !== "undefined") {
						// 			handleTts(dataObj.response.pretext);
						// 		}
						// 		handleTts(dataObj.response.message);
						// 	} else if(typeof(dataObj.responses) !== 'undefined') {
						// 		for(var i in dataObj.responses) {
						// 			if(typeof(dataObj.responses[i].pretext) !== "undefined") {
						// 				handleTts(dataObj.responses[i].pretext);
						// 			}
						// 			handleTts(dataObj.responses[0].message);
						// 		}
						// 	}
						// }

						// if(message != "") handleTts(message);

						// Intercept AIL clarifications
						if(typeof dataObj.responses !== 'undefined' && dataObj.responses.length > 0 && typeof dataObj.responses[0].ailClarifyResponseOptions !== 'undefined' && dataObj.responses[0].ailClarifyResponseOptions == true) {
							handleAilResponseOptions(dataObj);
						} else {
							handleSubmitMessageSuccess(dataObj, true, isForm, isValid, msg, form_data, client_ref, chat_ref, agentsAvailable, icChats, curAgents);
						}
						var agentsList = $srJq("#agentsList").val();
						populateAgentsList(agentsList);
					}, error: function(e,f,g) {
						console.log(e);
						clearSlowLoadTimers();
					}

				});
			} else {
				if($srJq('#srMsgSender').length != 1){
					alert("Please complete the form before submitting it.");
				} else {
					$srJq('#srMsgSender-error').slideDown(250);
				}
			}
		}

		function handleAilResponseOptions(dataObj) {
			              	var availableAmiAgents = $srJq('#amiAgentsList').val();
              	var amiAgentStatus = $srJq('#amiAgentsStatus').val();
              	var chatReclaimed = sr_isChatReclaimed();
				var chat_ref = getChatId();
              	if (!chatReclaimed && availableAmiAgents != '') {
                  	console.log('Ami Agent AIL clarify response options');
                  	submitLiveMessage(chat_ref, "", 1, undefined, 1);
                  	// Renable the text input for future messages
                  	enableChatForm();
                  	// Track the fact that this is being transfered to an Ami agent
                  	$srJq('#amiAgentsStatus').val(1);

					sr_startResponseTimer();
				} else {
					dataObj.response = dataObj.responses[0];
					handlePretext(dataObj, function() {
						handleAutoMsgs(dataObj.response, chat_ref, true, dataObj);
					});
				}
					}

		if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
		if(typeof(user_ref) === "undefined") var user_ref = getUsrId();
		var dpFormCode = '<div class="dp-container"><button class="dp-yes">Yes</button><button class="dp-no">No</button></div>';
		var dpQuestions = [];
		var intro_msg = "Thanks for your details. We would like to ask you some questions about how we use your personal data:",
			unfinished_msg = "Last time we chatted you answered some of our data protection questions, but we've got some more for you:",
			thanks_msg = "Thanks for answering our questions";

		/* Trigger the data protection question checking/showing process */
		function triggerDP(display, triggered_by_agent) {
			sr_clearResponseTimer();
			if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
			if(typeof(user_ref) === "undefined") var user_ref = getUsrId();
            if(typeof(triggered_by_agent) === "undefined") triggered_by_agent = false;
			$srJq.ajax({
				url: "//app.meetami.ai/chats/check_user_dp_responses/" + client_ref + "/" + user_ref,
				dataType: "json",
				type: "GET",
				success: function(data) {
					// console.log(data);
					if(data) {
						handleDPQuestions(data, display, triggered_by_agent);
                        console.log("TRIGGERING HANDLE DP QUESTIONS");
					}
				},
				error: function(errorThrown) {
					console.log(errorThrown);
				}
			});
		}

		function toSimpleForm (override) {
			console.log("TO SIMPLE FORM");
			if(isMobileUx) {
				$srJq("#srContent").removeClass("srMobileUxChatForm");
				$srJq('#srLaunchContainer').removeClass('srInFeedbackState');
				$srJq("#srLaunchContainer").removeClass("srMobileUxChatForm");
				// return false;
			}
			if($srJq("#srMsgSender").length > 0 && $srJq("#srMsgSender").val() != "") return;
			if (typeof override != 'undefined' || $srJq('.dp-container').length == 0 ) {
				var simple_form = '<div class="input textarea"><textarea name="data[Chat][message]" id="srMsgSender" required="required" placeholder="Press [Enter] to send" cols="30" rows="6"></textarea></div>';
								$srJq('#srInputs').html(simple_form);
			}
		}

		function storeDPQuestion(message, html_class, include_form, usr_msg, cb, triggered_by_agent) {
			var chat_ref = getChatId();
			if(typeof(user_ref) === "undefined") var user_ref = getUsrId();
			if(typeof(client_ref) === "undefined") var client_ref = '168019131601';
			if(typeof(triggered_by_agent) === "undefined") var triggered_by_agent = false;
			if(typeof(include_form) !== "undefined" && !include_form) {
				var formToInclude = null;
			} else{
				var formToInclude = dpFormCode;
			}
            console.log("formToInclude", formToInclude);
			if(typeof(usr_msg) == "undefined") {
				var usr_msg = 0;
				var sender = 'Ami';
			} else {
				var sender = 'Customer';
			}

			var data = {
				chat_id: chat_ref,
				agent_msg: 0,
				msg: message,
				user_ref: user_ref,
				sender: sender,
				block_suggestion: true,
				is_dp: true,
				client_ref: "168019131601"
			};

			//console.log('chat messagezzz');
			// socket.emit('chat message', data);
			var amiAgentStatus = $srJq('#amiAgentsStatus').val();
			if(amiAgentStatus == 1) {
                console.log("emitting autochat message from store question");
				socket.emit('autochat message', data);
			} else {
                console.log("emitting chat message from store question");
				socket.emit('chat message', data);
			}

			$srJq.ajax({
				url: "//app.meetami.ai/chats/store_dp_chat_message/" + chat_ref + "/" + client_ref + "/" + user_ref + "/" + usr_msg,
				dataType: "json",
				type: "POST",
				data: {
					message: message,
					html_class: html_class,
					form: formToInclude
				},
				success: function(data) {
                    if(!triggered_by_agent) redistributeViaNode({question: message, usr_msg: usr_msg, dpQuestions: dpQuestions}, 'dp-question');
					if(typeof(cb) !== "undefined" && cb !== false) cb();
				}
			});
		}

		function handleDPQuestions(questions, display, triggered_by_agent) {
			if(isMobileUx) {
				$srJq("#srChatForm").addClass("srMobileUxDpQuestion");
				$srJq("#srContent").addClass("srMobileUxDpQuestion");
				$srJq("#srLaunchContainer").addClass("srMobileUxDpQuestion");
			}
			dpQuestions = questions['questions'];
			if(questions.info.intro_msg != "") intro_msg = questions.info.intro_msg;
			if(questions.info.unfinished_msg != "") unfinished_msg = questions.info.unfinished_msg;
			if(questions.info.thanks_msg != "") thanks_msg = questions.info.thanks_msg;
			if(questions.info.unfinished == true) intro_msg = unfinished_msg;
			if(display) {
				setTimeout(function() {
					if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
					if(typeof(client_ref) === "undefined") var client_ref = '168019131601';
					socket.emit('switch answering dp', {chat_id: chat_ref, client_ref: client_ref, status: 1});
					appendDPQuestion(dpQuestions[0], intro_msg, false, triggered_by_agent);
					convertToDPInputs();
				}, 1000);
			}
		}

		function convertToDPInputs() {
			$srJq('#srInputs').html(dpFormCode);
		}

		function convertToNormalInput() {
			if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
			if(typeof(client_ref) === "undefined") var client_ref = '168019131601';
			toSimpleForm(1);
			setTimeout(function(){
				socket.emit('switch answering dp', {chat_id: chat_ref, client_ref: client_ref, status: 0});
			}, 250);
		}

		function appendDPQuestion(question, intro_msg, redistributed, triggered_by_agent) {
            if(!question.hasOwnProperty("question_content")) {
            	var content = question;
            } else {
    			if(typeof(intro_msg) !== "undefined" && intro_msg != "") {
    				var content = intro_msg + "<br /><br />" + question.question_content;
    			} else {
    				var content = question.question_content;
    			}
            }
			$srJq('#srMsgs').append('<div class="srDPQuestion"><p>' + content + '</p></div>');
			handleTts(content);
			scrollChat();
            if(typeof(redistributed) == "undefined" || !redistributed) {
                storeDPQuestion(content, 'srDPQuestion', true, 0, false, triggered_by_agent);
            }
			convertToDPInputs();
			if(typeof(redistributed) == "undefined") srPlink();
		}

		function endDPQuestions(redistributed) {
			if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
			if(typeof(client_ref) === "undefined") var client_ref = '168019131601';
			$srJq('#srMsgs').append('<div class="srDPQuestion end positive"><p>' + thanks_msg + '</p></div>');
			handleTts(thanks_msg);
			if(typeof(redistributed) == "undefined") storeDPQuestion(thanks_msg, 'srDPQuestion end positive', false);
			convertToNormalInput();
			$srJq("#srChatForm").removeClass("srMobileUxDpQuestion");
			if(isMobileUx) {
				$srJq("#srContent").removeClass("srMobileUxDpQuestion");
				$srJq("#srLaunchContainer").removeClass("srMobileUxDpQuestion");
			}
			scrollChat();
			if(typeof(redistributed) == "undefined") srPlink();
            socket.emit('switch answering dp', {chat_id: chat_ref, client_ref: client_ref, status: 0});
		}

		function nextDPQuestion() {
			dpQuestions.shift();
			if(dpQuestions.length > 0) {
				appendDPQuestion(dpQuestions[0]);
			} else {
				endDPQuestions();
			}
		}

		function handleDPResponse(response) {
			$srJq("#srInputs").addClass("text-center").html('<img src="//app.meetami.ai/img/core/bg/loading.gif" class="loading loading-mini" alt="Loading..." />');
			if(response == 0) {
				var response_verbose = "No";
			} else {
				var response_verbose = "Yes";
			}
			if(typeof(user_ref) === "undefined") var user_ref = getUsrId();
			$srJq("#srMsgs").append(
				"<p class='srDPQuestionTempHidden'><span>" + response_verbose + "</span></p>"
			);
			setTimeout(function() {
				dismissSpecificMsg(response_verbose);
			}, dismissTime);
			scrollChat();
			storeDPQuestion(response_verbose, "", false, true, function() {
				$srJq.ajax({
					url: "//app.meetami.ai/chats/store_user_dp_response/" + user_ref + "/" + dpQuestions[0].question_id + "/" + response,
					dataType: "json",
					type: "GET",
					success: function(data) {
						console.log(data);
						var previousAgentMsg = $srJq('#srMsgs').find(".agent, .srDPQuestion").last().find(".srMsgInnerContent").find("p").text();
						dismissUpToMsg(previousAgentMsg);
						var elems = [];
						elems.push($srJq('#srMsgs').find(".agent, .srDPQuestion").last());
						$srJq('#srMsgs').find(".agent, .srDPQuestion").last().prevAll('div, p').each(function(index, value) {
							elems.push($srJq(value));
						});
						$srJq.each(elems, function(index, value) {
							$srJq(value).animate({
								opacity: 0
							}, 200, function() {
								$srJq(value).css("opacity", 1);
								$srJq(value).addClass("srDismissed");
							});
						});
						$srJq("#srInputs").removeClass("text-center");
						convertToDPInputs();
						nextDPQuestion();
                        // redistributeViaNode({response: response}, 'dp-response');
					},
					error: function(errorThrown) {
						console.log(errorThrown);
					}
				});
			});
		}

		$srJq("body").on("click", ".dp-yes", function(e) {
			e.preventDefault();
			handleDPResponse(1);
		});

		$srJq("body").on("click", ".dp-no", function(e) {
			e.preventDefault();
			handleDPResponse(0);
		});

		$srJq("body").on("change", "#sr-checkbox1", function() {
			if($srJq(this).prop("checked") == true) {
				$srJq("#feedback-callback-form").slideDown();
			} else {
				$srJq("#feedback-callback-form").slideUp();
			}
		});

		
		function populate_feedback_callback_form() {
			var uid = getUsrId();
			$srJq("#feedback-callback-form, #sr-toggles").hide();
			$srJq(".feedback-callback-intro").addClass("hidden");

					}

		function handlePretext(dataObj, callback) {

			// Set this up to handle multiple response objects
			if ( typeof dataObj.curResponse != 'undefined' ) {
				dataObj.response = dataObj.curResponse;
				if ( typeof dataObj.agent_name != 'undefined' ) dataObj.response.agent_name = dataObj.agent_name;
				if ( typeof dataObj.agent_image != 'undefined' ) dataObj.response.agent_image = dataObj.agent_image;
			}

			// Process the pretext
			if(typeof dataObj.response.pretext != 'undefined' && dataObj.response.pretext != '' && dataObj.response.pretext != null) {
				timeDelay = dataObj.response.pretext.length * auto_delay;
				agentTyping(dataObj.response.agent_name);
				setTimeout(function () {
					var pretextMsg = getAgentMsgHtml(dataObj, dataObj.response.pretext);
					$srJq('#srMsgs').append(pretextMsg);
					handleTts(dataObj.response.pretext);
					urlTransfer(pretextMsg);
					removeAgentTyping();
					callback();
				},timeDelay);
			} else {
				callback();
			}

		}

		function handleTrackScript (isForm, triggerType) {

			if (isForm === true) {
															if (triggerType == 'chat-form') {
													}
												}

		}

		function agentMsgCount () {
			// Check to see whether the agent has sent a message yet
			var agent_msg_count = $srJq('#srMsgs p.agent').length;
			// How many messages has the user sent
			if (typeof agent_msg_count == 'undefined') {
				agent_msg_count = 0;
			}
			return agent_msg_count;
		}

		function getAgentMsgHtml(dataObj, msg) {
			var msgHtml = "";
			if ( typeof dataObj.response.agent_image != 'undefined' && dataObj.response.agent_image != '' && dataObj.response.agent_image != 'widget/default-avatar-lrg.svg' ) {
				msgHtml = '<p class="agent inc-avatar"><span class="avatar-mini"><img src="' + dataObj.response.agent_image +'" alt="' + dataObj.response.agent_name + '" /></span><span>' + dataObj.response.agent_name + ':</span> ' + msg + '</p>';
			} else {
				msgHtml = '<p class="agent"><span>' + dataObj.response.agent_name + ':</span> ' + msg + '</p>';
			}

			return msgHtml;
		}

		function agentTyping(agentName) {
			var typingMsg = "Ami is typing...".replace("Ami", "").replace(agentName, "");
			$srJq('#srMsgs').append('<span><p id="srFaded">' + agentName + ' ' + typingMsg + '</p></span>');
		}

		function removeAgentTyping() {
			$srJq('#srFaded').remove();
		}

		// Handle automated chat responses
		// Separated out to give a cleaner submitMessage function + allow for reuse with Ami agents
		function handleAutoMsgs ( dataObj, chat_ref, redistribute, mmObj ) {
			// Make this a function that is reusable for multiple responses as well as single responses
			// To do this simply reformat the single message response object to be in the format of a single response dataObj
			if ( typeof mmObj != 'undefined' ) {
				dataObj.agent_image = mmObj.agent_image;
				dataObj.agent_name = mmObj.agent_name;
				mmObj.response = dataObj;
				dataObj = mmObj;
			}

			// Handle the single message
			if ( typeof dataObj.response.agent_name == 'undefined' || dataObj.response.agent_name == null ) {
				dataObj.response.agent_name =	$srJq('#srMsgs').find('p.agent span:not(.avatar-mini)').html();
				if (typeof dataObj.response.agent_name != 'undefined') {
					dataObj.response.agent_name =	dataObj.response.agent_name.replace(':', '');
				}
			}
			if (typeof dataObj.response.agent_image == 'undefined' || dataObj.response.agent_image == '' || dataObj.response.agent_image.indexOf('small_') == -1 ) {
				if ( $srJq('#srMsgs p.agent.inc-avatar span.avatar-mini').length > 0 ) {
					dataObj.response.agent_image = $srJq('#srMsgs').find('p.agent.inc-avatar span.avatar-mini img').attr('src');
					dataObj.response.agent_image = dataObj.response.agent_image.replace('https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/', '');
				} else {
					dataObj.response.agent_image = '';
				}
			}

			
			var stopAfterGrn = false;
			// Handle any pretext messages
			if (typeof dataObj.response.pretext != 'undefined' && typeof dataObj.response.message != 'undefined' && dataObj.response.message != '' && typeof dataObj.isConvoForm != 'undefined') {
				// Handle the pretext
				ptDelay = dataObj.response.pretext.length * auto_delay;
				agentTyping(dataObj.response.agent_name);
				var ptResponse = getAgentMsgHtml(dataObj, dataObj.response.pretext);
				setTimeout(function(){
					removeAgentTyping();
					$srJq('#srMsgs').append(ptResponse);
					handleTts(dataObj.response.pretext);
					scrollChat();
					setTimeout(function(){
						agentTyping(dataObj.response.agent_name);
						scrollChat();
					}, 150);
				}, ptDelay);
				// Set up the core  message
				timeDelay = dataObj.response.message.length * auto_delay + ptDelay + 150;
				var response = getAgentMsgHtml(dataObj, dataObj.response.message);
			} else if (typeof dataObj.response.message != 'undefined' && dataObj.response.message != '') {
				// timeDelay = dataObj.response.message.length * auto_delay;
				// agentTyping(dataObj.response.agent_name);
				console.log("MESSAGE: " + dataObj.response.message);
				if(dataObj.response.virtual_msg_type == 'results-response' && dataObj.response.message.match(/(?:\*).*(?:\*)/)) {
					dataObj = handleResultsResponse(dataObj);
				} else if(dataObj.response.virtual_msg_type == 'ClickThrough' || dataObj.response.virtual_msg_type == 'ClickThroughEnd' || dataObj.response.virtual_msg_type == 'click-through-unupdated') {
					dataObj = handleClickThrough(dataObj);
				} else if(dataObj.response.hasOwnProperty('trigger_qsf_redirect') && (dataObj.response.virtual_msg_type == 'QuickSearchForm' || dataObj.response.virtual_msg_type == 'QuickSearchFormEnd' || dataObj.response.virtual_msg_type == 'quick-search-form')) {
					dataObj = handleQuickSearchForm(dataObj);
				} else if(dataObj.response.hasOwnProperty('cancel_appts')) {
					handleApptCancellationDates(dataObj);
 				}

				console.log(dataObj);
				if(typeof(dataObj) === "undefined") return false;
				// var response = getAgentMsgHtml(dataObj, dataObj.response.message);
			} else {
				stopAfterGrn = true;
			}

			// Check whether a green message is in place
			var overrideCall = false;
			if (dataObj.response.hasOwnProperty('grn_msg')) {
				// Firstly check wehter it's an override message
				if (typeof dataObj.response.grn_msg.override != 'undefined' && dataObj.response.grn_msg.override == 1) {
					overrideCall = true;
				}
				// If there is no response message then just apend the green message
				if (stopAfterGrn === true) {
					// Append the new green message onto the end of the chat
					var addn_data = '<div class="srEndChat positive"><p>' + dataObj.response.grn_msg.msg + '</p></div>';
					$srJq('#srMsgs').append(addn_data);
					handleTts(addn_data);
					toSimpleForm();
					$srJq('#srChatForm').removeClass('details');
					// Play alerts
					if(redistribute) srPlink();
					scrollChat();
				}
			}

			// Finally scroll the chat window down to the bottom
			scrollChat();

			if (stopAfterGrn === false) {

				var startingIndex = 0;
				renderAutoMessage(dataObj, startingIndex);
			}

			// If this includes a call cancellation then notify the node server
			if(dataObj.response.hasOwnProperty('cancel_call') && dataObj.response.cancel_call == true && dataObj.response.hasOwnProperty('call_ref') && dataObj.response.call_ref != '' && dataObj.response.call_ref != null){
				socket.emit('call cancel', '168019131601', dataObj.response.call_ref);
				clearTimeout(srSpecifyHide);
				delete srSpecifyHideSpec;
				$srJq('#srMsgs .srEndChat.phone:last').html("<p>The callback request has been cancelled.</p>").show();
				$srJq('#srSpecifyTime').off('click');
				$srJq('#srSpecifyTimeBtn').off('click');
			} else if (dataObj.response.hasOwnProperty('cancel_call') && dataObj.response.cancel_call == true && dataObj.response.hasOwnProperty('call_ref') && dataObj.response.call_ref == null) {
				clearTimeout(srSpecifyHide);
				delete srSpecifyHideSpec;
				$srJq('#srMsgs .srEndChat.phone:last').html("<p>The callback request has been cancelled.</p>").show();
				$srJq('#srSpecifyTime').off('click');
				$srJq('#srSpecifyTimeBtn').off('click');
			}


			$srJq('#srMsgs').linkify({ target: '_self' });

			if (typeof timeDelay == 'undefined') {
				var timeDelay = 1500;
			}
			return timeDelay;

			function renderAutoMessage(dataObj,index){

				var message = dataObj.response.message.trim();
				message = formatAutoMessageStrForRegularExpression(message);

				var splitMessage = getSplitMessageString(message,index,character_count_threshold);

				if(index >= message.length){
					//Deal with end of message
					enableChatForm();
					return;
				}

				if(splitMessage.trim().length === 0){
					//skip to rendering of next message if empty string
					index = getCutOffIndex(message,index,character_count_threshold) +1 ;
					return renderAutoMessage(dataObj,index);
				}

				index = getCutOffIndex(message,index,character_count_threshold);

				timeDelay = splitMessage.length * auto_delay;

				var response = getAgentMsgHtml(dataObj, splitMessage);
				disableChatForm();
				setTimeout(function(){

					scrollChat();
					agentTyping(dataObj.response.agent_name);
					setTimeout(function () {

						$srJq('#srMsgs').append(response);
						if(typeof(dataObj.response.message) !== "undefined") handleTts(dataObj.response.message);
						removeAgentTyping();
						scrollChat();

						$srJq("#srContent .feedback-prechat-container").removeClass("cc-exists");

						// If appropriate replace the form with a form from the response
						if(dataObj.response.hasOwnProperty('form') && dataObj.response.form != '' && dataObj.response.form != null){
							var form = dataObj.response.form;
							if(dataObj.response.form.indexOf('CC*') === -1) {
								form += '<p class=\"srDataSecure\"><b> Data Once </b> We only use this information to contact you regarding your enquiry.</p><a href="#submit" rel="srSubmitMessage" name="form" class="srFormBtn">Submit</a>';
							} else {
															}
							form = form.replace('CB*', '').replace('CC*', '');
							$srJq('#srInputs').html(form);
							$srJq('#srChatForm').addClass('details');
							if(isMobileUx) {
								prepareMobileUxChatForm();
								checkRecentMsgHeight();
								// msgHeight(50, function(){});
							}
							// Add a listener to the form button
							$srJq('a[rel="srSubmitMessage"]').off('click');
							$srJq('a[rel="srSubmitMessage"]').click(function(e){
								e.preventDefault();
								var params = $srJq(this).attr('name');
								if(typeof params != 'undefined'){
									submitMessage(params);
								} else {
									submitMessage();
								}
							});

						}

						// If the response calls for a delayed redirect (end of a deep link funnel) then handle that
						if(dataObj.response.hasOwnProperty('dl_redirect') && dataObj.response.dl_redirect != ''){
							handleRedirect(dataObj.response);
						}

						processGrnMsg(dataObj);

						// If a callback has been triggered then either display the form or the button
						if(dataObj.response.hasOwnProperty('callback') && dataObj.response.callback == 1){

							var haveNo = $srJq('#srNoExists').val();
							if(haveNo == 1 || (dataObj.response.hasOwnProperty('haveno') && dataObj.response.haveno == 1)){
																if (overrideCall === false) {

									setTimeout(function () {
										// Trigger the call
										var ref = 'ch-';
										if(dataObj.response.hasOwnProperty('callback_funnel') && dataObj.response.callback_funnel == 1){
											ref = 'sf-';
										}
																					scope.greenTimeout = setTimeout(function(){
												if (dataObj.response.hasOwnProperty('cb_exists') && dataObj.response.cb_exists == 1){
													// A callback request already exists so show a green message showing that
													var end_msg = '<div class="srEndChat phone"><p>A call has already been scheduled. We will be in touch as soon as we can.</p></div>';
													if(redistribute) recordAutoMsg('A call has already been scheduled. We will be in touch as soon as we can.', 'srEndChat phone');
													$srJq('#srMsgs').append(end_msg);
													handleTts(end_msg);
													scrollChat();
													if(redistribute) srPlink();
												} else {
													srEndChatWrapper(true, ref, redistribute);
												}
											}, 2000);
																			}, 3000);
									// Set it back to a simple form
									toSimpleForm();
									$srJq('#srChatForm').removeClass('details');

								}

							} else if (!dataObj.response.hasOwnProperty('form') || dataObj.response.form == '') {
								var cb_form = '<form action="/sitereplier/chats/chat/54251525" id="chatPhoneForm" method="post" accept-charset="utf-8"><div class="input text"><label for="srNameChat">Your name</label><input name="data[Chat][full_name]" id="srNameChat" required="required" type="text"/></div><div class="input text required"><label for="email">Email address</label><input type="email" id="email" name="data[Chat][email]" required="required" /></div><div class="input text"><label for="srPhoneChat">Phone number</label><input name="data[Chat][phone_no]" id="srPhoneChat" type="text"/></div></form><button class="srSubmitForm" id="srPhoneRlBtn" onclick="return triggerCallWrapper(%ch-%, %XYXY%, %srPhoneChat%, %srNameChat%, 0); return false;">Submit</button>';
								cb_form = cb_form.replace('XYXY', chat_ref);
								cb_form = cb_form.replace(/%/g, "'");
								$srJq('#srInputs').html(cb_form);
								$srJq('#srChatForm').addClass('details');
								if(isMobileUx) {
									checkRecentMsgHeight();
									// msgHeight(50, function(){});
								}
							}
						}

						// Finally scroll the chat window down to the bottom + enable the input
						enableChatForm();
						scrollChat();

						if(redistribute) srPlink();
						// Linkify the content


						var result = $srJq('#srMsgs').linkify({ target: '_self' });
						appendViewMoreLinkToResponse();
						// If the message also wants the user to redirect
						if(overrideCall === false && dataObj.response.hasOwnProperty('redirect') && dataObj.response.redirect != 'email'){
							if(dataObj.hasOwnProperty('redistributed')) {
								var add_chat = '<div class="srEndChat chat"><p>Your chat has been transferred to one of our live chat agents.</p></div>';
								// recordAutoMsg('Your chat has been transferred to one of our live chat agents.', 'srEndChat chat', 1, redistribute);
								$srJq('#srMsgs').append(add_chat);
								handleTts(add_chat);
								$srJq('#srMsgs').linkify({ target: '_self' });
								scrollChat();
							} else {
								switchLive(chat_ref, dataObj.response.redirect);
							}
						}

						// If the message wants an email sent
						if(overrideCall === false && dataObj.hasOwnProperty('emailed') && dataObj.emailed == 1){
							srEndChatWrapper('emailed');
						}

						// If it is switched on + this is the first negative comment in the chat
													scope.chat.hasUnknownQueries = false;
						
						if (scope.chat.hasUnknownQueries === false && typeof meMsgShown == 'undefined') {
							// If it is switched on then handle the intro
													}

						// Finally after a brief delay forward the user to any site URLs included in the message
						urlTransfer(response);

						index++;
						console.log('##index passed on next iteration##',index);
						renderAutoMessage(dataObj,index);
					}, timeDelay);

				},500);
			}
		}



		function getDynamicValues(selector, numeric, formatting) {
			var firstChar = $srJq(selector).first().text().charAt(0);
			var values = [];
			var floatValues = [];
			var hasValue = false;
			if(firstChar.match(/^[0-9a-zA-Z]+$/)) {
				var currencySymbol = "";
			} else {
				var currencySymbol = $srJq(selector).first().text().replace(/\n/ig, '').charAt(0).match(/[^\d,]/g);
			}
			var aVal;
			$srJq(selector).each(function(index, value) {
				var floatVal = parseFloat($srJq(this).text().replace(/[^\d.-]/g, ''));
				if (floatVal != "NaN" && !isNaN(floatVal)) {
					floatValues.push(floatVal);
					hasValue = true;
				}
				if(typeof(numeric) == "undefined" || numeric === false || (typeof(numeric) != "undefined" && numeric && !isNaN(floatVal))) {
					if(typeof(formatting) === "undefined" || formatting == "") {
						aVal = $srJq(this).html().replace(/<\/h[^>]*>/g, "<br />").replace(/<\/p>/g, "<br />").replace(currencySymbol, '').replace(/(<((?!br)[^>]+)>)/ig, "").trim();
						values.push(aVal);
					} else {
						var subElements = formatting.match(/[^{\}]+(?=})/g);
						if(subElements && subElements.length > 0) {
							var str = formatting;
							for(var i in subElements) {
								var regexp = new RegExp(subElements[i].replace(/\(/g, "\\(").replace(/\)/g, "\\)").replace(/\:/g, "\\:"), "g");
								str = str.replace(regexp, $srJq(this).find(subElements[i]).text()).replace(/{|}/g, "").replace(/&nbsp;/, " ").trim();
							}
						} else {
							var str = "";
						}
						values.push(str.replace(currencySymbol, ''));
					}
				}
			});
			if(typeof numeric != "undefined" && numeric) {
				if($srJq(selector).length > 0 && !hasValue) {
					return 'parse-failure';
				}
			}
			return {
				values: values,
				floatValues: floatValues,
				currencySymbol: currencySymbol
			};
		}

		function handleApptCancellationDates(dataObj) {
			var appt_btns = "";
			$srJq("body").off("click", ".srCancelAppt");
			$srJq("body").on("click", ".srCancelAppt", function() {
				$srJq("#srContent .feedback-prechat-container").removeClass("cc-exists");
				handleCancelAppt($srJq(this).data("value"));
			});
		}

		var apptCancelWait = false;
		function handleCancelAppt(value) {
			toSimpleForm();
			$srJq("#srMsgSender").val(value);
			submitMessage();
			$srJq("#srInputs").addClass("text-center").html('<img src="//app.meetami.ai/img/core/bg/loading.gif" class="loading loading-mini" alt="Loading..." />');
			apptCancelWait = true;
		}

		function handleResultsResponse(dataObj, isLast) {
			if(dataObj.response.target_url !== null) {
				var urlLength = dataObj.response.target_url.length;
				var curUrl = window.location.href;
				if(curUrl.substr(0, urlLength) !== dataObj.response.target_url) {
					dataObj.failed = true;
					return dataObj;
				}
			}
			var resultsResponsePre = dataObj.response.message;
			if(dataObj.response.message.indexOf('*LOWEST*') >= 0 && typeof(dataObj.response.lowest_css_selector) !== "undefined" && dataObj.response.lowest_css_selector != "") {
				var lowest = getDynamicValues(dataObj.response.lowest_css_selector, true);
				if(lowest == 'parse-failure') {
					dataObj.response.message = dataObj.response.parse_failure_message;
				} else if(lowest.floatValues.length > 0) {
					dataObj.response.message = dataObj.response.message.replace('*LOWEST*', lowest.currencySymbol + Math.min.apply(null, lowest.floatValues));
				}
			}
			if(dataObj.response.message.indexOf('*HIGHEST*') >= 0 && typeof(dataObj.response.highest_css_selector) !== "undefined" && dataObj.response.highest_css_selector != "") {
				var highest = getDynamicValues(dataObj.response.highest_css_selector, true);
				if(highest == 'parse-failure') {
					dataObj.response.message = dataObj.response.parse_failure_message;
				} else if(highest.floatValues.length > 0) {
					dataObj.response.message = dataObj.response.message.replace('*HIGHEST*', highest.currencySymbol + Math.max.apply(null, highest.floatValues));
				}
			}
			if(dataObj.response.message.indexOf('*AVERAGE*') >= 0 && typeof(dataObj.response.average_css_selector) !== "undefined" && dataObj.response.average_css_selector != "") {
				var average = getDynamicValues(dataObj.response.average_css_selector, true);
				if(average == 'parse-failure') {
					dataObj.response.message = dataObj.response.parse_failure_message;
				} else if(average.floatValues.length > 0) {
					dataObj.response.message = dataObj.response.message.replace('*AVERAGE*', average.currencySymbol + (average.floatValues.reduce(function(a,b){return a+b;}) / average.floatValues.length).toFixed(2));
				}
			}
			if(dataObj.response.message.indexOf('*LIST-ALL*') >= 0 && typeof(dataObj.response.list_all_css_selector) !== "undefined" && dataObj.response.list_all_css_selector != "") {
				var listAll = getDynamicValues(dataObj.response.list_all_css_selector, false, dataObj.response.list_all_formatting);
				if(listAll.values.length > 0) {
					var listValues = [];
					$srJq.each(listAll.values, function(lindex, lvalue) {
						if(listAll.currencySymbol != "") {
							lvalue = listAll.currencySymbol + lvalue;
						}
						listValues.push(lvalue);
					});
					if(listValues.length > 0) dataObj.response.message = dataObj.response.message.replace('*LIST-ALL*', ' - ' + listValues.join("<br /> - "));
				}
			}
			if(dataObj.response.message.search(/(LIST-)+[0-9]/) != -1 && typeof(dataObj.response.list_n_css_selector) !== "undefined" && dataObj.response.list_n_css_selector != "") {
				var listN = getDynamicValues(dataObj.response.list_n_css_selector, false, dataObj.response.list_n_formatting);
				var numToList = parseInt(dataObj.response.message.charAt(dataObj.response.message.search(/(LIST-)+[0-9]/) + 5));
				if(listN.values.length > 0) {
					var listValues = [];
					var c = 0;
					$srJq.each(listN.values, function(lindex, lvalue) {
						if(c < numToList) {
							if(listN.currencySymbol != "" && listN.currencySymbol != "↵") {
								lvalue = listN.currencySymbol + lvalue;
							}
							listValues.push(lvalue);
							c++;
						}
					});
					if(listValues.length > 0) {
						if (listValues.length == 1) {
							dataObj.response.message = dataObj.response.message.replace(/(\*LIST-)+[0-9]+(\*)/, listValues.join(""));
						} else {
							dataObj.response.message = dataObj.response.message.replace(/(\*LIST-)+[0-9]+(\*)/, ' - ' + listValues.join("<br />- "));
						}
					}
				}
			}
			var chat_ref = getChatId();
			var client_ref = '168019131601';
			if(dataObj.response.message.replace(/\r?\n|\r/g, " ").indexOf(/\*.*\*/) != -1 || dataObj.response.message.indexOf("LIST-") != -1 || dataObj.response.message.indexOf("*LOWEST*") != -1 || dataObj.response.message.indexOf("*HIGHEST*") != -1 || dataObj.response.message.indexOf("*AVERAGE*") != -1) {
				if(isLast) dataObj.response.message = dataObj.response.failure_message;
				dataObj.failed = true;
			} else {
				dataObj.failed = false;
			}
			if(isLast || !dataObj.failed) {
				$srJq.ajax({
					url: "//app.meetami.ai/results_response/update_variable_message/",
					type: "POST",
					dataType: "json",
					data: {
						chat_ref: chat_ref,
						client_ref: client_ref,
						pre_message: resultsResponsePre,
						post_message: dataObj.response.message
					},
					success: function(data) {
						console.log(data);
					},
					error: function(errorThrown) {
						console.log(errorThrown);
					}
				});
				dataObj.response.message = dataObj.response.message.replace(/(\r\n|\n\r|\r|\n)/g, "<br>");
			}
			if(!isLast && dataObj.failed) {
				dataObj.response.skip = 1;
			}
			return dataObj;
		}

		function handleQuickSearchForm(dataObj) {
			if($srJq(dataObj.response.search_input_selector).length > 0 && $srJq(dataObj.response.submit_button_selector).length > 0) {
				if(typeof(dataObj.response.terms) === 'string') dataObj.response.terms = JSON.parse(dataObj.response.terms);
				var term_string = dataObj.response.terms.join(" ");
				$srJq(dataObj.response.search_input_selector).val(term_string);
				$srJq(dataObj.response.submit_button_selector).trigger("click");
			} else {
				dataObj.response.message = dataObj.response.no_form_negative_message;
				return dataObj;
			}
		}

		function handleClickThrough(dataObj) {
			var terms = dataObj.response.terms;
			var name_css_selector = dataObj.response.name_css_selector;
			var chat_ref = getChatId();
			var client_ref = '168019131601';
			if(typeof(terms) == 'object') {
				var tmp = terms;
				terms = [];
				for(var i in tmp) {
					terms.push(tmp[i]);
				}
			}
			if(terms.length > 0) {
				var nameObjects = $srJq(name_css_selector);
				var nameObjectsText = [];
				$srJq(nameObjects).each(function(index, value) {
					nameObjectsText.push($srJq(value).text());
				});
				var matches = valueScores(terms, nameObjectsText);
				if(typeof(matches) !== "undefined" && matches.length > 0) {
					if(matches.length == 1) {
						var foundName = "\"" + $srJq(nameObjects[matches[0]]).text() + "\"";
						if(dataObj.response.hasOwnProperty('trigger_ct_redirect') || dataObj.response.hasOwnProperty('no_confirmation_toggle')) {
							var triggerElement = $srJq(nameObjects[matches[0]]).parents(dataObj.response.containing_css_selector).find(dataObj.response.click_through_css_selector);
							if(!dataObj.response.hasOwnProperty('no_confirmation_toggle')) {
								triggerElement.trigger("click");
							} else {
								$srJq.ajax({
									url: "//app.meetami.ai/chats/update_click_through_redirected/" + client_ref + "/" + chat_ref,
									type: "POST",
									success: function(data) {
										var dataObj = JSON.parse(data);
										console.log(dataObj);
										triggerElement.trigger("click");
									},
									error: function(data) {
										console.log(data);
									}
								});
							}
							return;
						} else {
							dataObj.response.message = dataObj.response.item_found_message.replace("*MATCH*", foundName);
							if(dataObj.response.message.indexOf("*ADDITIONAL*" != -1) && dataObj.response.additional_css_selector != "" && dataObj.response.containing_css_selector != "") {
								dataObj.response.message = dataObj.response.message.replace("*ADDITIONAL*", $srJq(nameObjects[matches[0]]).parents(dataObj.response.containing_css_selector).find($srJq(dataObj.response.additional_css_selector)).text());
							}
							$srJq.ajax({
								url: "//app.meetami.ai/chats/update_click_through_confirmation/" + client_ref + "/" + chat_ref,
								type: "POST",
								data: {
									msg: dataObj.response.message
								},
								success: function(data) {
									var dataObj = JSON.parse(data);
									console.log(dataObj);

								},
								error: function(data) {
									console.log(data);
								}
							});
						}
					} else if(matches.length > 1) {
						var clarifyNames = [];
						for(var i in matches) {
							clarifyNames.push("\"" + $srJq(nameObjects[matches[i]]).text() + "\"");
						}
						dataObj.response.message = dataObj.response.multi_clarification_message.replace("*MATCHES*", ' - ' + clarifyNames.join("<br /> - "));
					}
				} else {
					if(!dataObj.response.hasOwnProperty('enter_ct')) {
						dataObj.response.message = dataObj.response.none_found_message;
					}
				}
			}
			if(typeof(isEnd) === "undefined") var isEnd = null;
			$srJq.ajax({
				url: "//app.meetami.ai/chats/update_recent_click_through_msg/" + client_ref + "/" + chat_ref,
				type: "POST",
				data: {
					msg: dataObj.response.message,
					end: isEnd
				},
				success: function(data) {
					var dataObj = JSON.parse(data);
					console.log(dataObj);

				},
				error: function(data) {
					console.log(data);
				}
			});
			return dataObj;
		}

		/* Takes a [needle] and searches for it in [elements]. Returns array of indexes based on the match percentages */
		function valueScores(needles, elements) {
			var results = [];
			for(var i in needles) {
				var nameObjectCount = 0;
				for(var n in elements) {
					if(!results.hasOwnProperty(nameObjectCount)) {
						results[nameObjectCount] = {fullWord: 0, partialWord: 0, smallNeedle: false, elementIndex: parseInt(n)};
					}
					var fullWordMatch = false;
					var elementsSplit = elements[n].split(" ");
					for(var s in elementsSplit) {
						if(needles[i].toLowerCase() == elementsSplit[s].toLowerCase()) {
							fullWordMatch = true;
							results[nameObjectCount].fullWord = parseInt(results[nameObjectCount].fullWord + 2);
						}
					}
					if(!fullWordMatch && elements[n].toLowerCase().indexOf(needles[i].toLowerCase()) != -1) {
						if(needles[i].length < 3) {
							results[nameObjectCount].smallNeedle = true;
						}
						results[nameObjectCount].partialWord = parseInt(results[nameObjectCount].partialWord + 1);
					}
					nameObjectCount++;
				}
			}
			var highestScore = -1;
			var highestIndexes = [];
			for(var i in results) {
				if(results[i].fullWord == 0 && results[i].partialWord == 1 && results[i].smallNeedle == true) {
					delete results[i];
				} else {
					var combinedScore = results[i].fullWord + results[i].partialWord;
					if(combinedScore == 0) continue;
					if(combinedScore > highestScore) {
						highestScore = combinedScore;
						highestIndexes = [results[i].elementIndex];
					} else if(combinedScore == highestScore) {
						highestScore = combinedScore;
						highestIndexes.push(results[i].elementIndex);
					}
				}
			}
			// console.log("VALUE SCORE RESULTS", results);
			// console.log("HIGHEST SCORE", highestScore);
			// console.log("HIGHEST INDEXES", highestIndexes);
			return highestIndexes;
		}
		window.valueScores = valueScores;

		function processGrnMsg (dataObj){
console.log(dataObj);
			if (dataObj.hasOwnProperty('response') && dataObj.response.hasOwnProperty('grn_msg') && (!dataObj.response.hasOwnProperty('form') || (dataObj.response.hasOwnProperty('form') && dataObj.response.form == ''))) {
				// Append the new green message onto the end of the chat
				var addn_data = '<div class="srEndChat positive"><p>' + dataObj.response.grn_msg.msg + '</p></div>';
				$srJq('#srMsgs').append(addn_data);
				handleTts(addn_data);
				// Play alerts
				srPlink();
				scrollChat();
			}
		}

		/* Upon provision of a response track the department if provided */
		function trackDept (data) {

			if ( typeof data.department_id != 'undefined' && data.department_id != null ) {
				var prev = $srJq('#chatDept').val();
				if (prev != data.department_id) {
					$srJq('#chatDept').val(data.department_id);
					updateAvailableAgents(data.department_id);
				}
			}

		}

		// Handles a delayed redorect for Deep linking funnels
		function handleRedirect (dl_data) {

			setTimeout(function(){
				window.location.href = dl_data.dl_redirect;
			}, dl_data.dl_delay * 1000);

		}

		/* Utility function to update the available agents list based on the
		department that we are querying - if dept_id is left mepty then it returns
		all the agents for this organisation */
		function updateAvailableAgents (dept_id) {

			if (typeof dept_id == 'undefined' || (typeof(dept_id) == 'string' && dept_id == '')) {

				// No department selected just query the full list of agents
				socket.emit('agents customer query', '168019131601');

			} else {

				// No department selected just query the full list of agents
				socket.emit('agents customer query', '168019131601', dept_id);

			}
			// Get an updated list of Ami agents
			socket.emit('ami_agents customer query', '100');

		}

		// Check whether a message contains a URL that includes the approved domain
		function containsApprovedDomain ( url ) {

			// Set up a list of the approved domains for this client
			var approvedDomains = [];
			approvedDomains.push("https://www.stockport.gov.uk/");
							approvedDomains.push("stockport.gov.uk");
							approvedDomains.push("stage-iag-stockportgov.smbcdigital.net");
							approvedDomains.push("myaccount.stockport.gov.uk");
							approvedDomains.push("nationalrail.co.uk");
							approvedDomains.push(" stockport-hbnc.egovhub.net");
							approvedDomains.push("stockport-hbnc.egovhub.net");
							approvedDomains.push("stockport.gov.uk");
							approvedDomains.push(" roadworks.org");
							approvedDomains.push(" totallylocalcompany.co.uk");
							approvedDomains.push("democracy.stockport.gov.uk");
							approvedDomains.push("interactive.stockport.gov.uk");
							approvedDomains.push("roadworks.org");
							approvedDomains.push("gov.uk");
							approvedDomains.push("gov.uk");
							approvedDomains.push("mycaremychoice.org.uk");
							approvedDomains.push("recycleforgreatermanchester.com");
							approvedDomains.push("GOV.UK");
							approvedDomains.push("council.tax@stockport.gov.uk");
							approvedDomains.push("uk-air.defra.gov.uk");
							approvedDomains.push("stockport-fairtrade.org.uk");
							approvedDomains.push("eco-schools.org.uk");
							approvedDomains.push("feedingstockport.org.uk");
							approvedDomains.push("assets.ctfassets.net");
							approvedDomains.push("getcomposting.com");
							approvedDomains.push("webcontent@stockport.gov.uk");
							approvedDomains.push("education.stockport.gov.uk");
							approvedDomains.push("tfgm.com");
							approvedDomains.push("planningportal.co.uk");
			
			// loop through the approved domains
			for ( var i in approvedDomains ) {
				// Return true if the URL contains the desired domain
				console.log(approvedDomains[i]);
				if (url.indexOf(approvedDomains[i]) > -1) {
					console.log("WORKED");
					return true;
				}
			}

			// By defaukt return false
			return false;
		}

		/* Function to trigger an auto transfer to a link included within the agent message */
		function urlTransfer (response_content) {

        			// Set up the domain of the site the widget is installed on
				var installedDomain = "https://www.stockport.gov.uk/";
  			var cur_page = window.location.href;

  			// Search the response for the URL
  			if (containsApprovedDomain(cur_page)) {

  				// If it exists assemble the full URL to redirect to
  				response_content = response_content.split(/[ <>"']/);
  				for(var i = 0; i < response_content.length; i++) {
  					if (containsApprovedDomain(response_content[i]) && cur_page != response_content[i]) {
							// Set a delay so we don't forward whilst someone is trying to read

  						var rdrUrl = response_content[i];

  						if (rdrUrl.indexOf('@') == -1) {

  							// Clear existing redirects that may be awaiting transfer
  							clearTimeout(scope.pendingRedirect);
  							// Then transfer
  							scope.pendingRedirect = setTimeout(function () {
  								// Redirect to the URL (if not the current page)
  								window.location.href = rdrUrl;
  							}, 5000);

  						}

  					}
  				}
  			}
      		}

		function transferToBumpyard() {
			if(typeof chat_ref == "undefined") {
				var chat_ref = getChatId();
			}
			console.log("transferToBumpyard");
			// AJAX request to change the details of the current chat
			$srJq.ajax({
				url: "//app.meetami.ai/chats/transfer_to_bumpyard/" + chat_ref + "/" + client_ref,
				type: "GET",
				success: function(data) {
					console.log("Transfer to bumpyard success callback: ");
					console.log(data);

				},
				error: function(error) {
					console.log(error);
				}
			});
		}

		/* Function to handle the switch from standard to live chat
		*/
		function switchLive(chat_ref, transfer_type){

			if (transfer_type != 'BY') {
				transferToBumpyard();
			}

			// Get a list of available agents
			var agentsAvailable = $srJq('#agentsList').val();
			console.log('Start switchLive');
			// If there are live agents then start a chat
			if(agentsAvailable != ''){

				// AJAX request to change the details of the current chat
				$srJq.ajax({
					url: "//app.meetami.ai/chats/switch_chat/" + chat_ref + "/" + agentsAvailable,
					type: "GET",
					success: function(data) {

						dataObj = JSON.parse(data);

						if(dataObj.response == 'by-sc' && transfer_type != 'BY') {
							console.log("Intercepted switch chat for existing bumpyard chat");

							if(dataObj.folloup_type == "phone") {
								var add_chat = '<div class="srEndChat chat"><p>I will add this to your enquiry. It looks like already have your details from a previous enquiry. </p></div>';
								recordAutoMsg('I will add this to your enquiry. It looks like already have your details from a previous enquiry. ', 'srEndChat chat', 1);
							} else {
								var add_chat = '<div class="srEndChat chat"><p>Should you require more help, please use our website search function or online self-service area https://www.stockport.gov.uk/contact to help you answer your enquiry. Have a great day! </p></div>';
								recordAutoMsg('Should you require more help, please use our website search function or online self-service area https://www.stockport.gov.uk/contact to help you answer your enquiry. Have a great day! ', 'srEndChat chat', 1);
							}
							$srJq('#srMsgs').append(add_chat);
							handleTts(add_chat);
							$srJq('#srMsgs').linkify({ target: '_self' });
							scrollChat();
							// Change the form to the simple message input
							toSimpleForm();
							$srJq('#srChatForm').removeClass('details');

							// Track typing
							trackTyping();

						} else if(data != 0){

							// Count the messages already sent
							var chatSoFar = $srJq('#srMsgs').html();
							var countChatSoFar = (chatSoFar.match(/<p/g) || []).length - 1;

							createLiveChat(chat_ref, dataObj.public_id, dataObj.display_name, countChatSoFar, 'Switch to live agent chat', transfer_type);

							if (transfer_type != 'BY') {
								//Append the relevant data to the chat
								//var add_chat = '<span><p class="srIntro">You are now chatting with a live agent: ' + dataObj.display_name + '</p></span>';
								var add_chat = '<div class="srEndChat chat"><p>Your chat has been transferred to one of our live chat agents.</p></div>';
								recordAutoMsg('Your chat has been transferred to one of our live chat agents.', 'srEndChat chat', 1);
								$srJq('#srMsgs').append(add_chat);
								handleTts(add_chat);
								$srJq('#srMsgs').linkify({ target: '_self' });
								scrollChat();
								// Change the form to the simple message input
								toSimpleForm();
								$srJq('#srChatForm').removeClass('details');

								// Track typing
								trackTyping();

								// TODO - Handle the setup of a timeout to return this to auto after a certain no of seconds


								// If Google analytics events are enabled then track them
															}

						} else {
							console.log('switchLive - End Chat');

							// Error so return to the email form
							endReplierChat('skip');
						}
					}, error: function(e,f,g) {
						console.log(e);
					}
				});

			} else {
				// If we have tried to redirect to live chat but no agents are available then
				// tell them an agent will email them shortly
				if(dataObj.redirect == 'email'){
					//endReplierChat('skip');
					setTimeout(function(){
						var end_msg = '<div class="srEndChat mail"><p>There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. </p></div>';
						recordAutoMsg('There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ', 'srEndChat mail');
						$srJq('#srMsgs').append(end_msg);
						handleTts(end_msg);
						scrollChat();
						// If Google analytics events are enabled then track them
											}, 1500);
				}
			}
		}

		function sr_loadResponseTimer() {
			var current_cookie = $srJq.cookie('sr-act');
			if(typeof current_cookie != 'undefined') {
				current_cookie = JSON.parse(current_cookie);
				if(current_cookie.hasOwnProperty('noResponseCheck')) {
					//Cookie exists, load the timer!
					console.log('A response timer is in progress, loading now');
					var targetTimeout = current_cookie['noResponseCheck'];
					var now = new Date().getTime();
					var noResponseTimeoutSeconds = (targetTimeout - now) / 1000;
					if(noResponseTimeoutSeconds > 0) {
						sr_startResponseTimer(noResponseTimeoutSeconds);
					}
				}
			}
		}

		function sr_startResponseTimer(noResponseTimeoutSeconds) {

			if(noResponseTimeoutSeconds === undefined) {
				noResponseTimeoutSeconds = 60;
			}
			console.log('Starting no response timer for ' + noResponseTimeoutSeconds + ' seconds');

			var timeoutMillis = noResponseTimeoutSeconds * 1000;
			var targetTimeout = new Date().getTime() + timeoutMillis;
			var targetDateTime  = new Date(targetTimeout);
			console.log('Response check will trigger at ' + targetDateTime);

			var cookieData = {
				"noResponseCheck": targetTimeout
			};

			var current_cookie = $srJq.cookie('sr-act');
			var setCookie = true;
			if(typeof current_cookie != 'undefined') {
				current_cookie = JSON.parse(current_cookie);
				if(current_cookie.hasOwnProperty('noResponseCheck')) {
					//Cookie already exists dont set new one
					setCookie = false;
				}
			}

			var chat_ref = getChatId();
			var data = {
				chat_id: chat_ref,
				client_ref: "168019131601",
				reclaim_time: targetTimeout
			};

			if (typeof socket != 'undefined') {
				socket.emit('autochat reclaim time', data);

				sr_data['response_timer_last_reset'] = new Date().getTime();

				if(setCookie)
					$srJq.cookie('sr-act', JSON.stringify(cookieData), { path: '/', domain: domain });

				// Before insitigating a new timer make sure the old one is cleared!
				clearTimeout(sr_data['responseTimer']);
				sr_data['responseTimer'] = setTimeout(function() {
					console.log('Checking now for a response!');
					sr_reclaimChat();
				}, timeoutMillis);
			}

		}

		function sr_clearResponseTimer() {
			console.log('Clearing no response timer');
			clearTimeout(sr_data['responseTimer']);
		}

		function sr_reclaimChat() {
			console.log('Reclaiming chat');

			//Delete cookie
			var current_cookie = $srJq.cookie('sr-act');
			if(typeof current_cookie != 'undefined') {
				current_cookie = JSON.parse(current_cookie);
				if(current_cookie.hasOwnProperty('noResponseCheck')) {
					//Cookie already exists dont set new one
					delete current_cookie['noResponseCheck'];
					current_cookie['chatReclaimed'] = true;
					$srJq.cookie('sr-act', JSON.stringify(current_cookie), { path: '/', domain: domain });

					var chat_ref = getChatId();
					var data = {
						chat_id: chat_ref,
						client_ref: "168019131601"
					};

					socket.emit('autochat reclaimed', data);

					sr_getNextAction();
				}
			}
		}

		function sr_isChatReclaimed() {
			console.log('Checking if chat has been reclaimed');
			var chatReclaimed = false;
			var current_cookie = $srJq.cookie('sr-act');
			if(typeof current_cookie != 'undefined') {
				current_cookie = JSON.parse(current_cookie);
				if(current_cookie.hasOwnProperty('chatReclaimed') && current_cookie['chatReclaimed']) {
					chatReclaimed = true;
				}
			}

			console.log('Chat Reclaimed', chatReclaimed);
			return chatReclaimed;
		}

		function sr_getNextAction() {

			// Get the chat reference
			var chat_ref = $srJq('#chat_ref').val();


			$srJq.ajax({
					url: "//app.meetami.ai/chats/get_next_action/" + client_ref + "/" + chat_ref,
					type: "POST",
					data: {data: form_data},
					success: function(data) {
						console.log('Success getting next action');
						var dataObj = JSON.parse(data);
						console.log(dataObj);
						// If we have responses NOT a single response then loop through them and handle AutoMsgs for each
						if (typeof dataObj.responses != 'undefined') {
							for ( var i in dataObj.responses ) {
								var indObj = dataObj;
								indObj.response = dataObj.responses[i];
								handleAutoMsgs(indObj, chat_ref);
							}
						} else if (typeof dataObj.response != 'undefined') {
							handleAutoMsgs(dataObj, chat_ref);
						}
					},
					error: function(data) {
						console.error('Error getting next action');
						console.log(data);
					}
			});
		}

		function sr_resetNoResponseTimer() {

			var last_reset = sr_data['response_timer_last_reset'];
			var now = new Date().getTime();
			if(now - last_reset > 5000) {
				//Check when it was last reset
				sr_clearResponseTimer();
				sr_startResponseTimer();
			}
		}

		// Method to switch from live to automated chat
		function srSwitchAuto () {

			// Get the chat and user reference
			chat_ref = $srJq('#chat_ref').val();
			usr_ref = getUsrId();

			// Make the change through the database
			$srJq.ajax({
				url: "//app.meetami.ai/chats/switch_chat_auto/" + chat_ref + "/" + usr_ref,
				type: "GET",
				success: function(data) {

					if(data != 0){

						// Close the live sockets
						endLiveChat(chat_ref, 'auto');

						// Decode all the data that has been submitted
						dataObj = JSON.parse(data);
						if(dataObj.hasOwnProperty('id')){

							// Show relevant switch message
							$srJq('#srMsgs').append('<p class="feint">If you need more assistance, please use our website search function or online self-service area to help you answer your enquiry: https://www.stockport.gov.uk/contact </p>');
							handleTts("If you need more assistance, please use our website search function or online self-service area to help you answer your enquiry: https://www.stockport.gov.uk/contact ");
							// And also repopulate the header to the conversation
							$srJq('p.srIntro').html('You are chatting with ' + dataObj.agent_name);
							$srJq('p.srIntroPos').html(dataObj.role);
							if(typeof dataObj.agent_image != 'undefined' && dataObj.agent_image != null){
								$srJq('img.profile').replaceWith('<img src="https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/virtual_agent/agent_image/' + dataObj.agent_image_dir + '/tmb_' + dataObj.agent_image + '" alt="' + dataObj.agent_name + '" class="profile" />');
							} else {
								$srJq('img.profile').replaceWith('<span><img src="//app.meetami.ai/img/widget/default-avatar-lrg.svg" alt="' + dataObj.agent_name + '" class="profile bbl" /></span>');
							}

							// Play the alert and scroll
							srPlink();
							scrollChat();

							// Show the relevant intro message from the virtual agent after a short delay
							setTimeout(function () {
								if(typeof dataObj.agent_image != 'undefined' && dataObj.agent_image != null){
									$srJq('#srMsgs').append('<p class="agent inc-avatar"><span class="avatar-mini"><img src="https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/virtual_agent/agent_image/' + dataObj.agent_image_dir + '/tmb_' + dataObj.agent_image + '" alt="' + dataObj.agent_name + '" /></span><span>' + dataObj.agent_name + ':</span> ' + dataObj.msg + '</p>');
									handleTts(dataObj.msg);
								} else {
									$srJq('#srMsgs').append('<p class="agent"><span>' + dataObj.agent_name + ':</span> ' + dataObj.msg + '</p>');
									handleTts(dataObj.msg);
								}
								srPlink();
								scrollChat();
							}, 3000);

						}

					} else {
						checkExistingChats(chat_ref);
					}

				}, error: function(e,f,g) {
					console.log(e);
				}
			})


		}

		/* Function to disable / enable the chat inputs
		*/
		function disableChatForm(){
			$srJq('#srMsgSender').prop('disabled', true);
			$srJq('#srInputs input').each(function(){
				$srJq(this).prop('disabled', true);
			});
		}
		function enableChatForm(nf){
			console.log("IS INPUT MSG: ", isInputMsg);
			if($srJq('#srMsgSender').hasClass("srLoadingFakeMsgSender")) return false;
			if(typeof nf == 'undefined'){
				if (isIpad() === true) {
					$srJq('#srMsgSender').prop('disabled', false).blur();
				} else {
					$srJq('#srMsgSender').prop('disabled', false);
					if(isInputMsg) {
						$srJq('#srMsgSender').focus();
					}
				}
			} else {
				$srJq('#srMsgSender').prop('disabled', false);
			}
			$srJq('#srInputs input').each(function(){
				$srJq(this).prop('disabled', false);
			});
		}

		// Check whether an existing user has seen a manage expectations message
		function checkForManExp () {

			var usrRef = getUsrId();

			$srJq.ajax({
				url: "//app.meetami.ai/chats/check_manexp/168019131601/" + usrRef,
				type: "GET",
				success: function(data) {
					if (data == 1) {
						scope.chat.hasUnknownQueries = 1;
					}
				}
			});

		}


		/**************************************************************/
		/******************** Begin Live Chat sockets *****************/
		/**************************************************************/

		var socket = io.connect('https://chat.meetami.ai');
		// On reconnection, reset the transports option to use both polling and websockets
		socket.on('reconnect_attempt', function() {
			socket.io.opts.transports = ['websocket', 'polling'];
		});

		$srJq(function(){
			// Register the user as being on the site
			registerLoad();
			trackTyping();
		});

    function redistributeViaNode(data, type) {
      console.log("redistributing " + type);
      console.log(data);
    	if(typeof(chat_ref) === "undefined") var chat_ref = getChatId();
      data.chat_id = chat_ref;
      data.client_ref = "168019131601";
      data.redistribution_type = type;
      socket.emit('redistribute', data);
    }

		//Iterate over message breakdown strings returning time to render substring plus 500 milliseconds for Ami is typing message
		function getTimeToRenderEstimate(time,message,index){
			message = formatAutoMessageStrForRegularExpression(message);

			if(index >= message.length -1){
				//end recursion if reach end of original message string
				return time;
			}

			var splitMessage = getSplitMessageString(message,index,character_count_threshold);

			if(splitMessage.length > 0) {
				time += (splitMessage.length * auto_delay) + 500;
			}

			index = getCutOffIndex(message,index,character_count_threshold);

			return getTimeToRenderEstimate(time,message,index)
		}

		function handleSubmitMessageSuccess(dataObj, redistribute, isForm, isValid, msg, form_data, client_ref, chat_ref, agentsAvailable, icChats, curAgents) {

	    	if(dataObj['type'] == 'success'){

	        $srJq(".footerRate").addClass("active-chat");

					if(apptCancelWait == true) {
						toSimpleForm();
						apptCancelWait = false;
					}

	      	// Add the user message into the conversation
	        if (typeof dataObj.message != 'undefined') {
	        	// $srJq('#srMsgs').append('<p><span>You:</span> ' + dataObj.message + '</p>');
						if(isMobileUx) {
							convertMsgsMobileUx();
							bindChatMessageDraggable();
							var previousAgentMsg = $srJq('#srMsgs').find(".agent").last().find(".srMsgInnerContent").find("p").ignore("span").text();
							dismissUpToMsg(previousAgentMsg);
							var elems = [];
							elems.push($srJq('#srMsgs').find(".agent").last());
							$srJq('#srMsgs').find(".agent").last().prevAll('div, p').each(function(index, value) {
								elems.push($srJq(value));
							});
							$srJq.each(elems, function(index, value) {
								$srJq(value).animate({
									opacity: 0
								}, 200, function() {
									$srJq(value).css("opacity", 1);
									$srJq(value).addClass("srDismissed");
								});
							});
							$srJq(".srMobileUxEdit").parent().remove();
							var t = setTimeout(function() {
								dismissSpecificMsg(dataObj.message);
							}, dismissTime);
						}
	        }
	        $srJq('#srFaded').remove();
	        // Reset the form to empty
	        $srJq('#srMsgSender').val('');

					if(dataObj.hasOwnProperty('filter_form')) {
						handleFilterForm(dataObj.filter_form);
					}

        // Add in responses if they exist
				if(dataObj.hasOwnProperty('responses')){

					// Track the department once for the series of messages
					trackDept(dataObj);

					// Handle the messages
					var delay = 0;
					console.log(dataObj.responses);
					$srJq.each(dataObj.responses, function(key, response){
						console.log("response", response);

						if(response.hasOwnProperty('filter_form_selectors')) {
							filterFormSelectors = response.filter_form_selectors;
						}

						// Is there a population of a form element required?
						srCheckSearchEntry(response);
						// Delay the triggering of the messages such thet they are added in sequentially
						setTimeout(function(){

							// Adjust the data for submission
							var ptObj = dataObj;
							ptObj.curResponse = response;

							// Vary the response according to whether there are Ami agents for this company
							
								var availableAmiAgents = $srJq('#amiAgentsList').val();
								var amiAgentStatus = $srJq('#amiAgentsStatus').val();
								var chatReclaimed = sr_isChatReclaimed();
								if ( !chatReclaimed && availableAmiAgents != '' ) {
									// Autmomated messages are sent directly to the autochats list (Ami agents)
									// If Ami has a response then we just add to the nicely active list (unless they are already in a different Ami list)
									if ( response.virtual_msg_type == 'negative' || amiAgentStatus == 1 ) {

										// If it is someone in a queue but Ami can answer or if they are in a queue and in the sales funnel
										// then The Ami Agent side will query the last entered answer to get Ami's suggested response
										// So no need to do anything on this side
										// Submit message
										console.log('Ami Agent');
										if(redistribute) submitLiveMessage(chat_ref, msg, 1);
										// Renable the text input for future messages
										enableChatForm();
										// Track the fact that this is being transfered to an Ami agent
										$srJq('#amiAgentsStatus').val(1);
										var hasPretext = 0;
										if (response.hasOwnProperty('pretext')) {
											hasPretext = 1;
										}
										// Record the auto response as a hidden message.. in case no Ami agents check it in time to mark it as such
										$srJq.ajax({
											url: "//app.meetami.ai/chats/ami_hide/" + chat_ref + '/' + amiAgentStatus + '/' + hasPretext,
											type: "GET",
											success: function(data) {}
										});

										//Start the timer to reclaim chat if no ami agent claims it...
										setTimeout(function(){
											sr_startResponseTimer();
										}, 1000);

									} else {

										// Ami can answer... no need for an Ami agent to get involved
										submitLiveMessage(chat_ref, msg, 'yes');
										handlePretext(ptObj, function() {
											if(typeof response.pretext != 'undefined' && response.pretext != '') {
												submitLiveMessage(chat_ref, response.pretext, 0, response.agent_name);
											}

											handleAutoMsgs(response, chat_ref, redistribute, dataObj);
											// Submit a message to the Ami agents to tell them what the Ami said
											submitLiveMessage(chat_ref, response.message, 0, response.agent_name);
										});

									}
								} else {

									console.log('No Ami agents');
									// If no Ami agents available then just handle as normal
									console.log(">>>>>>>> HANDLE PRE TXT: ", ptObj);
									handlePretext(ptObj, function() {
										console.log(">>>>>>>> HANDLE AUTO MSGS: ", response);
										handleAutoMsgs(response, chat_ref, redistribute, dataObj);
									});

								}

							
						}, delay);
						if (typeof response.message != 'undefined') {
							var startTime = 0;
							var startIndex = 0;
							console.log(character_count_threshold);
							console.log('##response message##',response.message);
							delay += getTimeToRenderEstimate(startTime,response.message,startIndex)  + 1000;
							console.log('##delay##',delay);
						}
					});

				// If a single respons eis in place then use that
        } else if(dataObj.hasOwnProperty('response')){

					// Is there a population of a form element required?
					srCheckSearchEntry(dataObj.response);

          // If it has a dept ID then track that
          trackDept(dataObj.response); // TODO

          // Automated chats
          // IS Ami agent enabled / available?!
          // If so delay everything so they can comment on it
                      var availableAmiAgents = $srJq('#amiAgentsList').val();
            var amiAgentStatus = $srJq('#amiAgentsStatus').val();
            var chatReclaimed = sr_isChatReclaimed();
            if ( !chatReclaimed && availableAmiAgents != '' ) {
              // Autmomated messages are sent directly to the autochats list (Ami agents)
              // If Ami has a response then we just add to the nicely active list (unless they are already in a different Ami list)
              if ( dataObj.response.virtual_msg_type == 'negative' || amiAgentStatus == 1 ) {

                // If it is someone in a queue but Ami can answer or if they are in a queue and in the sales funnel
                // then The Ami Agent side will query the last entered answer to get Ami's suggested response
                // So no need to do anything on this side
                // Submit message
                console.log('Ami Agent');
                if(redistribute) submitLiveMessage(chat_ref, msg, 1);
                // Renable the text input for future messages
                enableChatForm();
                // Track the fact that this is being transfered to an Ami agent
                $srJq('#amiAgentsStatus').val(1);
								var hasPretext = 0;
								if (dataObj.response.hasOwnProperty('pretext')) {
									hasPretext = 1;
								}
                // Record the auto response as a hidden message.. in case no Ami agents check it in time to mark it as such
                $srJq.ajax({
                	url: "//app.meetami.ai/chats/ami_hide/" + chat_ref + '/' + amiAgentStatus + '/' + hasPretext,
                  type: "GET",
                  success: function(data) {}
                });


                //Start the timer to reclaim chat if no ami agent claims it...
                setTimeout(function(){
                  sr_startResponseTimer();
                }, 1000);

							} else {

								// Ami can answer... no need for an Ami agent to get involved
                submitLiveMessage(chat_ref, msg, 'yes');
                handlePretext(dataObj, function() {
                  if(typeof dataObj.response.pretext != 'undefined' && dataObj.response.pretext != '') {
                    submitLiveMessage(chat_ref, dataObj.response.pretext, 0, dataObj.response.agent_name);
                  }

                  handleAutoMsgs(dataObj, chat_ref, redistribute);
                  // Submit a message to the Ami agents to tell them what the Ami said
                  submitLiveMessage(chat_ref, dataObj.response.message, 0, dataObj.response.agent_name);
                });

              }

            } else {

							console.log('No Ami agents');
							// If no Ami agents available then just handle as normal
              handlePretext(dataObj, function() {
								handleAutoMsgs(dataObj, chat_ref, redistribute);
              });

						}

          
        } else {

					// If response does not exist (i.e. live chat) then commence socket live chat
          if($srJq('#srMsgSender').length){
            // Submit just the message
            submitLiveMessage(chat_ref, msg);
          }

				}

        handleTrackScript(isForm, 'chat-form');

      } else if(dataObj.hasOwnProperty('redirect') || dataObj['type'] == 'redirect'){

        handleTrackScript(isForm, 'chat-form');

      	// Add the user message into the conversation
        if(typeof dataObj.message != 'undefined' && dataObj.message != '') {
          $srJq('#srMsgs').append('<p><span>You:</span> ' + dataObj.message + '</p>');
				  handleTts(dataObj.message);
          $srJq('#srFaded').remove();
          // Reset the form to empty
          $srJq('#srMsgSender').val('');
        }

        if(dataObj.redirect == 'email'){
          
						if(dataObj.hasOwnProperty('callback_id')){
            	var trigger = 'ch';
              if(dataObj.hasOwnProperty('callback_trigger')){
                trigger = dataObj.callback_trigger;
              }
              setTimeout(function () {
      					// srEndChatWrapper(dataObj.callback_id, trigger);
                if (dataObj.hasOwnProperty('cb_exists') && dataObj.cb_exists == 1){
                  // A callback request already exists so show a green message showing that
                  var end_msg = '<div class="srEndChat phone"><p>A call has already been scheduled. We will be in touch as soon as we can.</p></div>';
                  if(redistribute) recordAutoMsg('A call has already been scheduled. We will be in touch as soon as we can.', 'srEndChat phone');
                  $srJq('#srMsgs').append(end_msg);
				  				handleTts(end_msg);
                  scrollChat();
                  if(redistribute) srPlink();

								} else {
                  srEndChatWrapper(true, trigger, redistribute);
                }
              }, 2500);

						} else {

						  setTimeout(function () {
                // Append the message to the end of the messages
                var end_msg = '<div class="srEndChat mail"><p>There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. </p></div>';
                $srJq('#srMsgs').append(end_msg);
								handleTts(end_msg);
                if(redistribute) recordAutoMsg('There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ', 'srEndChat mail');
                scrollChat();
                if(redistribute) srPlink();
								triggerDP(true, false);
              }, 2500);

						}

					
            // Say the email has been sent and ask if you can help them at all
          	// var agent_image = $srJq('#srMsgs >span img.profile').attr('src');
						if (typeof dataObj.msg != 'undefined') {
	            var agent_image = $srJq('#srMsgs .agent.inc-avatar .avatar-mini img').first().attr('src');
	            var agent_name = $srJq('#srMsgs').find('p.agent span:not([class])').html();
	            if ( typeof agent_image != 'undefined' && agent_image.indexOf('default-avatar-lrg.svg') == -1 ){
	              response = '<p class="agent inc-avatar"><span class="avatar-mini"><img src="' + agent_image + '" alt="' + agent_name + '" /></span><span>' + agent_name + '</span> ' + dataObj.msg + '</p>';
	            } else {
	              response = '<p class="agent"><span>' + agent_name + '</span> ' + dataObj.msg + '</p>';
	            }

	            $srJq('#srMsgs').append(response);
							handleTts(dataObj.msg);
						}

            processGrnMsg(dataObj);

            // Set the form back to the standard form
            toSimpleForm();
            $srJq('#srChatForm').removeClass('details');

            setTimeout(function() {
              // if(redistribute) triggerDP(true);
            }, 5000);

            // Finally scroll the chat window down to the bottom
            scrollChat();

            // Set a timeout to close the chat after
            autoClose = setTimeout(function () {
              endReplierChat('skip', 'nof');
		  }, 600000);

          } else {

						if(redistribute) switchLive(chat_ref, dataObj.tns_type);

					}

        } else if(dataObj.hasOwnProperty('noagents')){

					// User has submitted the form for no agents available
          // Show feedback form + close up
          endReplierChat('skip', 'nof');

				} else {

					// TODO - ADD IN SOME ERROR HANDLING
          //$srJq('body').append(data);

				}

        if(redistribute) redistributeViaNode(dataObj, "message");
      }

      socket.on("redistribute message", function(data) {
        console.log("recevied redistribute payload:");
        console.log(data);
        handleSubmitMessageSuccess(data, false);
      });

      socket.on("redistribute close", function(data) {
        console.log("recevied redistribute close payload:");
        console.log(data);
        closeReplier(true);
      });

	  socket.on("redistribute endchat", function(data) {
        console.log("recevied redistribute end chat payload:");
        console.log(data);
	  	endReplierChat('skip');
      });

      socket.on("redistribute dp-question", function(data) {
        if(data.hasOwnProperty("trigger_dp_questions")) return false;
        console.log("recevied redistribute dp payload:");
        console.log(data);
        if(data.hasOwnProperty('dpQuestions')) {
        	dpQuestions = data.dpQuestions;
        }
        if(data.usr_msg == true) {
          $srJq("#srMsgs").append(
  			"<p><span>" + data.question + "</span></p>"
  		);

		} else {

		  if(dpQuestions.length > 0) {
  			appendDPQuestion(data.question, '', true);
  		} else {
  			endDPQuestions(true);
  		}
    }
  });

  socket.on("redistribute callback-scheduled", function(data) {
    console.log("recevied redistribute cb schedule payload:");
    console.log(data);
    displayPhoneThanks(data.time);
  });

		socket.on("reclaim bumpyard", function(data) {
      console.log("Reclaim bumpyard payload received");
      console.log(data);
      reclaimBumpyard(data.chat_ref);
    });

		function reclaimBumpyard(chat_ref) {
			$srJq.ajax({
				url: "//app.meetami.ai/chats/reclaim_bumpyard/" + chat_ref,
				type: "GET",
				success: function(data) {
					console.log("SUCCESS FROM RECLAIM BUMPYARD AJAX:");
					console.log(data);
					dataObj = JSON.parse(data);
					dataObj.type = "success";
					handlePretext(dataObj, function() {
						handleAutoMsgs(dataObj, chat_ref, true);
						submitLiveMessage(chat_ref, dataObj.response.message, 0, dataObj.response.agent_name);
					});
				}
			});
		}

		// function populateAgentList(agents) {
		// 	var client_ref = '168019131601';
		// 	$srJq.ajax({
		// 		url: "//app.meetami.ai/chats/client_bumpyard_agent/" + client_ref,
		// 		type: "GET",
		// 		success: function(data) {
		// 			console.log("SUCCESS FROM populateAgentList AJAX:");
		// 			console.log(data);
		//
		// 		}
		// 	});
		// }

		// Function to register that the user is active on the site
		function registerLoad(){

			// Read the user session
			var current_cookie = $srJq.cookie('sr-data');
			if(typeof current_cookie != 'undefined'){
				current_cookie = JSON.parse(current_cookie);
			}
			var current_session = $srJq.cookie('sr-cur');
			var current_chat = $srJq.cookie('sr-ec');
			if(typeof current_chat == 'undefined'){
				current_chat = 0;
			}

			// If the user is not yet defined then define them
			if(typeof current_cookie == 'undefined' || typeof current_cookie['uid'] == 'undefined' || current_cookie['uid'] == ''){
				// Save the data
				$srJq.ajax({
					url: "//app.meetami.ai/chats/register_user/168019131601",
					type: "GET",
					success: function(data) {

						// On success update the cookie
						dataObj = JSON.parse(data);
						current_cookie = {};
						current_cookie['uid'] = dataObj.user_ref;
						current_cookie['os'] = current_cookie['platform'] = dataObj.os;
						current_cookie['browser'] = dataObj.browser;
						current_cookie['device'] = dataObj.device;
						current_cookie['ip'] = dataObj.ip;
						current_cookie['country_code'] = dataObj.country_code;
						// Stringify the data and save it to the session
						current_cookie = JSON.stringify(current_cookie);

						$srJq.cookie('sr-data', current_cookie, { expires: 30, path: '/', domain: domain });

						// Hack for Safari to make sure cookies are being written ok
						var written_cookie = $srJq.cookie('sr-data');
						if (typeof written_cookie == 'undefined' || typeof written_cookie['uid'] == 'undefined'){
							console.log('Failure to load up cookie first time');
							// Check that the cookie we just tried to write did indeed write
							// If not then recall this function in a few seconds time
							setTimeout(function(){
								console.log('Set retry of register');
								registerLoad();
							}, 2500);

						} else {
// TODO
// What if we handle this differently + check that the websocket connection has worked as well (retrying if not)
							// And open the socket
							var new_user = {
								user_ref: dataObj.user_ref,
								browser: dataObj.browser,
								os: dataObj.os,
								device: dataObj.device,
								ip: dataObj.ip,
								country_code: dataObj.country_code,
								logon_time: new Date(),
								cur_chat: current_chat,
								chat_no: 0,
								client_ref: '168019131601',
								visit_no: 1,
								page_url: document.URL,
								client_id: '100'
							}
console.log('Socket user data');
							socket.emit('customers load', new_user);

							// Set up the launch chat link
							var winWidth = getScreenWidth();
							if(winWidth < 720){
								$srJq('#srHeader h4 > a').attr('href','https://app.meetami.ai/chats/chat/168019131601/mob/' + dataObj.user_ref).attr('rel', '').attr('target', '_blank');
							}

							// Check whether this is a load to launch chat
							var launchChat = $srJq.cookie('sr-lc');
							if(launchChat !== undefined){
								createChat();
								$srJq.removeCookie('sr-lc', { path: '/', domain: domain });
							}
						}
					}
				});
			} else {

				// Track the load with an AJAX query - to allow us to track unique visitors each month
				$srJq.ajax({
					url: "//app.meetami.ai/chats/track_load/168019131601/" + current_cookie['uid'],
					type: "GET",
					success: function(data) {	}
				});

				if(typeof current_cookie['visit_no'] != 'undefined'){
					current_cookie['visit_no']++;
				} else {
					current_cookie['visit_no'] = 1;
				}

				if(typeof current_cookie['country_code'] == 'undefined'){
					current_cookie['country_code'] = '';
				}

				// If they are defined then check their current browser data etc
				// Set up the socket data
				var new_user = {
					user_ref: current_cookie['uid'],
					browser: current_cookie['browser'],
					os: current_cookie['os'],
					ip: current_cookie['ip'],
					country_code: current_cookie['country_code'],
					device: current_cookie['device'],
					logon_time: current_session,
					cur_chat: current_chat,
					chat_no: current_cookie['chat_no'],
					client_ref: '168019131601',
					visit_no: current_cookie['visit_no'],
					page_url: document.URL,
					client_id: '100'
				}
				socket.emit('customers load', new_user);

				// Check whether this is a load to launch chat
				var launchChat = $srJq.cookie('sr-lc');
				if(launchChat !== undefined){
					createChat();
					$srJq.removeCookie('sr-lc', { path: '/', domain: domain });
				}
			}
		}

		function populateAgentsList(agents) {
							$srJq('#agentsList').val(agents.trim());
					}

		// Return of the agents online list
		socket.on('agents inputList', function(data){
			if(data.client_ref == '168019131601'){
				// Check whether this user has filtered down to a dept yet
				var dept = getDeptId();
				if (dept == '') {
console.log('POPULATE EMPTY DEPT');
console.log(data.usrs);
					populateAgentsList(data.usrs);
console.log('VAL OF INPUT');
console.log($srJq('#agentsList').val());
				} else {
					// If they have filtered down to a dept then specifically search out their agents
					// rather than using a generic list
					updateAvailableAgents(dept);
				}
			}
		});

		socket.on('trigger dp questions', function(data){
            console.log("trigger dp questions!");
			triggerDP(true, true);
		});

		// Return of the agents online list - that has been specifically requested by this socket
		socket.on('agents inputList specific', function(data){
			if(data.client_ref == '168019131601'){
console.log('AGENTS SPECIFIC LISTING');
console.log(data);
				populateAgentsList(data.usrs);
			}
		});
		socket.on('ami_agents amiInputList', function(agents){
console.log('AMI AGENTS LISTING');
console.log(agents);
			var have_agents = false;
			for (var key in agents['usrs']){
				if(key == '100'){
					$srJq('#amiAgentsList').val(agents['usrs'][key]);
					have_agents = true;
				}
			}
			if(have_agents == false){
				$srJq('#amiAgentsList').val('');
			}
		});

		// When agents login request an update to available agents
		socket.on('customer query trigger', function(data){
			socket.emit('agents query', '168019131601');
		});

		// How many chats are in the incoming list
		socket.on('chats incoming', function(data){
			if(data.client == '168019131601'){
				$srJq('#icChats').val(data.chats);
			}
		});

		// Opens a socket and commences a live chat
		function createLiveChat(chat_id, agent_ref, agent_name, chatCount, lastMessage, transfer_type){
			console.log("CREATING LIVE CHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAT");
			// Set up the core user data cookie
			// First check for existing and update it
			var current_cookie = $srJq.cookie('sr-data');

			var current_session = $srJq.cookie('sr-cur');
			if(current_cookie !== undefined){
				current_cookie = JSON.parse(current_cookie);
				if(typeof current_cookie['visit_no'] != 'undefined'){
					var visit_no = current_cookie['visit_no'];
				} else {
					var visit_no = 1;
				}
			} else {
				var visit_no = 1;
			}
			// Set up the specific session visit data
			if(current_session !== undefined){
				var logon_time = current_session;
			} else {
				var logon_time = new Date();
			}

			// If we are not creating from autochat set up last msg and chat count
			if(typeof chatCount === undefined){
				chatCount = 1;
			}
			if(typeof lastMessage === undefined){
				lastMessage = 1;
			}
			if(typeof transfer_type === undefined){
				transfer_type = 'D';
			}
			if(typeof current_cookie['country_code'] == 'undefined'){
				current_cookie['country_code'] = '';
			}

			var uid = current_cookie['uid'];
			if(typeof uid == 'undefined'){
				uid = getUsrId();
			}

			// Get the department ID
			var dept_id = getDeptId();

			// Set up the chat data and submit it to the node server
			var data = {
				chat_id: chat_id,
				dept_id: dept_id,
				client_ref: "168019131601",
				agent_ref: agent_ref,
				agent_name: agent_name,
				visit_no: visit_no,
				user_ref: uid,
				chat_no: current_cookie['chat_no'],
				logon_time: logon_time,
				last_message: lastMessage,
				message_no: 0,
				transfer_type: transfer_type,
				device: current_cookie['device'],
				os: current_cookie['os'],
				browser: current_cookie['browser'],
				ip: current_cookie['ip'],
				country_code: current_cookie['country_code'],
				page_url: document.URL
			};
			console.log('CREATING CHAT');
			console.log(data);
			if(typeof transfer_type != 'undefined' && transfer_type == 'ami'){
				data.ami_status = 0;

				socket.emit('autochat create', data);
			} else {
				console.log('CREATING LIVE');
				socket.emit('chat create', data);
			}
			trackTyping();
		}

		// Utility function to get the currently chat dept ID
		function getDeptId () {
			var deptID = $srJq('#chatDept').val();
			return deptID;
		}

		// Closes a socket and ends a live chat
		function endLiveChat(chat_id, end_type){

			if(typeof end_type == 'undefined'){
				end_type = 'end';
			}

			// Set up the chat data and submit it to the node server
			var data = {
				chat_id: chat_id,
				client_ref: "168019131601",
				end_type: end_type
			};
			socket.emit('chat close', data);
			registerLoad();
		}

		function srGenerateConfirmRef ( msgData ) {

		  // Generate a unique reference
		  var ref = Math.random() * 1000000 + (new Date()).getTime() + '';
		  ref = ref.replace('.','');

		  // Update the chatData
		  msgData.confirmRef = ref;

		  // Save the data to the chat ref cookie
		  var existing = $srJq.cookie('sr-data');
		  existing = JSON.parse(existing);
		  existing.unconfirmedMsg = msgData;
		  existing = JSON.stringify(existing);
		  $srJq.cookie('sr-data', existing, { path: '/', domain: domain });

		  // Return the updated data
		  return msgData;

		}

		function srConfirmMsgReceipt ( msgRef ) {

		  // Get the existing cookie
		  var existing = $srJq.cookie('sr-data');
		  if (typeof existing != 'undefined') {

		    existing = JSON.parse(existing);
				if (typeof existing.unconfirmedMsg != 'undefined' && typeof existing.unconfirmedMsg.confirmRef != 'undefined' && existing.unconfirmedMsg.confirmRef == msgRef ) {
		      // We have confirmed the receipt reference so can clear the reference in the cookie
				  delete existing.unconfirmedMsg;
		      existing = JSON.stringify(existing);
		      $srJq.cookie('sr-data', existing, { path: '/', domain: domain });
					console.log('CONFIRMED MSG RECEIPT AT THE SERVER');
		      console.log(existing);
		    }

		  }
		  return true;
		}

		function srCheckForUnconfirmed () {

			// Get the cookie
			var existing = $srJq.cookie('sr-data');
		  if (typeof existing != 'undefined') {

				existing = JSON.parse(existing);
				if (typeof existing.unconfirmedMsg != 'undefined' && typeof existing.unconfirmedMsg.confirmRef != 'undefined' ) {
					var msgId = existing.unconfirmedMsg.confirmRef;
					if (typeof existing.unconfirmedChecks != 'undefined' && existing.unconfirmedChecks == msgId ) {
						// Already handled this so we need to display the error message + clear the cookie
						srDisplayConnectionIssue(existing.unconfirmedMsg);
						delete(existing.unconfirmedMsg);
						delete(existing.unconfirmedChecks);
						console.log('DISPLAYED unconfirmed error message');
					} else {
						// Not done a check on this one yet so just record the fact that we have now
						existing.unconfirmedChecks = msgId;
					}
					// Update the cookie
					existing = JSON.stringify(existing);
		      $srJq.cookie('sr-data', existing, { path: '/', domain: domain });
				}

			}
			return true;
		}

		// Display an error message when the user seems to have a message that hasn't been delivered
		function srDisplayConnectionIssue ( errorMsg ) {
			// Set up the HTML
			var alertMsg = '<div id="dcErr">';
			alertMsg += '<p>We\'re really sorry but it looks like there has been an issue sending your last messge to Ami:</p>';
			alertMsg += '<p><em>"' + errorMsg.msg + '"</em></p>';
			alertMsg += '<p>Please refresh the page and try resending the message.</p>';
			alertMsg += '</div>';

			// Append the HTML
			$srJq('#srMsgs').after(alertMsg);
			msgHeight(50, function(){});
		}

		function srHideConnectionIssue () {
			$srJq('#dcErr').slideUp(200, function(){
				$srJq('#dcErr').remove();
				msgHeight(50, function(){});
			});
		}

		$srJq(function(){
			setInterval(function(){
				srCheckForUnconfirmed();
			}, 7500);
		});

		// Confirm message receipt at the Node server
		socket.on('message receipt', function(data){
		  srConfirmMsgReceipt(data);
		});

		// Submit live chat message
		function submitLiveMessage(chat_id, msg, is_ami, agent_name, ail_clarification){
			console.log("submit live message", chat_id, msg, is_ami, agent_name);

			if( typeof is_ami == 'undefined'){
				is_ami = false;
			}

			if( typeof agent_name == 'undefined'){
				agent_name = false;
			}

			// Enable the input as it is a live chat
			if(is_ami === false){
				enableChatForm();
				var uid = getUsrId();
			}

			// Clear any old connection error messages
			srHideConnectionIssue();

			// Set up the chat data and submit it to the node server
			var data = {
				chat_id: chat_id,
				agent_msg: 0,
				msg: msg,
				user_ref: uid,
				client_ref: "168019131601"
			};
			data = srGenerateConfirmRef(data);

			if(typeof(ail_clarification) !== 'undefined') {
				data.ail_clarification = true;
			}

			if( is_ami === false ) {

				// console.log('chat messagezzz');
				// console.log(data);
				socket.emit('chat message', data);

				// Linkify the content
				$srJq('#srMsgs').linkify({ target: '_self' });

				// Check to see whether the agent has sent a message yet
				var agent_msg_count = agentMsgCount();
				// How many messages has the user sent
				if (typeof agent_msg_count != 'undefined') {
					var usr_msg_count = $srJq('#srMsgs p').length - (agent_msg_count + 2);
					agent_msg_count = 0;
				}

				
					if(agent_msg_count < 2 && usr_msg_count < 2){

						// Work out the agent name
						var agent_name = getAgentName();

						// Set a timeout for the no messages received
						queueTimer = setTimeout(function () {
							$srJq('#srMsgs').append('<p class="agent"><span>' + agent_name + ':</span> You are No1 in the queue we will be with you shortly</p>');
							handleTts("You are No1 in the queue we will be with you shortly");
							scrollChat();
						}, 3000);
					}
				
				
					if(agent_msg_count < 3 /*&& usr_msg_count < 2*/){

						// Work out the agent name
						var agent_name = getAgentName();

						// Set a timeout for the no messages received
						srSwAutoTimer = setTimeout(function () {
							srSwitchAuto(agent_name);
						}, 120000);
					} else {
						clearTimeout(srSwAutoTimer);
					}
				
			} else {

				// Figure out the original Ami status
				var origStatus = $srJq('#amiAgentsStatus').val();

				// Ami chats just submit the data
				if (is_ami == 'yes'){
					data.ami_status = 0;
				} else {
					data.ami_status = is_ami;
				}
				if ( agent_name !== false ) {
					data.sender = agent_name;
				}
				socket.emit('autochat message', data);

				// If it was originally an Ami chat but is now moving to Ami agent them show the "is thinking" message
				if (is_ami == 1 && origStatus == 0) {
					srDisplayThinkingMsg();
				}
			}

			typingCheck();

			// Trigger a timer to reload the chat socket if the message hasn't been received
			msgCheck = setTimeout(function () {
				joinChat(chat_id, "168019131601");
				socket.emit('chat notify', { chat_ref: chat_id, client_ref: "168019131601"});
				scrollChat();
			}, 750);

		}

		function srDisplayThinkingMsg () {
							// Clear any "is typing" messages
				// $srJq('#srMsgs #typing').remove();
				if (!isMobileUx) {
					setTimeout(function(){
						// Set up the variable of the message to be displayed
						var msg = "<div><p class='feint' id='typing'>Ami is thinking...</p></div>";
						$srJq('#srMsgs').append(msg);
						scrollChat();
					}, 1850);
				}
					}

		socket.on('chat closeagent agent', function(closed_chat) {
			var chat_ref = $srJq('#chat_ref').val();
			if (chat_ref == closed_chat) {
				sr_clearResponseTimer();
			}
		});

		// When a new message comes in display it
		socket.on('chat message', function(data){
			console.log('Chat dataaaaaaa', data);
			if(data.is_dp == true) return;

			// Clear the timeout to show that the message has been received
			if(typeof msgCheck != 'undefined'){
				clearTimeout(msgCheck);
			}

			if(data.sender != undefined){

				srCheckWidgetHeader(data);

				if(typeof data.agent_addn != 'undefined' && data.agent_addn != ''){
					data.sender = data.sender + ' - ' + data.agent_addn;
				}
				var agentImgUrl = false;

				if ( typeof data.image != 'undefined' && data.image != '' ) {
					agentImgUrl = data.image;
					response = '<p class="agent inc-avatar"><span class="avatar-mini"><img src="'+agentImgUrl+'" alt="' + data.sender + '" /></span><span>' + data.sender + ':</span> ' + data.msg + '</p>';
				} else {
					response = '<p class="agent"><span>' + data.sender + ':</span> ' + data.msg + '</p>';
				}
				//response = '<p class="agent"><span>' + data.sender + ':</span> ' + data.msg + '</p>';
				$srJq('#srMsgs').append(response);
				handleTts(data.msg);

				if(!sr_isChatOpen()) {
					sr_incrementUnreadMessages();
					sr_showPreviewMessage(data.msg, agentImgUrl);
				} else {
					// Mark it as read
					sr_markMessagesRead(1);
				}

				// Remove the chat cookie
				//$srJq.removeCookie('sr-ec');
				srPlink();
				// Unset the timer to show the bad message
				if(typeof queueTimer != 'undefined'){
					clearTimeout(queueTimer);
				}

				// Unset the timer to show the queue too long message
				if(typeof srSwAutoTimer != 'undefined'){
					clearTimeout(srSwAutoTimer);
				}

				sr_clearResponseTimer();
			}
			$srJq('#srMsgs p#typing').remove();
			$srJq('#srMsgs #srFaded').parent().remove();
			srHideConnectionIssue();
			convertToNormalInput();
			scrollChat();

			// Linkify the content
			$srJq('#srMsgs').linkify({ target: '_self' });

			// Finally after a brief delay forward the user to any site URLs included in the message
			urlTransfer(data.msg);

			// focus onto the text input for a response
			$srJq('#srMsgSender').focus();

		});

		// Handle the checks about the header of the widget to make sure we are showing
		// the correct agent at the top of the widget
		function srCheckWidgetHeader ( sender ) {

			// Get the details from the header at the moment
			var curAgent = $srJq('#srChatter #srMsgs p.srIntro').html();
			curAgent = curAgent.replace('You are chatting with ', '');
			var curPosn = $srJq('#srChatter #srMsgs p.srIntroPos').html();

			// Get the sender name
			var msgAgent = sender['sender'].replace(sender.agent_addn, '').trim();

			// If the message agent does not match the displayed agent
			if ( msgAgent != curAgent ) {
				// Change the intro message and image about the person you are chatting to
				$srJq('.srIntro').html('You are chatting with ' + msgAgent);

				// Fetch additional agent details
				populateAgent(sender.agent_ref, sender.sender);
			}

		}

		// If notified that a user has had to log back on to socket
		socket.on('chat notify', function(data){
			var chat_ref = getChatId();
			if(typeof chat_ref != 'undefined' && chat_ref == data.chat_ref){
				joinChat(data.chat_ref, "168019131601");
			}
		});

		// Return of a chat from an Ami agent to email
		socket.on('autochat email request', function(chat_ref, message, method, form_details, isFallback){

			if (typeof isFallback == 'undefined') {
				isFallback = 0;
			}

			// Get the agent name
			var agent_name = getAgentName();

			// Clear any Ami agent timeouts
			sr_clearResponseTimer();

			// DIsplay the relevant message to the user
			if ( method == 'email-sent' ) {

				$srJq('#srMsgs').append('<p class="agent"><span>' + agent_name + ':</span> ' + message + '</p>');
				handleTts(message);
				scrollChat();

				// If this is a fallback then tell them we have sent them an email in a green message
				if (isFallback == 1) {
					var haveEmailed = "There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ";
					setTimeout(function(){
						$srJq('#srMsgs').append('<div class="srEndChat mail"><p>' + haveEmailed + '</p></div>');
						handleTts(haveEmailed);
						srPlink();
						scrollChat();
					}, 2000);
				}

			} else {

				// Show the message
				$srJq('#srMsgs').append('<p class="agent"><span>' + agent_name + ':</span> ' + message + '</p>');
				handleTts(message);
				// Show the "I require your details" form
				if ( typeof form_details.form != 'undefined' && form_details.form != '' ){

					var full_form = form_details.form;
					form_details = form_details.form.replace('CB*', '');

					$srJq('#srInputs').html(form_details + '<p class=\"srDataSecure\"><b> Data Once </b> We only use this information to contact you regarding your enquiry.</p><a href="#submit" rel="srSubmitMessage" name="form" class="srFormBtn">Submit</a>');
					$srJq('#srChatForm').addClass('details');
					if(isMobileUx) {
						checkRecentMsgHeight();
            msgHeight(50, function(){});
					}
					// Add a listener to the form button
					$srJq('a[rel="srSubmitMessage"]').off('click');
					$srJq('a[rel="srSubmitMessage"]').click(function(e){
						e.preventDefault();
						var params = $srJq(this).attr('name');
						if(typeof params != 'undefined'){
							submitMessage(params);
						} else {
							submitMessage();
						}
					});

				}

				// Reset the status to Ami herself so she can deal with the outcome of the form
				$srJq('#amiAgentsStatus').val(0);
				scrollChat();
				srPlink();

			}

			// Update the message in the database
			if (isFallback == 1) {
				if ( typeof full_form == 'undefined'){
					full_form = '';
				}
				recordAutoMsg (message, 'negative', true, agent_name, full_form);
				srSetAuto(chat_ref, 1);

				// If we have added a green message then save that as well
				if (typeof haveEmailed != 'undefined') {
					setTimeout(function(){
						recordAutoMsg(haveEmailed, 'srEndChat mail', false);
					}, 500);
				}

				// If in an HTML5 enabled browser play the chink
				srPlink();
			}

		});

		function srPlink () {
			// If in an HTML5 enabled browser play the chink
			if(Modernizr.audio){
				var playPromise = document.getElementById('chink').play();
				if ( playPromise !== undefined ) {
					// playPromise.catch(error => {});
					playPromise.catch(function(){});
				}
			}
							$srJq('a#srLaunch').effect('bounce', {times: 3}, 'slow');
					}

		// Update the automated status
		function srSetAuto (chat_ref, isAuto) {
			$srJq.ajax({
				url: "//app.meetami.ai/chats/adjust_chat_status/168019131601/" + chat_ref + "/" + isAuto,
				type: "GET",
				success: function(data) {
				}
			});
		}

		// Return of a chat from an Ami agent to email
		socket.on('autochat chat request', function(chat_ref, message, method, agent_name, agent_ref){

			// Get the old agent name
			var old_agent = getAgentName();

			// Clear out any old Ami agent chat timeouts
			sr_clearResponseTimer();

			// Join the live chat room
			joinChat(chat_ref, '168019131601', false);

			// DIsplay the relevant message to the user
			$srJq('#srMsgs').append('<p class="agent"><span>' + old_agent + ':</span> ' + message + '</p>');
			handleTts(message);
			recordAutoMsg(message, '', false, old_agent);
			scrollChat();
			srPlink();

			// AFter a brief pause show the transfered message
			setTimeout(function(){
				var transferMsg = "Your chat has been transferred to one of our live chat agents.";
				$srJq('#srMsgs').append('<div class="srEndChat chat"><p>' + transferMsg + '</p></div>');
				handleTts(transferMsg);
				srPlink();
				scrollChat();
				recordAutoMsg(transferMsg, 'srEndChat chat', false);
			}, 2500);

			if (method == 'chat-by') {
			  transferToBumpyard();
			}

			// If Google analytics events are enabled then track them
					});

		// Autochat transfering from an Ami agent to a callback
		socket.on('autochat callback request', function(chat_ref, message, method, isFallback){

			if (typeof isFallback == 'undefined') {
				isFallback = 0;
			}

			// Clear any Ami agent timeouts
			sr_clearResponseTimer();

			// Reset the Ami chat status to Ami herself
			$srJq('#amiAgentsStatus').val(0);

			// Trigger the actual call wrapper
			var trigger = 'ch-' + chat_ref;
			if ( method == 'callback-sf') {
				trigger = 'sf-';
			}
			triggerCall(trigger, '', '', '', '', 0, 0, 1);

			// Display the message + scroll the chat
			var old_agent = getAgentName();
			$srJq('#srMsgs').append('<p class="agent"><span>' + old_agent + ':</span> ' + message + '</p>');
			handleTts(message);
			scrollChat();

			// If it is a fallback then store the message
			if (isFallback == 1) {
				recordAutoMsg(message, 'negative', 0, old_agent, '');
				srPlink();
			}

		});

		// Receive messages from an Ami agent
		socket.on('autochat message', function(data){

			if(data.agent_msg == 0) {
				$srJq('#amiAgentsStatus').val(0);
			}

			// Check that it was not the user's own chat
			if ( data.agent_msg != 0 || (typeof(data.force_show) !== "undefined" && data.force_show == 1)) {
				//console.log(data);
				// Work out the agent name
				var agent_name = $srJq('#srMsgs p.agent span:not([class])').html();
				agent_name = agent_name.replace(':', '');
				// Add the message on to the chat
				var agentImgUrl = false;
				if ( typeof data.image != 'undefined' && data.image != '' && data.image_dir != '' ) {
					agentImgUrl = data.image;
					var message = '<p class="agent inc-avatar"><span class="avatar-mini"><img src="'+agentImgUrl+'" alt="' + agent_name + '" /></span><span>' + agent_name + ':</span> ' + data.msg + '</p>';
				} else {
					var message = '<p class="agent"><span>' + agent_name + ':</span> ' + data.msg + '</p>';
				}
				$srJq('#srMsgs').append(message);
				handleTts(data.msg);
				$srJq('#srMsgs').linkify({ target: '_self' });
				convertToNormalInput();
				scrollChat();

				// If in an HTML5 enabled browser play the chink
				srPlink();
				sr_clearResponseTimer();

				srHideConnectionIssue();

			}

			if(!sr_isChatOpen()) {
				sr_incrementUnreadMessages();
				sr_showPreviewMessage(data.msg, agentImgUrl);
			} else {
				// Mark it as read
				sr_markMessagesRead(1);
			}
		});

		// Generic function to check for a previous close message - so we don't end up showing it several times
		function srCheckPreviousClose () {
			var display = true;
			$srJq('#srMsgs p.feint').each(function(){
				var content = $srJq(this).html();
				if (content.indexOf('ended') > -1) {
					display = false;
				}
			});
			return display;
		}

		// When an admin ends a chat
		socket.on('chat closeagent', function(){
			var display = srCheckPreviousClose();
			if (display = true) {
				response = '<div><p class="feint">The agent has ended this chat session. If you wish to open a new chat session please close this window and open a new one.</p></div>';
				$srJq('#srMsgs').append(response);
				scrollChat();
				registerLoad();
			}
		});

		// Handle transfers back to Ami
		socket.on('autochat transfered-back', function(new_status){
			$srJq('#amiAgentsStatus').val(new_status);
		});

		// Join chat
		function joinChat(chat_ref, client_ref, is_ami){
			// Is it an Ami chat
			if(typeof is_ami == 'undefined'){
				is_ami = false;
			}

			var cust_url = "https://www.stockport.gov.uk/brownfield/brownfield-land-register";
			var usrRef = getUsrId();
			var chat_data = { chat_id: chat_ref, client_ref: client_ref, custUrl: cust_url, usr_ref: usrRef }
			if(is_ami === false){
				socket.emit('chat join', chat_data);
			} else {
				chat_data.page_url = cust_url;
				socket.emit('autochat join', chat_data);
			}
		}

		// If a user has tried to send a message and the agent has left then tell them
		socket.on('agent closed', function(){
			var display = srCheckPreviousClose();
			if (display = true) {
				response = '<div><p class="feint">The agent has ended this chat session. If you wish to open a new chat session please close this window and open a new one.</p></div>';
				$srJq('#srMsgs').append(response);
				scrollChat();
			}
		});
		// If a user has tried to send a message and the agent has left then tell them
		socket.on('agent closed-time', function(){
			var display = srCheckPreviousClose();
			if (display = true) {
				response = '<div><p class="feint">This chat session has been ended due to a period of inactivity. If you wish to start a new new chat session please close this window and relaunch it.</p></div>';
				$srJq('#srMsgs').append(response);
				scrollChat();

				// Store the message as a feint
				storeMessage(response, 'feint');
			}
		});

		socket.on('autochat ami_status', function(cust_id, ami_status){
			var usr_id = getUsrId();
			if ( cust_id == usr_id && ami_status != 0 ) {
				$srJq('#amiAgentsStatus').val(1);
			}
		});

		// Stores feint messages from the server
		function storeMessage (message, sender, vmType, isAgent) {

			if (typeof vmType == 'undefined') {
				vmType = '';
			}
			if (typeof isAgent == 'undefined') {
				isAgent = '-';
			}

			var user_ref = getUsrId();
			var chat_ref = $srJq('#chat_ref').val();

			// Run the storage
			$srJq.ajax({
				url: "//app.meetami.ai/chats/store_message/168019131601/" + chat_ref + "/" + user_ref,
				type: "POST",
				data: { msg: message, sender: sender, vm_type: vmType, is_agent: isAgent },
				success: function(data) {
				}
			});

		}

		// Handle the so + so is typing messages
		function trackTyping(){
//alert('Stopping check');
			$srJq('#srMsgSender').off('keyup');
			$srJq('#srMsgSender').keyup(function(){
//alert('Keyup');
				typingCheck();
			});
		}

		function typingCheck(){
			var entry = $srJq('#srMsgSender').val();
			data = {
				name: 'Customer',
				pub_id: 'NONE',
				chat_id: $srJq('#chat_ref').val(),
				client_ref: "168019131601"
			}
//alert('Checking');
			if(typeof data.chat_id == 'undefined' || data.chat_id == '') {
				return;
			}

			if(entry != ''){
				socket.emit('chat typing', data);
				data.typing = 1;
				socket.emit('autochat typing', data);
			} else {
				socket.emit('chat stoptyping', data);
				data.typing = 0;
				socket.emit('autochat typing', data);
			}
		}

		socket.on('chat typing', function(data){
			if (!isMobileUx) {
				if(data.name != 'Customer' && $srJq('#srMsgs p#typing').length == 0 && $srJq('#srMsgs #srFaded').length == 0){
					$srJq('#srMsgs p#typing').remove();
					$srJq('#srMsgs #srFaded').parent().remove();
					agentTyping(data.name);
					scrollChat();
					sr_resetNoResponseTimer();
				}
			}
		});
		socket.on('chat stoptyping', function(data){
			$srJq('#srMsgs p#typing').remove();
			$srJq('#srMsgs #srFaded').parent().remove();
			scrollChat();
		});

		socket.on('autochat typing', function(data){
			// Check that it is not a customer typing message
			if (!isMobileUx) {
				if ( data.name != 'Customer' ) {
					$srJq('#srMsgs p#typing').remove();
					$srJq('#srMsgs #srFaded').parent().remove();
					if (data.typing == 1) {
						// Get the automated agent name
						var agent_name = $srJq('#srMsgs p.agent span:not([class])').html();
						agent_name = agent_name.replace(':','');
						// Add the is typing message
						agentTyping(agent_name);
						scrollChat();
						sr_resetNoResponseTimer();
					}
				}
			}
		});

		// Handle typists that are already typing when autochat is joined
		socket.on('autochat typists', function(typists){
			// Loop through the typists
			var hasTypists = false;
			for ( var key in typists ) {
				if ( typeof typists[key]['name'] != 'undefined' && typists[key]['name'] != 'Customer' ) {
					hasTypists = true;
				}
			}
			if(hasTypists === true){
				// Get the automated agent name
				var agent_name = $srJq('#srMsgs p.agent span:not([class])').html();
				if (typeof agent_name != 'undefined') {
					agent_name = agent_name.replace(':','');
					// Check that the last message isn't a typists message
					var existingTypeMsg = $srJq('#srMsgs #typing').length + $srJq('#srMsgs #srFaded').length;
					if (existingTypeMsg == 0){
						// Add the is typing message
						agentTyping(agent_name);
						scrollChat();
					}
				}
			}
		});

		// Utility function to populate an agent's details in a chat widget
		function populateAgent (agent_ref, agent_name) {
			// Update the chat agent details
			$srJq('.srIntro').html('You are chatting with ' + agent_name);

			// Fetch additional agent details
			$srJq.ajax({
				url: "https://app.meetami.ai/agents/return_details/" + agent_ref,
				type: "GET",
				success: function(data) {
					// Parse the JSOn array
					dataObj = JSON.parse(data);
					// Set the data
					$srJq('.srIntroPos').html(dataObj.team);
					/*if(dataObj.image_dir != null && typeof dataObj.image != null && dataObj.image != null){
						$srJq('img.profile').replaceWith('<img src="https://s3-eu-west-1.amazonaws.com/aomg-sr-app-live/agent/image/' + dataObj.image_dir + '/tmb_' + dataObj.image + '" alt="' + dataObj.display_name + '" class="profile" />');
					} else {
						$srJq('img.profile').parent('span').replaceWith('<span><img src="//app.meetami.ai/img/widget/default-avatar-lrg.svg" alt="' + dataObj.display_name + '" class="profile bbl" /></span>');
					}*/
				}
			});
		}

		// Transfer a chat between owners
		socket.on('chat transfered-widget', function(data){
			if (typeof data.agent_name != 'undefined' && data.agent_name.indexOf('Ami v') == -1) {
				// Add message to chat window
				$srJq('#srMsgs').append('<div><p class="feint">The chat was transferred to ' + data.agent_name + '</p></div>');
				// Update the chat agent details
				$srJq('.srIntro').html('You are chatting with ' + data.agent_name);

				// Fetch additional agent details
				populateAgent(data.agent_ref,data.agent_name);
				scrollChat();
			}
		});

		/* Handling disconnects, reconnects etc */

		socket.on('disconnect', function(){
			// If socket disconnects
			console.log('Socket disconnected');
			$srJq('#amiAgentsList').val('');
			$srJq('#agentsList').val('');
			// If the user is in a chat and they get disconnected then atempt to reconnect
			var curChat = getChatId();
			if(typeof curChat != 'undefined'){
				joinChat(curChat, "168019131601");
				socket.emit('chat notify', { chat_ref: curChat, client_ref: "168019131601"});
			}
		});

		socket.on('connect', function(){
			// When socket reconnects
			console.log('Socket connected');
			reconnectChats();
			var dept = getDeptId();
			updateAvailableAgents(dept);
		});

		socket.on('connect_error', function(){
			// TODO - anything to handle the loss of a connection
			showErrorBanner();
		});

		socket.on('reconnect', function(){
			// Anything to handle the reconnection
			reconnectChats();
			hideErrorBanner();
			// Repopulate agent lists
			var dept = getDeptId();
			updateAvailableAgents(dept);
			// TODO - bespoke function to repopulate the Ami agents list
		});

		function reconnectChats () {
			// If the user is in a chat and they get disconnected then atempt to reconnect
			var curChat = getChatId();
			if(typeof curChat != 'undefined'){
				joinChat(curChat, "168019131601");
				// TODO - check for missed messages since the last one (check the MySQL db)
			}
		}

		function showErrorBanner (  ) {

		}

		function hideErrorBanner (  ) {

		}

		/******************** End Live Chat sockets *******************/

		// The function to end a chat
		// Runs a confirmation
		// If skip_confirm == skip then it skips the confirmation
		function endReplierChat(skip_confirm, nof){

			//$srJq('#srChatter').attr('class', 'srFeedback');
			if(typeof nof == 'undefined' || nof == ''){
				nof = "";
			}
			// Check Ami agent status
			var amiAgentStatus = $srJq('#amiAgentsStatus').val();

			// Check whether any messages have been submitted (if they have not then skip_confirm and nof should bothe be implemented)
			var close = 0;
			if(skip_confirm != 'skip' || (typeof nof == 'undefined' || nof == '')){
				var msg_no = $srJq('#srMsgs p.agent').length;
				if(msg_no == 1){
					skip_confirm = 'skip';
					nof = 'nof';
					close = 1;
				}
			}

			if($srJq('#srChatter').data('sr-feedback-given') == 1) {
				close = 1;
			}

			if(skip_confirm == 'skip'){
				var chat_ref = getChatId();
				// TODO - Check whether there are any callbacks to be triggered before closing
				if (typeof srSpecifyHide != 'undefined') {
					srTriggerCbEarly();
				}
				redistributeViaNode({}, 'close');
				endChat();

				// Drop a cookie to make sure the replier is not reopened by auto trigger
				$srJq.cookie('sr-cl', 1, { path: '/', domain: domain });
				$srJq('#srChatter').attr('class', 'srFeedback');

				// Retrieve the fedback form via AJAX
				$srJq.ajax({
					type: "GET",
					url: "//app.meetami.ai/feedback/create/" + chat_ref + "/" + nof,
					success: function(feedback_form) {
						// Display the feedback fom
						if(close == 1){
							closeReplier();
						} else {
							$srJq('#srChatter').slideUp(250).html(feedback_form).slideDown(300);
							populate_feedback_callback_form();
						}
						// Notify Ami agents of socket chat end
						if (amiAgentStatus == 1) {
							socket.emit('autochat close', chat_ref, 0);
						}

						// Reset the close button if required
						$srJq('.srClose').attr("rel", "srChatToggle");
						if(nof == 'nof'){
							closeEnd();
						}
					}
				});
			} else {

				var confirmedExit = false;
				if ( confirmedExit === false ) {
					if($srJq("#srCloseOverlay").hasClass("visible") == false) {
						$srJq("#srCloseOverlay").fadeIn("fast");
						$srJq("#srCloseOverlay").addClass("visible");
						return;
					} else {
						confirmedExit = true;
					}
				}

				if (confirmedExit){
          redistributeViaNode({}, 'close');
					endChat();
					var chat_ref = getChatId();

					// Check whether there are any callbacks to be triggered before closing
					if (typeof srSpecifyHide != 'undefined') {
						srTriggerCbEarly();
					}

					$srJq('#srChatter').attr('class', 'srFeedback');

					// Drop a cookie to make sure the replier is not reopened by auto trigger
					$srJq.cookie('sr-cl', 1, { path: '/', domain: domain });
					// Notify Ami agents of socket chat end
	// 				if (amiAgentStatus == 1) { // Commented out to allow auto chats to clear from the dashboard
						socket.emit('autochat close', chat_ref, 0);
//					}
					// Retrieve the fedback form via AJAX
					$srJq.ajax({
						type: "GET",
						url: "//app.meetami.ai/feedback/create/" + chat_ref + "/" + nof,
						success: function(feedback_form) {

							// Display the feedback fom
							if(close == 1){
								closeReplier();
							} else {
								$srJq('#srChatter').slideUp(250).html(feedback_form).slideDown(300);
								populate_feedback_callback_form();
							}
							// Reset the close button if required
							$srJq('.srClose').attr("rel", "srChatToggle");
							if(nof == 'nof'){
								closeEnd();
							}
						}
					});
				}
			}

			
			$srJq.cookie('sr-inSe', 0, { path: '/', domain: domain });
		}

		function endChat() {
			var chat_ref = getChatId();
			$srJq.ajax({
				type: "GET",
				url: "//app.meetami.ai/chats/end_chat/" + chat_ref,
				success: function(data) {
					console.log("Ended chat");
				}
			});
		}

		$srJq("#srCloseOverlay .srYes").click(function() {
			endReplierChat();
			$srJq("#srCloseOverlay").hide();
			$srJq("#srCloseOverlay").removeClass("visible");
		});

		$srJq("#srCloseOverlay .srNo").click(function() {
			$srJq("#srCloseOverlay").hide();
			$srJq("#srCloseOverlay").removeClass("visible");
		});

		function srIsiPhoneNoConfirm () {
		  var iHeight = window.screen.height;
		  var iWidth = window.screen.width;
			var size = false;
		  if (iWidth === 375 && iHeight === 667) {
		    size = true;
		  } else if (iWidth === 414 && iHeight === 736) {
		    size = true;
		  }

			var safariBrowser = isSafari();
			if (!!navigator.userAgent.match(/iPhone/i) && safariBrowser === true && size === true) {
				return true;
			}
			return false;
		}

		function isSafari () {
			var ua = navigator.userAgent.toLowerCase();
			if (ua.indexOf('safari') != -1) {
			  if (ua.indexOf('chrome') > -1) {
			    return false;
			  } else {
			    return true;
			  }
			}
			return false;
		}

		// Function to submit feedback and display the thanks page
		function submitFeedback(during){
			$srJq('a[rel="srSubmitFeedback"]').off('click');
			// Get the chat reference
			var chat_ref = getChatId();
			var client_ref = '168019131601';

			// Retrieve the message that has been typed
			feedback = $srJq('#srFeedbackInput').val();
			rating = $srJq('#srRating').val();

			var name = $srJq("#feedback-callback-form").find("#name").val();
			var email = $srJq("#feedback-callback-form").find("#email").val();
			var phone = $srJq("#feedback-callback-form").find("#phone").val();
			var callback_time = $srJq("#feedback-callback-form").find("#srSelectTime").val();

			// Run the AJAX submission + save
			$srJq.ajax({
				url: "//app.meetami.ai/feedback/create/" + chat_ref + "/" + during,
				type: "POST",
				data: {
					feedback: feedback,
					rating: rating,
					uname: name,
					uemail: email,
					phone_no: phone,
					call_time: callback_time
				},
				success: function(data) {

					if(typeof(during) === "undefined" || during == false) {
						$srJq('#srChatter').html(data);
					} else {
						$srJq('#srChatter').html(chat_dom).data("sr-feedback-given", 1);
						checkExistingChats();
						triggerListeners();
						$srJq('#srChatter a.footerRate').parent().replaceWith('<p class="footerRate success-color">Thanks for your feedback</p>');
						setTimeout(function() {
							$srJq('#srChatter .feedback-upper-container').hide();
						}, 25000);

						if(phone != "" && callback_time != "") {
							if(data != 0 && data != 'invalid-phone' && data != 'error-phone' && data != 'error-recent'){

								// Set it back to a simple form
								toSimpleForm();

								displayPhoneThanks(callback_time);

								// If Google analytics events are enabled then track them
								
							} else if(data == 'error-very-recent') {

								var end_msg = '<div class="srEndChat phone"><p>We are calling you now.</p></div>';
								$srJq('#srMsgs').append(end_msg);
								handleTts(end_msg);
								scrollChat();

								redistributeViaNode({time: 'none'}, 'callback-scheduled');

							} else if(data == 'error-recent') {
								// Update the latest message to say someone is already calling
								var end_msg = '<div class="srEndChat phone"><p>A call has already been scheduled. We will be in touch as soon as we can.</p></div>';
								$srJq('#srMsgs').append(end_msg);
								handleTts(end_msg);
								scrollChat();

								// Store the message for page switch
								recordAutoMsg ("A call has already been scheduled. We will be in touch as soon as we can.", "srEndChat phone", 0);
								clearTimeout(scope.greenTimeout);

							} else {
								alert('Sorry but there was a problem making the call. Please try again.');
							}
						}

					}
					$srJq('a[rel="srSubmitFeedback"]').click(function(e){
						e.preventDefault();
						submitFeedback();
					});

				}, error: function(e,f,g) {
					console.log(e);
				}
			});
		}

		/**************************************************************/
		/******************** Search results display ******************/
		/**************************************************************/

		$srJq(function() {

													
			
			
					});

		
		
		function createRemoteChat(msg_type){

			// Dissable the input
			form_data = $srJq('#' + msg_type + 'MsgForm').serializeArray();
			form_data = JSON.stringify(form_data);
			var last_msg = $srJq('#' + msg_type + 'MsgForm #' + msg_type + 'Msg').val();
			$srJq('#' + msg_type + 'Msg').attr('disabled', true);

			// Get an agents list
			var agents = $srJq('#agentsList').val();
			if(agents == ''){
				agents = 'none'
			}

			$srJq.ajax({
				type: "GET",
				url: "//app.meetami.ai/chats/create_chat/" + client_ref + '/' + agents + '/' + uid + '/direct-mob',
				success: function(data) {

					if(data != 'no-agent'){
						dataObj = JSON.parse(data);

						// TODO - submit first message

						$srJq.ajax({
							url: "//app.meetami.ai/chats/add_msg/" + client_ref + "/" + dataObj.chat_ref + "/" + agents,
							type: "POST",
							data: {data: form_data},
							success: function(data) {

								// Open up the chat socket
								var tns_type = 'SL';
								if(msg_type == 'rl'){ tns_type = 'RL'; }
								createLiveChat(dataObj.chat_ref, dataObj.agent_id, dataObj.agent_name, dataObj.chat_no, last_msg, tns_type);

								var chat_url = 'https://app.meetami.ai/chats/chat/168019131601/mob/' + uid + '/' + dataObj.chat_ref;
								srOpenTab(chat_url);

								// Change the lightbox content to show that a chat has been started
								$srJq('#' + msg_type + 'Msg').attr('disabled', false).val('');
								if(msg_type == 'srch'){
									$srJq('#srCoverRecovery .text-form').html('<p>Thanks for starting a chat. Your conversation will open in a new tab.</p><p>If the chat window does not open automatically, please use the button below.</p><a href="' + chat_url + '" class="srSubBtn" target="_blank">Open Chat</a>');
								} else {
									$srJq('#srCover .text-form').html('<p>Thanks for starting a chat. Your conversation will open in a new tab.</p><p>If the chat window does not open automatically, please use the button below.</p><a href="' + chat_url + '" class="srSubBtn" target="_blank">Open Chat</a>');
								}
							}
						});

					} else {
						alert('Sorry but we do not have anyone available to speak to you at the moment');
					}
				}
			});

		}

		
		// Track all entries into the contact forms
		
		function storeField(the_form, field_selector, field_value, triggers_call, call_delay){

			// User ref
			uid = getUsrId();

			// Post the AJAX request
			$srJq.ajax({
				url: "//app.meetami.ai/client_contact_forms/record_details/168019131601/" + the_form,
				type: "POST",
				data: {field_value: field_value, selector: field_selector, uid: uid, url: "https://www.stockport.gov.uk/brownfield/brownfield-land-register"},
				success: function(data) {
									}
			});

		}

		// Track submissions of the search form
		
		// Track result pages that are displayed
		function trackResult(){

			// Set up the client reference
			var client_ref = '168019131601';

			// User ref
			var uid = getUsrId();

			// Set up the search ref (if applicable)
			var srch_ref = $srJq.cookie('sr-srch');
			if(typeof srch_ref == 'undefined'){
				srch_ref = '';
			}

			// Loop through each of the search elements and get the data that they contain
			// Assemble the JSON blob for posting
			
			if(typeof page_elements != 'undefined'){
				// Post the AJAX request
				$srJq.ajax({
					url: "//app.meetami.ai/client_result_pages/record_result/" + client_ref + "/" + srch_ref,
					type: "POST",
					data: {field_data: page_elements, uid: uid, url: "https://www.stockport.gov.uk/brownfield/brownfield-land-register"},
					success: function(data) {
						// If data != 0 then the save has been successful
						if(data != 0){
							// Delete the cookie for the search if save is successful and search is fulfilled
							$srJq.removeCookie('sr-srch', { path: '/', domain: domain });

													}
					}
				});
			}
		}

		// Function to trigger a recovery layer
		function recoveryLayer(layer_type){

			// Check if chat is already open (in which case we do not show recovery layers)
			var status = $srJq('#srContent').css('display');

			// Check whether the recovery layer has already been displayed this session
			var existing = $srJq.cookie('sr-rl');
			if(typeof existing != 'undefined'){
				existing = JSON.parse(existing);
			}

			// If chat is currently closed then open it + create a new chat
			if(status == 'none'){

				if(typeof layer_type == 'undefined'){
					//Standard Recovery Layer
					if(typeof existing == 'undefined' || existing['rl'] != 1){
						$srJq('#srCover').fadeIn(350);
						setTimeout(function () {
							$srJq('#srCover .srCoverContent').slideDown(350);
							$srJq('#srCover a.srCloseBtn').slideDown(350);
						}, 550);
						// Set up the recovery layer cookie
						if(typeof existing != 'undefined'){
							existing['rl'] = 1;
						} else {
							existing = { rl: 1, srch: 0 }
						}
						existing = JSON.stringify(existing);
						$srJq.cookie('sr-rl', existing, { path: '/', domain: domain });
					}

				} else {

					//Post search recovery layer
					$srJq('#srCoverRecovery').fadeIn(350);
					setTimeout(function () {
						$srJq('#srCoverRecovery .srCoverContentRecovery').slideDown(350);
						$srJq('#srCoverRecovery a.srCloseBtn').slideDown(350);
					}, 550);
					// Unset the search aspect of the RL cookie
					// Set up the recovery layer cookie
					if(typeof existing != 'undefined'){
						existing['srch'] = 0;
					} else {
						existing = { rl: 1, srch: 0 }
					}
					var rslt = existing['rslt'];
					existing = JSON.stringify(existing);
					$srJq.cookie('sr-rl', existing, { path: '/', domain: domain });

					
					// Record the result outcome as currently being recovery layer shown
					var usr_ref = getUsrId();
					$srJq.ajax({
						url: "//app.meetami.ai/user_searches/record_goal/" + usr_ref + '/' + rslt + '/rl' ,
						type: "GET",
						success: function(data) {}
					});
				}
			} else {
				// Remove a search trigger from the rl cookie so another recovery layer is not triggered
				if(typeof existing != 'undefined'){
					existing['srch'] = 0;
					var rslt = existing['rslt'];
					existing['rslt'] = 0;
					existing = JSON.stringify(existing);
					$srJq.cookie('sr-rl', existing, { path: '/', domain: domain });

					// Record result as chat already open - track chat ID
					var usr_ref = getUsrId();
					var chat_ref = $srJq('#chat_ref').val();
					$srJq.ajax({
						url: "//app.meetami.ai/user_searches/record_goal/" + usr_ref + '/' + rslt + '/cho-' + chat_ref,
						type: "GET",
						success: function(data) {}
					});
				}
			}
		}

		function closeLayer(layer_type){
			if(typeof layer_type == 'undefined'){
				$srJq('#srCover .srCoverContent').slideUp(350);
				$srJq('#srCover a.srCloseBtn').fadeOut(350);
				$srJq('#srCover').fadeOut(600);
			} else {
				$srJq('#srCoverRecovery #srCoverContentRecovery').slideDown(350);
				$srJq('#srCoverRecovery a.srCloseBtn').fadeOut(350);
				$srJq('#srCoverRecovery').fadeOut(600);

				// Record result as chat already open - track chat ID
				var existing = $srJq.cookie('sr-rl');
				if(typeof existing != 'undefined'){
					existing = JSON.parse(existing);
					var rslt = existing['rslt'];
					if(rslt != 0){
						existing['rslt'] = 0;
						existing = JSON.stringify(existing);
						$srJq.cookie('sr-rl', existing, { path: '/', domain: domain });

						var usr_ref = getUsrId();
						var chat_ref = $srJq('#chat_ref').val();
						$srJq.ajax({
							url: "//app.meetami.ai/user_searches/record_goal/" + usr_ref + '/' + rslt + '/rl-nfa',
							type: "GET",
							success: function(data) {}
						});
					}
				}
			}
		}

		/* Function to return the UID */
		function getUsrId(){
			var usr_cookie = $srJq.cookie('sr-data');
			uid = '';
			if(typeof usr_cookie != 'undefined'){
				usr_details = JSON.parse(usr_cookie);
				if(usr_details['uid'] != '' && usr_details['uid'] != undefined){
					uid = usr_details['uid'];
				}
			}
			return uid;
		}

		function getChatId () {

			var chat_ref = $srJq('#chat_ref').val();
			if(typeof(chat_ref) === "undefined" || chat_ref == '') var chat_ref = $srJq.cookie('sr-ec');

			if ( typeof chat_ref != 'undefined') {
				return chat_ref;
			} else {
				return false;
			}

		}

		console.log("department_hours", department_hours);

		/* Utility form submission action */
		function submitForm(form_id){

			// If Google analytics events are enabled then track them
			
			// Set up the user ID + the rec layer ID
			var uid = getUsrId();

			// Rec layer details
			var rlCookie = $srJq.cookie('sr-rl');
			if(typeof rlCookie != 'undefined'){
				rlCookie = JSON.parse(rlCookie);
				var rslt = rlCookie['rslt'];
				if(form_id == 'searchRecForm'){
					rslt = 'sl-' + rslt;
				} else {
					rslt = 'rl-' + rslt;
				}
				if(rslt != 0){
					rlCookie['rslt'] = 0;
					rlCookie = JSON.stringify(rlCookie);
					$srJq.cookie('sr-rl', rlCookie, { path: '/', domain: domain });
				}
			}

			// Check that the form validates
			var isValid = $srJq('#' + form_id).valid();

			// Check that the phone number validates
			if($srJq('#' + form_id + ' input[type=tel]').length){
				phone_rslt = validatePhone($srJq('#' + form_id + ' input[type=tel]').val());
				if(phone_rslt != true){
					isValid = false;
					$srJq('#' + form_id + ' input[type=tel]').closest('div').children('p.errormsg').remove();
					$srJq('#' + form_id + ' input[type=tel]').closest('div').append('<p class="small errormsg">' + phone_rslt + '</p>');
				}
			}

			if(isValid == true){

				// Hide the form + display the loader
				$srJq('#' + form_id).slideUp(200);
				$srJq('#' + form_id).closest('div').children('.loader').slideDown(200);

				// Serialise the form data based on the ID
				form_data = $srJq('#' + form_id).serializeArray();
				form_data = JSON.stringify(form_data);

				// Post it via AJAX
				$srJq.ajax({
					url: "//app.meetami.ai/chats/submit_form/168019131601/" + uid + '/' + rslt,
					type: "POST",
					data: { form_data: form_data },
					success: function(data) {
						$srJq('#' + form_id).closest('div').children('.loader').slideUp(300);
						if(data == 1){
							$srJq('#' + form_id).prepend('<p class="success">Thanks for your message. We will be in touch shortly.</p>').slideDown(300);
							// Record form submission as the final goal
							$srJq.ajax({
								url: "//app.meetami.ai/user_searches/record_goal/" + uid + '/' + rslt + '/form',
								type: "GET",
								success: function(data) {}
							});
						} else {
							$srJq('#' + form_id).prepend('<p class="error">Sorry but there was an error submitting your form. Please try again.</p>').slideDown(300);
						}
					}
				});
			}

		}

		
		
		// Show the success message at the end of a chat
		function srEndChatMsg (msg, msg_class, redistribute) {
			// If there is already a callback request in the queue
			var end_msg = '<div class="srEndChat ' + msg_class + '"><p>There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. </p></div>';
			// Append the message to the end of the messages
			$srJq('#srMsgs').append(end_msg);
			handleTts(end_msg);
			if(redistribute) recordAutoMsg('There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ', 'srEndChat ' + msg_class);
			$srJq('#srMsgs').linkify({ target: '_self' });
			scrollChat();
			if(redistribute) srPlink();
		}

		// Handles the display of the
		function srEndChatWrapper(callback_id, trigger, redistribute){

			var deptId = getDeptId();
							var icbl = 0;
			
			var is_cb_msg = false;

			// If we are just informing them that an emil has been sent
			if (typeof callback_id != 'undefined' && callback_id == 'emailed') {

				srEndChatMsg('There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ', 'mail', redistribute);

			// Display the initial ending message onto the chat
			} else if(typeof callback_id != 'undefined' && callback_id != true && callback_id.indexOf('existing') > -1){

				// If there is already a callback request in the queue
				srEndChatMsg('A callback has already been scheduled for you. Our team will be in touch at your requested time.', 'phone', redistribute);

			} else if(icbl == 1 && typeof(deptId) !== 'undefined' && deptId != '' && typeof department_hours[deptId] != 'undefined' && department_hours[deptId].open == 1) {
				// The chat is in a department and that department is open
				is_cb_msg = true;
				var end_msg = '<div class="srEndChat phone"><p>Schedule your call.</p><p id="specifyBtn"><a href="#specify" name="' + callback_id + ' ' + trigger + '" id="srSpecifyTime">Click here</a> to specify a time or <a href="#specifyNow" id="srCallNow">click here</a> for a call now</p></div>';
				if(redistribute) recordAutoMsg('We are calling you now.', 'srEndChat phone');
			} else if(icbl == 1 && typeof(deptId) !== 'undefined' && deptId != '' && typeof department_hours[deptId] != 'undefined' && department_hours[deptId].hasFutureHours !== false) {
				// The chat is in a department and that department has future times available
				is_cb_msg = true;
				var end_msg = '<div class="srEndChat phone"><p>There is currently no-one available to call you back. Please schedule your call for an appropriate time.</p><p id="specifyBtn"><a href="#specify" name="' + callback_id + ' ' + trigger + '" id="srSpecifyTime">Click here</a> to specify a time.</p></div>';
				if(redistribute) recordAutoMsg('There is currently no-one available to call you back. Please schedule your call for an appropriate time.', 'srEndChat phone');
			} else {
									var end_msg = '<div class="srEndChat mail"><p>There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. </p></div>';
					if(redistribute) recordAutoMsg('There are currently no available agents online. I have passed on your enquiry via email.  We have live agents available from  09:00 – 16:30  Monday to Thursday and 09:00 – 16:00 on a Friday. ', 'srEndChat mail');
					// If Google analytics events are enabled then track them
													is_cb_msg = true;
			}

			if(is_cb_msg == true) {
				// Append the message to the end of the messages
				$srJq('#srMsgs').append(end_msg);
				handleTts(end_msg);
				$srJq('.phone').show();
				$srJq('#srMsgs').linkify({ target: '_self' });
									srSetupListenner('trigger', callback_id);
				
				// Give a plink plonk
				if(redistribute) srPlink();

				// Scroll the chatter and chink
				scrollChat();
				if(redistribute) srPlink();

									// Set a timer to hide the specify time link
					srSpecifyHide = setTimeout(function () {
						srHandleCallNow(false, false, trigger, redistribute);
					}, 1000);
					srSpecifyHideSpec = {
						'trigger': trigger
					};
					scrollChat();
							}

		}

		function srHandleCallNow(callbacks, callback_id, trigger, redistribute) {
			if(callbacks) {
				$srJq('#srMsgs #specifyBtn').slideUp(150);
				// Either trigger the call directly or set a callback request
				srCbRequest(callback_id, trigger, undefined, true);
			} else {
				$srJq('#srMsgs #specifyBtn').slideUp(150);
				// Trigger the call directly
				var uid = getUsrId();
				var chat_id = getChatId();
				if(redistribute) srTriggerDirectCall(uid, chat_id, 'none', trigger, true);
				redistributeViaNode({time: 'none'}, 'callback-scheduled');
			}
		}

		function srTriggerCbEarly () {

			if (typeof srSpecifyHideSpec != 'undefined' && typeof srSpecifyHideSpec.trigger != 'undefined') {

				// Check what we are to do with the request
				if (typeof srSpecifyHideSpec.callback_id != 'undefined') {
					srCbRequest(srSpecifyHideSpec.callback_id, srSpecifyHideSpec.trigger);
				} else {
					var uid = getUsrId();
					var chat_id = getChatId();

					srTriggerDirectCall(uid, chat_id, 'none', srSpecifyHideSpec.trigger);
				}
				clearTimeout(srSpecifyHide);
				delete srSpecifyHideSpec;
				$srJq('#srMsgs #specifyBtn').slideUp(150);
			}
			return;

		}

		function srGenerateCallbackSelect() {
			returnArr = {};
							returnArr = {
					content: '<p>Please choose a time to schedule your call today</p>'.replace("today", "tomorrow"),
					day: 'tomorrow',
					menu: '<select name="data[time]" id="srSelectTime"><option value="9:00">9am</option><option value="10:00">10am</option><option value="11:00">11am</option></select>'
				}
							return returnArr;
		}

		function srGenerateCallbackDeptSelect() {
			var selectMenuArr = {};
																																																																																							return selectMenuArr;
		}

		// Listen for clicks on the specify button]
		function srSetupListenner (trigger, callback_id) {
			$srJq('#srCallNow').on('click', function(e){
				e.preventDefault();
        		clearTimeout(srSpecifyHide);
									srHandleCallNow(false, false, trigger, true, true);
					scrollChat();
							});

			$srJq('#srSpecifyTime').on('click', function(e){

				e.preventDefault();

				// Clear the automated action
				clearTimeout(srSpecifyHide);
				delete srSpecifyHideSpec;

				// Get the parameters
				var params = $srJq(this).attr('name');
				//params = params.split(' ');

				// Set up the form
				var selectMenuData = srGenerateCallbackSelect();
				var updatedContent = selectMenuData.content;
				var selectMenu = selectMenuData.menu;
				var day_date = false;

				// Create a select menu for each of the relevant departments
				var selectMenuArr = srGenerateCallbackDeptSelect()

				// Check whether we are in a standard chat or a departmental one
				var deptId = getDeptId();
				console.log("DEPT ID: " + deptId);
				console.log(selectMenuArr[deptId]);
				if (deptId != '' && typeof selectMenuArr[deptId] != 'undefined') {
					updatedContent = selectMenuArr[deptId].content;
					selectMenu = selectMenuArr[deptId].menu;
					selectMenuData = selectMenuArr[deptId];
					day_date = selectMenuData.day_date;
				}

				updatedContent += '<p>Please call ' + selectMenuData.day + ' at: ' + selectMenu + '</p>';
				updatedContent += '<a href="#specify" name="' + params + '" id="srSpecifyTimeBtn">Select time</a>';

				// Switch out the content of the end chat box for the form
				$srJq('#srMsgs .srEndChat.phone:last').html(updatedContent).show();
				recordAutoMsg(updatedContent, 'srEndChat phone', 1);
				setTimeout(function () {
					scrollChat();
					if ( typeof trigger == 'undefined' ) {
						srSetupListenner();
						srSetupCallBackFormListenner(day_date); // TODO - test this out
					} else {
						srSetupListenner(trigger);
						srSetupTriggerTimeFormListenner(day_date);
					}
				}, 500);

			});
/*
			if ( typeof trigger == 'undefined' ) {
				srSetupCallBackFormListenner(); // TODO - test this out
			} else {
				srSetupTriggerTimeFormListenner();
			}*/
		};


		// Setup a listenner for thr trigger time
		function srSetupTriggerTimeFormListenner (day_date) {

			$srJq('#srSpecifyTimeBtn').on('click', function(e){

				e.preventDefault();

				// Get the time that they have selected
				var selectedTime = $srJq('#srSelectTime').val();

				if(typeof day_date !== 'undefined' && day_date != false) {
					selectedTime = day_date + " " + selectedTime + ':00';
				} else {
					selectedTime = "2019-12-31 " + selectedTime + ':00';
				}

				// Get the callback ID and trigger / store them somewhere
				// Get the parameters
				var params = $srJq(this).attr('name');
				params = params.split(' ');

				// Get the user ID
				var uid = getUsrId();
				var chat_id = getChatId();

				// Trigger the call asynchronously (with the time set in the request)
				srTriggerDirectCall(uid, chat_id, selectedTime, params[1]);

        redistributeViaNode({time: selectedTime}, 'callback-scheduled');

				// Show the thanks message
				//displayPhoneThanks();

			});

		}

		function displayPhoneThanks(time, isNow) {
            console.log("DISPLAYING THANKS FOR TIME: " + time);
			if ( time == 'none') {
				if(typeof(isNow) === "undefined") {
					var thanksContent = "We are calling you now.";
				} else {
					var thanksContent = "We will call you as soon as possible.";
				}
			} else {
				var thanksContent = "Thank you. Your call is now scheduled.";
			}
			$srJq('#srMsgs .srEndChat.phone:last').html(thanksContent).show();
			recordAutoMsg("Thank you. Your call is now scheduled.", 'srEndChat phone', 1);
			scrollChat();
		}

		// Set up the listenner on the callback time form
		function srSetupCallBackFormListenner (day_date) {
			// Trigger a listener for form submission
			$srJq('#srSpecifyTimeBtn').on('click', function(e){

				e.preventDefault();

				// Get the time that they have selected
				var selectedTime = $srJq('#srSelectTime').val();

				if(typeof day_date !== 'undefined' && day_date != false) {
					selectedTime = day_date + " " + selectedTime + ':00';
				} else {
					selectedTime = "2019-12-31 " + selectedTime + ':00';
				}

				// Get the callback ID and trigger / store them somewhere
				// Get the parameters
				var paramsSet = $srJq(this).attr('name');
				paramsSet = paramsSet.split(' ');

				// Get the user ID
				var uid = getUsrId();
				var chat_ref = getChatId();

				// Store the callback time to the database asynchronously
				$srJq.ajax({
					url: "//app.meetami.ai/chats/update_cb_time/" + paramsSet[0] + "/" + uid + "/" + chat_ref,
					type: "POST",
					data: {cb_time: selectedTime},
					success: function(data) {
						// No need to do anything on success as this runs asynchronously
                        redistributeViaNode({time: selectedTime}, 'callback-scheduled');
						if (data == 'BY') {
							// Because it is a BY triggering create the live room
							var chat_id = getChatId();
							switchLive(chat_id, 'T');
							triggerDP(true, false);
						}
					}
				});

				// Trigger the call asynchronously (with the time set in the request)
				srCbRequest(paramsSet[0], paramsSet[1], selectedTime);

				// Show the thanks message
				var thanksContent = "Thank you. Your call is now scheduled.";
				$srJq('#srMsgs .srEndChat.phone:last').html(thanksContent).show();
				recordAutoMsg("Thank you. Your call is now scheduled.", 'srEndChat phone', 1);
				scrollChat();

			});
		}


		

		// Action to track actions for the SR stats
		function trackAction(trigger, action){

			var user_ref = getUsrId();

			$srJq.ajax({
				url: "//app.meetami.ai/chats/track_action/168019131601/" + user_ref + '/' + trigger + '/' + action,
				type: "GET",
				success: function(data) {
					// No need to do anything
				}
			});

		}

		// TODO - call this new function when we display a green message
		// - also check which greenies already get stored / displayed
		function recordAutoMsg (msg, msgClass, isUpdate, sender, form) {

			// Get the user and chat refs
			var user_ref = getUsrId();
			var chat_ref = $srJq('#chat_ref').val();

			if (typeof chat_ref == 'undefined' || chat_ref == '') {
				return false;
			}

			if (typeof isUpdate == 'undefined' || isUpdate == '') {
				isUpdate = 0;
			}

			if (typeof sender == 'undefined') {
				sender = '';
			}
			if (typeof form == 'undefined') {
				form = '';
			}
console.log(form);
			// Run the AJAX query to save the data
			$srJq.ajax({
				url: "//app.meetami.ai/chats/record_auto_msg/168019131601/",
				type: "POST",
				data: { user_ref: user_ref, chat_ref: chat_ref, msg: msg, msg_class: msgClass, is_update: isUpdate, sender_name: sender, form: form },
				success: function(data) {
					// No need to do anything
				}
			});

		}

		function srOpenTab(url) {
			// Create link in memory
			var a = window.document.createElement("a");
			a.target = '_blank';
			a.href = url;

			// Dispatch fake click
			var e = window.document.createEvent("MouseEvents");
			e.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			a.dispatchEvent(e);
		};

		function oldSiteHack(){
			// A hack to handle the responsive elements for older (non-responsive sites)
			var viewportVal = $srJq('meta[name=viewport]').attr('content');
			if(typeof viewportVal == 'undefined' || viewportVal.indexOf('device-width') === false){

				var winWidth = getScreenWidth();
				if(winWidth < 720){
					$srJq('.mobOnly').css('display', 'block');
					$srJq('.mobHide').css('display', 'none');
					$srJq('#srContent').attr('class', 'mobHack');
					$srJq('.srCallBtn').attr('class', 'srCallBtn mobHack').css('display', 'block');
					imgToTxtHeader(1,1);
				} else {
					$srJq('.mobOnly').css('display', 'none');
					$srJq('.mobHide').css('display', 'block');
					$srJq('.mobHide.il').css('display', 'inline');
					$srJq('#srContent').attr('class', '');
					$srJq('.srCallBtn').attr('class', 'srCallBtn').css('display', 'none');
				}

			}
		}

		function timeOnSite(){
			// Get the current session cookie
			var srLoggedOn = $srJq.cookie('sr-cur');

			if(typeof srLoggedOn != 'undefined'){
				// If exists calculate how long on site
				srLoggedOn = Date.parse(srLoggedOn);
				var srNow = new Date();
				srNow = Date.parse(srNow);

				return (srNow - srLoggedOn) / 1000;
			} else {
				// If not then the time is zero (i.e. just joined)
				return 0;
			}
		}

		function getAgentName(){

			if($srJq('#srMsgs p.agent span:not(.avatar-mini)').length > 0){
				var name = $srJq('#srMsgs p.agent span:not(.avatar-mini)').html();
				name = name.replace(':', '');
			} else {
				name = '';
			}

			return name;
		}

		// Function to specifically perform a loose validation on phone numbers
		function validatePhone (phone_no) {

			// Does it contain just numbers
			// If not are the additional characters just spaces, plusses, brackets or other commonly used phone number elements
//			var regEx = new RegExp("/[0-9] +-()/");
			regEx = new RegExp("^[0-9-+ ]{0,20}$");
			if(!regEx.test(phone_no)){
				// If not is a it a DDI or Ext included
				phone_no = phone_no.toLowerCase();
				if(phone_no.indexOf('ex') > -1 || phone_no.indexOf('dd') > -1){
					return true;
				} else {
					return 'Please enter only numbers';
				}
			} else {
				// Check it is at least 10 characters
				if(phone_no.length > 9 || phone_no.length == 0){
					return true;
				} else {
					if (phone_no.length == 0) {
						return "Please enter your phone number";
					} else {
						return "Sorry but your phone number is too short";
					}
				}
			}
		}

		function isIpad () {
			// For use within normal web clients
			var isiPad = navigator.userAgent.match(/iPad/i) != null;
			return isiPad;
		}

		function sendGaEvent (sendVar, eventVar, nameVar, detailVar) {
							if (typeof ga != 'undefined') {
					ga(sendVar, eventVar, nameVar, detailVar);
				}
					}

		function appendToFormData(formData, obj) {
			formData = JSON.parse(formData);
			formData.push(obj);
			formData = JSON.stringify(formData);
			return formData;
		}

				function scrollChat(delay_me){
  console.log("scrollchat called..");
  // Do a quick cursory check of the avatars to check we aren't showing any defaults that shouldn't be there
  // Loop through once to set up an object containing the images for each agent in the chat
  var agent_images = {};
  $srJq('#srMsgs p').each(function(){
    var an_image = $srJq(this).children('span.avatar-mini').html();
    var aname = $srJq(this).children('span:not([class])').html();
    if ( typeof aname != 'undefined' && typeof agent_images[aname] == 'undefined' && typeof an_image != 'undefined' ){
      aname = aname.replace(';', '');
      agent_images[aname] = an_image;
    }

    // Finally check whether the images are actually in place
    var currStatus = $srJq(this).attr('class');
    if ( typeof currStatus != 'undefined' && currStatus.indexOf('inc-avatar') == -1 && typeof agent_images[aname] != 'undefined' && typeof an_image != 'undefined' ) {
      $srJq(this).addClass('inc-avatar').prepend('<span class="avatar-mini">' + an_image + '</span>');
    }
  });

  // Check for nav bars on mobile + hide them
  var winWidth = getScreenWidth();
  if(winWidth < 720){
    setTimeout(function(){
      // Hide the address bar!
      window.scrollTo(0, 1);
    }, 0);
  }

  // Handle the message height
  msgHeight(250, function(rslt){

    // Handle the scroll
    if(typeof delay_me == 'undefined'){
      $srJq("#srMsgs").each( function() {
        // Fix for browsers that have a bug such that scrollHeight is too small
        // when content does not fill the client area of the element
        var scrollHeight = Math.max(this.scrollHeight, this.clientHeight);
        var sTVal = scrollHeight - this.clientHeight;
				// $srJq(this).animate({ scrollTop: sTVal }, 500); // TODO - get this scrolling
				this.scrollTop = sTVal;
				// console.log("Non delayed scroll: " + sTVal);
				srPositionFeedback();
      });
    } else {
      setTimeout(function () {
        $srJq("#srMsgs").each( function() {
          // Fix for browsers that have a bug such that scrollHeight is too small
          // when content does not fill the client area of the element
          var scrollHeight = Math.max(this.scrollHeight, this.clientHeight);
					var sTVal = scrollHeight - this.clientHeight;
					// $srJq(this).animate({ scrollTop: sTVal }, 500); // TODO - get this scrolling
					// console.log("Delayed scroll: " + sTVal);
					this.scrollTop = sTVal;
					srPositionFeedback();
        });
      }, delay_me);
    }

  });
}

// Manual function to handle screen size
// Combines window width with screen.width to find the smaller of the two
function getScreenWidth(){
  // Get the two widths
  var screenSize = screen.width;
  var windowSize = $srJq(window).width();

  // Decide which one to return
  var winWidth = screenSize;
  if(screenSize > windowSize){
    winWidth = windowSize;
  }

  return winWidth;
}

// Reposition the feedback button depending upon the settings for this client
function srPositionFeedback () {
			// Only implement these tweaks for mobile layouts and large format widget
		var scrnWidth = getScreenWidth();
		if (scrnWidth < 720) {
				if($srJq('.feedback-prechat-container').length){
				// Handle the position of the feedback item for forms / not forms
				if($srJq('#srChatForm').length) {
					var formHeight = $srJq('#srContent #srChatForm').height() + 5;
					$srJq('#srContent .feedback-prechat-container').css('bottom', formHeight);
				} else {
					$srJq('#srContent .feedback-prechat-container').css('bottom', 95);
				}
			}
			}
	}

// Utility function to handle the calculation of the permitted height of the
// chat area within the widget
function msgHeight (delay, callback) {

  if (typeof delay =='undefined'){
    delay = 50;
  }
  setTimeout(function(){
    // Get the height of srContent
    var screenWdth = getScreenWidth();
    var areaHeight = $srJq('#srContent').height();

    
			var scrnHeight = $srJq(window).height();

      if ( (areaHeight > 560 || scrnHeight > 860) && screenWdth > 720 ) {
        areaHeight = 560;
      }
        // console.log('Initial ' + areaHeight);
    // Get the height of the bits at the top + bottom (header, form, input etc)
    // + use them to calculate the remainder for the Msgs area
    areaHeight -= $srJq('#srContent #srHeader').height();
    //console.log('Header ' + areaHeight);
    if($srJq('#srContent #footerLnk').length){
      areaHeight -= ($srJq('#srContent #footerLnk').height() + 15);
      console.log('Footer 1 ' + areaHeight);
    }
    if($srJq('#srContent .footerLnk').length){
      areaHeight -= ($srJq('#srContent .footerLnk').height() + 15);
      console.log('Footer 2 ' + areaHeight);
    }
    if($srJq('#srChatForm').length){
      areaHeight -= ($srJq('#srContent #srChatForm').height() + 15);
      console.log('chatForm ' + areaHeight);
			// Check for an absolute bottom to the form
			var formBtm = $srJq("#srContent #srChatForm").css('bottom');
			if (!$srJq('#srContent .footerLnk').length && !$srJq('#srContent #footerLnk').length && typeof formBtm != 'undefined' && formBtm != "") {
				formBtm = Number(formBtm.replace('px', ''));
				if (!isNaN(formBtm)) {
					areaHeight -= formBtm;
					alert("added extra: " + formBtm);
				}
			}
    }
    if($srJq('.feedback-prechat-container').length){
      console.log('feedkack before ' + areaHeight);
      areaHeight -= ($srJq('#srContent .feedback-prechat-container').height());
      // console.log('feedback ' + $srJq('#srContent .feedback-prechat-container').height());
      console.log('feedkack after ' + areaHeight);
    }
    // Check if we are on mobile - if so drop a bit more off as well
    // if ( screenWdth < 720 ) {
    //   areaHeight += 40;
    // }
    console.log('Final ' + areaHeight);

    // Set srMsgs height appropriately
		$srJq('#srContent #srMsgs').css('max-height', areaHeight);
    // $srJq('#srContent #srMsgs').animate({ maxHeight: areaHeight }, 500);
    if($srJq('#srContent #srMsgs').hasScrollBar()) {
      $srJq(".feedback-upper-container").addClass("scrollbar-visible");
      // console.log("SCROLLBAR VISIBLE!");
    }
    callback(true);
  }, delay);
}

// Handle the swipe to minimise on the widget
$srJq(function(){
  bindMobileSwipe();
});
function bindMobileSwipe() {
  // Only use the swiping on mobile (not desktop)
  // if(isMobileUx) {
  //   // Figure out the containment for the swipe action
  //   // Top of the widget is:
  //   var totalScrnHeight = $srJq(window).innerHeight();
  //   var widgetHeight = $srJq("#srContent").height()
  //   var topPosn = totalScrnHeight - widgetHeight;
  //   // Check whether the chat is currently open
  //   if (!$srJq('#srContent').hasClass('mobileMin')) {
  //     $srJq("#srContent").draggable({
  //       axis: "y",
  //       handle: "#srHeader",
  //       containment: [
  //         0,
  //         topPosn,
  //         $srJq(window).width(),
  //         totalScrnHeight - 41
  //       ],
  //       stop: function(event, ui) {
  //         console.log(topPosn);
  //         console.log(ui.offset.top);
  //         if (topPosn + 25 < ui.offset.top) {
  //           // Work out the current bottom position + set it (clearing the current top and left values)
  //           var movement = topPosn - ui.offset.top;
  //           $srJq('#srContent').css({ left:'', top:'', bottom: movement + "px" });
  //           // Minimise the widget now (only call after above element - otherwise the top position will block the minimisation)
  //           minToggle();
  //         }
  //       }
  //     });
	//
  //   }
	//
  // }
}
		// Rudimentary state tracking
var funnelStatus = {
	qFieldType: false,
	qFieldSelector: false,
	options: {},
	frameReady: false,
	groupCompletion: {},
	curGroup: 0,
	closed: false
}

// Handle the skipping funnels (create the appropriate iFrames etc)
function srCreateSkipper ( chatData, isEntry ) {

	$srJq("#srMsgSender").prop("disabled", true).addClass("srLoadingFakeMsgSender");

	if (typeof isEntry == 'undefined') {
		isEntry = false;
	}

	// Get the chat ref
	var chatRef = getChatId();
	console.log('GETTING FRAME: ' + chatRef);

	// Make an AJAX request ot get details of the iFrame to be included
	$srJq.ajax({
		url: "https://app.meetami.ai/search_funnels/frame/168019131601/" + chatRef,
		type: "GET",
		success: function(pageData) {
			// Now that we have the iFrame details load it up
			$srJq('#srInputs').append(pageData);
			$srJq("#hiddenFrame").removeClass("srInvisibleFrame");
			$srJq("#srMsgSender").removeClass("srNormalMsgSender");
			// Set the existing funnel status
			if (typeof chatData != 'undefined' && typeof chatData.LastMsgSff != 'undefined') {
				var curFieldType = funnelStatus.qFieldType = chatData.LastMsgSff.field_type;
				var curFieldSelector = funnelStatus.qFieldSelector = chatData.LastMsgSff.element_selector;
			} else if ( isEntry && typeof chatData != 'undefined' && typeof chatData.selector != 'undefined' ) {
				// If this is the initial entry to the form then check what the first
				var curFieldType = chatData.field_type;
				var curFieldSelector = chatData.selector;
			}

			// Populate existing fields
			srPopulateExisting();
			funnelStatus.closed = false;

			// If the last message is a radio or select menu field then get a list of options
			if ( typeof curFieldType != 'undefined' && typeof curFieldSelector != 'undefined' && (curFieldType == 'select' || curFieldType == 'radio-group') ) {
				setTimeout(function(){
					if (curFieldType == 'radio-group') {
						srRetrieveRadioOptions( curFieldSelector );
					} else if (curFieldType == 'select') {
						srRetrieveSelectOptions( curFieldSelector );
					}
				}, 4500);
			}

			// Set a cookie to track the fact that we are in a search frame
			$srJq.cookie('sr-inSe', 1, { path: '/', domain: domain });

		}
	});

}

// Set the iFrame to  variable for reference later on.
function srCheckSearchEntry (response) {

	// Check for a funnel entry
	if (typeof response.virtual_msg_type != 'undefined' && response.virtual_msg_type == 'SearchFunnel' && $srJq('#hiddenFrame').length <= 0) {
		srCreateSkipper(response, true);
	}

	// Check for required population
	if (typeof response.populatePrevious != 'undefined') {
		srPopulateField(response.populatePrevious);
	}

	// If it is a click then handle it
	if (typeof response.action != 'undefined' && response.action.indexOf('click') > -1) {
		srClickBtn(response);
	}

	// Update the scope (if required)
	if (typeof response.field_type != 'undefined')
		funnelStatus.qFieldType = response.field_type;
	if (typeof response.selector != 'undefined')
		funnelStatus.qFieldSelector = response.selector;

	// If the funnel status field type os select or radio then get the options
	// We have to do it now as window.postMessage is asynchronous
	if ( funnelStatus.qFieldType == 'select' ) {
		srRetrieveSelectOptions( funnelStatus.qFieldSelector );
	} else if ( funnelStatus.qFieldType == 'radio-group' ) {
		srRetrieveRadioOptions( funnelStatus.qFieldSelector );
	}

	// Finally (it's not really entry but) check for exit from the funnel
	if (typeof response.ending != 'undefined' && response.ending == 'clear-search') {
		// srClearFrame();
		setTimeout(function() {
			$srJq('#hiddenFrame').hide();
			$srJq('#srInputs').removeClass('srForceFrameUserInput');
			$srJq('#srMsgSender').show().prop("disabled", false).focus();
		}, 1000);
	}
}

// Message the iFrame window
// To do things like populating the form
function srMsgIFrame ( action, element, elementType, msg ) {

	// Assemble the JSON object to be sent
	var msgObj = {
		action: action,
		element: element,
		elementType: elementType
	}
	if (typeof msg != 'undefined') msgObj.msg = msg;

	// Trigger the message to the child window
	var frame = document.getElementById('hiddenFrameIFrame');
	if (frame != null && typeof frame.contentWindow != 'undefined') {
		frame.contentWindow.postMessage(msgObj, '*');
	} else {
		setTimeout(function(){
			frame = document.getElementById('hiddenFrameIFrame');
			frame.contentWindow.postMessage(msgObj, '*');
		}, 1200);
	}

}

// Handle the button click
function srClickBtn (response, isLocal, delay) {

	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}
	if (typeof delay == 'undefined') delay = 0;
console.log("CLICKING NOW");

	if (isLocal) {
		srRevertToNormalMsgSender();
		$srJq(response.selector).prop('disabled', false).click();
		console.log("CLICKING LOCAL");
	} else {
		console.log("CLICKING NONLOCAL");
		console.log(response);
		// Is this a parent click or not?
		// Then click the button
		// var hiddenFrame = $srJq('#hiddenFrame iframe');
		if ( response.action == 'click-parent' ) {
	// TODO - Do something that handles this in the parent window
			// In form?
			var isInForm = 1; //$srJq(response.selector, hiddenFrame.contents()).closest('form').length;
			if (isInForm == 1) {
				// $srJq(response.selector, hiddenFrame.contents()).closest('form').attr('target', '_parent');
				// $srJq(response.selector, hiddenFrame.contents()).prop('disabled', false).click();
				// srMsgIFrame('click', response.selector, 'button-parent');
				setTimeout(function(){
					if (!srShouldClick) {
						setTimeout(function(){
							srClickBtn(response, isLocal, 0);
						}, 1500);
					} else if (!srShouldClear()) {
						srRevertToNormalMsgSender();
						srMsgIFrame('click', response.selector, 'button-parent');
						funnelStatus.frameReady = false;
						funnelStatus.curGroup++;
					}
				}, 500 + delay);
			} else {
				// We are not in a form so switch pages to the form page, populate the form and submit it
				// Drop a cookie and redirect to the form page
				$srJq.cookie('sr-sea-rdr', JSON.stringify({ formUrl: response.formUrl, funnel: response.searchFunnel }), { path: '/', domain: domain });
				window.location = response.formUrl;
			}
		} else {
			setTimeout(function(){
				if (!srShouldClick) {
					setTimeout(function(){
						srClickBtn(response, isLocal, 0);
					}, 1500);
				} else if (!srShouldClear()) {
					srRevertToNormalMsgSender();
					srMsgIFrame('click', response.selector, 'button');
					funnelStatus.frameReady = false;
					funnelStatus.curGroup++;
				}
			}, 500 + delay);
		}
	}
}

function srRevertToNormalMsgSender() {
	$srJq("#hiddenFrame").addClass("srInvisibleFrame");
	$srJq("#srMsgSender").addClass("srNormalMsgSender").prop("disabled", true).blur();
	$srJq.cookie('sr-sea-rdr', 0, { path: '/', domain: domain });
	var msgSenderInterval = setInterval(function() {
		$srJq("#srMsgSender").prop("disabled", true);
	}, 10);
	setTimeout(function() {
		clearInterval(msgSenderInterval);
	}, 2000);
}

function srShouldClick (group) {
	if (funnelStatus.closed === true) {
		return true;
	}
	if (funnelStatus.frameReady !== true) {
		return false;
	}
	if (typeof response.group == 'undefined') {
		return true;
	}
	if (funnelStatus.curGroup != response.group ){
		return false;
	}
	if ( funnelStatus.groupCompletion[response.group].fieldsPopulated < funnelStatus.groupCompletion[response.group].fieldNo) {
		return false;
	}

	return true;
}

function srSearchReinput(chat_ref, searchCookie, callback) {

	if (typeof searchCookie == 'undefined') {
		// Get the details of the form population and redirect that need to be completed
		console.log('NO SEARCH COOKIE');
		callback(true);
		return;
	}
	searchCookie = JSON.parse(searchCookie);
	if (typeof searchCookie.formUrl == 'undefined' || searchCookie.formUrl != window.location.href) {
		console.log('SEARCH COOKIE: wrong URL');
		console.log(window.location.href);
		callback(true);
		return;
	}

	// We have the search cookie so run the AJAX request to get details of what form we are supposed to be populating
	// And with what data
	$srJq.ajax({
		url: "https://app.meetami.ai/search_funnels/get_details/168019131601/" + chat_ref + '/' + searchCookie.funnel,
		type: "GET",
		success: function(data) {
			console.log("RE DATA");
			// Now that we have the iFrame details load it up
			if (data != 'error') {

				data = JSON.parse(data);
				console.log('REPOPULATING');
				console.log(data);
				for (var i in data.fields) {
					srPopulateField(data.fields[i], true);
				}
			}
			// Click the button
			srClickBtn(data.button, true);

			// Delete the cookie
			$srJq.removeCookie('sr-sea-rdr', { path: '/', domain: domain });

			callback(false);
			return;
		},
		error: function () {
			callback(true);
			return;
		}
	});

	callback(false);
}

function srPopulateField (details, isLocal, delay) {

	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}
	if (typeof delay == 'undefined') {
		delay = 0;
	}
  // Distribute out the request to different types of populator
  if (details.field_type == 'text' || details.field_type == 'textarea' || details.field_type == 'email' || details.field_type == 'tel') {
    srPopulateText(details.selector, details.value);
  } else {
		switch (details.field_type) {
			case "select-one":
				srPopulateSelect( details.selector, details.value, isLocal, delay );
				break;
			case "radio-group":
				srPopulateRadioGroup( details.selector, details.value, isLocal, delay );
				break;
			case "checkbox":
				srPopulateCheckbox( details.selector, details.value, isLocal, delay );
				break;
      case "autocomplete":
        srPopulateText(details.selector, details.value, isLocal, delay);
  			// srPopulateAutocomplete( details.selector, details.value, details );
  			break;
			default:
				srPopulateText(details.selector, details.value, isLocal, delay);
				break
		}
	}
}

// Populate a straight text or textarea field
function srPopulateText ( selector, value, isLocal, delay, group ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}

	if (typeof delay == 'undefined') delay = 0;
	setTimeout(function(){
		if (isLocal) {
			$srJq(selector).val(value);
		} else {
			if (!srShouldPopulate(group)) {
				setTimeout(function(){
					srPopulateText( selector, value, isLocal, 0 );
				}, 1500);
			} else if (!srShouldClear()) {
				srMsgIFrame("populate", selector, "text", value);
				srTrackPopulation ( group );
			}
		}
	}, delay);
}

// Populate Checkbox
function srPopulateCheckbox ( selector, isChecked, isLocal, delay, group ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}

	if (typeof delay == 'undefined') delay = 0;
	setTimeout(function(){
		if (isLocal) {
			$srJq(selector).prop('checked', isChecked);
		} else {
			if (!srShouldPopulate(group)) {
				setTimeout(function(){
					srPopulateCheckbox ( selector, isChecked, isLocal, 0 );
				}, 1500);
			} else if (!srShouldClear()) {
				srMsgIFrame("populate", selector, "checkbox", isChecked );
				srTrackPopulation ( group );
			}
		}
	}, delay);
}

// Populate a radio group
function srPopulateRadioGroup ( selector, value, isLocal, delay, group ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}

	if (typeof delay == 'undefined') delay = 0;

	setTimeout(function(){
		if (isLocal) {
			$srJq(selector + ' input[type=radio]').each(function(){
				if ($srJq(this).val() == value) {
					$srJq(this).prop('checked', true);
				} else {
					$srJq(this).prop('checked', false);
				}
			});
		} else {
			if (!srShouldPopulate(group)) {
				setTimeout(function(){
					srPopulateRadioGroup ( selector, value, isLocal, 0, group );
				}, 1500);
			} else if (!srShouldClear()) {
				srMsgIFrame("populate", selector, "radio", value );
				srTrackPopulation ( group );
			}
		}
	}, delay);
}

// Get a list of the values available to a radio group
function srGetRadioOptions ( selector, isLocal ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}
	if (isLocal) {
		var optList = {};
		$srJq(selector + ' input[type=radio]').each(function(){
			var thisId = $srJq(this).attr('id');
			if (typeof thisId != 'undefined' && $srJq( selector + ' label[for=' + thisId + ']').length > 0) {
				optList[$srJq(this).val()] = $srJq( selector + ' label[for=' + thisId + ']').html();
			} else {
				optList[$srJq(this).val()] = $srJq(this).val();
			}
		});
	} else {
		return (typeof funnelStatus.options[selector] != 'undefined') ? funnelStatus.options[selector] : {};
	}
	return optList;
}

// Get select options from remote iFrame
function srRetrieveRadioOptions ( selector, incrementer ) {
	// Issue a message to trigger the retrieval of data
	srMsgIFrame("retrieve", selector, "radio" );
	// Set the values as pending status + trigger retesting
	setTimeout(function(){
		incrementer = (typeof incrementer == 'undefined') ? 1 : incrementer++;
		if (incrementer < 10 && (typeof funnelStatus.options[selector] == 'undefined' || funnelStatus.options[selector] == 'pending')) {
			srRetrieveRadioOptions ( selector, incrementer );
		}
	}, 1500);
}

function srProcessRadioOptions ( selector, rData ) {
	if (rData != 'missing') {
		funnelStatus.options[selector] = rData;
	}
}

// Populate select menus
function srPopulateSelect ( selector, value, isLocal, delay, group ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}

	if (typeof delay == 'undefined') delay = 0;
	setTimeout(function(){
		if (isLocal) {
			$srJq(selector + ' option').each(function(){
				if ($srJq(this).val() == value) {
					$srJq(this).prop('selected', true);
				} else {
					$srJq(this).prop('selected', false);
				}
			});
		} else {
			if (!srShouldPopulate(group)) {
				setTimeout(function(){
					srPopulateSelect ( selector, value, isLocal, delay, group );
				}, 1500);
			} else if (!srShouldClear()) {
				srMsgIFrame("populate", selector, "select", value );
				srTrackPopulation ( group );
			}
		}
	}, delay);
}

function srTrackPopulation ( group ) {
	if (typeof funnelStatus.groupCompletion[group] != 'undefined') {
		funnelStatus.groupCompletion[group].fieldsPopulated++;
	}
}

function srShouldPopulate ( group ) {
	if (funnelStatus.closed === true) {
		return true;
	}
	if (funnelStatus.frameReady !== true) {
		return false;
	}
	if (typeof group == 'undefined') {
		return true;
	}
	if (group != funnelStatus.curGroup) {
		return false;
	}
	return true;
}

function srShouldClear () {
	if (funnelStatus.closed) {
		return true;
	}
	return false;
}

// Get the possible options from a select list
function srGetSelectOptions ( selector, isLocal ) {
	if (typeof isLocal == 'undefined') {
		isLocal = false;
	}
	if (isLocal) {
		var optList = {};
		$srJq(selector + ' option').each(function(){
			optList[$srJq(this).val()] = $srJq(this).html();
		});
	} else {
		var optList = (typeof funnelStatus.options[selector] != 'undefined' && funnelStatus.options[selector] != 'pending') ? funnelStatus.options[selector] : {};
	}
	return optList;
}

// Get select options from remote iFrame
function srRetrieveSelectOptions ( selector, incrementer ) {
	// Issue a message to trigger the retrieval of data
	srMsgIFrame("retrieve", selector, "select" );
	// Set the values as pending status + trigger retesting
	funnelStatus.options[selector] = 'pending';
	setTimeout(function(){
		incrementer = (typeof incrementer == 'undefined') ? 1 : incrementer++;
		if (incrementer < 10 && (typeof funnelStatus.options[selector] == 'undefined' || funnelStatus.options[selector] == 'pending')) {
			srRetrieveSelectOptions ( selector, incrementer );
		}
	}, 1500);
}

function srProcessSelectOptions ( selector, rData ) {
	if (rData != 'missing') {
		funnelStatus.options[selector] = rData;
	}
}

// Use a message to find out which option has been selected
function srCompareToOptions ( selector, fieldType, msgStr, isLocal ) {

	// Get the options
	switch (fieldType) {
		case "select":
			var optList = srGetSelectOptions(selector, isLocal);
			break;
		case "select-one":
			var optList = srGetSelectOptions(selector, isLocal);
			break;
		case "radio-group":
			var optList = srGetRadioOptions(selector, isLocal);
			break;
		default:
			var optList = srGetSelectOptions(selector, isLocal);
			break;
	}
	msgStr = msgStr.toLowerCase();
	// console.log('OPTLIST');
	// console.log(optList);
	// console.log(msgStr);
	// Loop through the options (are any included in the msgStr)
	// Exact string match
	for (var i in optList) {
		// If we have a successful in finding an option then return it
		optList[i] = optList[i].toLowerCase();
		if (msgStr.indexOf(optList[i]) > -1 && optList[i].length > 10) {
			return i;
		}
	}

	// If we don't have a result then do it word by word to see what we can match
	var wordMatches = [];
	var msgArr = msgStr.split(' ');
	for (var i in optList) {
		var words = optList[i].split(' ');
		var matches = 0;
		for ( var j in words ) {
			if (msgArr.indexOf(words[j]) > -1) {
				// Score of 2 for an exact match
				matches++;
				matches++;
			} else if (msgStr.indexOf(words[j]) > -1 && words[j].length > 2) {
				// Partial words only score one
				matches++;
			}

		}
		wordMatches.push({ optVal: i, matches: matches });
	}

	if (wordMatches.length > 0) {
		wordMatches.sort(function(a,b){
			return a['matches'] - b['matches'];
		});
		var lastWord = wordMatches.pop();
		if (lastWord.matches > 1) {
			return lastWord.optVal;
		}
	}

	// Handle incorrect spellings (e.g. Dubia)
	var nearMatches = [];
	var nearMatch = false;
	for (var i in optList) {
		var words = optList[i].split(' ');
		var matches = 0;
		for ( var j in words ) {
			// Still do a check for exact matches
			if (msgArr.indexOf(words[j]) > -1) {
				matches++;
			} else {
				// Check for not real matches
				nearMatch = srCloseSpellings(words[j], msgStr);
				if (nearMatch != false) {
					matches++;
				}
			}
		}
		nearMatches.push({ optVal: i, matches: matches });
	}
	if (nearMatches.length > 0) {
		nearMatches.sort(function(a,b){
			return a['matches'] - b['matches'];
		});
		var lastNearWord = nearMatches.pop();
		if (lastNearWord.matches > 0) {
			return lastNearWord.optVal;
		}
	}

	return false;

}

// Simple function to check for words that could've been created by basic spelling errors
function srCloseSpellings (word, msgStr) {

	var lettersList = "abcdefghijklmnopqrstuvwxyz".split("");

	// Figure out the potential options
	// Options created by missed letters
	var rslts = [];
	for (i=0; i < word.length; i++) {
    console.log(word);
    console.log(typeof word);
    if (typeof word != 'undefined' && typeof word != 'function' && word != "") {
    	var opt = word.slice(0, i) + word.slice(i+1);
  		if (msgStr.indexOf(opt) > -1 && opt.length > 2) {
  			return opt;
  		}
    }
	}

	// Options created by transpositions
	var rslts = [];
	for (i=0; i < word.length-1; i++) {
    if (typeof word != 'undefined' && typeof word != 'function' && word != "") {
    	var opt = word.slice(0, i) + word.slice(i+1, i+2) + word.slice(i, i+1) + word.slice(i+2);
  		if (msgStr.indexOf(opt) > -1 && opt.length > 2) {
  			return opt;
  		}
    }
	}

	// Options created by alterations
	var rslts = [];
	for (i=0; i < word.length; i++) {
		for( var j in lettersList) {
      if (typeof word != 'undefined' && typeof word != 'function' && word != "") {
  			var opt = word.slice(0, i) + lettersList[j] + word.slice(i+1);
  			if (msgStr.indexOf(opt) > -1 && opt.length > 2) {
  				return opt;
  			}
      }
		}
	}

	// Options created by insertion of an additional letter
	var rslts = [];
	for (i=0; i <= word.length; i++) {
		for ( var j in lettersList ) {
      if (typeof word != 'undefined' && typeof word != 'function' && word != "") {
  			var opt = word.slice(0, i) + lettersList[j] + word.slice(i);
  			if (msgStr.indexOf(opt) > -1 && opt.length > 2) {
  				return opt;
  			}
      }
		}
	}

	// If nothing is found then return a negative result
	return false;
}

// Populate the form with existing details
function srPopulateExisting () {
	$srJq("#hiddenFrame").removeClass("srInvisibleFrame");
	$srJq("#srMsgSender").removeClass("srNormalMsgSender");
	setTimeout(function(){
		// Get the details of existing fields
		var detailsArr = $srJq('#hiddenFrameField').val();
		var details = JSON.parse(detailsArr);

		// Loop through the existing details and populate into the field
		var detailTO = 1; // Standard gap between elements is v short (increase for future groups)
		for (var i in details) {

			// Figure out how long to delay for... may no longer be necessary
			detailTO = details[i].group * 500 + 1;
			// Track what has / hasn't been clicked
			if (typeof funnelStatus.groupCompletion[details[i].group] == 'undefined' && details[i].field_type != 'button' && details[i].field_type != 'submit') {
				funnelStatus.groupCompletion[details[i].group] = {
					fieldNo: 1,
					fieldsPopulated: 0,
					btnClicked: false
				};
			} else if (typeof funnelStatus.groupCompletion[details[i].group] != 'undefined' && details[i].field_type != 'button' && details[i].field_type != 'submit') {
				funnelStatus.groupCompletion[details[i].group].fieldNo++;
			}

			// Trigger the population of the fields
			switch (details[i].field_type) {
				case "select":
					srPopulateSelect( details[i].selector, details[i].value, false, detailTO, details[i].group );
					break;
				case "radio-group":
					console.log(details[i]);
					srPopulateRadioGroup( details[i].selector, details[i].value, false, detailTO, details[i].group );
					break;
				case "checkbox":
					srPopulateCheckbox( details[i].selector, details[i].value, false, detailTO, details[i].group );
					break;
				case "button":
					var btnDetail = details[i];
					if (btnDetail.action == 'click') srClickBtn(btnDetail, false, detailTO);
					break;
				case "submit":
					var btnDetail = details[i];
					if (btnDetail.action == 'click') srClickBtn(btnDetail, false, detailTO);
					break;
				default:
					srPopulateField(details[i], false, detailTO, details[i].group);
					break;
			}

		}
	}, 2500);
}

// Check whether this chat is in a search funnel
function srInSearchFunnel() {
	// Does the funnel field exist?
	if ($srJq('#hiddenFrameId').length > 0) {
		return true;
	}
}

// Check for a select value in the message submission
function srCheckSearchFunnelValue (msg) {

	// Get the current question type and selector
	if (funnelStatus.qFieldType === false || funnelStatus.qFieldSelector === false) {
		return false;
	}

	// Check to see whether an option has been submitted
	var selected = false;
	switch (funnelStatus.qFieldType) {
		case "select":
			selected = srCompareToOptions(funnelStatus.qFieldSelector, funnelStatus.qFieldType, msg);
			srPopulateSelect( funnelStatus.qFieldSelector, selected );
			break;
		case "select-one":
			selected = srCompareToOptions(funnelStatus.qFieldSelector, funnelStatus.qFieldType, msg);
			srPopulateSelect( funnelStatus.qFieldSelector, selected );
			break;
		case "radio-group":
			selected = srCompareToOptions(funnelStatus.qFieldSelector, funnelStatus.qFieldType, msg);
			srPopulateRadioGroup( funnelStatus.qFieldSelector, selected );
			break;
		default:
			return false;
			break;
	}

	return selected;

}

// Clear away the frame + end the funnel
function srClearFrame () {

	// Remove the frame
	$srJq('#hiddenFrame').remove();

	// Reset the funnel status
	funnelStatus = {
		qFieldType: false,
		qFieldSelector: false,
		options: {},
		frameReady: false,
		groupCompletion: {},
		curGroup: 0,
		closed: true
	}

	return;
}

var current = false;
function handleBodyResize() {
	var bodyWidth = $srJq(window).outerWidth();
	if(bodyWidth > 720 && (current == false || current == 'mobile')) {
		srMsgIFrame('isDesktop');
		current = 'desktop';
	} else if(bodyWidth <= 720 && (current == false || current == 'desktop')) {
		srMsgIFrame('isMobile');
		current = 'mobile';
	}
}

$srJq(function() {
	$srJq(window).resize(function() {
		handleBodyResize();
	});
	// $srJq(window).trigger("resize");
});


/******************** TESTING FUNCTIONS *************************/

// TODO
// 6 - Different options for clicking the button
		// - Handle the presence or absence of a form
		// - Handle the blocking popups addon
		// Is there any hope it may just work with subdomains?! Probably not!
		//
// 1 - Delay in the selection of the address (possibly an interval that keeps on looking until loaded?)
	// What happens with the refresh of the frame content on the address picking page

/******************** TESTING FUNCTIONS END *************************/

// Listen for messages sent back from the iFrame
$srJq(function(){

	window.addEventListener('message', function(event) {

		// TODO - Check the origin of the data against the approved URLs for this company
		var domainList = ["Stockport Council"];
					domainList.push("stockport.gov.uk");
					domainList.push("stage-iag-stockportgov.smbcdigital.net");
					domainList.push("myaccount.stockport.gov.uk");
					domainList.push("nationalrail.co.uk");
					domainList.push(" stockport-hbnc.egovhub.net");
					domainList.push("stockport-hbnc.egovhub.net");
					domainList.push("stockport.gov.uk");
					domainList.push(" roadworks.org");
					domainList.push(" totallylocalcompany.co.uk");
					domainList.push("democracy.stockport.gov.uk");
					domainList.push("interactive.stockport.gov.uk");
					domainList.push("roadworks.org");
					domainList.push("gov.uk");
					domainList.push("gov.uk");
					domainList.push("mycaremychoice.org.uk");
					domainList.push("recycleforgreatermanchester.com");
					domainList.push("GOV.UK");
					domainList.push("council.tax@stockport.gov.uk");
					domainList.push("uk-air.defra.gov.uk");
					domainList.push("stockport-fairtrade.org.uk");
					domainList.push("eco-schools.org.uk");
					domainList.push("feedingstockport.org.uk");
					domainList.push("assets.ctfassets.net");
					domainList.push("getcomposting.com");
					domainList.push("webcontent@stockport.gov.uk");
					domainList.push("education.stockport.gov.uk");
					domainList.push("tfgm.com");
					domainList.push("planningportal.co.uk");
		
		// Check that the request comes from a permitted domain
		var isAcceptable = false;
		for (var i in domainList) {
			if (~event.origin.indexOf(domainList[i])) {
				isAcceptable = true;
				continue;
			}
		}

		if (isAcceptable) {

			// Check whether it is just a notifcation that the window is ready to listen
			if (typeof event.data.isReady != 'undefined') {

				funnelStatus.frameReady = event.data.isReady;
				$srJq("#hiddenFrame").css("opacity", 1);

			} else if (typeof event.data.forceUserInput != 'undefined') {

				$srJq("#srInputs").addClass("srForceFrameUserInput");
				$srJq("#srMsgSender").prop("disabled", true).removeClass("srLoadingFakeMsgSender");
				// $srJq("#hiddenFrame").appendTo("#srInputs");
				$srJq("#srMsgSender").hide().removeClass("srNormalMsgSender");
				$srJq("#hiddenFrame").removeClass("srInvisibleFrame");
				handleBodyResize();

			} else if (typeof event.data.searchFunnelMsg != 'undefined') {

				console.log("RECEVIED MSG FROM FRAME, submitting");
				$srJq("#srMsgSender").val(event.data.searchFunnelMsg);
				submitMessage();

			} else {

				// Handle the received data
				switch (event.data.elementType) {
					case "select":
						srProcessSelectOptions(event.data.element, event.data.options);
						break;
					case "radio":
						srProcessRadioOptions(event.data.element, event.data.options);
						break;
					default:
						srProcessSelectOptions(event.data.element, event.data.options);
						break;
				}

			}

		}
	});
});


// $srJq(function(){
//   srPopulateAutocomplete("#airports//ul.ui-autocomplete//5000", "london Gatwick", [])
// });

// // Get the otpions for an autocomplete
// function srPopulateAutocomplete (selector, msg, details) {
//
//   // Explode the message about the words + extract any extraction words
//   var words = msg.split(" ");
//
//   // Get the details of the inputs that are relevant
//   var [ input, acList, delay ] = selector.split('//');
//
//   // Loop through each of the message words
//   let loopLength = words.length;
//   let i = 0;
//   acLoop(input, acList, delay, words, loopLength, i);
//
// }
//
// // Function to slowly iterate through the loop of words and work out which give an outcome
// function acLoop ( input, listElement, delay, words, loopLength, i ) {
//   var firstCouple;
//   var hiddenFrame = $srJq('#hiddenFrame iframe');
//   setTimeout(function(){
//     console.log(words);
//     console.log(words[i]);
//     firstCouple = words[i].substring(0,2).toLowerCase();
//     console.log(firstCouple);
//
//     // $srJq(input, hiddenFrame.contents()).autocomplete('search');
//     $srJq(input, hiddenFrame.contents()).focus().val(firstCouple).trigger($srJq.Event( 'keypress', { keyCode: 32, which: 32 } ));
//     // $srJq(input, hiddenFrame.contents()).focus().trigger(e);
//
//
//     i++;
//     if (i < loopLength) {
//       acLoop( input, listElement, delay, words, loopLength, i );
//     }
//     console.log(delay);
//   }, delay);
// }
		function handleFilterForm(filter_form) {
	if(filter_form.inverted) {
		for(var i in filter_form.inverted_field_group_selectors) {
			$srJq(filter_form.inverted_field_group_selectors[i]).trigger("click");
		}
	} else {
		for(var i in filter_form.element_selectors) {
			$srJq(filter_form.element_selectors[i]).trigger("click");
		}
	}
	if(filter_form.is_ajax_form == 0 && filter_form.submit_css_selector != "") {
		$srJq(filter_form.submit_css_selector).trigger("click");
	}
	if(filter_form.hasOwnProperty('matched_pretriggered_fields')) {
		for(var i in filter_form.matched_pretriggered_fields) {
			if(filter_form.matched_pretriggered_fields[i].fieldType == 'select') {
				srPopulateSelect(i, filter_form.matched_pretriggered_fields[i].value, true);
			} else if(filter_form.matched_pretriggered_fields[i].fieldType == 'radio-group') {
				srPopulateRadioGroup(i, filter_form.matched_pretriggered_fields[i].value, true);
			}
		}
	}
}
function srInFilterForm() {
	if(typeof filterFormSelectors !== 'null' && filterFormSelectors !== null) {
		return true;
	}
  return false;
}
function srCheckFilterFormValue (msg) {
	// Check to see whether an option has been submitted
	var selected = {};
	for(var i in filterFormSelectors) {
		selected[i] = srCompareToOptions(filterFormSelectors[i].selector, filterFormSelectors[i].fieldType, msg, 'filter-form');
	}
	return selected;

}


		var callbackScheduled = false;

		function fadeOutCallbackModal(CallbackModal){
			$srJq('#callbackCover .srCoverContent').slideUp(350);
			$srJq('#callbackCover a.srCloseBtn').fadeOut(350);
			$srJq('#callbackCover').fadeOut(600);
			$srJq('#callbackLaunchContainer .bubble-container').hide();
			$srJq('#callbackLaunchContainer .triangle').hide();

			if(!callbackScheduled){
				$srJq('.ami-icon.callback').fadeIn(250);
			}

			$srJq('.ami-icon').not('.callback').fadeIn(250);

		}

		function setupBubbleFadeIn(){
			var fadeInDelayInSeconds = 10;

			if( $srJq.cookie("sr-bubble-appeared") != 1 ){
				setTimeout(function(){
					$srJq('.bubble-component').fadeIn(250);
				},fadeInDelayInSeconds * 1000);
			}
		}

		var scheduleFormOpen = false;

		
		function checkIfCallbackScheduledForUser(){
			var chat_ref = $srJq('#chat_ref').val();
			var current_cookie = $srJq.cookie('sr-data');

			if(typeof current_cookie != 'undefined'){
				current_cookie = JSON.parse(current_cookie);
			} else {
				//No cookie, cant saveUnsentMessage
				return;
			}

			var userId = current_cookie['uid'];

			var clientRef = '168019131601';
			var url = "//app.meetami.ai/chats/is_callback_established/"+clientRef+"/"+userId;


			$srJq.ajax({
				url: url,
				type: "GET",
				success: function(data) {
					if(data == 0){
						$srJq('#callbackLaunchContainer').show();
					}
				},
				error: function(e,f,g) {
					console.log(e);
				}
			});
		}


		function triggerUserCallbackByAjax(isScheduled){
			var chat_ref = $srJq('#chat_ref').val();
			var current_cookie = $srJq.cookie('sr-data');

			if(typeof current_cookie != 'undefined'){
				current_cookie = JSON.parse(current_cookie);
			} else {
				//No cookie, cant saveUnsentMessage
				return;
			}

			var userId = current_cookie['uid'];

			var isValid = (isScheduled) ? $srJq('#scheduleFutureCallback').valid() : $srJq('#scheduleCallback').valid() ;
			if (!isValid) {
				return;
			}

			// Disable the buttons and show something is happening
			$srJq('#request-callback-now-btn').addClass('pending');
			$srJq('#request-callback-scheduled-btn').addClass('pending');

			// Disable the buttons and show something is happening
			$srJq('#request-callback-now-btn').addClass('pending');
			$srJq('#request-callback-scheduled-btn').addClass('pending');

			var data = {};

			if(isScheduled){
				data.name = $srJq('.futureCallbackCoverContent').find('#srNameRL').val();
				data.phone = $srJq('.futureCallbackCoverContent').find('#srPhoneRL').val();
				if($srJq("#srDept").length > 0) {
					var deptId = $srJq("#srDept").val();
				}

			} else {
				data.name = $srJq('.nowCallbackCoverContent').find('#srNameRL').val();
				data.phone = $srJq('.nowCallbackCoverContent').find('#srPhoneRL').val();
				if($srJq("#srDeptCallNow").length > 0) {
					var deptId = $srJq("#srDeptCallNow").val();
				}
			}

			var clientRef = '168019131601';

			var url = "//app.meetami.ai/chats/store_details_form/"+clientRef+"/"+userId;

			$srJq.ajax({
				url: url,
				type: "POST",
				data: data,
				success: function(data) {

					if (data != 1) {
						// Handle failures
						$srJq('#scheduleFutureCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;'>Sorry but there was an error saving your details. Please check them and try again.</div>");
						$srJq('#scheduleCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;>Sorry but there was an error saving your details. Please check them and try again.</div>");
						// Reset the button
						$srJq('#request-callback-now-btn').removeClass('pending');
						$srJq('#request-callback-scheduled-btn').removeClass('pending');
					} else {

						$srJq('#scheduleFutureCallback .srCBFormError').remove();
						$srJq('#scheduleCallback .srCBFormError').remove();

						if(typeof(deptId) == 'undefined') {
							deptId = null;
						}

						var url = "//app.meetami.ai/chats/trigger_call_from_layer/"+clientRef+"/"+userId+'/none/ic/-/' + deptId;
						console.log('user details store');
						var data = {};
						if(isScheduled){
							data.cb_time = $srJq('#ChatCallbackTime').val();
							data.cb_day = $srJq('#ChatCallbackDay').val();
						}

						$srJq.ajax({
							url: url,
							type: "POST",
							data:data,
							success: function(data) {
								if(data == 1){
									var html = '<div class="centre phonecall"><img src="//'+siteUrl+'/img/widget/phonecall.png" alt="Phone success icon" class="centre"><p>Thank you. we’ve placed your number in our call queue.</p><p>Please wait while we contact you by telephone.</p></div>';
									$srJq('.callbackCoverContent').find('.content').html(html);

									callbackScheduled = true;//closure to hide callback icon if successful
																	}

								if(data != 0 && data != 'error-recent') {
									// If callback requests are enabled then set it up as a request
									
									var html = '<div class="centre phonecall"><img src="//'+siteUrl+'/img/widget/phonecall.png" alt="Phone success icon" class="centre"><p>Thank you. we’ve placed your number in our call queue.</p><p>Please wait while we contact you by telephone.</p></div>';
									$srJq('.callbackCoverContent').find('.content').html(html);
								}

								// Handle other errors
								if (data == 'error-recent') {
									$srJq('#scheduleFutureCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;'>Sorry but there was an error triggering your call - you already have a callback scheduled.</div>");
									$srJq('#scheduleCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;>Sorry but there was an error triggering your call - you already have a callback scheduled.</div>");
								}
								if (data == 0) {
									$srJq('#scheduleFutureCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;'>Sorry but there was an error triggering your call. Please check the details you entered and try again.</div>");
									$srJq('#scheduleCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;>Sorry but there was an error triggering your call. Please check the details you entered and try again.</div>");
								}

								$srJq('#request-callback-now-btn').removeClass('pending');
								$srJq('#request-callback-scheduled-btn').removeClass('pending');

							}, error: function(e,f,g) {
								console.log(e);
								$srJq('#request-callback-now-btn').removeClass('pending');
								$srJq('#request-callback-scheduled-btn').removeClass('pending');
								$srJq('#scheduleFutureCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;'>Sorry but there was an error triggering your call. Please check the details you entered and try again.</div>");
								$srJq('#scheduleCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;>Sorry but there was an error triggering your call. Please check the details you entered and try again.</div>");
							}
						});
					}
				}, error: function(e,f,g) {
					console.log(e);
					$srJq('#request-callback-now-btn').removeClass('pending');
					$srJq('#request-callback-scheduled-btn').removeClass('pending');
					$srJq('#scheduleFutureCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;'>Sorry but there was an error saving your details. Please check them and try again.</div>");
					$srJq('#scheduleCallback').prepend("<div class='error srCBFormError' style='margin-bottom: 12px;>Sorry but there was an error saving your details. Please check them and try again.</div>");
				}
			});
		}

		

		function getSplitMessageString(message,index,character_count_threshold){

			if(parseInt(character_count_threshold) === 0){
				//return entire message if threshold set to 0
				return message;
			}

			var cutOffIndex = getCutOffIndex(message,index,character_count_threshold);

			var messageLength = cutOffIndex - index + 1;
			var splitMessage = message.substr(index,messageLength );

			//remove leading <br/> tags from start of message
			while(splitMessage.indexOf('<br/>') === 0){
				splitMessage = splitMessage.substr(5);
			}

			//remove ending <br/> tags from message
			while(splitMessage.lastIndexOf('<br/>') === splitMessage.length -  5){
				splitMessage = splitMessage.substr(0,splitMessage.length -  5);
			}

			return splitMessage;
		}

		function getCutOffIndex(message,index,character_count_threshold){

			if(parseInt(character_count_threshold) === 0){
				//return entire message length if no threshold set
				return message.length;
			}

			var cutOffIndex = parseInt(index)+ parseInt(character_count_threshold);
			var remainingMessage = message.substr(cutOffIndex);

			var minIndex = 0;
			var foundSentenceEndindex = -1;
			var foundBrIndex = -1;
			var reg = /[.!?]\s/;
			var match = reg.exec(remainingMessage);

			if(match){
				//grab index of match
				foundSentenceEndindex = match.index;
			}

			var brIndex = remainingMessage.indexOf('<br/>');

			if(brIndex !== -1){
				foundBrIndex  = brIndex;
			}

			if(foundSentenceEndindex == -1 && foundBrIndex === -1){
				//set cut off index to rest of string if no match found
				cutOffIndex += message.substr(index).length
			} else if (foundSentenceEndindex >=0   && foundBrIndex === -1){
				//found .?! but no <br/>
				cutOffIndex += foundSentenceEndindex + 1;
			} else if(foundSentenceEndindex == -1 && foundBrIndex >=0 ){
				//found <br/> but no .?!
				cutOffIndex += foundBrIndex +4;
			} else if (foundSentenceEndindex < foundBrIndex) {
				//found !.? before <br/>
				cutOffIndex += foundSentenceEndindex + 1;
			} else {
				//found <br/> before !.?
				cutOffIndex += foundBrIndex +4;
			}

			return cutOffIndex;
		}

		function formatAutoMessageStrForRegularExpression(message){

			message = message.replace(/<br \/>/g,'<br/>');
			message = message.trim();
			message += ' ';

			return message;
		}

		function appendViewMoreLinkToResponse(){
			// var viewMoreLinkExists = ($srJq('#srMsgs').find('a.linkified').next('a').length > 0);
			// var foundLinksInText = linkify.find($srJq('#srMsgs').text());
			//
			// if(foundLinksInText.length > 0  && !viewMoreLinkExists ){
			// 	var linkedMsgContainer = $srJq('#srMsgs').find('a.linkified').parent();
			// 	var viewMore = $srJq("<a target='_blank' class='srViewMoreLink' href='"+foundLinksInText[0]['href'] + "'>View More</a>");
			// 	linkedMsgContainer.append(viewMore);
			// }
		}



		function revealCallbackModal(domain){

			if(sr_isWelcomeMessageOpen()) {
				closeReplier();
			}

			$srJq('#callbackCover').fadeIn(350);
			setTimeout(function () {
				$srJq('#callbackCover .srCoverContent').slideDown(350);
				$srJq('#callbackCover a.srCloseBtn').slideDown(350);
			}, 550);

			$srJq('.ami-icon').fadeOut(250);
			$srJq('.bubble-component').fadeOut(250);

			// Set up the recovery layer cookie
			if(typeof existing != 'undefined'){
				existing['rl'] = 1;
			} else {
				existing = { rl: 1, srch: 0 }
			}
			existing = JSON.stringify(existing);
			$srJq.cookie('cb-rl', existing, { path: '/', domain: domain });
		}

		// Utility function to strip out spaces at the end of sentences before punctuation
		function stripIncorrectSpaces ( str ) {

			var delimiters = [".", ",", "?", "!", ":", ";"];

			for ( var i in delimiters ) {
				str = str.replace(" " + delimiters[i], delimiters[i]);
			}

			// Trim the string to remove preceeding or trailing spaces
			str = str.trim();
			str = str.replace(/^\n|\n$/g, '');

			return str;

		}

	}

	</script>



</body></html>